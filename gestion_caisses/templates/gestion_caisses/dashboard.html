{% extends 'gestion_caisses/base.html' %}
{% load static %}

{% block title %}Tableau de Bord - Gestion des Caisses{% endblock %}

{% block extra_css %}
<style>
/* Styles inspirés de index.html (mêmes fonctionnalités et structure) */
.dashboard-container { display: grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 2rem); background: #f8f9fa; position: relative; }

/* Header de l'application */
.app-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  z-index: 1000;
}

.app-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  backdrop-filter: blur(10px);
  overflow: hidden;
}

.logo-icon {
  font-size: 32px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.logo-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.app-title h1 {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.app-title p {
  margin: 5px 0 0 0;
  font-size: 14px;
  opacity: 0.9;
  font-weight: 300;
}
.sidebar { 
  background: #2c3e50; 
  color: #fff; 
  padding: 20px; 
  position: sticky; 
  top: 1rem; 
  height: calc(100vh - 120px); 
  border-radius: 12px; 
  margin-top: 100px;
  overflow-y: auto;
  overflow-x: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.user-info { 
  background: rgba(255,255,255,0.08); 
  border-radius: 12px; 
  padding: 20px; 
  margin-bottom: 24px; 
  text-align: center;
  position: relative;
  z-index: 5;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.user-avatar { font-size: 42px; margin-bottom: 10px }
.user-name { font-weight: 600 }
.user-role { color: #58a6ff }
.logout-btn { 
  background: #e74c3c; 
  color: #fff; 
  border: none; 
  padding: 10px 16px; 
  border-radius: 8px; 
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
  width: 100%;
  position: relative;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.logout-btn:hover {
  background: #c0392b;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.logout-btn:active {
  transform: translateY(0);
}
.nav-menu { display: flex; flex-direction: column; gap: 8px }
.nav-tab { background: transparent; color: #cbd5e1; border: none; padding: 12px 14px; text-align: left; border-radius: 8px }
.nav-tab.active, .nav-tab:hover { background: rgba(255,255,255,0.12); color: #fff }
.main-content { padding: 20px; padding-top: 120px; }
.content-section { display: none }
.content-section.active { display: block }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 16px; margin-bottom: 20px }
.stat-card { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08); display: flex; align-items: center; gap: 14px }
.stat-icon { font-size: 36px }
.stat-number { font-size: 28px; font-weight: 700 }
.stat-label { color: #6b7280; text-transform: uppercase; font-size: 12px; letter-spacing: .5px }
.dashboard-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px }
.chart-container { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08) }
.alertes-section { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08) }
.alertes-grid { display: grid; gap: 12px }
.alerte-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; border-left: 4px solid }
.alerte-item.danger { background: #f8d7da; border-left-color: #dc3545; color:#7a1c21 }
.alerte-item.warning { background: #fff3cd; border-left-color: #ffc107; color:#7a5a00 }
.alerte-item.info { background: #d1ecf1; border-left-color: #17a2b8; color:#0c5460 }
.alerte-item.success { background: #d4edda; border-left-color: #28a745; color:#155724 }
/* Centrage des modals */
.modal-dialog { display: flex; align-items: center; min-height: calc(100vh - 2rem); }
.modal-dialog .modal-content { margin: auto; }
/* Assurer la superposition correcte des modales et éviter le clipping */
.modal { z-index: 9999 !important; overflow: visible !important; }
.modal-backdrop { z-index: 9990 !important; }
/* Barre de recherche */
.search-bar { max-width: 420px }
@media (max-width: 1024px){ 
  .dashboard-container { grid-template-columns: 1fr } 
  .sidebar { position: static; height: auto; margin-top: 0; } 
  .dashboard-charts{ grid-template-columns:1fr } 
  .main-content { padding-top: 20px; }
  .app-header { padding: 15px 20px; }
  .app-title h1 { font-size: 24px; }
  .app-title p { font-size: 12px; }
  .logo-icon { font-size: 28px; }
  .app-logo { width: 50px; height: 50px; }
  
  /* Améliorer la visibilité du bouton de déconnexion sur mobile */
  .logout-btn {
    padding: 12px 20px;
    font-size: 16px;
    margin-top: 15px;
  }
  
  .user-info {
    padding: 25px 20px;
    margin-bottom: 30px;
  }
}

/* Styles pour les modals modernes */
.modal-content {
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
  border-radius: 15px 15px 0 0;
}

.modal-footer {
  border-radius: 0 0 15px 15px;
}

.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.alert {
  border-radius: 10px;
  border: none;
}

.card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Styles pour les rapports */
.stat-item {
  text-align: center;
  padding: 15px;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  margin-bottom: 10px;
}

.stat-item h3, .stat-item h4 {
  margin: 0;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.stat-item small {
  color: #6c757d;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table-responsive {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.table th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

.table td {
  vertical-align: middle;
}

.badge.bg-pink {
  background-color: #e83e8c !important;
}

.badge.bg-blue {
  background-color: #007bff !important;
}

/* Animation pour les cartes de rapport */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Styles pour les filtres de rapport */
.form-control:focus, .form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-group .btn {
  border-radius: 6px;
  margin: 0 2px;
}

.btn-group .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Styles pour les toasts */
.toast {
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Animation pour les spinners */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.spinner-border {
  animation: spinner-border 0.75s linear infinite, pulse 2s ease-in-out infinite;
}

/* Styles pour les listes dans les modals */
.list-unstyled li {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.list-unstyled li:last-child {
  border-bottom: none;
}

/* Styles pour les icônes */
.fas, .fa {
  margin-right: 8px;
}

/* Styles pour les tableaux dans les modals */
.table {
  border-radius: 8px;
  overflow: hidden;
}

.table th {
  background-color: #f8f9fa;
  border: none;
  font-weight: 600;
}

.table td {
  border: none;
  border-bottom: 1px solid #f0f0f0;
}

/* Styles pour les boutons dans les modals */
.modal-footer .btn {
  min-width: 120px;
}

/* Styles pour les alertes dans les modals */
.alert-info {
  background-color: #e3f2fd;
  color: #0d47a1;
}

.alert-success {
  background-color: #e8f5e8;
  color: #1b5e20;
}

.alert-warning {
  background-color: #fff3e0;
  color: #e65100;
}

.alert-danger {
  background-color: #ffebee;
  color: #c62828;
}

/* Styles pour les badges et statuts */
.badge {
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

/* Styles pour les cartes de prêts */
.pret-card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.pret-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

/* Styles pour les barres de progression */
.progress {
  border-radius: 10px;
  height: 20px;
  background-color: #f0f0f0;
}

.progress-bar {
  border-radius: 10px;
  font-size: 10px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Styles pour les animations de chargement */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  background-color: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Styles pour les notifications */
.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #dc3545;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Styles pour les tooltips personnalisés */
.custom-tooltip {
  position: relative;
  cursor: help;
}

.custom-tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
}

/* Styles pour les formulaires dans les modals */
.form-control, .form-select {
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

/* Styles pour les labels */
.form-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 8px;
}

/* Styles pour les messages d'erreur */
.text-danger {
  font-size: 0.875rem;
  font-weight: 500;
}

/* Styles pour les messages de succès */
.text-success {
  font-weight: 600;
}

/* Styles pour les icônes dans les boutons */
.btn i {
  margin-right: 6px;
}

/* Styles pour les modals de confirmation */
.confirmation-modal .modal-content {
  border: 3px solid #28a745;
}

/* Styles pour les modals de succès */
.success-modal .modal-content {
  border: 3px solid #28a745;
}

/* Styles pour les modals d'erreur */
.error-modal .modal-content {
  border: 3px solid #dc3545;
}

/* Styles pour les animations d'entrée */
.modal.fade .modal-dialog {
  transform: scale(0.8);
  transition: transform 0.3s ease;
}

.modal.show .modal-dialog {
  transform: scale(1);
}

/* Styles pour les animations de sortie */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease;
}

/* Styles pour les toasts avec animations */
.toast {
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Styles pour les boutons de fermeture */
.btn-close {
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.btn-close:hover {
  background-color: rgba(255,255,255,0.2);
  transform: rotate(90deg);
}

/* Styles pour les sections dans les modals */
.modal-section {
  padding: 20px 0;
  border-bottom: 1px solid #f0f0f0;
}

.modal-section:last-child {
  border-bottom: none;
}

/* Styles pour les titres de sections */
.section-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #007bff;
}

/* Styles pour les listes d'actions */
.action-list {
  list-style: none;
  padding: 0;
}

.action-list li {
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
}

.action-list li:last-child {
  border-bottom: none;
}

.action-list li i {
  margin-right: 10px;
  width: 20px;
  text-align: center;
}

/* Styles pour les informations importantes */
.important-info {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.important-info h6 {
  color: #856404;
  margin-bottom: 10px;
}

.important-info ul {
  margin-bottom: 0;
  padding-left: 20px;
}

.important-info li {
  color: #856404;
  margin-bottom: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container container-fluid">
  <!-- Header avec logo et nom de l'application -->
  <div class="app-header">
    <div class="app-logo">
      {% if logo %}
        <img src="{{ logo.url }}" alt="Logo" class="logo-image">
      {% else %}
        <span class="logo-icon">€</span>
      {% endif %}
    </div>
    <div class="app-title">
      <h1>{{ nom_application|default:"CashFlow Pro FKM" }}</h1>
      <p>{{ description_application|default:"Gestion des Caisses FKM" }}</p>
    </div>
  </div>
  
  <div class="sidebar">
    <div class="user-info">
      <div class="user-avatar">👤</div>
      <div class="user-name" id="user-name">{{ user.first_name }} {{ user.last_name }}</div>
      <div class="user-role" id="user-role">{{ user_role }}</div>
      <button class="logout-btn" onclick="handleLogout()">🚪 Déconnexion</button>
    </div>
    <nav class="nav-menu">
              <button class="nav-tab active" onclick="showSection(event,'dashboard')">📊 Dashboard</button>
        <button class="nav-tab" onclick="showSection(event,'caisses')">🏦 Caisses</button>
        <button class="nav-tab" onclick="showSection(event,'membres')">👥 Membres</button>
        <button class="nav-tab" id="tab-prets" onclick="showSection(event,'prets')">💰 Prêts</button>
        {% if user_role == 'Administrateur' %}
        <button class="nav-tab" onclick="showSection(event,'salaires')">🧾 Salaires Agents</button>
        {% endif %}
        <button class="nav-tab" id="tab-depenses" onclick="showSection(event,'depenses')">💸 Dépenses</button>
        <button class="nav-tab" id="tab-rapports" onclick="showSection(event,'rapports')">📈 Rapports</button>
        {% if user_role == 'Administrateur' %}
        <button class="nav-tab" onclick="showSection(event,'motifs')">🗂️ Motifs Prêts</button>
        {% endif %}
        <button class="nav-tab" onclick="showSection(event,'seances')">🗓️ Séances</button>
        <button class="nav-tab" onclick="showSection(event,'cotisations')">💵 Cotisations</button>
    </nav>
  </div>

  <div class="main-content">
    <div id="dashboard" class="content-section active">
      <h2>📊 Tableau de Bord — {{ caisse_nom }}</h2>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">🏦</div><div><div class="stat-number" id="total-caisses">0</div><div class="stat-label">Total Caisses</div></div></div>
        <div class="stat-card"><div class="stat-icon">👥</div><div><div class="stat-number" id="total-membres">0</div><div class="stat-label">Total Membres</div></div></div>
        <div class="stat-card"><div class="stat-icon">💰</div><div><div class="stat-number" id="total-fonds">0 FCFA</div><div class="stat-label">Fonds Disponibles</div></div></div>
        <div class="stat-card"><div class="stat-icon">📊</div><div><div class="stat-number" id="total-prets">0</div><div class="stat-label">Prêts Actifs</div></div></div>
        </div>
      <div class="dashboard-charts">
        <div class="chart-container">
          <h3>📈 Évolution des Prêts</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="evolutionChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <h3>🏆 Caisses par Région</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="regionsChart"></canvas>
          </div>
        </div>
      </div>
      <div class="alertes-section">
        <h3>🚨 Alertes</h3>
        <div id="alertes-list" class="alertes-grid"></div>
        </div>
    </div>
    <div id="caisses" class="content-section">
      <!-- En-tête avec statistiques -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="fa fa-building me-2 text-primary"></i>
          Gestion des Caisses
        </h2>
        <div class="d-flex gap-2">
          <span class="badge bg-primary fs-6" id="total-caisses-badge">0 Caisse</span>
          <button class="btn btn-outline-primary btn-sm" onclick="loadCaisses()">
            <i class="fa fa-refresh me-1"></i>Actualiser
          </button>
        </div>
      </div>

      <!-- Filtres et recherche -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Rechercher une caisse</label>
              <input type="text" id="searchInput" class="form-control" placeholder="Nom, code ou localisation...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Statut</label>
              <select id="statutFilter" class="form-select">
                <option value="">Tous les statuts</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
                <option value="SUSPENDUE">Suspendue</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Tri par</label>
              <select id="sortFilter" class="form-select">
                <option value="date_creation">Date de création</option>
                <option value="nom">Nom</option>
                <option value="solde">Solde disponible</option>
                <option value="code">Code</option>
              </select>
            </div>
            <div class="col-md-2">
              <button id="clearFilters" class="btn btn-outline-secondary w-100">
                <i class="fa fa-times me-1"></i>Effacer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Grille des cartes -->
      <div class="row g-4" id="caissesGrid">
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-2 text-muted">Chargement des caisses...</p>
        </div>
      </div>
    </div>
    <div id="membres" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">👥 Gestion des Membres</h2>
        <div class="d-flex gap-2 align-items-center">
          <input id="membreSearch" class="form-control search-bar" placeholder="Rechercher un membre..." oninput="filterMembers()" />
          <button class="btn btn-success" onclick="openMembreModal()">+ Nouveau Membre</button>
          <button class="btn btn-info" onclick="generateMembresListePDF(USER_CAISE_ID)" title="Générer la liste complète des membres en PDF">
            <i class="fas fa-file-pdf"></i> Liste PDF
          </button>
        </div>
      </div>
      <div id="membres-content" class="mt-3"></div>
    </div>
    <div id="prets" class="content-section">
      <div class="d-flex align-items-center justify-content-between">
        <h2>💰 Gestion des Prêts</h2>
        <div>
          <button class="btn btn-warning me-2" onclick="generateEcheancesRetardPDF(event)" title="Générer le rapport des échéances en retard">
            <i class="fas fa-exclamation-triangle"></i> Échéances en Retard
          </button>
          <button class="btn btn-primary" onclick="openPretModal()">+ Nouveau Prêt</button>
        </div>
      </div>
      <div id="prets-content" class="mt-3"></div>
    </div>
    {% if user_role == 'Administrateur' %}
    <div id="salaires" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">🧾 Salaires des Agents</h2>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-secondary" onclick="loadSalairesAgents()">↻ Actualiser</button>
          <button class="btn btn-primary" onclick="genererFichesMensuelles()">🖨️ Générer fiches (mois courant)</button>
        </div>
      </div>
      <div id="salaires-alerts" class="mt-2"></div>
      <div class="row g-2 mt-2">
        <div class="col-6 col-md-2">
          <label class="form-label small mb-1">Mois</label>
          <select id="salaires-mois" class="form-select" onchange="loadSalairesAgents()">
            <option value="">Tous</option>
            <option value="1">Janvier</option><option value="2">Février</option><option value="3">Mars</option>
            <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>
            <option value="7">Juillet</option><option value="8">Août</option><option value="9">Septembre</option>
            <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">Décembre</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label small mb-1">Année</label>
          <input id="salaires-annee" type="number" class="form-control" min="2000" max="2100" onchange="loadSalairesAgents()" />
        </div>
        <div class="col-12 col-md-8 d-flex align-items-end justify-content-end">
          <button class="btn btn-success" onclick="openCreateSalaireForm()">+ Nouveau salaire</button>
        </div>
      </div>
      <div id="salaire-form" class="card mt-2" style="display:none">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label for="sf-agent" class="form-label mb-1">Agent</label>
              <select id="sf-agent" class="form-select" onchange="checkSalaireDuplicate()"><option value="">Sélectionner un agent...</option></select>
              <div class="form-text">Choisissez l'agent concerné par ce salaire.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-mois" class="form-label mb-1">Mois</label>
              <select id="sf-mois" class="form-select" onchange="checkSalaireDuplicate()">
                <option value="">Mois</option>
                <option value="1">Janvier</option><option value="2">Février</option><option value="3">Mars</option>
                <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>
                <option value="7">Juillet</option><option value="8">Août</option><option value="9">Septembre</option>
                <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">Décembre</option>
              </select>
              <div class="form-text">Sélectionnez le mois de paie.</div>
            </div>
            <div class="col-6 col-md-2">
              <label for="sf-annee" class="form-label mb-1">Année</label>
              <input id="sf-annee" type="number" min="2000" max="2100" class="form-control" placeholder="Année" oninput="checkSalaireDuplicate()" />
              <div class="form-text">Saisissez l'année (ex: 2025).</div>
            </div>
            <div class="col-12"><div id="sf-duplicate" class="alert alert-warning py-2 px-3" style="display:none">Un salaire existe déjà pour cet agent et cette période.</div></div>
            <div class="col-6 col-md-3">
              <label for="sf-base" class="form-label mb-1">Salaire de base</label>
              <input id="sf-base" type="number" step="0.01" class="form-control" placeholder="0.00" />
              <div class="form-text">Montant fixe mensuel en FCFA.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-bonus" class="form-label mb-1">Bonus caisses</label>
              <input id="sf-bonus" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Bonus lié aux nouvelles caisses créées.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-prime" class="form-label mb-1">Prime de performance</label>
              <input id="sf-prime" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Prime additionnelle éventuelle.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-ded" class="form-label mb-1">Déductions</label>
              <input id="sf-ded" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Retenues et charges à déduire.</div>
            </div>
            <div class="col-12">
              <label for="sf-notes" class="form-label mb-1">Notes</label>
              <input id="sf-notes" type="text" class="form-control" placeholder="Informations complémentaires (optionnel)" />
              <div class="form-text">Ajoutez un commentaire interne si nécessaire.</div>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-secondary" onclick="toggleSalaireForm()">Annuler</button>
            <button id="sf-submit" class="btn btn-primary" onclick="soumettreSalaireAgent()">Enregistrer</button>
          </div>
        </div>
      </div>
      <div id="salaires-stats" class="mt-3"></div>
      <div id="salaires-list" class="mt-3"></div>
      <div id="fiches-list" class="mt-3"></div>
    </div>
    {% endif %}
    <div id="seances" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">🗓️ Séances de Réunion</h2>
        <div class="d-flex gap-2 align-items-center">
          <button id="btnNewSeance" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#seanceModal">+ Nouvelle Séance</button>
        </div>
      </div>
      <div id="seances-list" class="mt-3"></div>
    </div>
    <div id="cotisations" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">💵 Cotisations</h2>
        <div class="d-flex gap-2 align-items-center">
          <button id="btnNewCotisation" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cotisationModal">+ Nouvelle Cotisation</button>
        </div>
      </div>
      <div class="mt-3">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">📊 Totaux</h5>
                <div class="row text-center">
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Tempon</div>
                    <div class="fw-bold" id="statTempon">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Solidarité</div>
                    <div class="fw-bold" id="statSolidarite">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Fondation</div>
                    <div class="fw-bold" id="statFondation">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Pénalité</div>
                    <div class="fw-bold" id="statPenalite">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold" id="statTotal">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small"># Cotisations</div>
                    <div class="fw-bold" id="statNombre">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">📈 Série mensuelle</h5>
                <canvas id="cotisationsChart" height="160"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                  <h5 class="card-title m-0">👤 Stats par membre</h5>
                  <select id="statsMembre" class="form-select" style="min-width:280px" onchange="refreshMemberStats()"></select>
                </div>
                <div class="row text-center mb-3">
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Mois cotisés</div>
                    <div class="fw-bold" id="mStatMois">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold" id="mStatTotal">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Tempon</div>
                    <div class="fw-bold" id="mStatTempon">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Solidarité</div>
                    <div class="fw-bold" id="mStatSolidarite">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Pénalités</div>
                    <div class="fw-bold" id="mStatPenalite">0</div>
                  </div>
                </div>
                <canvas id="cotisationsMemberChart" height="120"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="cotisations-list" class="mt-3"></div>
    </div>
    
    <!-- Section Dépenses -->
    <div id="depenses" class="content-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>💸 Gestion des Dépenses</h2>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" onclick="openDepenseCreateModal()">
            <i class="fas fa-plus"></i> Nouvelle Dépense
          </button>
          <button type="button" class="btn btn-outline-info" onclick="chargerDepenses()">
            <i class="fas fa-sync"></i> Actualiser
          </button>
        </div>
      </div>

      <!-- Statistique des dépenses (Solde disponible uniquement) -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Solde Disponible</h6>
                  <h4 id="solde-depenses" class="mb-0">0 FCFA</h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-wallet fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export PDF Dépenses entre deux dates -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Date de début</label>
              <input type="date" class="form-control" id="depenses-date-debut" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Date de fin</label>
              <input type="date" class="form-control" id="depenses-date-fin" />
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-danger" onclick="exportDepensesPDF(this)">
                <i class="fas fa-file-pdf"></i> PDF Dépenses (période)
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste des dépenses -->
      <div class="card">
        <div class="card-body">
          <div id="depenses-list">
            <div class="text-center py-5">
              <i class="fas fa-list fa-3x text-muted mb-3"></i>
              <p class="text-muted">Cliquez sur "Actualiser" pour charger la liste des dépenses</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="rapports" class="content-section">
      <style>
        .report-toolbar{gap:.5rem}
        .report-btn{border-radius:999px;padding:.35rem .6rem;box-shadow:0 2px 8px rgba(0,0,0,.06);display:inline-flex;align-items:center;gap:.35rem;font-weight:600;font-size:.85rem;transition:transform .08s ease,box-shadow .2s ease}
        .report-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.09)}
        .report-sep{width:1px;background:rgba(0,0,0,.06);margin:0 .25rem}
      </style>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">📈 Rapports et Statistiques</h2>
        <div class="d-flex flex-wrap report-toolbar">
          <button type="button" class="btn btn-sm btn-outline-primary report-btn" title="Rapport général (PDF)" onclick="genererRapportPDF('general', this)"><i class="fas fa-chart-line"></i><span>Général</span></button>
          <button type="button" class="btn btn-sm btn-outline-success report-btn" title="Rapport financier (PDF)" onclick="genererRapportPDF('financier', this)"><i class="fas fa-coins"></i><span>Financier</span></button>
          <button type="button" class="btn btn-sm btn-outline-info report-btn" title="Rapport des prêts (PDF)" onclick="genererRapportPDF('prets', this)"><i class="fas fa-hand-holding-usd"></i><span>Prêts</span></button>
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-outline-danger report-btn" title="Cotisations (général) en PDF" onclick="genererRapportPDF('cotisations_general', this)"><i class="fas fa-file-invoice-dollar"></i><span>Cotisations</span></button>
          <button type="button" class="btn btn-sm btn-outline-danger report-btn" title="Cotisations par membre (PDF)" onclick="genererRapportPDF('cotisations_par_membre', this)"><i class="fas fa-user-friends"></i><span>Par membre</span></button>
          <button type="button" class="btn btn-sm btn-outline-warning report-btn" title="Dépenses (PDF)" onclick="genererRapportPDF('depenses', this)"><i class="fas fa-receipt"></i><span>Dépenses</span></button>
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir cotisations (général)" onclick="chargerRapportCotisations()"><i class="fas fa-list"></i><span>Voir cotisations</span></button>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir cotisations par membre" onclick="chargerRapportCotisationsParMembre()"><i class="fas fa-user"></i><span>Par membre</span></button>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir dépenses" onclick="chargerRapportDepenses()"><i class="fas fa-list"></i><span>Voir dépenses</span></button>
          {% if user_role != 'Administrateur' %}
          <button type="button" class="btn btn-sm btn-outline-primary report-btn" title="Préparer rapport membre" onclick="(function(){ const contenuRapport = document.getElementById('contenu-rapport'); contenuRapport.innerHTML = afficherRapportCotisationsMembre({items:[], totaux:{}, membre:{nom:''}}); initRapportMembreSelect(); })()"><i class="fas fa-user-check"></i><span>Membre</span></button>
          {% endif %}

          {% if user_role == 'Administrateur' %}
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-primary report-btn" title="PDF - Tous les membres par caisse" onclick="telechargerMembresSystemePDF(this)"><i class="fas fa-users"></i><span>Membres PDF</span></button>
          <button type="button" class="btn btn-sm btn-dark report-btn" title="PDF - Tous les agents" onclick="telechargerAgentsSystemePDF(this)"><i class="fas fa-id-badge"></i><span>Agents PDF</span></button>
          <button type="button" class="btn btn-sm btn-danger report-btn" title="PDF - Évaluation des prêts" onclick="telechargerPretsEvaluationPDF(this)"><i class="fas fa-clipboard-check"></i><span>Éval. Prêts</span></button>
          {% endif %}
        </div>
      </div>

      <!-- Filtres de date -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Filtres de période</h5>
          <div class="row">
            <div class="col-md-3">
              <label for="date-debut" class="form-label">Date de début</label>
              <input type="date" class="form-control" id="date-debut">
            </div>
            <div class="col-md-3">
              <label for="date-fin" class="form-label">Date de fin</label>
              <input type="date" class="form-control" id="date-fin">
            </div>
            <div class="col-md-3">
              <label for="type-rapport" class="form-label">Type de rapport</label>
              <select class="form-select" id="type-rapport">
                <option value="general">Rapport Général</option>
                <option value="financier">Rapport Financier</option>
                <option value="prets">Rapport des Prêts</option>
                <option value="membres">Rapport des Membres</option>
                <option value="echeances">Rapport des Échéances</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary" onclick="chargerRapport()">
                <i class="fas fa-search"></i> Charger
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenu du rapport -->
      <div id="contenu-rapport">
        <div class="text-center py-5">
          <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
          <p class="text-muted">Sélectionnez un type de rapport et cliquez sur "Charger" pour afficher les données</p>
        </div>
      </div>
    </div>
    {% if user_role == 'Administrateur' %}
    <div id="motifs" class="content-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">🗂️ Motifs des Prêts</h2>
        <div class="d-flex gap-2">
          <select id="motif-select" class="form-select form-select-sm" style="width:200px">
            <option value="">Tous les motifs</option>
            <option value="commerce">Commerce</option>
            <option value="agriculture">Agriculture</option>
            <option value="sante">Santé</option>
            <option value="education">Éducation</option>
            <option value="logement">Logement</option>
            <option value="autres">Autres</option>
          </select>
          <button class="btn btn-sm btn-outline-primary" onclick="chargerPretsParMotif()"><i class="fas fa-search"></i> Filtrer</button>
          <button class="btn btn-sm btn-primary" onclick="telechargerPretsParMotifPDF(this)"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
      </div>
      <div id="motifs-content">
        <div class="text-muted">Choisissez un motif et cliquez sur Filtrer.</div>
      </div>
    </div>
    {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let evolutionChart, regionsChart;

document.addEventListener('DOMContentLoaded', function() {
  try {
    // Attacher handlers explicites sur les boutons pour fiabilité
    document.getElementById('btnNewSeance')?.addEventListener('click', openSeanceCreateModal);
    document.getElementById('btnNewCotisation')?.addEventListener('click', openCotisationCreateModal);
    // Accessibilité: placer le focus dans le premier champ quand une modale s'affiche
    document.getElementById('seanceModal')?.addEventListener('shown.bs.modal', () => {
      const el = document.getElementById('seanceModal');
      try { el?.removeAttribute('aria-hidden'); } catch {}
      document.getElementById('seanceDate')?.focus();
    });
    document.getElementById('cotisationModal')?.addEventListener('shown.bs.modal', () => {
      const el = document.getElementById('cotisationModal');
      try { el?.removeAttribute('aria-hidden'); } catch {}
      document.getElementById('cotisationMembre')?.focus();
    });
  } catch(e) { console.warn('Bind buttons error', e); }

  loadDashboardData();
  loadAlertes();
  fetchUserContext().then(() => { loadCaisse(); loadMembers(); loadPrets(); });
});

// Helpers de dates sûrs côté frontend
function parseDateMaybe(value){
  if(!value) return null;
  try {
    // Supporte ISO, timestamps, et formats communs
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  } catch { return null; }
}
function formatDateSafe(value){
  const d = parseDateMaybe(value);
  return d ? d.toLocaleDateString('fr-FR') : (value||'');
}
function formatDateTimeSafe(value){
  const d = parseDateMaybe(value);
  return d ? d.toLocaleString('fr-FR') : (value||'');
}

function showSection(evt, id){
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  evt.currentTarget.classList.add('active');
  if (id === 'dashboard') loadDashboardData();
  if (id === 'depenses') {
    try { chargerDepenses(); } catch(e) { console.error(e); }
  }
  if (id === 'salaires') {
    try { loadSalairesAgents(); } catch(e) { console.error(e); }
  }
}

function handleLogout(){
  fetch('/gestion-caisses/api/logout/', { method:'POST', headers: { 'X-CSRFToken': getCSRFToken() }})
    .then(()=> window.location.href = '/gestion-caisses/');
}

let isLoadingDashboard = false;

function loadDashboardData(){
  if (isLoadingDashboard) return; // Éviter les appels multiples
  
  isLoadingDashboard = true;
  
  fetch('/gestion-caisses/api/dashboard/stats/', { 
    headers: { 'X-CSRFToken': getCSRFToken() }
  })
    .then(r => {
      if (!r.ok) throw new Error('Erreur réseau');
      return r.json();
    })
    .then(data => {
      updateDashboardStats(data);
      renderCharts(data);
    })
    .catch(error => {
      console.error('Erreur lors du chargement du dashboard:', error);
      // Afficher un message d'erreur à l'utilisateur
      const alertesList = document.getElementById('alertes-list');
      if (alertesList) {
        alertesList.innerHTML = '<div class="alerte-item danger">❌ Erreur lors du chargement des données</div>';
      }
    })
    .finally(() => {
      isLoadingDashboard = false;
    });
}

// ===================== Salaires Agents =====================
async function loadSalairesAgents(){
  const statsBox = document.getElementById('salaires-stats');
  const listBox = document.getElementById('salaires-list');
  if (!statsBox || !listBox) return;
  statsBox.innerHTML = '<div class="alert alert-info">Chargement des statistiques...</div>';
  listBox.innerHTML = '<div class="alert alert-info">Chargement de la liste des salaires...</div>';

  // Charger stats
  try {
    const statsResp = await fetch('/gestion-caisses/api/agents-salaires-stats/', {
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'same-origin'
    });
    const stats = statsResp.ok ? await statsResp.json() : null;
    renderSalairesStats(stats);
  } catch (e){
    console.error('Stats error', e);
    statsBox.innerHTML = '<div class="alert alert-danger">Impossible de charger les statistiques.</div>';
  }

  // Charger liste salaires
  try {
    const params = new URLSearchParams();
    const mois = document.getElementById('salaires-mois')?.value;
    const annee = document.getElementById('salaires-annee')?.value;
    if (mois) params.append('mois', mois);
    if (annee) params.append('annee', annee);
    const salairesResp = await fetch(`/gestion-caisses/api/salaires-agents/${params.toString() ? ('?'+params.toString()) : ''}`, {
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'same-origin'
    });
    const salairesData = salairesResp.ok ? await salairesResp.json() : [];
    const salairesList = (salairesData && (salairesData.results || (Array.isArray(salairesData) ? salairesData : []))) || [];
    renderSalairesList(salairesList);
  } catch (e){
    console.error('List error', e);
    listBox.innerHTML = '<div class="alert alert-danger">Impossible de charger la liste des salaires.</div>';
  }

  // Charger fiches
  try { await loadFichesPaieRecents(); } catch(e){ console.error(e); }
}

function renderSalairesStats(data){
  const el = document.getElementById('salaires-stats');
  if (!el) return;
  if (!data){
    el.innerHTML = '<div class="alert alert-warning">Aucune statistique disponible.</div>';
    return;
  }
  const totalAgents = data.total_agents ?? 0;
  const annee = data.annee_courante ?? '';
  const top = (data.top_agents_bonus || []).slice(0,5).map(a=>`<li>${a.agent} • ${a.matricule} — Bonus: ${fmt(a.bonus_caisses)} FCFA</li>`).join('') || '<li>Aucun</li>';
  el.innerHTML = `
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <div class="card"><div class="card-body">
          <div class="d-flex align-items-center gap-3">
            <div style="font-size:32px">👤</div>
            <div>
              <div class="text-muted small">Agents</div>
              <div class="fw-bold" style="font-size:20px">${totalAgents}</div>
            </div>
          </div>
        </div></div>
      </div>
      <div class="col-12 col-md-8">
        <div class="card"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="m-0">Top bonus ${annee}</h5>
          </div>
          <ul class="mt-2 mb-0">${top}</ul>
        </div></div>
      </div>
    </div>
  `;
}

function renderSalairesList(items){
  const el = document.getElementById('salaires-list');
  if (!el) return;
  const rows = (items || []).map(it=>{
    const periode = it.periode || `${it.mois}/${it.annee}`;
    const statut = it.statut || '';
    return `
      <tr>
        <td>${it.agent_nom || ''}<div class="text-muted small">${it.agent_matricule || ''}</div></td>
        <td>${periode}</td>
        <td class="text-end">${fmt(it.salaire_base)} FCFA</td>
        <td class="text-end">${fmt(it.bonus_caisses)} FCFA</td>
        <td class="text-end">${fmt(it.prime_performance)} FCFA</td>
        <td class="text-end">${fmt(it.total_net)} FCFA</td>
        <td><span class="badge ${statut==='PAYE'?'bg-success':(statut==='EN_ATTENTE'?'bg-warning text-dark':'bg-secondary')}">${statut}</span></td>
        <td class="text-end">
          ${statut!=='PAYE' ? `<button class=\"btn btn-sm btn-success\" onclick=\"payerSalaire(${it.id})\">Payer</button>` : ''}
          <button class=\"btn btn-sm btn-outline-secondary ms-1\" onclick=\"calculerBonus(${it.id})\">Calculer bonus</button>
          <button class=\"btn btn-sm btn-outline-primary ms-1\" onclick=\"openEditSalaireForm(${encodeURIComponent(JSON.stringify(it))})\">Éditer</button>
          ${statut==='PAYE' ? `<button class=\"btn btn-sm btn-outline-primary ms-1\" onclick=\"openFicheFromSalaire(${it.id})\">PDF</button>` : ''}
        </td>
      </tr>
    `;
  }).join('');
  el.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">Derniers salaires</h5>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Période</th>
                <th class="text-end">Salaire base</th>
                <th class="text-end">Bonus caisses</th>
                <th class="text-end">Prime</th>
                <th class="text-end">Net</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="7" class="text-center text-muted">Aucun salaire</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

async function payerSalaire(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/salaires-agents/${id}/marquer-paye/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    if (!resp.ok) throw new Error('Paiement échoué');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    alert('Impossible de marquer le salaire comme payé.');
  }
}

async function calculerBonus(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/salaires-agents/${id}/calculer-bonus/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ montant_par_caisse: 5000 })
    });
    if (!resp.ok) throw new Error('Calcul échoué');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    alert('Impossible de calculer le bonus.');
  }
}

async function loadFichesPaieRecents(){
  const box = document.getElementById('fiches-list');
  if (!box) return;
  box.innerHTML = '<div class="alert alert-info">Chargement des fiches de paie...</div>';
  try{
    const mois = document.getElementById('salaires-mois')?.value;
    const annee = document.getElementById('salaires-annee')?.value;
    const qp = new URLSearchParams();
    if (mois) qp.append('mois', mois);
    if (annee) qp.append('annee', annee);
    qp.append('page_size', '1000');
    const url = `/gestion-caisses/api/fiches-paie/${qp.toString() ? ('?'+qp.toString()) : ''}`;
    const resp = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }, credentials: 'same-origin' });
    const data = resp.ok ? await resp.json() : [];
    const items = (data && (data.results || (Array.isArray(data) ? data : []))) || [];
    renderFichesPaie(items);
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="alert alert-danger">Impossible de charger les fiches de paie.</div>';
  }
}

function renderFichesPaie(items){
  const el = document.getElementById('fiches-list');
  if (!el) return;
  const rows = (items || []).map(it=>{
    const periode = it.periode || `${it.mois}/${it.annee}`;
    const pdf = it.fichier_pdf_url ? `<a class=\"btn btn-sm btn-outline-primary\" href=\"${it.fichier_pdf_url}\" target=\"_blank\">PDF</a>` : `<button class=\"btn btn-sm btn-primary\" onclick=\"genererFiche(${it.id})\">Générer PDF</button>`;
    return `
      <tr>
        <td>${it.agent_nom || ''}<div class="text-muted small">${it.agent_matricule || ''}</div></td>
        <td>${periode}</td>
        <td class="text-end">${fmt(it.total_net)} FCFA</td>
        <td class="text-end">${pdf}</td>
      </tr>
    `;
  }).join('');
  el.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">Fiches de paie</h5>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Période</th>
                <th class="text-end">Net</th>
                <th class="text-end">Fichier</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="4" class="text-center text-muted">Aucune fiche</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

async function genererFiche(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/fiches-paie/${id}/generer-pdf/`, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() }});
    if (!resp.ok) throw new Error('Génération échouée');
    await loadFichesPaieRecents();
  }catch(e){
    console.error(e);
    alert('Impossible de générer le PDF.');
  }
}

async function openFicheFromSalaire(salaireId){
  try{
    // Essayer de trouver une fiche liée à ce salaire
    const resp = await fetch(`/gestion-caisses/api/fiches-paie/?salaire=${salaireId}`, { headers: { 'X-CSRFToken': getCSRFToken() }, credentials: 'same-origin' });
    const data = await resp.json();
    const items = data.results || data || [];
    if (Array.isArray(items) && items.length > 0){
      const f = items[0];
      if (f.fichier_pdf_url){
        window.open(f.fichier_pdf_url, '_blank');
        return;
      }
      await genererFiche(f.id);
      // Recharger et ouvrir si dispo
      const r2 = await fetch(`/gestion-caisses/api/fiches-paie/${f.id}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
      const f2 = await r2.json();
      if (f2.fichier_pdf && f2.fichier_pdf_url){ window.open(f2.fichier_pdf_url, '_blank'); }
      return;
    }
    // Sinon, tenter la génération mensuelle pour ce salaire (mois/année)
    const sResp = await fetch(`/gestion-caisses/api/salaires-agents/${salaireId}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if (!sResp.ok) return;
    const s = await sResp.json();
    // Créer une fiche liée à ce salaire
    const createResp = await fetch('/gestion-caisses/api/fiches-paie/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ salaire: salaireId, type_fiche: 'MOIS' })
    });
    if (createResp.ok){
      const created = await createResp.json();
      await genererFiche(created.id);
      // Recharger et ouvrir
      const r3 = await fetch(`/gestion-caisses/api/fiches-paie/${created.id}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
      const f3 = await r3.json();
      if (f3.fichier_pdf && f3.fichier_pdf_url){ window.open(f3.fichier_pdf_url, '_blank'); }
    } else {
      alert("Fiche introuvable et création non disponible.");
    }
  }catch(e){ console.error(e); }
}

async function genererFichesMensuelles(){
  try{
    const now = new Date();
    const mois = now.getMonth() + 1;
    const annee = now.getFullYear();
    const resp = await fetch('/gestion-caisses/api/fiches-paie/generer-mensuelle/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ mois, annee })
    });
    if (!resp.ok) throw new Error('Génération mensuelle échouée');
    await loadFichesPaieRecents();
  }catch(e){
    console.error(e);
    alert('Impossible de générer les fiches mensuelles.');
  }
}

function toggleSalaireForm(){
  const box = document.getElementById('salaire-form');
  if (!box) return;
  box.style.display = (box.style.display === 'none' || !box.style.display) ? 'block' : 'none';
  if (box.style.display === 'block') hydrateAgentsSelect();
}

function showSalaireAlert(type, message){
  const wrap = document.getElementById('salaires-alerts');
  if (!wrap) return;
  const cls = type === 'success' ? 'alert-success' : (type === 'warning' ? 'alert-warning' : 'alert-danger');
  wrap.innerHTML = `<div class="alert ${cls} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button></div>`;
  setTimeout(()=>{ if (wrap.firstChild) wrap.firstChild.remove(); }, 5000);
}

function openCreateSalaireForm(){
  document.getElementById('salaire-form').dataset.mode = 'create';
  document.getElementById('salaire-form').dataset.id = '';
  document.getElementById('sf-submit').textContent = 'Enregistrer';
  // reset fields
  ['sf-agent','sf-mois','sf-annee','sf-base','sf-bonus','sf-prime','sf-ded','sf-notes'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT') el.value = '';
    else el.value = '';
  });
  toggleSalaireForm();
}

function openEditSalaireForm(item){
  document.getElementById('salaire-form').dataset.mode = 'edit';
  document.getElementById('salaire-form').dataset.id = item.id;
  document.getElementById('sf-submit').textContent = 'Mettre à jour';
  toggleSalaireForm();
  hydrateAgentsSelect().then(()=>{
    document.getElementById('sf-agent').value = item.agent;
  });
  document.getElementById('sf-mois').value = item.mois;
  document.getElementById('sf-annee').value = item.annee;
  document.getElementById('sf-base').value = item.salaire_base;
  document.getElementById('sf-bonus').value = item.bonus_caisses;
  document.getElementById('sf-prime').value = item.prime_performance;
  document.getElementById('sf-ded').value = item.deductions;
  document.getElementById('sf-notes').value = item.notes || '';
}

async function soumettreSalaireAgent(){
  try{
    const agent = document.getElementById('sf-agent').value;
    const mois = document.getElementById('sf-mois').value;
    const annee = document.getElementById('sf-annee').value;
    const base = document.getElementById('sf-base').value;
    const bonus = document.getElementById('sf-bonus').value;
    const prime = document.getElementById('sf-prime').value;
    const ded = document.getElementById('sf-ded').value;
    const notes = document.getElementById('sf-notes').value || '';

    if (!agent){ alert('Veuillez sélectionner un agent.'); return; }
    if (!mois){ alert('Veuillez choisir le mois.'); return; }
    if (!annee){ alert("Veuillez saisir l'année."); return; }
    if (!base){ alert('Veuillez saisir le salaire de base.'); return; }

    const payload = {
      agent: parseInt(document.getElementById('sf-agent').value || '0', 10),
      mois: parseInt(document.getElementById('sf-mois').value || '0', 10),
      annee: parseInt(document.getElementById('sf-annee').value || '0', 10),
      salaire_base: parseFloat(document.getElementById('sf-base').value || '0'),
      bonus_caisses: parseFloat(document.getElementById('sf-bonus').value || '0'),
      prime_performance: parseFloat(document.getElementById('sf-prime').value || '0'),
      deductions: parseFloat(document.getElementById('sf-ded').value || '0'),
      notes: notes
    };
    const formEl = document.getElementById('salaire-form');
    const mode = formEl.dataset.mode || 'create';
    const currentId = formEl.dataset.id;
    const url = mode === 'edit' && currentId ? `/gestion-caisses/api/salaires-agents/${currentId}/` : '/gestion-caisses/api/salaires-agents/';
    const method = mode === 'edit' && currentId ? 'PUT' : 'POST';
    const resp = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      let message = 'Création échouée';
      try{ const err = await resp.json(); message = JSON.stringify(err); }catch(e){ message = await resp.text(); }
      throw new Error(message || 'Création échouée');
    }
    toggleSalaireForm();
    showSalaireAlert('success', mode === 'edit' ? 'Salaire mis à jour avec succès.' : 'Salaire ajouté avec succès.');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    showSalaireAlert('danger', 'Échec: ' + (e.message || 'Erreur inconnue'));
  }
}

async function hydrateAgentsSelect(){
  try{
    const sel = document.getElementById('sf-agent');
    if (!sel) return;
    sel.innerHTML = '<option value="">Chargement...</option>';
    const resp = await fetch('/gestion-caisses/api/agents/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = resp.ok ? await resp.json() : [];
    const list = data.results || data || [];
    sel.innerHTML = '<option value="">Sélectionner un agent...</option>' +
      list.map(a=>`<option value="${a.id}">${a.nom_complet} — ${a.matricule}</option>`).join('');
    checkSalaireDuplicate();
  }catch(e){
    console.error(e);
  }
}

async function checkSalaireDuplicate(){
  try{
    const btn = document.getElementById('sf-submit');
    const alertBox = document.getElementById('sf-duplicate');
    const formEl = document.getElementById('salaire-form');
    const mode = formEl.dataset.mode || 'create';

    const agent = document.getElementById('sf-agent').value;
    const mois = document.getElementById('sf-mois').value;
    const annee = document.getElementById('sf-annee').value;
    if (!agent || !mois || !annee){
      if (alertBox) alertBox.style.display = 'none';
      if (btn) btn.disabled = false;
      return;
    }
    const url = `/gestion-caisses/api/salaires-agents/?agent_id=${encodeURIComponent(agent)}&mois=${encodeURIComponent(mois)}&annee=${encodeURIComponent(annee)}`;
    const resp = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = resp.ok ? await resp.json() : [];
    const list = data.results || data || [];
    const exists = Array.isArray(list) && list.length > 0;
    if (exists && mode !== 'edit'){
      if (alertBox) alertBox.style.display = 'block';
      if (btn) btn.disabled = true;
    } else {
      if (alertBox) alertBox.style.display = 'none';
      if (btn) btn.disabled = false;
    }
  }catch(e){
    console.error(e);
  }
}

function loadAlertes(){
  fetch('/gestion-caisses/api/dashboard/alertes/', { headers: { 'X-CSRFToken': getCSRFToken() }})
    .then(r=>r.json()).then(data=> updateAlertes(data.alertes || []));
}

function updateDashboardStats(data){
  document.getElementById('total-caisses').textContent = data.total_caisses || 0;
  document.getElementById('total-membres').textContent = data.total_membres || 0;
  document.getElementById('total-fonds').textContent = ((data.solde_total_disponible || 0)).toLocaleString('fr-FR') + ' FCFA';
  document.getElementById('total-prets').textContent = data.total_prets_actifs || 0;
}

function updateAlertes(alertes){
  const el = document.getElementById('alertes-list');
  if (!alertes.length){ el.innerHTML = '<div class="alerte-item success">✅ Aucune alerte en cours</div>'; return; }
  el.innerHTML = alertes.map(a=>`
    <div class="alerte-item ${a.niveau}">
      <div class="alerte-icon">${getAlerteIcon(a.niveau)}</div>
      <div class="alerte-content">
        <div class="alerte-message">${a.message}</div>
        <div class="alerte-type">${a.type}</div>
      </div>
    </div>
  `).join('');
}

function getAlerteIcon(n){ return ({ danger:'🚨', warning:'⚠️', info:'ℹ️', success:'✅'})[n] || 'ℹ️' }

function getCSRFToken(){ return window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value }

function renderCharts(stats){
  // Vérifier si les données sont valides
  if (!stats || (!stats.evolution_prets && !stats.caisses_par_region)) {
    console.log('Aucune donnée de graphique disponible');
    return;
  }

  // Données pour l'évolution des prêts
  const evoLabels = (stats.evolution_prets || []).map(e=>e.mois).reverse();
  const evoValues = (stats.evolution_prets || []).map(e=>e.nombre).reverse();
  
  // Données pour les caisses par région
  const regLabels = (stats.caisses_par_region || []).map(r=> r.region__nom || r.region || Object.values(r)[0]);
  const regValues = (stats.caisses_par_region || []).map(r=> r.total);

  // Détruire les graphiques existants
  if (evolutionChart) {
    evolutionChart.destroy();
    evolutionChart = null;
  }
  if (regionsChart) {
    regionsChart.destroy();
    regionsChart = null;
  }

  // Créer le graphique d'évolution des prêts
  const evoCtx = document.getElementById('evolutionChart');
  if (evoCtx && evoLabels.length > 0) {
    const ctx = evoCtx.getContext('2d');
    evolutionChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: evoLabels,
        datasets: [{
          label: 'Prêts',
          data: evoValues,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,.15)',
          tension: 0.3,
          fill: true,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Créer le graphique des caisses par région
  const regCtx = document.getElementById('regionsChart');
  if (regCtx && regLabels.length > 0) {
    const ctx = regCtx.getContext('2d');
    regionsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: regLabels,
        datasets: [{
          label: 'Caisses',
          data: regValues,
          backgroundColor: 'rgba(25,135,84,.65)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });
  }
}

// ===== Contexte utilisateur / Caisse =====
async function fetchUserContext(){
  try{
    const r = await fetch('/gestion-caisses/api/user-context/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await r.json();
    USER_CAISE_ID = data.caisse_id || null;
  }catch(e){ USER_CAISE_ID = null; }
}

async function loadCaisse(){
  const wrap = document.getElementById('caisse-card');
  if (!USER_CAISE_ID){ wrap.innerHTML = '<div class="alert alert-warning mt-2">Aucune caisse liée.</div>'; return; }
  
  try {
    // Charger les informations de base de la caisse
    const res = await fetch('/gestion-caisses/api/caisses/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await res.json();
    const caisse = (data.results && data.results[0]) || data[0] || data;
    if (!caisse || !caisse.id){ wrap.innerHTML = '<div class="alert alert-warning mt-2">Caisse introuvable.</div>'; return; }
    
    // Charger les prêts pour calculer les statistiques
    const pretsRes = await fetch('/gestion-caisses/api/prets/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const pretsData = await pretsRes.json();
    const prets = pretsData.results || pretsData || [];
    
    // Calculer les statistiques des prêts
    const pretsActifs = prets.filter(p => ['EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(p.statut)).length;
    const pretsEnAttente = prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length;
    const pretsValides = prets.filter(p => p.statut === 'VALIDE').length;
    const pretsTermines = prets.filter(p => p.statut === 'REMBOURSE').length;
    const pretsRejetes = prets.filter(p => p.statut === 'REJETE').length;
    
    // Calculer les montants
    const montantTotalPrets = prets.filter(p => ['EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(p.statut))
      .reduce((sum, p) => sum + (parseFloat(p.montant_accord || 0)), 0);
    const montantTotalRembourse = prets.filter(p => p.statut === 'REMBOURSE')
      .reduce((sum, p) => sum + (parseFloat(p.montant_rembourse || 0)), 0);
    
    wrap.innerHTML = `
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="card-title mb-1">🏦 ${caisse.nom_association}</h5>
              <div class="text-muted">Code: ${caisse.code}</div>
              <div class="text-muted small">${caisse.region?.nom || ''} ${caisse.prefecture?.nom ? '> ' + caisse.prefecture.nom : ''} ${caisse.commune?.nom ? '> ' + caisse.commune.nom : ''}</div>
            </div>
            <div class="text-end d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="loadCaisse()" title="Rafraîchir">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="openCaisseModal(${caisse.id}, \"${(caisse.notes||'').replace(/"/g,'&quot;')}\")">
                <i class="fas fa-edit"></i> Modifier notes
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="generateMembresListePDF(${caisse.id})" title="Générer PDF liste des membres">
                <i class="fas fa-file-pdf"></i> Liste membres
              </button>
            </div>
          </div>
          
          <!-- Statistiques principales -->
          <div class="row g-3 mb-4">
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-primary mb-1">${caisse.nombre_membres || 0}</div>
                <div class="text-muted small">Membres actifs</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-success mb-1">${pretsActifs}</div>
                <div class="text-muted small">Prêts actifs</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-warning mb-1">${Number(caisse.fond_disponible||0).toLocaleString('fr-FR')}</div>
                <div class="text-muted small">Fonds disponibles (FCFA)</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-info mb-1">${Number(montantTotalPrets).toLocaleString('fr-FR')}</div>
                <div class="text-muted small">En circulation (FCFA)</div>
              </div>
            </div>
          </div>
          
          <!-- Détails des prêts -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h6 class="text-muted mb-3">📊 État des prêts</h6>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-warning mb-1">${pretsEnAttente}</div>
                <div class="text-muted small">En attente</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-info mb-1">${pretsValides}</div>
                <div class="text-muted small">Validés</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-success mb-1">${pretsTermines}</div>
                <div class="text-muted small">Terminés</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-danger mb-1">${pretsRejetes}</div>
                <div class="text-muted small">Rejetés</div>
              </div>
            </div>
          </div>
          
          <!-- Graphique des prêts par statut -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <div class="card border-light">
                <div class="card-body">
                  <h6 class="text-muted mb-3">📈 Répartition des prêts par statut</h6>
                  <div style="height: 300px; position: relative;">
                    <canvas id="pretStatusChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Informations financières -->
          <div class="row g-3">
            <div class="col-12">
              <h6 class="text-muted mb-3">💰 Informations financières</h6>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Fond initial:</span>
                <span class="fw-bold">${Number(caisse.fond_initial||0).toLocaleString('fr-FR')} FCFA</span>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Total remboursé:</span>
                <span class="fw-bold text-success">${Number(montantTotalRembourse).toLocaleString('fr-FR')} FCFA</span>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Taux de remboursement:</span>
                <span class="fw-bold text-info">${pretsActifs + pretsTermines > 0 ? Math.round((pretsTermines / (pretsActifs + pretsTermines)) * 100) : 0}%</span>
              </div>
            </div>
          </div>
          
          ${caisse.notes ? `
          <div class="mt-4 p-3 bg-light rounded">
            <h6 class="text-muted mb-2">📝 Notes</h6>
            <p class="mb-0">${caisse.notes}</p>
          </div>
          ` : ''}
        </div>
      </div>
      
                <!-- Actions rapides et Mouvements de fonds -->
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card border-primary">
                <div class="card-body text-center">
                  <h6 class="text-primary mb-2">🚀 Actions rapides</h6>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="showSection(event, 'membres')">
                      <i class="fas fa-users"></i> Gérer les membres
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="showSection(event, 'prets')">
                      <i class="fas fa-hand-holding-usd"></i> Gérer les prêts
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h6 class="text-info mb-2">📈 Prochaines étapes</h6>
                  <div class="text-start small">
                    ${pretsEnAttente > 0 ? `<div class="mb-1">• ${pretsEnAttente} prêt(s) en attente de validation</div>` : ''}
                    ${pretsValides > 0 ? `<div class="mb-1">• ${pretsValides} prêt(s) validé(s) à octroyer</div>` : ''}
                    ${pretsActifs > 0 ? `<div class="mb-1">• ${pretsActifs} prêt(s) actif(s) à suivre</div>` : ''}
                    ${!pretsEnAttente && !pretsValides && !pretsActifs ? '<div class="text-muted">• Aucune action requise</div>' : ''}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <h6 class="text-warning mb-2">💰 Derniers mouvements</h6>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning btn-sm" onclick="loadMouvementsFonds()">
                      <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                  </div>
                  <div id="mouvements-fonds-list" class="mt-2 small text-start">
                    <div class="text-muted text-center">Cliquez pour charger</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
    `;
    
    // Créer le graphique des prêts par statut
    setTimeout(() => createPretStatusChart(prets), 100);
    
    // Charger les mouvements de fonds
    setTimeout(() => loadMouvementsFonds(), 200);
    
  } catch (error) {
    console.error('Erreur lors du chargement de la caisse:', error);
    wrap.innerHTML = '<div class="alert alert-danger mt-2">Erreur lors du chargement des données de la caisse.</div>';
  }
}

// Fonction pour créer un graphique des prêts par statut
function createPretStatusChart(prets) {
  const ctx = document.getElementById('pretStatusChart');
  if (!ctx) return;
  
  // Compter les prêts par statut
  const stats = {
    'En attente': prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length,
    'Validés': prets.filter(p => p.statut === 'VALIDE').length,
    'En cours': prets.filter(p => p.statut === 'EN_COURS').length,
    'En retard': prets.filter(p => p.statut === 'EN_RETARD').length,
    'Terminés': prets.filter(p => p.statut === 'REMBOURSE').length,
    'Rejetés': prets.filter(p => p.statut === 'REJETE').length
  };
  
  // Filtrer les statuts avec des valeurs > 0
  const labels = Object.keys(stats).filter(key => stats[key] > 0);
  const data = labels.map(key => stats[key]);
  
  // Couleurs pour chaque statut
  const colors = {
    'En attente': '#ffc107',
    'Validés': '#17a2b8',
    'En cours': '#28a745',
    'En retard': '#dc3545',
    'Terminés': '#6f42c1',
    'Rejetés': '#6c757d'
  };
  
  const backgroundColor = labels.map(key => colors[key]);
  
  // Détruire le graphique existant s'il y en a un (et s'il expose destroy)
  if (window.pretStatusChart && typeof window.pretStatusChart.destroy === 'function') {
    window.pretStatusChart.destroy();
  }
  
  // Créer le nouveau graphique
  window.pretStatusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColor,
        borderWidth: 2,
        borderColor: '#fff',
        hoverBorderWidth: 3,
        hoverBorderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#fff',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return `${context.label}: ${context.parsed} prêt(s) (${percentage}%)`;
            },
            afterLabel: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              return `Total: ${total} prêt(s)`;
            }
          }
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true
      }
    }
  });
  
  // Ajouter des statistiques détaillées sous le graphique
  const chartContainer = ctx.parentElement;
  const statsDiv = document.createElement('div');
  statsDiv.className = 'mt-3';
  statsDiv.innerHTML = `
    <div class="row g-2 text-center">
      ${Object.entries(stats).map(([key, value]) => `
        <div class="col-4 col-md-2">
          <div class="p-2 border rounded bg-light">
            <div class="h6 mb-1" style="color: ${colors[key] || '#6c757d'}">${value}</div>
            <div class="small text-muted">${key}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  // Supprimer l'ancien div de statistiques s'il existe
  const oldStatsDiv = chartContainer.querySelector('.mt-3');
  if (oldStatsDiv) {
    oldStatsDiv.remove();
  }
  
  chartContainer.appendChild(statsDiv);
}

// Graphique des prêts par statut dans l'onglet "Prêts"
function createPretStatusChartInPrets(prets) {
  const canvas = document.getElementById('pretStatusChartPrets');
  // Ne rien faire si le canvas n'existe plus (nous gardons le graphique uniquement côté Caisse)
  if (!canvas) return;
  // Réutilise la logique de comptage et couleurs
  const stats = {
    'En attente': prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length,
    'Validés': prets.filter(p => p.statut === 'VALIDE').length,
    'En cours': prets.filter(p => p.statut === 'EN_COURS').length,
    'En retard': prets.filter(p => p.statut === 'EN_RETARD').length,
    'Terminés': prets.filter(p => p.statut === 'REMBOURSE').length,
    'Rejetés': prets.filter(p => p.statut === 'REJETE').length
  };
  const labels = Object.keys(stats).filter(k => stats[k] > 0);
  const data = labels.map(k => stats[k]);
  const colors = {
    'En attente': '#ffc107',
    'Validés': '#17a2b8',
    'En cours': '#28a745',
    'En retard': '#dc3545',
    'Terminés': '#6f42c1',
    'Rejetés': '#6c757d'
  };
  const backgroundColor = labels.map(k => colors[k]);

  if (window.pretStatusChartPrets && typeof window.pretStatusChartPrets.destroy === 'function') {
    window.pretStatusChartPrets.destroy();
  }
  window.pretStatusChartPrets = new Chart(canvas, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor, borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
        tooltip: { callbacks: { label: (ctx) => {
          const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
          const pc = total ? ((ctx.parsed/total)*100).toFixed(1) : 0;
          return `${ctx.label}: ${ctx.parsed} (${pc}%)`;
        }}}
      }
    }
  });
}

// Fonction pour charger et afficher les derniers mouvements de fonds
async function loadMouvementsFonds() {
  try {
    const response = await fetch('/gestion-caisses/api/mouvements-fonds/', { 
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const data = await response.json();
    const mouvements = (data.results || data).slice(0, 10); // Limiter à 10 derniers
    
    const container = document.getElementById('mouvements-fonds-list');
    if (!container) return;
    
    if (!mouvements.length) {
      container.innerHTML = '<div class="text-muted text-center">Aucun mouvement de fonds récent</div>';
      return;
    }
    
    container.innerHTML = mouvements.map(m => `
      <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
        <div>
          <div class="fw-bold">${m.type_mouvement}</div>
          <div class="small text-muted">${m.description || 'Aucune description'}</div>
          <div class="small text-muted">${new Date(m.date_mouvement).toLocaleDateString('fr-FR')}</div>
        </div>
        <div class="text-end">
          <div class="fw-bold ${m.type_mouvement === 'ALIMENTATION' || m.type_mouvement === 'REMBOURSEMENT' ? 'text-success' : 'text-danger'}">
            ${m.type_mouvement === 'ALIMENTATION' || m.type_mouvement === 'REMBOURSEMENT' ? '+' : '-'}${Number(m.montant).toLocaleString('fr-FR')} FCFA
          </div>
          <div class="small text-muted">Solde: ${Number(m.solde_apres).toLocaleString('fr-FR')} FCFA</div>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Erreur lors du chargement des mouvements de fonds:', error);
    const container = document.getElementById('mouvements-fonds-list');
    if (container) {
      container.innerHTML = '<div class="text-danger text-center">Erreur lors du chargement des mouvements</div>';
    }
  }
}

function openCaisseModal(id, notes){
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('caisseModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const html = `
  <div class="modal fade" tabindex="-1" id="caisseModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">📝 Modifier les notes de la caisse</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Notes et commentaires</label>
            <textarea class="form-control" id="caisseNotes" rows="5" placeholder="Ajoutez des notes, commentaires ou informations importantes sur cette caisse...">${notes||''}</textarea>
            <div class="form-text">Ces notes seront visibles par tous les membres de la caisse.</div>
          </div>
          <div id="caisseError" class="alert alert-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" onclick="submitCaisse(${id})">
            <i class="fas fa-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  
  const modal = new bootstrap.Modal(document.getElementById('caisseModal'));
  modal.show();
}
function closeCaisseModal(){ 
  const el = document.getElementById('caisseModal'); 
  if (!el) return; 
  const modal = bootstrap.Modal.getInstance(el);
  if (modal) {
    modal.hide();
    setTimeout(() => el.remove(), 300); // Attendre la fin de l'animation
  } else {
    el.remove();
  }
}
async function submitCaisse(id){
  try{
    const submitBtn = document.querySelector('#caisseModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    
    // Désactiver le bouton et afficher un indicateur de chargement
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    
    const notes = document.getElementById('caisseNotes').value;
    const r = await fetch(`/gestion-caisses/api/caisses/${id}/`, { 
      method:'PATCH', 
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':getCSRFToken() 
      }, 
      body: JSON.stringify({ notes }) 
    });
    
    if (!r.ok) {
      const errorData = await r.json().catch(() => ({}));
      throw new Error(errorData.detail || 'Échec de mise à jour des notes');
    }
    
    // Succès
    closeCaisseModal();
    
    // Afficher un message de succès temporaire
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Notes mises à jour avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte après 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
    // Recharger les données de la caisse
    loadCaisse();
    
  } catch(e) { 
    const err = document.getElementById('caisseError'); 
    if (err) { 
      err.textContent = e.message; 
      err.style.display = 'block'; 
    }
    
    // Réactiver le bouton
    const submitBtn = document.querySelector('#caisseModal .btn-primary');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
}

// ===== Membres (CRUD minimal) =====
function openMembreModal(id){
  document.getElementById('membreError')?.style && (document.getElementById('membreError').style.display='none');
  const form = document.getElementById('membreForm');
  
  // Ne faire reset que si c'est un nouveau membre (pas d'ID)
  if (!id) {
    form.reset();
    form.id.value = '';
    
    // Initialiser les valeurs par défaut pour nouveau membre
    const sexeSelect = form.querySelector('select[name="sexe"]');
    if (sexeSelect) sexeSelect.value = 'F';
    
    const statutSelect = form.querySelector('select[name="statut"]');
    if (statutSelect) statutSelect.value = 'ACTIF';
    
    const roleSelect = form.querySelector('select[name="role"]');
    if (roleSelect) roleSelect.value = 'MEMBRE';
    
    // Initialiser les checkboxes de carte d'électeur
    const possedeCarte = document.getElementById('possede_carte_electeur');
    const carteValide = document.getElementById('carte_electeur_valide');
    if (possedeCarte) possedeCarte.checked = true;
    if (carteValide) { carteValide.checked = false; carteValide.disabled = false; }
    
    // Initialiser l'indicatif téléphone
    const indicatif = form.querySelector('select[name="indicatif_telephone"]');
    if (indicatif) indicatif.value = '+228';
    
    // Masquer les aperçus d'images
    const photoPreviewWrapper = document.getElementById('photoPreviewWrapper');
    const signaturePreviewWrapper = document.getElementById('signaturePreviewWrapper');
    if (photoPreviewWrapper) photoPreviewWrapper.style.display = 'none';
    if (signaturePreviewWrapper) signaturePreviewWrapper.style.display = 'none';
  } else {
    // Pour modification, on garde l'ID mais on ne fait pas de reset
    form.id.value = id;
  }
  
  document.getElementById('membreModalTitle').textContent = id ? 'Modifier membre' : 'Nouveau membre';
  new bootstrap.Modal(document.getElementById('membreModal')).show();
}
function closeMembreModal(){ const m = document.getElementById('membreModal'); bootstrap.Modal.getInstance(m)?.hide(); }

async function submitMembre(){
  try{
    if (!USER_CAISE_ID) throw new Error('Aucune caisse liée');
    const form = document.getElementById('membreForm');
    const id = form.id.value;
    
    if (id) {
      // Modification : utiliser JSON pour les données textuelles
      const formData = new FormData(form);
      const photoFile = formData.get('photo');
      
      // Créer un objet avec les données textuelles
      const payload = {
        numero_carte_electeur: formData.get('numero_carte_electeur'),
        numero_telephone: formData.get('numero_telephone'),
        nom: formData.get('nom'),
        prenoms: formData.get('prenoms'),
        date_naissance: formData.get('date_naissance'),
        adresse: formData.get('adresse'),
        sexe: formData.get('sexe'),
        role: formData.get('role'),
        statut: formData.get('statut'),
        caisse_id: USER_CAISE_ID
      };
      
      const r = await fetch(`/gestion-caisses/api/membres/${id}/`, { 
        method: 'PATCH', 
        headers:{ 
          'Content-Type': 'application/json',
          'X-CSRFToken':getCSRFToken() 
        }, 
        body: JSON.stringify(payload)
      });
      
      if (!r.ok) {
        const errorData = await r.json();
        throw new Error(errorData.detail || 'Échec modification membre');
      }
    } else {
      // Création : utiliser FormData pour inclure la photo
      const formData = new FormData(form);
      formData.append('caisse_id', USER_CAISE_ID);
      
      const r = await fetch('/gestion-caisses/api/membres/', { 
        method: 'POST', 
        headers:{ 'X-CSRFToken':getCSRFToken() }, 
        body: formData 
      });
      
      if (!r.ok) {
        const errorData = await r.json();
        throw new Error(errorData.detail || 'Échec création membre');
      }
    }
    
    closeMembreModal();
    loadMembers();
  }catch(e){ 
    const el = document.getElementById('membreError'); 
    if (el){ 
      el.textContent = e.message; 
      el.style.display='block'; 
    } 
  }
}

let CURRENT_MEMBRES = [];
async function loadMembers(){
  const container = document.getElementById('membres-content');
  container.innerHTML = '<div class="text-muted">Chargement...</div>';
  const r = await fetch('/gestion-caisses/api/membres/?ordering=nom', { headers:{ 'X-CSRFToken': getCSRFToken() }});
  const data = await r.json();
  CURRENT_MEMBRES = data.results || data || [];
  if (!CURRENT_MEMBRES.length){ container.innerHTML = '<div class="alert alert-light">Aucun membre.</div>'; return; }
  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  CURRENT_MEMBRES.forEach(m=>{
    const card = document.createElement('div');
    card.className = 'col-12 col-md-6 col-lg-4';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between'>
            <h5 class='card-title mb-1'>${m.nom_complet}</h5>
            <span class='badge ${m.statut==='ACTIF'?'bg-success':'bg-secondary'}'>${m.statut}</span>
          </div>
          <div class='text-muted mb-2'>Rôle: ${m.role}</div>
          <div class='small text-muted'>Téléphone: ${m.numero_telephone||'-'}</div>
          <div class='mt-3 d-flex gap-2'>
            <button class='btn btn-sm btn-outline-primary' onclick='prefillMembre(${m.id})'>Modifier</button>
            <button class='btn btn-sm btn-outline-success' onclick='generateMembrePDF(${m.id})' title='Générer fiche PDF'>
              <i class="fas fa-file-pdf"></i>
            </button>
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

function filterMembers(){
  const q = (document.getElementById('membreSearch').value||'').toLowerCase();
  const list = CURRENT_MEMBRES.filter(m => (m.nom_complet||'').toLowerCase().includes(q) || (m.numero_telephone||'').toLowerCase().includes(q));
  const container = document.getElementById('membres-content');
  if (!list.length){ container.innerHTML = '<div class="alert alert-light mt-3">Aucun membre ne correspond.</div>'; return; }
  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  list.forEach(m=>{
    const card = document.createElement('div');
    card.className = 'col-12 col-md-6 col-lg-4';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between'>
            <h5 class='card-title mb-1'>${m.nom_complet}</h5>
            <span class='badge ${m.statut==='ACTIF'?'bg-success':'bg-secondary'}'>${m.statut}</span>
          </div>
          <div class='text-muted mb-2'>Rôle: ${m.role}</div>
          <div class='small text-muted'>Téléphone: ${m.numero_telephone||'-'}</div>
          <div class='mt-3 d-flex gap-2'>
            <button class='btn btn-sm btn-outline-primary' onclick='prefillMembre(${m.id})'>Modifier</button>
            <button class='btn btn-sm btn-outline-success' onclick='generateMembrePDF(${m.id})' title='Générer fiche PDF'>
              <i class="fas fa-file-pdf"></i>
            </button>
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

async function prefillMembre(id){
  const r = await fetch(`/gestion-caisses/api/membres/${id}/`, { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const m = await r.json();
  
  // D'abord ouvrir le modal
  openMembreModal(id);
  
  // Ensuite remplir les données
  const form = document.getElementById('membreForm');
  form.id.value = id;
  
  // Informations d'identification
  const possedeCarte = document.getElementById('possede_carte_electeur');
  const carteValide = document.getElementById('carte_electeur_valide');
  if (possedeCarte) possedeCarte.checked = m.possede_carte_electeur || false;
  if (carteValide) carteValide.checked = m.carte_electeur_valide || false;
  
  form.numero_carte_electeur.value = m.numero_carte_electeur || '';
  
  // Informations personnelles
  form.nom.value = m.nom || '';
  form.prenoms.value = m.prenoms || '';
  form.date_naissance.value = m.date_naissance || '';
  form.adresse.value = m.adresse || '';
  
  // Gérer le champ sexe
  const sexeSelect = form.querySelector('select[name="sexe"]');
  if (sexeSelect) sexeSelect.value = m.sexe || 'F';
  
  // Contact
  const indicatifSelect = form.querySelector('select[name="indicatif_telephone"]');
  if (indicatifSelect) indicatifSelect.value = m.indicatif_telephone || '+228';
  
  form.numero_telephone.value = m.numero_telephone || '';
  form.numero_whatsapp.value = m.numero_whatsapp || '';
  
  // Localisation
  form.quartier.value = m.quartier || '';
  
  // Rôle et statut
  form.role.value = m.role || 'MEMBRE';
  form.statut.value = m.statut || 'ACTIF';
  
  // Notes
  form.notes.value = m.notes || '';
  
  // Gérer l'affichage de la photo existante
  if (m.photo){
    const preview = document.getElementById('photoPreview');
    const previewWrapper = document.getElementById('photoPreviewWrapper');
    if (preview && previewWrapper){
      preview.src = m.photo;
      previewWrapper.style.display = 'block';
    }
  } else {
    const previewWrapper = document.getElementById('photoPreviewWrapper');
    if (previewWrapper) previewWrapper.style.display = 'none';
  }
  
  // Gérer l'affichage de la signature existante
  if (m.signature){
    const preview = document.getElementById('signaturePreview');
    const previewWrapper = document.getElementById('signaturePreviewWrapper');
    if (preview && previewWrapper){
      preview.src = m.signature;
      previewWrapper.style.display = 'block';
    }
  } else {
    const previewWrapper = document.getElementById('signaturePreviewWrapper');
    if (previewWrapper) previewWrapper.style.display = 'none';
  }
}

// ===== Prêts (CRUD minimal) =====
function openPretModal(id){
  document.getElementById('pretError')?.style && (document.getElementById('pretError').style.display='none');
  const form = document.getElementById('pretForm');
  form.reset();
  form.id.value = id || '';
  document.getElementById('pretModalTitle').textContent = id ? 'Modifier prêt' : 'Nouveau prêt';
  
  // Réinitialiser l'avertissement et le bouton
  const warningDiv = document.getElementById('memberLoanWarning');
  const submitBtn = document.querySelector('#pretModal .btn-primary');
  if (warningDiv) warningDiv.style.display = 'none';
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Enregistrer';
  }
  
  loadPretMembres().then(async ()=>{ 
    const modalEl = document.getElementById('pretModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    if (id) {
      await prefillPret(id);
    } else {
      setTimeout(() => updateInterestPreview(), 0);
    }
  });
}
function closePretModal(){ const m = document.getElementById('pretModal'); bootstrap.Modal.getInstance(m)?.hide(); }

async function loadPretMembres(){
  const sel = document.getElementById('pretMembre');
  sel.innerHTML = '';
  const r = await fetch('/gestion-caisses/api/membres/', { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const data = await r.json();
  (data.results||data).forEach(m=>{ const opt = document.createElement('option'); opt.value = m.id; opt.textContent = m.nom_complet; sel.appendChild(opt); });
}

async function submitPret(){
  try{
    if (!USER_CAISE_ID) throw new Error('Aucune caisse liée');
    const form = document.getElementById('pretForm');
    const payload = Object.fromEntries(new FormData(form).entries());
    const id = payload.id; delete payload.id;
    payload.caisse_id = USER_CAISE_ID;
    
    // Gérer la logique du motif "autres"
    if (payload.motif === 'autres') {
      if (!payload.motif_autre || payload.motif_autre.trim() === '') {
        throw new Error('Veuillez préciser le motif spécifique');
      }
      payload.motif = payload.motif_autre;
    }
    delete payload.motif_autre; // Supprimer le champ temporaire
    
    const method = id ? 'PATCH' : 'POST';
    const url = id ? `/gestion-caisses/api/prets/${id}/` : '/gestion-caisses/api/prets/';
    const r = await fetch(url, { method, headers:{ 'Content-Type':'application/json','X-CSRFToken':getCSRFToken() }, body: JSON.stringify(payload) });
    if (!r.ok) throw new Error('Échec enregistrement prêt');
    closePretModal();
    loadPrets();
  }catch(e){ const el = document.getElementById('pretError'); if (el){ el.textContent = e.message; el.style.display='block'; } }
}

async function loadPrets(){
  const container = document.getElementById('prets-content');
  container.innerHTML = '<div class="text-muted">Chargement...</div>';
  const r = await fetch('/gestion-caisses/api/prets/', { headers:{ 'X-CSRFToken': getCSRFToken() }});
  const data = await r.json();
  const prets = data.results || data;
  // (supprimé) mise à jour graph dans l'onglet Prêts
  if (!prets || !prets.length){ container.innerHTML = '<div class="alert alert-light">Aucun prêt.</div>'; return; }
  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  prets.forEach(p=>{
    const totalARemb = Number(p.total_a_rembourser||0);
    const montantRestant = Number(p.montant_restant||0);
    let ratio = 0;
    if (totalARemb > 0) {
      ratio = (totalARemb - Math.max(0, montantRestant)) / totalARemb;
    } else if (p.nombre_echeances) {
      ratio = Number(p.nombre_echeances_payees||0) / Number(p.nombre_echeances||1);
    }
    if (!isFinite(ratio) || ratio < 0) ratio = 0; if (ratio > 1) ratio = 1;
    const pct = Math.round(ratio * 100);
    const barClass = pct >= 100 ? 'bg-success' : (pct >= 50 ? 'bg-info' : 'bg-warning');
    const statutLabel = (p.statut==='REMBOURSE') ? 'REMBOURSÉ' : p.statut;
    const statusClass = p.statut==='EN_COURS'?'bg-success':(p.statut==='EN_RETARD'?'bg-danger':'bg-secondary');
    const card = document.createElement('div'); card.className='col-12 col-lg-6';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between align-items-center'>
            <span class='badge ${statusClass}'>${statutLabel}</span>
            <div class='text-end'>
              <div class='text-muted'>${p.numero_pret||''}</div>
              {% if user_role == 'Administrateur' %}
              <div class='small text-secondary'>${p.caisse_code || p.caisse?.code || ''} — ${p.caisse_nom || p.caisse?.nom_association || ''}</div>
              {% endif %}
            </div>
          </div>
          <h5 class='mt-2 mb-1'>${p.membre_nom || p.membre?.nom_complet || ''}</h5>
          <div class='small text-muted'>Montant demandé: ${Number(p.montant_demande||0).toLocaleString('fr-FR')} FCFA</div>
          ${p.taux_interet && p.taux_interet > 0 ? `
          <div class='small text-info'>
            <i class="fas fa-percentage"></i> Taux: ${p.taux_interet}% | 
            Intérêt: ${Number((p.montant_accord||p.montant_demande||0) * (p.taux_interet||0) / 100).toLocaleString('fr-FR')} FCFA
          </div>
          <div class='small text-success fw-bold'>
            Total à rembourser: ${Number(p.total_a_rembourser||0).toLocaleString('fr-FR')} FCFA
          </div>
          ` : `
          <div class='small text-muted'>Total à rembourser: ${Number(p.montant_accord||p.montant_demande||0).toLocaleString('fr-FR')} FCFA</div>
          `}
          <div class='small text-muted'>Reste: ${Number(p.montant_restant||0).toLocaleString('fr-FR')} FCFA</div>
          <div class='mt-2'>
            <div class='d-flex justify-content-between small'>
              <span>Parcours de remboursement</span><span>${pct}%</span>
            </div>
            <div class='progress' style='height:6px;'>
              <div class='progress-bar ${barClass}' role='progressbar' style='width:${pct}%' aria-valuenow='${pct}' aria-valuemin='0' aria-valuemax='100'></div>
            </div>
            ${p.nombre_echeances ? `<div class='small text-muted mt-1'>Échéances: ${p.nombre_echeances_payees||0}/${p.nombre_echeances}</div>` : ''}
          </div>
          <div class='mt-3 d-flex gap-2 flex-wrap'>
            ${['EN_ATTENTE','EN_ATTENTE_ADMIN'].includes(p.statut) ? `<button class='btn btn-sm btn-outline-primary' onclick='openPretModal(${p.id})'><i class="fas fa-edit"></i> Modifier</button>` : ''}
            
            ${p.statut==='VALIDE' ? `<button class='btn btn-sm btn-success' onclick='octroyerPret(${p.id})'><i class="fas fa-hand-holding-usd"></i> Octroyer</button>` : ''}
            ${(p.statut==='EN_COURS'||p.statut==='EN_RETARD') ? `<button class='btn btn-sm btn-warning' onclick='openRemboursementModal(${p.id})'><i class="fas fa-money-bill-wave"></i> Rembourser</button>` : ''}
            ${p.statut==='EN_COURS' ? `<button class='btn btn-sm btn-outline-info' onclick='generateAttestationPretPDF(${p.id})'><i class="fas fa-file-pdf"></i> Attestation Prêt</button>` : ''}
            ${p.statut==='REMBOURSE' ? `<button class='btn btn-sm btn-info' onclick='generateRemboursementCompletPDF(${p.id})'><i class="fas fa-file-pdf"></i> PDF Complet</button>` : ''}
            ${p.statut==='REMBOURSE' ? `<button class='btn btn-sm btn-outline-success' onclick='generateAttestationRemboursementPDF(${p.id})'><i class="fas fa-file-pdf"></i> Attestation Remboursement</button>` : ''}
            ${p.statut==='BLOQUE' ? `<button class='btn btn-sm btn-warning' onclick='showFondsInsuffisantsAlert(${JSON.stringify(p).replace(/"/g, '&quot;')})'><i class="fas fa-exclamation-triangle"></i> Voir Détails</button>` : ''}
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

// Fonction pour vérifier le statut des prêts du membre sélectionné
async function checkMemberLoanStatus() {
  const membreId = document.getElementById('pretMembre').value;
  const warningDiv = document.getElementById('memberLoanWarning');
  const contribWarningDiv = document.getElementById('memberContributionWarning');
  const contribInfo = document.getElementById('memberContributionInfo');
  const submitBtn = document.querySelector('#pretModal .btn-primary');
  
  if (!membreId) {
    warningDiv.style.display = 'none';
    if (contribWarningDiv) contribWarningDiv.style.display = 'none';
    if (contribInfo) contribInfo.style.display = 'none';
    submitBtn.disabled = false;
    return;
  }
  
  try {
    const response = await fetch(`/gestion-caisses/api/prets/?membre=${membreId}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const data = await response.json();
    const prets = data.results || data;
    
    // Vérifier s'il y a des prêts actifs (tous les statuts sauf REMBOURSE et REJETE)
    const hasActiveLoan = prets.some(pret => 
      ['EN_ATTENTE', 'EN_ATTENTE_ADMIN', 'VALIDE', 'EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(pret.statut)
    );
    
    if (hasActiveLoan) {
      warningDiv.style.display = 'block';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Prêt impossible - Membre a déjà un prêt actif';
      
      // Afficher un message plus détaillé
      const activePret = prets.find(pret => 
        ['EN_ATTENTE', 'EN_ATTENTE_ADMIN', 'VALIDE', 'EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(pret.statut)
      );
      
      if (activePret) {
        const statutLabel = activePret.statut === 'EN_COURS' ? 'En cours' : 
                           activePret.statut === 'EN_ATTENTE' ? 'En attente' :
                           activePret.statut === 'EN_ATTENTE_ADMIN' ? 'En attente validation admin' :
                           activePret.statut === 'VALIDE' ? 'Validé' :
                           activePret.statut === 'EN_RETARD' ? 'En retard' :
                           activePret.statut === 'BLOQUE' ? 'Bloqué' : activePret.statut;
        
        warningDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i> 
          Ce membre a déjà un prêt ${statutLabel.toLowerCase()} (${activePret.numero_pret}). 
          Il doit d'abord terminer ce prêt avant de pouvoir faire un nouveau prêt.
        `;
      }
    } else {
      warningDiv.style.display = 'none';

      // Vérifier le total des cotisations du membre (endpoint dédié)
      let totalCotisations = 0;
      try {
        const res = await fetch(`/gestion-caisses/api/membres/${membreId}/cotisations-total/`, { headers: { 'X-CSRFToken': getCSRFToken() } });
        if (res.ok) {
          const js = await res.json();
          totalCotisations = parseFloat(js.total_cotisations) || 0;
        }
      } catch (e) {
        // En cas d'erreur, ne pas bloquer côté frontend; le backend validera
      }

      if (totalCotisations < 3000) {
        if (contribWarningDiv) {
          contribWarningDiv.style.display = 'block';
          contribWarningDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Cotisations cumulées: ${totalCotisations.toLocaleString('fr-FR')} FCFA. Minimum requis: 3000 FCFA.`;
        }
        if (contribInfo) {
          contribInfo.style.display = 'block';
          contribInfo.textContent = `Cotisations cumulées: ${totalCotisations.toLocaleString('fr-FR')} FCFA`;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Prêt indisponible - Cotisations < 3000 FCFA';
      } else {
        if (contribWarningDiv) contribWarningDiv.style.display = 'none';
        if (contribInfo) {
          contribInfo.style.display = 'block';
          contribInfo.textContent = `Cotisations cumulées: ${totalCotisations.toLocaleString('fr-FR')} FCFA`;
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enregistrer';
      }
    }
  } catch (error) {
    console.error('Erreur lors de la vérification du statut des prêts:', error);
  }
}

// Fonction pour mettre à jour l'aperçu du calcul d'intérêt
function updateInterestPreview() {
  const montantDemande = parseFloat(document.getElementById('pretForm').montant_demande.value || 0);
  const tauxInteret = parseFloat(document.getElementById('pretForm').taux_interet.value || 0);
  
  if (montantDemande > 0 && tauxInteret > 0) {
    const interet = montantDemande * tauxInteret / 100;
    const total = montantDemande + interet;
    
    document.getElementById('previewMontantDemande').textContent = montantDemande.toLocaleString('fr-FR');
    document.getElementById('previewInteret').textContent = interet.toLocaleString('fr-FR');
    document.getElementById('previewTotal').textContent = total.toLocaleString('fr-FR');
    
    // Mettre à jour le taux affiché dans l'aperçu
    document.querySelector('#interestPreview .col-md-4:nth-child(2) strong').innerHTML = `Intérêt (${tauxInteret}%):`;
    
    document.getElementById('interestPreview').style.display = 'block';
  } else {
    document.getElementById('interestPreview').style.display = 'none';
  }
}

// Fonction pour gérer l'affichage du champ "Autres" pour le motif
function toggleMotifAutre() {
  const motifSelect = document.getElementById('motifSelect');
  const motifAutreDiv = document.getElementById('motifAutreDiv');
  const motifAutre = document.getElementById('motifAutre');
  
  if (motifSelect.value === 'autres') {
    motifAutreDiv.style.display = 'block';
    motifAutre.required = true;
  } else {
    motifAutreDiv.style.display = 'none';
    motifAutre.required = false;
    motifAutre.value = '';
  }
}

async function prefillPret(id){
  const r = await fetch(`/gestion-caisses/api/prets/${id}/`, { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const p = await r.json();
  const form = document.getElementById('pretForm');
  form.id.value = id;
  document.getElementById('pretMembre').value = p.membre?.id || '';
  form.montant_demande.value = p.montant_demande || p.montant_accord || 0;
  form.duree_mois.value = p.duree_mois || 0;
  form.taux_interet.value = p.taux_interet || 0;
  
  // Gérer le motif - vérifier si c'est une valeur prédéfinie ou "autres"
  const motifSelect = document.getElementById('motifSelect');
  const motifAutre = document.getElementById('motifAutre');
  const motifAutreDiv = document.getElementById('motifAutreDiv');
  
  if (p.motif) {
    // Vérifier si le motif correspond à une option prédéfinie
    const options = Array.from(motifSelect.options).map(opt => opt.value);
    if (options.includes(p.motif)) {
      motifSelect.value = p.motif;
      if (p.motif === 'autres') {
        motifAutreDiv.style.display = 'block';
        motifAutre.required = true;
      } else {
        motifAutreDiv.style.display = 'none';
        motifAutre.required = false;
      }
    } else {
      // Si le motif n'est pas dans les options prédéfinies, le mettre dans "autres"
      motifSelect.value = 'autres';
      motifAutre.value = p.motif;
      motifAutreDiv.style.display = 'block';
      motifAutre.required = true;
    }
  }
  
  // Gérer les détails du prêt
  form.details_pret.value = p.details_pret || '';
  
  // Mettre à jour l'aperçu du calcul d'intérêt
  setTimeout(() => updateInterestPreview(), 0);
}

async function octroyerPret(id){
  // Afficher un modal moderne de confirmation
  showOctroiConfirmationModal(id);
}

function showOctroiConfirmationModal(pretId) {
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('octroiConfirmationModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalHtml = `
    <div class="modal fade" id="octroiConfirmationModal" tabindex="-1" aria-labelledby="octroiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-success text-white border-0">
            <h5 class="modal-title" id="octroiModalLabel">
              <i class="fas fa-hand-holding-usd me-2"></i>
              Confirmation d'Octroi de Prêt
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-info border-0 bg-light">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong>Action importante :</strong> Vous êtes sur le point d'octroyer ce prêt au membre.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="d-flex align-items-center justify-content-center mb-3">
                  <div class="spinner-border text-primary me-3" role="status" id="octroiSpinner" style="display: none;">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <div id="octroiContent">
                    <p class="mb-3">
                      <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                      Cette action va :
                    </p>
                    <ul class="list-unstyled ms-4">
                      <li><i class="fas fa-check-circle text-success me-2"></i>Débiter le montant du prêt de la caisse</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>Changer le statut du prêt à "En cours"</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>Générer un PDF d'attestation d'octroi</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>Envoyer une notification à la présidente</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="octroiError" class="alert alert-danger mt-3" style="display: none;">
              <i class="fas fa-exclamation-circle me-2"></i>
              <span id="octroiErrorMessage"></span>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Annuler
            </button>
            <button type="button" class="btn btn-success" onclick="confirmOctroi(${pretId})" id="confirmOctroiBtn">
              <i class="fas fa-hand-holding-usd me-2"></i>Confirmer l'Octroi
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('octroiConfirmationModal'));
  modal.show();
}

async function confirmOctroi(pretId) {
  const spinner = document.getElementById('octroiSpinner');
  const content = document.getElementById('octroiContent');
  const confirmBtn = document.getElementById('confirmOctroiBtn');
  const errorDiv = document.getElementById('octroiError');
  const errorMessage = document.getElementById('octroiErrorMessage');
  
  // Afficher le spinner et désactiver le bouton
  spinner.style.display = 'block';
  content.style.display = 'none';
  confirmBtn.disabled = true;
  confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement en cours...';
  errorDiv.style.display = 'none';
  
  try {
    // Appeler l'API pour octroyer le prêt
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/octroyer/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Erreur lors de l\'octroi du prêt');
    }
    
    const data = await response.json();
    
    // Afficher le succès
    showOctroiSuccessModal(pretId, data);
    
  } catch (error) {
    console.error('Erreur lors de l\'octroi:', error);
    
    // Afficher l'erreur
    errorMessage.textContent = error.message;
    errorDiv.style.display = 'block';
    
    // Restaurer l'interface
    spinner.style.display = 'none';
    content.style.display = 'block';
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = '<i class="fas fa-hand-holding-usd me-2"></i>Confirmer l\'Octroi';
  }
}

function showOctroiSuccessModal(pretId, pretData) {
  // Fermer le modal de confirmation
  const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('octroiConfirmationModal'));
  confirmationModal.hide();
  
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('octroiSuccessModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalHtml = `
    <div class="modal fade" id="octroiSuccessModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-success text-white border-0">
            <h5 class="modal-title" id="successModalLabel">
              <i class="fas fa-check-circle me-2"></i>
              Prêt Octroyé avec Succès !
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-success border-0 bg-light-success">
                <i class="fas fa-hand-holding-usd text-success me-2"></i>
                <strong>Félicitations !</strong> Le prêt a été octroyé avec succès.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title text-primary">
                      <i class="fas fa-file-alt me-2"></i>Détails de l'Octroi
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Numéro de prêt :</strong></p>
                        <p class="text-muted">${pretData.numero_pret || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Membre :</strong></p>
                        <p class="text-muted">${pretData.membre?.nom_complet || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Montant accordé :</strong></p>
                        <p class="text-success fw-bold">${Number(pretData.montant_accord || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Date d'octroi :</strong></p>
                        <p class="text-muted">${new Date().toLocaleDateString('fr-FR')}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info mt-3 border-0">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Prochaines étapes :</strong>
              <ul class="mb-0 mt-2">
                <li>Téléchargez l'attestation d'octroi en PDF</li>
                <li>Remettez le montant au membre</li>
                <li>Suivez les remboursements dans le tableau</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Fermer
            </button>
            <button type="button" class="btn btn-primary" onclick="downloadOctroiPDF(${pretId})">
              <i class="fas fa-file-pdf me-2"></i>Télécharger l'Attestation
            </button>
            <button type="button" class="btn btn-success" onclick="closeOctroiSuccessAndRefresh()">
              <i class="fas fa-check me-2"></i>Terminé
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('octroiSuccessModal'));
  modal.show();
}

async function downloadOctroiPDF(pretId) {
  try {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Génération...';
    
    // Appeler l'API pour générer le PDF
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/octroi_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `attestation-octroi-pret-${pretId}.pdf`;
    document.body.appendChild(a);
    a.click();
    // Rafraîchir l'application après le clic
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    showToast('PDF généré avec succès !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    showToast('Erreur lors de la génération du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = '<i class="fas fa-file-pdf me-2"></i>Télécharger l\'Attestation';
  }
}

function closeOctroiSuccessAndRefresh() {
  // Fermer le modal de succès
  const successModal = bootstrap.Modal.getInstance(document.getElementById('octroiSuccessModal'));
  successModal.hide();
  
  // Recharger la liste des prêts
  loadPrets();
  
  // Afficher un toast de confirmation
  showToast('Prêt octroyé avec succès !', 'success');
}

function showToast(message, type = 'info') {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0 position-fixed" 
         style="top: 20px; right: 20px; z-index: 9999;" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.querySelector('.toast');
  const toast = new bootstrap.Toast(toastElement);
  toast.show();
  
  // Supprimer le toast après qu'il soit caché
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

async function openRemboursementModal(id){
  // Récupérer les infos du prêt pour afficher le reste total (principal + intérêts)
  let pret;
  try{
    const r = await fetch(`/gestion-caisses/api/prets/${id}/`);
    pret = await r.json();
  }catch(e){ pret = null; }

  if (!pret) {
    showToast('Erreur lors de la récupération des informations du prêt', 'error');
    return;
  }

  // Calculer le montant restant de manière plus précise
  const montantAccord = Number(pret?.montant_accord||0);
  const principalRembourse = Number(pret?.montant_rembourse||0);
  const totalARembourser = Number(pret?.total_a_rembourser||0);
  
  // Calculer le montant restant réel
  let totalRestant;
  if (totalARembourser > 0) {
    // Utiliser le total à rembourser calculé par le backend
    totalRestant = Math.max(totalARembourser - principalRembourse, 0);
  } else {
    // Fallback sur le montant restant du modèle
    totalRestant = Math.max(Number(pret?.montant_restant||0), 0);
  }

  // Calculer le principal restant et l'intérêt restant
  const principalRestant = Math.max(montantAccord - principalRembourse, 0);
  const interetRestant = Math.max(totalRestant - principalRestant, 0);

  // Exposer la limite pour la validation côté client
  window.__totalRembRestant = totalRestant;
  window.__principalRestant = principalRestant;
  window.__interetRestant = interetRestant;

  const fmt = (n)=> Number(n||0).toLocaleString('fr-FR') + ' FCFA';

  const html = `
  <div class="modal" tabindex="-1" id="rembModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remboursement</h5>
          <button type="button" class="btn-close" onclick="closeRembModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 p-3 bg-light rounded">
            <h6 class="mb-2">Résumé du prêt</h6>
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Montant accordé:</small><br/>
                <strong>${fmt(montantAccord)}</strong>
              </div>
              <div class="col-6">
                <small class="text-muted">Déjà remboursé:</small><br/>
                <strong>${fmt(principalRembourse)}</strong>
              </div>
            </div>
            <hr class="my-2">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Principal restant:</small><br/>
                <strong class="text-primary">${fmt(principalRestant)}</strong>
              </div>
              <div class="col-6">
                <small class="text-muted">Intérêt restant:</small><br/>
                <strong class="text-warning">${fmt(interetRestant)}</strong>
              </div>
            </div>
            <hr class="my-2">
            <div class="text-center">
              <small class="text-muted">Total restant à payer:</small><br/>
              <strong class="text-success fs-5">${fmt(totalRestant)}</strong>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Montant principal à rembourser (peut inclure l'intérêt)</label>
            <input type="number" class="form-control" id="rembMontant" 
                   value="${totalRestant}" min="0" max="${totalRestant}" step="100"
                   oninput="validateRemboursement()" 
                   placeholder="Saisissez le montant total à rembourser" />
            <small class="text-muted">Maximum: ${fmt(totalRestant)} (principal + intérêt)</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Montant intérêt à rembourser (optionnel)</label>
            <input type="number" class="form-control" id="rembInteret" 
                   value="0" min="0" max="${interetRestant}" step="100"
                   oninput="validateRemboursement()" 
                   placeholder="Saisissez le montant d'intérêt séparément (optionnel)" />
            <small class="text-muted">Maximum: ${fmt(interetRestant)} - Laissez vide si l'intérêt est inclus dans le montant principal</small>
          </div>
          
          <div class="mb-3 p-2 bg-info text-white rounded" id="rembTotal">
            <strong>Total du remboursement: ${fmt(0)}</strong>
          </div>
          
          <div class="alert alert-danger" id="rembErr" style="display:none" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="rembErrText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeRembModal()">Annuler</button>
          <button class="btn btn-primary" id="btnEnregistrer" onclick="submitRemboursement(${id})" disabled>
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>`;
  
  document.body.insertAdjacentHTML('beforeend', html);
  new bootstrap.Modal(document.getElementById('rembModal')).show();
  
  // Initialiser la validation
  validateRemboursement();
}

function closeRembModal(){ 
  const el = document.getElementById('rembModal'); 
  if (!el) return; 
  
  // Nettoyer les variables globales
  delete window.__totalRembRestant;
  delete window.__principalRestant;
  delete window.__interetRestant;
  
  bootstrap.Modal.getInstance(el)?.hide(); 
  el.remove(); 
}

async function submitRemboursement(id){
  try{
    // Désactiver le bouton pendant le traitement
    const btnEnregistrer = document.getElementById('btnEnregistrer');
    if (btnEnregistrer) {
      btnEnregistrer.disabled = true;
      btnEnregistrer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    }
    
    const montant = parseFloat(document.getElementById('rembMontant').value||'0');
    const interet = parseFloat(document.getElementById('rembInteret').value||'0');
    
    // Validation finale côté client
    if (!montant && !interet) {
      throw new Error('Veuillez saisir au moins un montant à rembourser');
    }
    
    if (montant < 0 || interet < 0) {
      throw new Error('Les montants ne peuvent pas être négatifs');
    }
    
    // Validation que le total ne dépasse pas le reste à payer
    const total = montant + interet;
    if (typeof window.__totalRembRestant==='number' && total > window.__totalRembRestant + 1e-6){
      throw new Error(`Le montant total (${total.toLocaleString('fr-FR')} FCFA) dépasse le reste à payer (${(window.__totalRembRestant||0).toLocaleString('fr-FR')} FCFA)`);
    }
    
    // Envoyer la requête
    const r = await fetch(`/gestion-caisses/api/prets/${id}/rembourser/`, { 
      method:'POST', 
      headers:{ 
        'Content-Type':'application/json',
        'X-CSRFToken':getCSRFToken() 
      }, 
      body: JSON.stringify({ montant, interet }) 
    });
    
    const data = await r.json();
    if (!r.ok) {
      throw new Error(data.error || data.detail || 'Échec du remboursement');
    }
    
    // Succès
    closeRembModal();
    showToast('Remboursement enregistré avec succès !', 'success');
    
    // Ouvrir le PDF si disponible
    if (data.mouvement_id){ 
      window.open(`/gestion-caisses/api/prets/${id}/remboursement_pdf/?mouvement_id=${data.mouvement_id}`, '_blank'); 
      setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    }
    
    // Recharger la liste des prêts
    loadPrets();
    
  } catch(e) { 
    console.error('Erreur remboursement:', e);
    
    // Afficher l'erreur
    const el = document.getElementById('rembErr'); 
    const errText = document.getElementById('rembErrText');
    if (el && errText){ 
      errText.textContent = e.message; 
      el.style.display='block'; 
    }
    
    // Réactiver le bouton
    if (btnEnregistrer) {
      btnEnregistrer.disabled = false;
      btnEnregistrer.innerHTML = 'Enregistrer';
    }
  }
}

function validateRemboursement(){
  const montant = parseFloat(document.getElementById('rembMontant').value||'0');
  const interet = parseFloat(document.getElementById('rembInteret').value||'0');
  const total = (isNaN(montant)?0:montant) + (isNaN(interet)?0:interet);
  
  const err = document.getElementById('rembErr');
  const btnEnregistrer = document.getElementById('btnEnregistrer');
  const rembTotal = document.getElementById('rembTotal');
  
  if (!err || !btnEnregistrer || !rembTotal) return;
  
  // Mettre à jour l'affichage du total
  const fmt = (n)=> Number(n||0).toLocaleString('fr-FR') + ' FCFA';
  rembTotal.innerHTML = `<strong>Total du remboursement: ${fmt(total)}</strong>`;
  
  let isValid = true;
  let errorMessage = '';
  
  // Validation du montant principal (peut inclure l'intérêt)
  if (isNaN(montant) || montant < 0) {
    isValid = false;
    errorMessage = 'Le montant principal doit être un nombre positif';
  } else if (montant > (window.__totalRembRestant || 0)) {
    isValid = false;
    errorMessage = `Le montant principal ne peut pas dépasser ${fmt(window.__totalRembRestant || 0)} (total restant à payer)`;
  }
  
  // Validation de l'intérêt (optionnel mais contrôlé si saisi)
  if (interet > 0) { // Seulement si une valeur est saisie
    if (isNaN(interet) || interet < 0) {
      isValid = false;
      errorMessage = 'Le montant d\'intérêt doit être un nombre positif';
    } else if (interet > (window.__interetRestant || 0)) {
      isValid = false;
      errorMessage = `Le montant d'intérêt ne peut pas dépasser ${fmt(window.__interetRestant || 0)}`;
    }
  }
  
  // Validation du total
  if (isValid && typeof window.__totalRembRestant==='number' && total > window.__totalRembRestant + 1e-6) {
    isValid = false;
    errorMessage = `Le montant total (principal + intérêt) dépasse le reste à payer (${fmt(window.__totalRembRestant || 0)})`;
  }
  
  // Validation que au moins un montant est saisi
  if (isValid && total <= 0) {
    isValid = false;
    errorMessage = 'Veuillez saisir au moins un montant à rembourser';
  }
  
      // Afficher/masquer l'erreur et activer/désactiver le bouton
    if (!isValid) {
      const errText = document.getElementById('rembErrText');
      if (errText) errText.textContent = errorMessage;
      err.style.display = 'block';
      btnEnregistrer.disabled = true;
    } else {
      err.style.display = 'none';
      btnEnregistrer.disabled = false;
    }
}



// Fonction pour générer un PDF de remboursement complet
async function generateRemboursementCompletPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Appeler l'API pour générer le PDF de remboursement complet
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/remboursement_complet_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `remboursement-complet-pret-${pretId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> PDF de remboursement complet généré avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte après 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la génération du PDF: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte après 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // Réactiver le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}

// Fonction pour générer l'attestation de prêt PDF
async function generateAttestationPretPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Rediriger vers l'URL de génération du PDF
    window.open(`/gestion-caisses/attestation-pret/${pretId}/pdf/`, '_blank');
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    
    // Afficher un message de succès
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Attestation de prêt générée avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte après 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la génération de l\'attestation:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la génération de l'attestation: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte après 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // Réactiver le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}

// Fonction pour générer l'attestation de remboursement PDF
async function generateAttestationRemboursementPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Rediriger vers l'URL de génération du PDF
    window.open(`/gestion-caisses/attestation-remboursement/${pretId}/pdf/`, '_blank');
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    
    // Afficher un message de succès
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Attestation de remboursement générée avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte après 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la génération de l\'attestation:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la génération de l'attestation: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte après 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // Réactiver le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}

// Aperçu de l'image sélectionnée
document.addEventListener('change', function(e){
  // Gestion des checkboxes pour la carte d'électeur
  if (e.target && e.target.id === 'possede_carte_electeur'){
    const checked = e.target.checked;
    const valide = document.getElementById('carte_electeur_valide');
    const numero = document.querySelector('input[name="numero_carte_electeur"]');
    
    if (valide){
      valide.disabled = !checked;
      if (!checked) valide.checked = false;
    }
    if (numero){
      numero.required = checked;
      if (!checked) numero.value = '';
    }
  }
  
  // Gestion de l'aperçu photo
  if (e.target && e.target.id === 'photoInput' && e.target.files && e.target.files[0]){
    const file = e.target.files[0];
    
    // Vérifier la taille du fichier (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Le fichier est trop volumineux. Taille maximum autorisée : 5MB');
      e.target.value = '';
      return;
    }
    
    // Vérifier le type de fichier
    if (!file.type.match('image.*')) {
      alert('Veuillez sélectionner un fichier image valide (JPG, PNG, GIF)');
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(evt){
      const preview = document.getElementById('photoPreview');
      const previewWrapper = document.getElementById('photoPreviewWrapper');
      if (preview && previewWrapper){
        preview.src = evt.target.result;
        previewWrapper.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  }
  
  // Gestion de l'aperçu signature
  if (e.target && e.target.id === 'signatureInput' && e.target.files && e.target.files[0]){
    const file = e.target.files[0];
    
    // Vérifier la taille du fichier (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Le fichier est trop volumineux. Taille maximum autorisée : 5MB');
      e.target.value = '';
      return;
    }
    
    // Vérifier le type de fichier
    if (!file.type.match('image.*')) {
      alert('Veuillez sélectionner un fichier image valide (JPG, PNG, GIF)');
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(evt){
      const preview = document.getElementById('signaturePreview');
      const previewWrapper = document.getElementById('signaturePreviewWrapper');
      if (preview && previewWrapper){
        preview.src = evt.target.result;
        previewWrapper.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  }
});

// Fonction pour vérifier les fonds disponibles avant validation
async function checkFondsDisponibles(pretId) {
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/check-fonds/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la vérification des fonds');
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Erreur lors de la vérification des fonds:', error);
    return null;
  }
}

// Fonction pour afficher une alerte de fonds insuffisants
function showFondsInsuffisantsAlert(pretData) {
  const alertHtml = `
    <div class="modal fade" id="fondsInsuffisantsModal" tabindex="-1" aria-labelledby="fondsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-danger text-white border-0">
            <h5 class="modal-title" id="fondsModalLabel">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Fonds Insuffisants
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-danger border-0">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <strong>Attention :</strong> Les fonds de la caisse sont insuffisants pour octroyer ce prêt.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title text-danger">
                      <i class="fas fa-info-circle me-2"></i>Détails du Prêt
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Numéro de prêt :</strong></p>
                        <p class="text-muted">${pretData.numero_pret || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Membre :</strong></p>
                        <p class="text-muted">${pretData.membre?.nom_complet || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Montant demandé :</strong></p>
                        <p class="text-danger fw-bold">${Number(pretData.montant_demande || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Fonds disponibles :</strong></p>
                        <p class="text-success fw-bold">${Number(pretData.caisse?.fond_disponible || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-warning mt-3 border-0">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Solutions possibles :</strong>
              <ul class="mb-0 mt-2">
                <li>Alimenter la caisse avec des fonds supplémentaires</li>
                <li>Réduire le montant du prêt demandé</li>
                <li>Attendre que d'autres prêts soient remboursés</li>
                <li>Mettre le prêt en attente jusqu'à disponibilité des fonds</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Fermer
            </button>
            <button type="button" class="btn btn-warning" onclick="mettreEnAttentePret(${pretData.id})">
              <i class="fas fa-clock me-2"></i>Mettre en Attente
            </button>
            <button type="button" class="btn btn-primary" onclick="alimenterCaisse(${pretData.caisse?.id})">
              <i class="fas fa-plus-circle me-2"></i>Alimenter la Caisse
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', alertHtml);
  const modal = new bootstrap.Modal(document.getElementById('fondsInsuffisantsModal'));
  modal.show();
}

// Fonction pour mettre un prêt en attente
async function mettreEnAttentePret(pretId) {
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/mettre_en_attente/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({
        motif_attente: 'Fonds insuffisants - Prêt mis en attente'
      })
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la mise en attente');
    }
    
    // Fermer le modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('fondsInsuffisantsModal'));
    modal.hide();
    
    // Recharger la liste des prêts
    loadPrets();
    
    // Afficher un message de succès
    showToast('Prêt mis en attente avec succès', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la mise en attente:', error);
    showToast('Erreur lors de la mise en attente', 'error');
  }
}

// Fonction pour alimenter la caisse
function alimenterCaisse(caisseId) {
  // Fermer le modal actuel
  const modal = bootstrap.Modal.getInstance(document.getElementById('fondsInsuffisantsModal'));
  modal.hide();
  
  // Rediriger vers la page d'alimentation de la caisse
  window.location.href = `/gestion-caisses/caisses/${caisseId}/alimenter/`;
}

// Fonction pour valider un prêt (admin seulement)
async function validerPret(pretId) {
  try {
    // Vérifier les fonds disponibles avant la validation
    const fondsData = await checkFondsDisponibles(pretId);
    
    if (!fondsData) {
      showToast('Erreur lors de la vérification des fonds', 'error');
      return;
    }
    
    if (!fondsData.fonds_suffisants) {
      // Afficher l'alerte de fonds insuffisants
      showFondsInsuffisantsAlert(fondsData);
      return;
    }
    
    // Si les fonds sont suffisants, procéder à la validation
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/valider/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Erreur lors de la validation');
    }
    
    const data = await response.json();
    
    // Afficher un message de succès
    showToast('Prêt validé avec succès !', 'success');
    
    // Recharger la liste des prêts
    loadPrets();
    
  } catch (error) {
    console.error('Erreur lors de la validation:', error);
    showToast(error.message || 'Erreur lors de la validation', 'error');
  }
}

// Fonction pour rejeter un prêt (admin seulement)
async function rejeterPret(pretId) {
  const motif = prompt('Motif du rejet :');
  if (!motif) return;
  
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/rejeter/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({ motif_rejet: motif })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Erreur lors du rejet');
    }
    
    // Afficher un message de succès
    showToast('Prêt rejeté avec succès', 'success');
    
    // Recharger la liste des prêts
    loadPrets();
    
  } catch (error) {
    console.error('Erreur lors du rejet:', error);
    showToast(error.message || 'Erreur lors du rejet', 'error');
  }
}

// Fonction de déconnexion pour le dashboard
async function handleLogout() {
  try {
    const response = await fetch('/gestion-caisses/api/logout/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      window.location.href = '/gestion-caisses/login/';
    } else {
      showToast('Erreur lors de la déconnexion', 'error');
    }
  } catch (error) {
    console.error('Erreur de déconnexion:', error);
    showToast('Erreur lors de la déconnexion', 'error');
  }
}

// ============================================================================
// FONCTIONS POUR LES RAPPORTS DE CAISSE
// ============================================================================

async function chargerRapport() {
  try {
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const typeRapport = document.getElementById('type-rapport').value;
    
    // Afficher un indicateur de chargement
    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-3">Chargement du rapport...</p>
      </div>
    `;
    
    // Construire l'URL avec les paramètres
    const params = new URLSearchParams();
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    params.append('type', typeRapport);
    
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors du chargement du rapport');
    }
    
    const rapport = await response.json();
    afficherRapport(rapport, typeRapport);
    
  } catch (error) {
    console.error('Erreur lors du chargement du rapport:', error);
    showToast('Erreur lors du chargement du rapport', 'error');
    
    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        Erreur lors du chargement du rapport: ${error.message}
      </div>
    `;
  }
}

function afficherRapport(rapport, typeRapport) {
  const contenuRapport = document.getElementById('contenu-rapport');
  
  switch (typeRapport) {
    case 'general':
      contenuRapport.innerHTML = afficherRapportGeneral(rapport);
      break;
    case 'financier':
      contenuRapport.innerHTML = afficherRapportFinancier(rapport);
      break;
    case 'prets':
      contenuRapport.innerHTML = afficherRapportPrets(rapport);
      break;
    case 'membres':
      contenuRapport.innerHTML = afficherRapportMembres(rapport);
      break;
    case 'echeances':
      contenuRapport.innerHTML = afficherRapportEcheances(rapport);
      break;
    case 'cotisations_membre':
      contenuRapport.innerHTML = afficherRapportCotisationsMembre(rapport);
      break;
    default:
      contenuRapport.innerHTML = '<div class="alert alert-warning">Type de rapport non reconnu</div>';
  }
}

// === Rapports Cotisations ===
async function chargerRapportCotisations(){
  const res = await fetch(`${API_BASE}/cotisations/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  const list = (data.results||data);
  const contenuRapport = document.getElementById('contenu-rapport');
  contenuRapport.innerHTML = `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">📋 Cotisations - Vue générale</h5>
        <span class="text-muted">Total: ${fmt(list.reduce((a,c)=> a + Number(c.montant_total||0), 0))} FCFA</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>Date</th><th>Membre</th><th>Séance</th>
            <th>Tempon</th><th>Solidarité</th><th>Fondation</th><th>Pénalité</th><th>Total</th>
          </tr></thead>
          <tbody>
            ${list.map(c=>`
              <tr>
                <td>${formatDateTimeSafe(c.date_cotisation)}</td>
                <td>${c.membre_nom}</td>
                <td>${formatDateSafe(c.seance_date)}</td>
                <td>${fmt(c.prix_tempon)}</td>
                <td>${fmt(c.frais_solidarite)}</td>
                <td>${fmt(c.frais_fondation)}</td>
                <td>${fmt(c.penalite_emprunt_retard)}</td>
                <td class="fw-bold">${fmt(c.montant_total)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
}

async function chargerRapportCotisationsParMembre(){
  const res = await fetch(`${API_BASE}/cotisations/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  const list = (data.results||data);
  const agg = new Map();
  for (const c of list){
    const key = `${c.membre}`;
    const cur = agg.get(key) || { nom: c.membre_nom, tempon:0, solidarite:0, fondation:0, penalite:0, total:0, nombre:0 };
    cur.tempon += Number(c.prix_tempon||0);
    cur.solidarite += Number(c.frais_solidarite||0);
    cur.fondation += Number(c.frais_fondation||0);
    cur.penalite += Number(c.penalite_emprunt_retard||0);
    cur.total += Number(c.montant_total||0);
    cur.nombre += 1;
    agg.set(key, cur);
  }
  const rows = Array.from(agg.values());
  const contenuRapport = document.getElementById('contenu-rapport');
  contenuRapport.innerHTML = `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">👤 Cotisations par membre</h5>
        <span class="text-muted">Membres: ${rows.length}</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>Membre</th><th>#</th><th>Tempon</th><th>Solidarité</th><th>Fondation</th><th>Pénalités</th><th>Total</th>
          </tr></thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.nom}</td>
                <td>${fmt(r.nombre)}</td>
                <td>${fmt(r.tempon)}</td>
                <td>${fmt(r.solidarite)}</td>
                <td>${fmt(r.fondation)}</td>
                <td>${fmt(r.penalite)}</td>
                <td class="fw-bold">${fmt(r.total)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
}

// UI: Générer PDF cotisations pour un membre
async function genererPdfCotisationsMembre(){
  const membreSelect = document.getElementById('rapport-membre-select');
  const membreId = membreSelect && membreSelect.value;
  if (!membreId){
    showToast('Veuillez sélectionner un membre', 'warning');
    return;
  }
  const dateDebut = document.getElementById('date-debut')?.value || '';
  const dateFin = document.getElementById('date-fin')?.value || '';
  const params = new URLSearchParams();
  params.append('type', 'cotisations_membre');
  params.append('membre', membreId);
  if (dateDebut) params.append('date_debut', dateDebut);
  if (dateFin) params.append('date_fin', dateFin);
  params.append('format', 'pdf');
  window.open(`/gestion-caisses/api/rapports-caisse/?${params.toString()}`, '_blank');
}

function afficherRapportCotisationsMembre(rapport){
  const items = rapport.items || [];
  const totaux = rapport.totaux || {};
  const membre = rapport.membre?.nom || '';
  return `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">📋 Cotisations — ${membre}</h5>
        <div class="d-flex gap-2">
          <select id="rapport-membre-select" class="form-select form-select-sm"></select>
          <button class="btn btn-sm btn-primary" onclick="genererPdfCotisationsMembre()"><i class="fas fa-file-pdf"></i> PDF Membre</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>Séance</th><th>Tempon</th><th>Solidarité</th><th>Pénalité</th><th>Total</th><th>Observation</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>`
              <tr>
                <td>${it.seance||''}</td>
                <td>${fmt(it.prix_tempon)}</td>
                <td>${fmt(it.frais_solidarite)}</td>
                <td>${fmt(it.penalite_emprunt_retard)}</td>
                <td class="fw-bold">${fmt(it.montant_total)}</td>
                <td>${(it.observation||'')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="p-3 text-end">
        <strong>Totaux — Tempon:</strong> ${fmt(totaux.tempon)}
        <strong class="ms-3">Solidarité:</strong> ${fmt(totaux.solidarite)}
        <strong class="ms-3">Pénalités:</strong> ${fmt(totaux.penalite)}
        <strong class="ms-3">Total:</strong> ${fmt(totaux.total)}
      </div>
    </div>`;
}

// Peupler la liste de membres pour le rapport membre
async function initRapportMembreSelect(){
  try{
    let url = '/gestion-caisses/api/membres/';
    const params = new URLSearchParams();
    if (USER_CAISE_ID) params.append('caisse', USER_CAISE_ID);
    if (params.toString()) url += `?${params.toString()}`;
    const r = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await r.json();
    const membres = data.results || data;
    const sel = document.getElementById('rapport-membre-select');
    if (!sel) return;
    sel.innerHTML = '<option value="">Sélectionner un membre</option>';
    membres.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m.id; opt.textContent = m.nom_complet; sel.appendChild(opt);
    });
  } catch(e) {}
}

function afficherRapportGeneral(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-pie"></i> Rapport Général - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Date de création:</strong> ${rapport.caisse.date_creation}</li>
                  <li><strong>Statut:</strong> ${rapport.caisse.statut}</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6>Période du rapport</h6>
                <ul class="list-unstyled">
                  <li><strong>Début:</strong> ${rapport.periode.debut || 'Toutes les dates'}</li>
                  <li><strong>Fin:</strong> ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📊 Membres</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-primary">${rapport.membres.total}</h3>
                  <small>Total</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-success">${rapport.membres.actifs}</h3>
                  <small>Actifs</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-warning">${rapport.membres.inactifs}</h3>
                  <small>Inactifs</small>
                </div>
              </div>
            </div>
            <div class="row text-center mt-3">
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.membres.femmes}</h4>
                  <small>Femmes</small>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-secondary">${rapport.membres.hommes}</h4>
                  <small>Hommes</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">💰 Prêts</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-primary">${rapport.prets.total}</h3>
                  <small>Total</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-success">${rapport.prets.en_cours}</h3>
                  <small>En cours</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-info">${rapport.prets.rembourses}</h3>
                  <small>Remboursés</small>
                </div>
              </div>
            </div>
            <div class="row text-center mt-3">
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.prets.en_retard}</h4>
                  <small>En retard</small>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-danger">${(rapport.prets.montant_moyen || 0).toLocaleString('fr-FR')} FCFA</h4>
                  <small>Moyenne</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">🏦 Fonds</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-primary">${rapport.fonds.fond_initial.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond initial</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-success">${rapport.fonds.fond_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond disponible</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.fonds.montant_total_prets.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Total prêts</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.fonds.solde_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Solde disponible</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportFinancier(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-line"></i> Rapport Financier - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Période:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">💰 Fonds Actuels</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-primary">${rapport.fonds_actuels.fond_initial.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond initial</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-success">${rapport.fonds_actuels.fond_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond disponible</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.fonds_actuels.montant_total_prets.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Total prêts</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.fonds_actuels.solde_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Solde disponible</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📊 Mouvements de Fonds</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Nombre</th>
                    <th>Montant Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.mouvements.stats_par_type.map(stat => `
                    <tr>
                      <td>${stat.type_mouvement}</td>
                      <td>${stat.nombre}</td>
                      <td>${stat.total.toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📈 Évolution des Fonds</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Montant</th>
                    <th>Solde</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.mouvements.evolution.map(mouvement => `
                    <tr>
                      <td>${mouvement.date}</td>
                      <td><span class="badge bg-${getBadgeColor(mouvement.type)}">${mouvement.type}</span></td>
                      <td>${mouvement.montant.toLocaleString('fr-FR')} FCFA</td>
                      <td>${mouvement.solde.toLocaleString('fr-FR')} FCFA</td>
                      <td>${mouvement.description}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportPrets(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-hand-holding-usd"></i> Rapport des Prêts - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Période:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📊 Statistiques par Statut</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Statut</th>
                    <th>Nombre</th>
                    <th>Montant Total</th>
                    <th>Montant Moyen</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.statistiques.par_statut.map(stat => `
                    <tr>
                      <td><span class="badge bg-${getBadgeColor(stat.statut)}">${stat.statut}</span></td>
                      <td>${stat.nombre}</td>
                      <td>${(stat.montant_total || 0).toLocaleString('fr-FR')} FCFA</td>
                      <td>${(stat.montant_moyen || 0).toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">⚠️ Prêts en Retard</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-6">
                <div class="stat-item">
                  <h3 class="text-danger">${rapport.prets_retard.nombre}</h3>
                  <small>Nombre de prêts en retard</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stat-item">
                  <h3 class="text-warning">${rapport.prets_retard.montant_total_retard.toLocaleString('fr-FR')} FCFA</h3>
                  <small>Montant total en retard</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📋 Détails des Prêts</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Numéro</th>
                    <th>Membre</th>
                    <th>Montant Accordé</th>
                    <th>Montant Remboursé</th>
                    <th>Montant Restant</th>
                    <th>Statut</th>
                    <th>Date Demande</th>
                    <th>Durée (mois)</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_prets.map(pret => `
                    <tr>
                      <td>${pret.numero}</td>
                      <td>${pret.membre}</td>
                      <td>${pret.montant_accord.toLocaleString('fr-FR')} FCFA</td>
                      <td>${pret.montant_rembourse.toLocaleString('fr-FR')} FCFA</td>
                      <td>${pret.montant_restant.toLocaleString('fr-FR')} FCFA</td>
                      <td><span class="badge bg-${getBadgeColor(pret.statut)}">${pret.statut}</span></td>
                      <td>${pret.date_demande}</td>
                      <td>${pret.duree_mois}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportMembres(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-users"></i> Rapport des Membres - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Période:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📊 Par Statut</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_statut.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.statut}</span>
                <span class="badge bg-primary">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">👥 Par Sexe</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_sexe.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.sexe === 'F' ? 'Femmes' : 'Hommes'}</span>
                <span class="badge bg-info">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">🎭 Par Rôle</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_role.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.role}</span>
                <span class="badge bg-success">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📋 Détails des Membres</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nom Complet</th>
                    <th>Numéro Carte</th>
                    <th>Téléphone</th>
                    <th>Sexe</th>
                    <th>Rôle</th>
                    <th>Statut</th>
                    <th>Date Adhésion</th>
                    <th>Nombre Prêts</th>
                    <th>Total Prêts</th>
                    <th>Total Remboursé</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_membres.map(membre => `
                    <tr>
                      <td>${membre.nom_complet}</td>
                      <td>${membre.numero_carte}</td>
                      <td>${membre.telephone}</td>
                      <td>${membre.sexe === 'F' ? 'F' : 'M'}</td>
                      <td><span class="badge bg-secondary">${membre.role}</span></td>
                      <td><span class="badge bg-${getBadgeColor(membre.statut)}">${membre.statut}</span></td>
                      <td>${membre.date_adhesion}</td>
                      <td>${membre.nombre_prets}</td>
                      <td>${membre.montant_total_prets.toLocaleString('fr-FR')} FCFA</td>
                      <td>${membre.montant_total_rembourse.toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportEcheances(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-calendar-check"></i> Rapport des Échéances - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Période:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📊 Statistiques Générales</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-primary">${rapport.statistiques.total_echeances}</h3>
              <small>Total échéances</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-success">${rapport.statistiques.total_montant.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant total</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-info">${rapport.statistiques.total_paye.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant payé</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">⚠️ Échéances en Retard</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-danger">${rapport.echeances_retard.nombre}</h3>
              <small>Nombre en retard</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-warning">${rapport.echeances_retard.montant_total.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant en retard</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📅 Échéances à Venir</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-info">${rapport.echeances_a_venir.nombre}</h3>
              <small>Nombre à venir</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-primary">${rapport.echeances_a_venir.montant_total.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant à venir</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">📋 Détails des Échéances</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>N° Échéance</th>
                    <th>N° Prêt</th>
                    <th>Membre</th>
                    <th>Montant Échéance</th>
                    <th>Montant Payé</th>
                    <th>Montant Restant</th>
                    <th>Date Échéance</th>
                    <th>Date Paiement</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_echeances.map(echeance => `
                    <tr class="${echeance.en_retard ? 'table-danger' : ''}">
                      <td>${echeance.numero_echeance}</td>
                      <td>${echeance.pret_numero}</td>
                      <td>${echeance.membre}</td>
                      <td>${echeance.montant_echeance.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.montant_paye.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.montant_restant.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.date_echeance}</td>
                      <td>${echeance.date_paiement || '-'}</td>
                      <td><span class="badge bg-${getBadgeColor(echeance.statut)}">${echeance.statut}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function getBadgeColor(type) {
  const colors = {
    // Statuts de prêts
    'EN_ATTENTE': 'warning',
    'EN_ATTENTE_ADMIN': 'warning',
    'VALIDE': 'info',
    'REJETE': 'danger',
    'BLOQUE': 'secondary',
    'EN_COURS': 'primary',
    'REMBOURSE': 'success',
    'EN_RETARD': 'danger',
    
    // Statuts de membres
    'ACTIF': 'success',
    'INACTIF': 'secondary',
    'SUSPENDU': 'warning',
    'RETRAITE': 'info',
    
    // Types de mouvements
    'ALIMENTATION': 'success',
    'DECAISSEMENT': 'danger',
    'REMBOURSEMENT': 'info',
    'FRAIS': 'warning',
    'AUTRE': 'secondary',
    
    // Statuts d'échéances
    'A_PAYER': 'warning',
    'PARTIELLEMENT_PAYE': 'info',
    'PAYE': 'success',
    'EN_RETARD': 'danger',
    
    // Rôles de membres
    'PRESIDENTE': 'primary',
    'SECRETAIRE': 'info',
    'TRESORIERE': 'success',
    'MEMBRE': 'secondary',
    
    // Sexe
    'F': 'pink',
    'M': 'blue'
  };
  
  return colors[type] || 'secondary';
}

async function genererRapportPDF(typeRapport, btnEl) {
  let button = null; let originalText = '';
  try {
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    
    // Afficher un indicateur de chargement
    button = btnEl || document.activeElement || null;
    originalText = button ? button.innerHTML : '';
    if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...'; }
    
    // Construire l'URL avec les paramètres
    const params = new URLSearchParams();
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    params.append('type', typeRapport);
    params.append('format', 'pdf');
    
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `rapport_${typeRapport}_${new Date().toISOString().split('T')[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    showToast(`PDF du rapport ${typeRapport} généré avec succès !`, 'success');
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    showToast('Erreur lors de la génération du PDF', 'error');
  } finally {
    // Restaurer le bouton
    if (button) { button.disabled = false; button.innerHTML = originalText; }
  }
}

async function telechargerMembresSystemePDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const params = new URLSearchParams({ type: 'membres_systeme_pdf', format: 'pdf' });
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `membres_systeme_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur génération PDF membres', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function telechargerAgentsSystemePDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const params = new URLSearchParams({ type: 'agents_systeme_pdf', format: 'pdf' });
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `agents_systeme_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur génération PDF agents', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function telechargerPretsEvaluationPDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const params = new URLSearchParams({ type: 'prets_evaluation_pdf', format: 'pdf' });
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `prets_evaluation_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur génération PDF évaluation des prêts', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function chargerPretsParMotif(){
  const motif = document.getElementById('motif-select').value;
  const content = document.getElementById('motifs-content');
  content.innerHTML = '<div class="text-muted">Chargement...</div>';
  const params = new URLSearchParams({ type: 'prets_par_motif' });
  if (motif) params.append('motif', motif);
  const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
  if (!resp.ok){ content.innerHTML = '<div class="alert alert-warning">Erreur de chargement</div>'; return; }
  const data = await resp.json();
  const rows = (data.items||[]).map(it=>`<tr><td>${it.numero_pret}</td><td>${it.membre}</td><td>${it.caisse}</td><td class='text-end'>${(it.pourcentage||0)}%</td></tr>`).join('');
  const total = data.totaux || {};
  content.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="m-0">Résultats</h5>
          <div class='small text-muted'>Motif: ${data.motif||'Tous'} — Nombre: ${data.nombre||0}</div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead><tr><th>N° Prêt</th><th>Membre</th><th>Caisse</th><th class='text-end'>% remboursé</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="4" class="text-center text-muted">Aucun résultat</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>`;
}

async function telechargerPretsParMotifPDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const motif = document.getElementById('motif-select').value;
    const params = new URLSearchParams({ type: 'prets_par_motif', format: 'pdf' });
    if (motif) params.append('motif', motif);
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `prets_par_motif_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur génération PDF prêts par motif', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}
</script>

<!-- Membres Modal -->
<div class="modal" tabindex="-1" id="membreModal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="membreModalTitle">Nouveau membre</h5>
        <button type="button" class="btn-close" onclick="closeMembreModal()"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <form id="membreForm">
          {% csrf_token %}
          <input type="hidden" name="id" />
          <div class="row g-3">
            <!-- Informations d'identification -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3">📋 Informations d'identification</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Possède une carte d'électeur</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="possede_carte_electeur" id="possede_carte_electeur" checked />
                <label class="form-check-label" for="possede_carte_electeur">Oui</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Carte d'électeur valide</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="carte_electeur_valide" id="carte_electeur_valide" />
                <label class="form-check-label" for="carte_electeur_valide">Valide</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Numéro carte d'électeur <span class="text-danger">*</span></label>
              <input class="form-control" name="numero_carte_electeur" maxlength="26" pattern="[A-Z0-9-]{26}" placeholder="Ex: A457-475G-5478U-45-01-01-25-12" required />
              <small class="form-text text-muted">26 caractères, lettres/chiffres/tirets, en majuscules</small>
            </div>
            
            <!-- Informations personnelles -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">👤 Informations personnelles</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nom <span class="text-danger">*</span></label>
              <input class="form-control" name="nom" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Prénoms <span class="text-danger">*</span></label>
              <input class="form-control" name="prenoms" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Date de naissance <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="date_naissance" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Sexe <span class="text-danger">*</span></label>
              <select class="form-select" name="sexe">
                <option value="F" selected>Féminin</option>
                <option value="M">Masculin</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Adresse <span class="text-danger">*</span></label>
              <textarea class="form-control" name="adresse" rows="2" placeholder="Adresse complète du membre" required></textarea>
            </div>
            
            <!-- Contact -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">📞 Contact</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Téléphone <span class="text-danger">*</span></label>
              <div class="input-group">
                <select class="form-select" style="max-width:120px" name="indicatif_telephone">
                  <option value="+228" selected>+228 (Togo)</option>
                  <option value="+229">+229 (Bénin)</option>
                  <option value="+233">+233 (Ghana)</option>
                </select>
                <input class="form-control" name="numero_telephone" placeholder="90123456" required />
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Numéro WhatsApp</label>
              <input class="form-control" name="numero_whatsapp" placeholder="90123456" />
            </div>
            
            <!-- Localisation -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">📍 Localisation</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Quartier</label>
              <input type="text" class="form-control" name="quartier" id="quartier" placeholder="Nom du quartier (optionnel)" />
            </div>
            
            <!-- Photos et documents -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">📷 Photos et documents</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Photo</label>
              <input type="file" class="form-control" name="photo" id="photoInput" accept="image/*" />
              <small class="form-text text-muted">Formats acceptés: JPG, PNG, GIF (max 5MB)</small>
            </div>
            <div class="col-md-6">
              <div id="photoPreviewWrapper" style="display:none; text-align:center;">
                <img id="photoPreview" alt="Aperçu de la photo" style="max-height:120px; max-width:100%; border-radius:8px; border: 1px solid #ddd;" />
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Signature</label>
              <input type="file" class="form-control" name="signature" id="signatureInput" accept="image/*" />
              <small class="form-text text-muted">Formats acceptés: JPG, PNG, GIF (max 5MB)</small>
            </div>
            <div class="col-md-6">
              <div id="signaturePreviewWrapper" style="display:none; text-align:center;">
                <img id="signaturePreview" alt="Aperçu de la signature" style="max-height:120px; max-width:100%; border-radius:8px; border: 1px solid #ddd;" />
              </div>
            </div>
            
            <!-- Rôle et statut -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">⚙️ Rôle et statut</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Rôle</label>
              <select class="form-select" name="role">
                <option value="MEMBRE" selected>Membre simple</option>
                <option value="SECRETAIRE">Secrétaire</option>
                <option value="PRESIDENTE">Présidente</option>
                <option value="TRESORIERE">Trésorière</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Statut</label>
              <select class="form-select" name="statut">
                <option value="ACTIF" selected>Actif</option>
                <option value="INACTIF">Inactif</option>
                <option value="SUSPENDU">Suspendu</option>
                <option value="RETRAITE">Retraité</option>
              </select>
            </div>
            
            <!-- Notes -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">📝 Notes</h6>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="3" placeholder="Notes additionnelles sur le membre (optionnel)"></textarea>
            </div>
          </div>
        </form>
        <div id="membreError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeMembreModal()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitMembre()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal Séance -->
  <div class="modal fade" id="seanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nouvelle séance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="seanceForm">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label required">Date de la séance</label>
              <input id="seanceDate" name="date_seance" type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Titre (optionnel)</label>
              <input id="seanceTitre" name="titre" class="form-control" placeholder="Titre" />
            </div>
          </form>
          <div id="seanceError" class="text-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="submitSeanceModal()">Créer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cotisation -->
  <div class="modal fade" id="cotisationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Nouvelle cotisation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="cotisationForm">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label required">Membre</label>
                <select id="cotisationMembre" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label required">Séance</label>
                <select id="cotisationSeance" class="form-select" required></select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Prix tempon</label>
                <input id="prixTempon" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Frais solidarité</label>
                <input id="fraisSolidarite" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Frais fondation</label>
                <input id="fraisFondation" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Pénalité emprunt</label>
                <input id="penaliteEmprunt" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-12">
                <label class="form-label">Observation</label>
                <textarea id="cotisationDescription" class="form-control" rows="2" placeholder="Observation"></textarea>
              </div>
            </div>
          </form>
          <div id="cotisationError" class="text-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-success" onclick="submitCotisationModal()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Édition Séance -->
<div class="modal fade" id="seanceEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Modifier la séance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="seanceEditId" />
        <div class="mb-3">
          <label class="form-label">Date de la séance</label>
          <input id="seanceEditDate" type="date" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">Titre (optionnel)</label>
          <input id="seanceEditTitre" class="form-control" placeholder="Titre" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitSeanceEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Édition Cotisation -->
<div class="modal fade" id="cotisationEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Modifier la cotisation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cotisationEditId" />
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Membre</label>
            <select id="cotisationEditMembre" class="form-select"></select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Séance</label>
            <select id="cotisationEditSeance" class="form-select"></select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Prix tempon</label>
            <input id="prixTemponEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Frais solidarité</label>
            <input id="fraisSolidariteEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Frais fondation</label>
            <input id="fraisFondationEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Pénalité emprunt</label>
            <input id="penaliteEmpruntEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-12">
            <label class="form-label">Observation</label>
            <textarea id="cotisationDescriptionEdit" class="form-control" rows="2" placeholder="Observation"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" onclick="submitCotisationEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Dépense -->
<div class="modal fade" id="depenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Nouvelle dépense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="depenseForm">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label required">Objectif de la dépense</label>
              <textarea id="depenseObjectif" class="form-control" rows="2" placeholder="Objectif de la dépense" required></textarea>
            </div>
            
            <div class="col-12 col-md-6">
              <label class="form-label required">Montant (FCFA)</label>
              <input id="depenseMontant" type="number" class="form-control" min="0" step="1" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label required">Date de la dépense</label>
              <input id="depenseDate" type="date" class="form-control" required />
            </div>
            <div class="col-12">
              <label class="form-label">Observation (optionnel)</label>
              <textarea id="depenseObservation" class="form-control" rows="3" placeholder="Observation (facultatif)"></textarea>
            </div>
          </div>
        </form>
        <div id="depenseError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" onclick="submitDepenseModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Édition Dépense -->
<div class="modal fade" id="depenseEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Modifier la dépense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="depenseEditId" />
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label required">Objectif de la dépense</label>
            <textarea id="depenseEditDescription" class="form-control" rows="2" placeholder="Objectif de la dépense" required></textarea>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label required">Montant (FCFA)</label>
            <input id="depenseEditMontant" type="number" class="form-control" min="0" step="1" required />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label required">Date de la dépense</label>
            <input id="depenseEditDate" type="date" class="form-control" required />
          </div>
          <div class="col-12">
            <label class="form-label">Observation (optionnel)</label>
            <textarea id="depenseEditObservation" class="form-control" rows="3" placeholder="Observation (facultatif)"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" onclick="submitDepenseEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmation Générique -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmTitle">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmMessage">Êtes-vous sûr ?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmAcceptBtn">Supprimer</button>
      </div>
    </div>
  </div>
  </div>

<!-- Prêts Modal -->
<div class="modal" tabindex="-1" id="pretModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pretModalTitle">Nouveau prêt</h5>
        <button type="button" class="btn-close" onclick="closePretModal()"></button>
      </div>
      <div class="modal-body">
        <form id="pretForm">
          {% csrf_token %}
          <input type="hidden" name="id" />
                      <div class="mb-3">
              <label class="form-label">Membre</label>
              <select class="form-select" name="membre_id" id="pretMembre" required onchange="checkMemberLoanStatus()"></select>
              <div id="memberLoanWarning" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> 
                Ce membre a déjà un prêt en cours. Il doit d'abord terminer le remboursement de son prêt actuel.
              </div>
              <div id="memberContributionWarning" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                Ce membre n'a pas encore atteint 3000 FCFA de cotisations. Le prêt est indisponible.
              </div>
              <div id="memberContributionInfo" class="text-muted mt-1" style="display:none; font-size: 12px;"></div>
            </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Montant demandé (FCFA)</label>
              <input class="form-control" name="montant_demande" type="number" required oninput="updateInterestPreview()" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Durée (mois)</label>
              <input class="form-control" name="duree_mois" type="number" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Taux d'intérêt (%)</label>
              <input class="form-control" name="taux_interet" type="number" step="0.01" value="0" oninput="updateInterestPreview()" />
            </div>
            <div class="col-12">
              <div class="alert alert-info" id="interestPreview" style="display: none;">
                <div class="row">
                  <div class="col-md-4">
                    <strong>Montant demandé:</strong><br>
                    <span id="previewMontantDemande">0</span> FCFA
                  </div>
                  <div class="col-md-4">
                    <strong>Intérêt (0%):</strong><br>
                    <span id="previewInteret">0</span> FCFA
                  </div>
                  <div class="col-md-4">
                    <strong>Total à rembourser:</strong><br>
                    <span id="previewTotal" class="text-success fw-bold">0</span> FCFA
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Motif <span class="text-danger">*</span></label>
              <select class="form-select" name="motif" id="motifSelect" required onchange="toggleMotifAutre()">
                <option value="">Sélectionner un motif</option>
                <option value="commerce">Commerce</option>
                <option value="agriculture">Agriculture</option>
                <option value="elevage">Élevage</option>
                <option value="artisanat">Artisanat</option>
                <option value="transport">Transport</option>
                <option value="education">Éducation</option>
                <option value="sante">Santé</option>
                <option value="habitat">Habitat</option>
                <option value="equipement">Équipement</option>
                <option value="stock">Stock</option>
                <option value="urgence">Urgence</option>
                <option value="autres">Autres</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Détails du prêt</label>
              <textarea class="form-control" name="details_pret" id="detailsPret" rows="3" placeholder="Précisions sur l'utilisation du prêt (optionnel)"></textarea>
            </div>
            <div class="col-12" id="motifAutreDiv" style="display: none;">
              <label class="form-label">Préciser le motif <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="motif_autre" id="motifAutre" placeholder="Décrivez le motif spécifique" />
            </div>
          </div>
        </form>
        <div id="pretError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePretModal()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitPret()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Fonctions pour la génération de PDFs
async function generateMembresListePDF(caisseId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Appeler l'API pour générer le PDF de la liste des membres
    const response = await fetch(`/gestion-caisses/api/caisses/${caisseId}/membres_liste_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `liste_membres_caisse_${caisseId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    showToast('PDF de la liste des membres généré avec succès !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    showToast('Erreur lors de la génération du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

async function generateMembrePDF(membreId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Appeler l'API pour générer le PDF de la fiche membre
    const response = await fetch(`/gestion-caisses/api/membres/${membreId}/fiche_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `fiche_membre_${membreId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    showToast('PDF de la fiche membre généré avec succès !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    showToast('Erreur lors de la génération du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

async function generateEcheancesRetardPDF(event) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
    
    // Appeler l'API pour générer le PDF des échéances en retard
    const response = await fetch(`/gestion-caisses/api/caisses/${USER_CAISE_ID}/echeances_retard_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la génération du PDF');
    }
    
    // Télécharger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `echeances_retard_${new Date().toISOString().split('T')[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succès
    showToast('PDF des échéances en retard généré avec succès !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la génération du PDF:', error);
    showToast('Erreur lors de la génération du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// === Séances & Cotisations (Frontend) ===
const API_BASE = '/gestion-caisses/api';
// IMPORTANT: éviter la redéclaration si déjà défini plus haut
if (typeof USER_CAISE_ID === 'undefined') { var USER_CAISE_ID = null; }

document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Charger contexte utilisateur (récupère caisse_id)
    const ctx = await fetch(`${API_BASE}/user-context/`).then(r=>r.json());
    USER_CAISE_ID = ctx.caisse_id;
    // Précharger listes
    await refreshSeances();
    await refreshCotisations();
    await hydrateMembresSelect();
    await hydrateSeancesSelect();
    // Précharger les dépenses et le solde dès l'arrivée sur le dashboard
    try { await chargerDepenses(); } catch(e) { console.error(e); }
  } catch(e) { console.error(e); }
});

window.openSeanceCreateModal = function(e){
  try { e && e.preventDefault && e.preventDefault(); } catch {}
  try {
    const d = document.getElementById('seanceDate'); if(d) d.value = '';
    const t = document.getElementById('seanceTitre'); if(t) t.value = '';
  } catch {}
  const el = document.getElementById('seanceModal');
  if(el){
    try { if (el.parentElement !== document.body) document.body.appendChild(el); } catch {}
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }
};

window.openCotisationCreateModal = function(e){
  try { e && e.preventDefault && e.preventDefault(); } catch {}
  // Hydrater selects si nécessaire
  try { hydrateMembresSelect(); } catch {}
  try { hydrateSeancesSelect(); } catch {}
  // Bloquer ouverture si aucun exercice actif
  try {
    const my = (allCaisses||[]).find(c=>true);
    if (!my || !my.exercice_actuel) { showToast("Aucun exercice en cours pour votre caisse","warning"); return; }
  } catch {}
  const el = document.getElementById('cotisationModal');
  if(el){
    try { if (el.parentElement !== document.body) document.body.appendChild(el); } catch {}
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }
};

async function openSeanceEditModal(id, dateStr, titre){
  try {
    if(!id){ return; }
    // Si date/titre non fournis ou potentiellement invalides, recharger depuis l'API
    if(!dateStr){
      const s = await fetch(`${API_BASE}/seances/${id}/`).then(r=>r.json());
      dateStr = s.date_seance || '';
      titre = s.titre || '';
    }
    document.getElementById('seanceEditId').value = id;
    document.getElementById('seanceEditDate').value = (dateStr||'');
    document.getElementById('seanceEditTitre').value = (titre||'');
    const el = document.getElementById('seanceEditModal');
    if(el){ bootstrap.Modal.getOrCreateInstance(el).show(); }
  } catch(e) { console.error(e); }
}

async function submitSeanceEditModal(){
  const id = document.getElementById('seanceEditId').value;
  const dateVal = document.getElementById('seanceEditDate').value;
  const titreVal = document.getElementById('seanceEditTitre').value;
  if(!id){ return; }
  const res = await fetch(`${API_BASE}/seances/${id}/`,{
    method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({ date_seance: dateVal, titre: titreVal })
  });
  if(!res.ok){ showToast('Erreur mise à jour séance','error'); return; }
  showToast('Séance mise à jour','success');
  bootstrap.Modal.getInstance(document.getElementById('seanceEditModal'))?.hide();
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function deleteSeance(id){
  if(!confirm('Supprimer cette séance ?')) return;
  const res = await fetch(`${API_BASE}/seances/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': getCSRFToken()} });
  if(res.status !== 204){ showToast('Erreur suppression séance','error'); return; }
  showToast('Séance supprimée','success');
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function openCotisationEditModal(id){
  // Charger la cotisation
  const data = await fetch(`${API_BASE}/cotisations/${id}/`).then(r=>r.json());
  document.getElementById('cotisationEditId').value = id;
  // Hydrate selects si vides
  if(document.getElementById('cotisationEditMembre').options.length === 0){
    const m = await fetch(`${API_BASE}/membres/?caisse=${USER_CAISE_ID}`).then(r=>r.json());
    document.getElementById('cotisationEditMembre').innerHTML = (m.results||m).map(x=>`<option value="${x.id}">${x.nom_complet}</option>`).join('');
  }
  if(document.getElementById('cotisationEditSeance').options.length === 0){
    const s = await fetch(`${API_BASE}/seances/?caisse=${USER_CAISE_ID}`).then(r=>r.json());
    document.getElementById('cotisationEditSeance').innerHTML = (s.results||s).map(x=>`<option value="${x.id}">${formatDateSafe(x.date_seance)} - ${x.titre||''}</option>`).join('');
  }
  document.getElementById('cotisationEditMembre').value = data.membre;
  document.getElementById('cotisationEditSeance').value = data.seance;
  document.getElementById('prixTemponEdit').value = data.prix_tempon||0;
  document.getElementById('fraisSolidariteEdit').value = data.frais_solidarite||0;
  document.getElementById('fraisFondationEdit').value = data.frais_fondation||0;
  document.getElementById('penaliteEmpruntEdit').value = data.penalite_emprunt_retard||0;
  document.getElementById('cotisationDescriptionEdit').value = data.description||'';
  const modal = new bootstrap.Modal(document.getElementById('cotisationEditModal'));
  modal.show();
}

async function submitCotisationEditModal(){
  const id = document.getElementById('cotisationEditId').value;
  const payload = {
    membre: Number(document.getElementById('cotisationEditMembre').value||0),
    seance: Number(document.getElementById('cotisationEditSeance').value||0),
    prix_tempon: Number(document.getElementById('prixTemponEdit').value||0),
    frais_solidarite: Number(document.getElementById('fraisSolidariteEdit').value||0),
    frais_fondation: Number(document.getElementById('fraisFondationEdit').value||0),
    penalite_emprunt_retard: Number(document.getElementById('penaliteEmpruntEdit').value||0),
    description: document.getElementById('cotisationDescriptionEdit').value||''
  };
  const res = await fetch(`${API_BASE}/cotisations/${id}/`, { method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken': getCSRFToken()}, body: JSON.stringify(payload) });
  if(!res.ok){ showToast('Erreur mise à jour cotisation','error'); return; }
  showToast('Cotisation mise à jour','success');
  bootstrap.Modal.getInstance(document.getElementById('cotisationEditModal'))?.hide();
  await refreshCotisations();
}

async function deleteCotisation(id){
  // Confirmation moderne via modal inline minimaliste
  const confirmHtml = `
  <div class="modal fade" id="confirmDeleteCotModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white"><h6 class="modal-title m-0">Confirmer la suppression</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">Cette action est irréversible. Continuer ?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmDeleteCotBtn" class="btn btn-danger">Supprimer</button>
        </div>
      </div>
    </div>
  </div>`;
  document.getElementById('confirmDeleteCotModal')?.remove();
  document.body.insertAdjacentHTML('beforeend', confirmHtml);
  const mdl = new bootstrap.Modal(document.getElementById('confirmDeleteCotModal'));
  mdl.show();
  document.getElementById('confirmDeleteCotBtn').onclick = async () => {
    const res = await fetch(`${API_BASE}/cotisations/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': getCSRFToken()} });
    mdl.hide();
    if(res.status !== 204){ showToast('Erreur suppression cotisation','error'); return; }
    showToast('Suppression réussie','success');
    await refreshCotisations();
    setTimeout(()=> document.getElementById('confirmDeleteCotModal')?.remove(), 300);
  };
}

async function refreshSeances(){
  if(!USER_CAISE_ID) return;
  const res = await fetch(`${API_BASE}/seances/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  const list = document.getElementById('seances-list');
  list.innerHTML = (data.results||data).map(s=>`
    <div class="card mb-2"><div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div><strong>${s.titre||''}</strong></div>
        <div>Date: ${formatDateSafe(s.date_seance)}</div>
      </div>
      <div class="text-end">
        <div class="mb-2">
          <button class="btn btn-sm btn-outline-primary" onclick="openSeanceEditModal(${s.id}, '${s.date_seance}', ${JSON.stringify(s.titre||'')})">Éditer</button>
        </div>
        <small class="text-muted">Créé le: ${formatDateTimeSafe(s.date_creation)}</small>
      </div>
    </div></div>
  `).join('');
}

async function createSeance(){
  const err = document.getElementById('seanceError'); if(err){ err.style.display='none'; err.textContent=''; }
  const dateVal = document.getElementById('seanceDate').value;
  const titreVal = document.getElementById('seanceTitre').value;
  if(!dateVal||!USER_CAISE_ID){ if(err){ err.textContent = 'La date est requise.'; err.style.display='block'; } showToast('Sélectionnez une date', 'warning'); return; }
  const res = await fetch(`${API_BASE}/seances/`,{
    method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({ caisse: USER_CAISE_ID, date_seance: dateVal, titre: titreVal })
  });
  if(!res.ok){ const t=await res.text(); if(err){ err.textContent='Erreur: '+t; err.style.display='block'; } showToast('Erreur création séance','error'); return; }
  showToast('Séance créée','success');
  document.getElementById('seanceDate').value='';
  document.getElementById('seanceTitre').value='';
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function submitSeanceModal(){
  const btns = document.querySelectorAll('#seanceModal .btn');
  btns.forEach(b=>b.disabled=true);
  try {
    await createSeance();
    const modalEl = document.getElementById('seanceModal');
    bootstrap.Modal.getInstance(modalEl)?.hide();
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}

async function hydrateMembresSelect(){
  const sel = document.getElementById('cotisationMembre');
  if(!sel||!USER_CAISE_ID) return;
  const res = await fetch(`${API_BASE}/membres/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  sel.innerHTML = '<option value="">Sélectionner un membre</option>' + (data.results||data).map(m=>`<option value="${m.id}">${m.nom_complet} (${m.numero_carte_electeur})</option>`).join('');
}

async function hydrateSeancesSelect(){
  const sel = document.getElementById('cotisationSeance');
  if(!sel||!USER_CAISE_ID) return;
  const res = await fetch(`${API_BASE}/seances/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  sel.innerHTML = '<option value="">Sélectionner une séance</option>' + (data.results||data).map(s=>`<option value="${s.id}">${s.date_seance} - ${s.titre||''}</option>`).join('');
}

async function refreshCotisations(){
  if(!USER_CAISE_ID) return;
  const res = await fetch(`${API_BASE}/cotisations/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  const list = document.getElementById('cotisations-list');
  list.innerHTML = (data.results||data).map(c=>`
    <div class="card mb-2"><div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div><strong>${c.membre_nom}</strong> — Séance: ${formatDateSafe(c.seance_date)}</div>
        <div>
          Tempon: <strong>${fmt(c.prix_tempon)} FCFA</strong> · Solidarité: <strong>${fmt(c.frais_solidarite)} FCFA</strong> · Fondation: <strong>${fmt(c.frais_fondation)} FCFA</strong> · Pénalité: <strong>${fmt(c.penalite_emprunt_retard)} FCFA</strong>
        </div>
      </div>
      <div class="text-end">
        <div class="fw-bold">Total: ${fmt(c.montant_total)} FCFA</div>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="openCotisationEditModal(${c.id})">Éditer</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteCotisation(${c.id})">Supprimer</button>
        </div>
        <small class="text-muted">${formatDateTimeSafe(c.date_cotisation)}</small>
      </div>
    </div></div>
  `).join('');

  // Stats totales
  const tot = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${USER_CAISE_ID}`).then(r=>r.json());
  const t = tot.totaux || {};
  setText('statTempon', fmt(t.prix_tempon||0)+' FCFA');
  setText('statSolidarite', fmt(t.frais_solidarite||0)+' FCFA');
  setText('statFondation', fmt(t.frais_fondation||0)+' FCFA');
  setText('statPenalite', fmt(t.penalite_emprunt_retard||0)+' FCFA');
  setText('statTotal', fmt(t.total||0)+' FCFA');
  setText('statNombre', fmt(t.nombre||0));

  // Série mensuelle
  const serie = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${USER_CAISE_ID}&group_by=month`).then(r=>r.json());
  const series = serie.series||[];
  drawCotisationsChart(series.map(x=>x.mois), series.map(x=>x.total||0));

  // Hydrater le sélecteur de stats membre une seule fois si vide
  const statsSel = document.getElementById('statsMembre');
  if(statsSel && statsSel.options.length === 0){
    const mres = await fetch(`${API_BASE}/membres/?caisse=${USER_CAISE_ID}`);
    const mdata = await mres.json();
    statsSel.innerHTML = '<option value="">Sélectionner un membre</option>' + (mdata.results||mdata).map(m=>`<option value="${m.id}">${m.nom_complet} (${m.numero_carte_electeur})</option>`).join('');
  }
}

function fmt(x){ try{ return Number(x).toLocaleString('fr-FR'); }catch{ return x; } }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

let cotChart;
function drawCotisationsChart(labels, values){
  const ctx = document.getElementById('cotisationsChart');
  if(!ctx) return;
  if(cotChart){ cotChart.destroy(); }
  cotChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total mensuel (FCFA)',
        data: values,
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76,175,80,0.15)',
        tension: 0.2,
        fill: true,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { ticks: { callback: v=>fmt(v) } } }
    }
  });
}

let cotMemberChart;
async function refreshMemberStats(){
  const id = document.getElementById('statsMembre').value;
  if(!id){ return; }
  const agg = await fetch(`${API_BASE}/cotisations-stats/membre/?membre_id=${id}`).then(r=>r.json());
  const serie = await fetch(`${API_BASE}/cotisations-stats/membre/?membre_id=${id}&group_by=month`).then(r=>r.json());
  const t = agg.totaux||{};
  setText('mStatMois', fmt(agg.nombre_mois_cotises||0));
  setText('mStatTotal', fmt(t.total||0)+' FCFA');
  setText('mStatTempon', fmt(t.prix_tempon||0)+' FCFA');
  setText('mStatSolidarite', fmt(t.frais_solidarite||0)+' FCFA');
  setText('mStatPenalite', fmt(t.penalite_emprunt_retard||0)+' FCFA');
  drawMemberChart((serie.series||[]).map(x=>x.mois), (serie.series||[]).map(x=>x.total||0));
}

function drawMemberChart(labels, values){
  const ctx = document.getElementById('cotisationsMemberChart');
  if(!ctx) return;
  if(cotMemberChart){ cotMemberChart.destroy(); }
  cotMemberChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Total mensuel (FCFA)', data: values, backgroundColor: 'rgba(54,162,235,0.4)', borderColor:'#36A2EB' }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v=>fmt(v) } } } }
  });
}

async function createCotisation(){
  const err = document.getElementById('cotisationError'); if(err){ err.style.display='none'; err.textContent=''; }
  const membreId = document.getElementById('cotisationMembre').value;
  const seanceId = document.getElementById('cotisationSeance').value;
  const prixTempon = Number(document.getElementById('prixTempon').value||0);
  const fraisSolid = Number(document.getElementById('fraisSolidarite').value||0);
  const fraisFond = Number(document.getElementById('fraisFondation').value||0);
  const penalite = Number(document.getElementById('penaliteEmprunt').value||0);
  const description = (document.getElementById('cotisationDescription')?.value||'');
  if(!membreId||!seanceId){ if(err){ err.textContent='Veuillez sélectionner un membre et une séance.'; err.style.display='block'; } showToast('Sélectionnez membre et séance','warning'); return; }
  const res = await fetch(`${API_BASE}/cotisations/`,{
    method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({
      membre_id: Number(membreId), caisse_id: USER_CAISE_ID, seance_id: Number(seanceId),
      prix_tempon: prixTempon, frais_solidarite: fraisSolid, frais_fondation: fraisFond, penalite_emprunt_retard: penalite,
      description: description
    })
  });
  if(!res.ok){ const t=await res.text(); console.error(t); if(err){ err.textContent='Erreur: '+t; err.style.display='block'; } showToast('Erreur enregistrement','error'); return; }
  showToast('Cotisation enregistrée','success');
  document.getElementById('prixTempon').value='';
  document.getElementById('fraisSolidarite').value='';
  document.getElementById('fraisFondation').value='';
  document.getElementById('penaliteEmprunt').value='';
  await refreshCotisations();
}

async function submitCotisationModal(){
  const btns = document.querySelectorAll('#cotisationModal .btn');
  btns.forEach(b=>b.disabled=true);
  try {
    await createCotisation();
    const modalEl = document.getElementById('cotisationModal');
    bootstrap.Modal.getInstance(modalEl)?.hide();
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}
// Fonction de déconnexion pour le dashboard
async function handleLogout() {
  try {
    const response = await fetch('/gestion-caisses/api/logout/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      window.location.href = '/gestion-caisses/login/';
    } else {
      showToast('Erreur lors de la déconnexion', 'error');
    }
  } catch (error) {
    console.error('Erreur de déconnexion:', error);
    showToast('Erreur lors de la déconnexion', 'error');
  }
}

// === FONCTIONS DÉPENSES ===

// Ouvrir la modale de création de dépense
function openDepenseCreateModal() {
  // Initialiser la date à aujourd'hui
  document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
  
  // Plus de choix de caisse ici; tout est basé sur la caisse utilisateur
  
  // Afficher la modale
  const modal = new bootstrap.Modal(document.getElementById('depenseModal'));
  modal.show();
}

// Charger les caisses pour le formulaire de dépense
async function chargerCaissesDepenses() {
  try {
    const res = await fetch(`${API_BASE}/caisses/?id=${USER_CAISE_ID||''}`);
    const data = await res.json();
    const caisses = data.results || data;
    
    const select = document.getElementById('depenseCaisse');
    select.innerHTML = '<option value="">Sélectionner une caisse</option>';
    
    caisses.forEach(caisse => {
      const option = document.createElement('option');
      option.value = caisse.id;
      option.textContent = caisse.nom_association;
      select.appendChild(option);
    });
    // Pré-sélectionner la caisse de l'utilisateur si disponible
    if (USER_CAISE_ID) {
      try { select.value = String(USER_CAISE_ID); } catch {}
    }
  } catch (error) {
    console.error('Erreur chargement caisses:', error);
  }
}

// Charger les membres pour le formulaire de dépense
async function chargerMembresDepenses() {
  try {
    const res = await fetch(`${API_BASE}/membres/`);
    const data = await res.json();
    const membres = data.results || data;
    
    const select = document.getElementById('depenseResponsable');
    select.innerHTML = '<option value="">Sélectionner un responsable</option>';
    
    membres.forEach(membre => {
      const option = document.createElement('option');
      option.value = membre.id;
      option.textContent = membre.nom_complet;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Erreur chargement membres:', error);
  }
}

// Charger la liste des dépenses
async function chargerDepenses() {
  try {
    const url = USER_CAISE_ID ? `${API_BASE}/depenses/?caisse=${USER_CAISE_ID}` : `${API_BASE}/depenses/`;
    const res = await fetch(url);
    const data = await res.json();
    const depenses = data.results || data;
    
    afficherDepenses(depenses);
    chargerStatsDepenses();
  } catch (error) {
    console.error('Erreur chargement dépenses:', error);
    showToast('Erreur lors du chargement des dépenses', 'error');
  }
}

// Afficher la liste des dépenses
function afficherDepenses(depenses) {
  const container = document.getElementById('depenses-list');
  
  if (!depenses || depenses.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">Aucune dépense trouvée</p>
      </div>
    `;
    return;
  }
  
  const table = `
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Objectif</th>
            <th>Montant</th>
            <th>Observation</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${depenses.map(depense => `
            <tr>
              <td>${formatDateSafe(depense.datedepense)}</td>
              <td>${depense.Objectifdepense}</td>
              <td class="fw-bold">${fmt(depense.montantdepense)} FCFA</td>
              <td>${depense.observation || ''}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-warning" onclick="editerDepense(${depense.id})" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger" onclick="supprimerDepense(${depense.id})" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                  ${depense.statut === 'EN_COURS' ? `
                    <button class="btn btn-outline-success" onclick="approuverDepense(${depense.id})" title="Approuver">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="rejeterDepense(${depense.id})" title="Rejeter">
                      <i class="fas fa-times"></i>
                    </button>
                  ` : ''}
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  container.innerHTML = table;
}

// Obtenir le badge de statut
function getStatutBadge(statut) {
  const badges = {
    'EN_COURS': '<span class="badge bg-warning">En cours</span>',
    'APPROUVEE': '<span class="badge bg-success">Approuvée</span>',
    'REJETEE': '<span class="badge bg-danger">Rejetée</span>',
    'TERMINEE': '<span class="badge bg-info">Terminée</span>'
  };
  return badges[statut] || '<span class="badge bg-secondary">Inconnu</span>';
}

// Charger les statistiques des dépenses
async function chargerStatsDepenses() {
  try {
    if (!USER_CAISE_ID) { return; }
    const res = await fetch(`${API_BASE}/depenses/stats/?caisse_id=${USER_CAISE_ID}`, { credentials: 'same-origin', headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await res.json();
    
    document.getElementById('solde-depenses').textContent = `${fmt(data.solde_disponible || 0)} FCFA`;
  } catch (error) {
    console.error('Erreur chargement stats dépenses:', error);
  }
}

// Filtrer les dépenses
function filtrerDepenses() {
  const caisse = document.getElementById('depense-caisse').value;
  const categorie = document.getElementById('depense-categorie').value;
  const statut = document.getElementById('depense-statut').value;
  
  // Construire l'URL avec les filtres
  let url = `${API_BASE}/depenses/`;
  const params = new URLSearchParams();
  
  if (caisse) params.append('caisse', caisse);
  if (categorie) params.append('categorie', categorie);
  if (statut) params.append('statut', statut);
  
  if (params.toString()) {
    url += '?' + params.toString();
  }
  
  // Charger les dépenses filtrées
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const depenses = data.results || data;
      afficherDepenses(depenses);
    })
    .catch(error => {
      console.error('Erreur filtrage dépenses:', error);
      showToast('Erreur lors du filtrage', 'error');
    });
}

// Créer une nouvelle dépense
async function createDepense() {
  const err = document.getElementById('depenseError');
  if (err) {
    err.style.display = 'none';
    err.textContent = '';
  }
  
  const caisseId = USER_CAISE_ID;
  const objectif = document.getElementById('depenseObjectif').value;
  const montant = Number(document.getElementById('depenseMontant').value);
  const dateDepense = document.getElementById('depenseDate').value;
  const observation = document.getElementById('depenseObservation').value;
  // Champs optionnels supprimés pour correspondre au modèle en base
  
  if (!caisseId || !objectif || !montant || !dateDepense) {
    if (err) {
      err.textContent = 'Veuillez remplir tous les champs obligatoires.';
      err.style.display = 'block';
    }
    showToast('Veuillez remplir tous les champs obligatoires', 'warning');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/depenses/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        caisse: Number(caisseId),
        Objectifdepense: objectif,
        montantdepense: montant,
        datedepense: dateDepense,
        observation: observation
      })
    });
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error(errorText);
      if (err) {
        err.textContent = 'Erreur: ' + errorText;
        err.style.display = 'block';
      }
      showToast('Erreur lors de l\'enregistrement', 'error');
      return;
    }
    
    showToast('Dépense enregistrée avec succès', 'success');
    
    // Fermer la modale et recharger
    const modal = bootstrap.Modal.getInstance(document.getElementById('depenseModal'));
    modal.hide();
    
    // Vider le formulaire
    document.getElementById('depenseForm').reset();
    
    // Recharger la liste
    await chargerDepenses();
    
  } catch (error) {
    console.error('Erreur création dépense:', error);
    if (err) {
      err.textContent = 'Erreur lors de l\'enregistrement';
      err.style.display = 'block';
    }
    showToast('Erreur lors de l\'enregistrement', 'error');
  }
}

// Soumettre la modale de dépense
async function submitDepenseModal() {
  const btns = document.querySelectorAll('#depenseModal .btn');
  btns.forEach(b => b.disabled = true);
  
  try {
    await createDepense();
  } finally {
    btns.forEach(b => b.disabled = false);
  }
}

// Voir une dépense
function voirDepense(depenseId) {
  // Implémenter la vue détaillée d'une dépense
  showToast('Fonctionnalité à implémenter', 'info');
}

// Éditer une dépense
async function editerDepense(depenseId) {
  try {
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/`);
    const d = await res.json();
    document.getElementById('depenseEditId').value = d.id;
    document.getElementById('depenseEditMontant').value = d.montantdepense;
    document.getElementById('depenseEditDate').value = (d.datedepense||'').slice(0,10);
    document.getElementById('depenseEditDescription').value = d.Objectifdepense || '';
    const modal = new bootstrap.Modal(document.getElementById('depenseEditModal'));
    modal.show();
  } catch (e) {
    console.error(e);
    showToast('Erreur chargement dépense', 'error');
  }
}

async function submitDepenseEditModal(){
  const id = document.getElementById('depenseEditId').value;
  const payload = {
    caisse: USER_CAISE_ID ? Number(USER_CAISE_ID) : undefined,
    Objectifdepense: document.getElementById('depenseEditDescription').value,
    montantdepense: Number(document.getElementById('depenseEditMontant').value),
    datedepense: document.getElementById('depenseEditDate').value,
    observation: document.getElementById('depenseEditObservation').value || ''
  };
  try {
    const res = await fetch(`${API_BASE}/depenses/${id}/`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    showToast('Dépense modifiée', 'success');
    const modal = bootstrap.Modal.getInstance(document.getElementById('depenseEditModal'));
    modal.hide();
    await chargerDepenses();
  } catch(e){
    console.error(e);
    showToast('Erreur modification', 'error');
  }
}

// Approuver une dépense
async function approuverDepense(depenseId) {
  try {
    const notes = prompt('Notes d\'approbation (optionnel):');
    
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/approuver/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        notes: notes || ''
      })
    });
    
    if (res.ok) {
      showToast('Dépense approuvée avec succès', 'success');
      await chargerDepenses();
    } else {
      const error = await res.json();
      showToast('Erreur: ' + (error.error || 'Impossible d\'approuver la dépense'), 'error');
    }
  } catch (error) {
    console.error('Erreur approbation dépense:', error);
    showToast('Erreur lors de l\'approbation', 'error');
  }
}

// Rejeter une dépense
async function rejeterDepense(depenseId) {
  try {
    const notes = prompt('Motif du rejet (optionnel):');
    
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/rejeter/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        notes: notes || ''
      })
    });
    
    if (res.ok) {
      showToast('Dépense rejetée avec succès', 'success');
      await chargerDepenses();
    } else {
      const error = await res.json();
      showToast('Erreur: ' + (error.error || 'Impossible de rejeter la dépense'), 'error');
    }
  } catch (error) {
    console.error('Erreur rejet dépense:', error);
    showToast('Erreur lors du rejet', 'error');
  }
}

// Supprimer une dépense
function confirmAction({title='Confirmation', message='Êtes-vous sûr ?', confirmText='Confirmer', confirmClass='btn-primary', onConfirm}){
  try {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    const btn = document.getElementById('confirmAcceptBtn');
    btn.textContent = confirmText;
    btn.className = 'btn ' + confirmClass;
    const modalEl = document.getElementById('confirmModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    // Nettoyer anciens listeners
    btn.replaceWith(btn.cloneNode(true));
    const newBtn = document.getElementById('confirmAcceptBtn');
    newBtn.addEventListener('click', async ()=>{
      try { await onConfirm?.(); } finally { modal.hide(); }
    });
    modal.show();
  } catch(e) { if (onConfirm) onConfirm(); }
}

async function supprimerDepense(depenseId){
  confirmAction({
    title: 'Supprimer la dépense',
    message: 'Cette action est irréversible. Confirmez la suppression ?',
    confirmText: 'Supprimer',
    confirmClass: 'btn-danger',
    onConfirm: async () => {
      try {
        const res = await fetch(`${API_BASE}/depenses/${depenseId}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': getCSRFToken() }
        });
        if (res.status === 204) {
          showToast('Dépense supprimée', 'success');
          await chargerDepenses();
        } else {
          const t = await res.text();
          throw new Error(t);
        }
      } catch(e) {
        console.error(e);
        showToast('Erreur suppression', 'error');
      }
    }
  });
}

// Charger le rapport des dépenses
async function chargerRapportDepenses() {
  try {
    const res = await fetch(`${API_BASE}/depenses/`);
    const data = await res.json();
    const depenses = data.results || data;
    
    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="m-0">💸 Rapport des Dépenses</h5>
          <span class="text-muted">Total: ${fmt(depenses.reduce((a, d) => a + Number(d.montant || 0), 0))} FCFA</span>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Caisse</th>
                <th>Catégorie</th>
                <th>Montant</th>
                <th>Responsable</th>
                <th>Statut</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              ${depenses.map(depense => `
                <tr>
                  <td>${formatDateSafe(depense.date_depense)}</td>
                  <td>${depense.caisse_nom}</td>
                  <td><span class="badge bg-info">${depense.categorie_display}</span></td>
                  <td class="fw-bold">${fmt(depense.montant)} FCFA</td>
                  <td>${depense.responsable_nom}</td>
                  <td>${getStatutBadge(depense.statut)}</td>
                  <td>${depense.description}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  } catch (error) {
    console.error('Erreur chargement rapport dépenses:', error);
    showToast('Erreur lors du chargement du rapport', 'error');
  }
}

// Exporter PDF Dépenses entre deux dates
async function exportDepensesPDF(btn){
  let button = btn; let originalText = button ? button.innerHTML : '';
  try {
    if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...'; }
    const d1 = document.getElementById('depenses-date-debut').value;
    const d2 = document.getElementById('depenses-date-fin').value;
    const params = new URLSearchParams();
    if (d1) params.append('date_debut', d1);
    if (d2) params.append('date_fin', d2);
    params.append('type', 'depenses');
    params.append('format', 'pdf');
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    if (!response.ok) throw new Error('Erreur génération PDF');
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `depenses_${new Date().toISOString().split('T')[0]}.pdf`; a.style.display='none';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    showToast('PDF Dépenses généré', 'success');
  } catch(e){
    console.error(e); showToast('Erreur génération PDF', 'error');
  } finally {
    if (button) { button.disabled = false; button.innerHTML = originalText; }
  }
}

// ============================================================================
// GESTION DES CAISSES - INTERFACE CARTES
// ============================================================================

// Variables globales pour les caisses
let allCaisses = [];
let caissesLoaded = false;

// CSS pour les cartes de caisses
const caissesCSS = `
<style>
    .caisse-card-inner {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid #e9ecef;
    }
    
    .caisse-card-inner:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    
    .card-header {
        border-bottom: none;
        padding: 1rem;
    }
    
    .list-group-item {
        background: transparent;
        border: none;
        padding: 0.25rem 0;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.4em 0.6em;
    }
    
    .text-success {
        color: #198754 !important;
    }
    
    .text-warning {
        color: #ffc107 !important;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .text-primary {
        color: #007bff !important;
    }
    
    .caisse-card .card-body {
        background: #f8f9fa;
    }
    
    .caisse-card .card-footer {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }
    
    .caisse-card .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .caisse-card .alert {
        font-size: 0.75rem;
        padding: 0.5rem;
    }
</style>
`;

// Ajouter le CSS au head
document.head.insertAdjacentHTML('beforeend', caissesCSS);

// Charger les caisses
async function loadCaisses() {
    try {
        const response = await fetch(`${API_BASE}/caisses/`);
        if (!response.ok) throw new Error('Erreur lors du chargement des caisses');
        
        const data = await response.json();
        const caisses = data.results || data;
        
        // Charger les exercices pour chaque caisse
        const caissesWithDetails = await Promise.all(caisses.map(async (caisse) => {
            try {
                console.log('Traitement caisse:', caisse.nom_association, caisse);
                
                // Charger les exercices - essayer différentes approches
                let exerciceActuel = null;
                
                try {
                    // Essayer d'abord l'endpoint spécifique
                    const exerciceResponse = await fetch(`${API_BASE}/caisses/${caisse.id}/exercices/`);
                    if (exerciceResponse.ok) {
                        const exerciceData = await exerciceResponse.json();
                        const exercices = exerciceData.results || exerciceData;
                        exerciceActuel = exercices.find(e => e.statut === 'EN_COURS');
                    }
                } catch (e) {
                    console.log('Erreur chargement exercices spécifique:', e);
                }
                
                // Si pas trouvé, essayer l'endpoint général des exercices
                if (!exerciceActuel) {
                    try {
                        const allExercicesResponse = await fetch(`${API_BASE}/exercices-caisse/`);
                        if (allExercicesResponse.ok) {
                            const allExercicesData = await allExercicesResponse.json();
                            const allExercices = allExercicesData.results || allExercicesData;
                            exerciceActuel = allExercices.find(e => e.caisse === caisse.id && e.statut === 'EN_COURS');
                        }
                    } catch (e) {
                        console.log('Erreur chargement exercices général:', e);
                    }
                }
                
                // Construire la localisation à partir des données du serializer
                const parts = [];
                if (caisse.village_nom) parts.push(caisse.village_nom);
                if (caisse.canton_nom) parts.push(caisse.canton_nom);
                if (caisse.commune_nom) parts.push(caisse.commune_nom);
                const localisation = parts.join(', ');
                
                console.log(`Caisse ${caisse.nom_association}: exercice_actuel =`, exerciceActuel);
                console.log(`Caisse ${caisse.nom_association}: localisation =`, localisation);
                console.log(`Caisse ${caisse.nom_association}: agent_nom =`, caisse.agent_nom);
                console.log(`Caisse ${caisse.nom_association}: presidente_nom =`, caisse.presidente_nom);
                
                return {
                    ...caisse,
                    exercice_actuel: exerciceActuel,
                    localisation: localisation
                };
            } catch (e) {
                console.log('Erreur générale pour caisse:', caisse.nom_association, e);
                return { ...caisse, exercice_actuel: null };
            }
        }));
        
        allCaisses = caissesWithDetails;
        caissesLoaded = true;
        
        renderCaisses();
        updateCaissesCount();
        
        // Ajouter les événements de filtrage
        setupCaissesFilters();
        
    } catch (error) {
        console.error('Erreur lors du chargement des caisses:', error);
        document.getElementById('caissesGrid').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    Erreur lors du chargement des caisses: ${error.message}
                </div>
            </div>
        `;
    }
}

// Rendre les cartes de caisses
function renderCaisses(caissesToRender = allCaisses) {
    const grid = document.getElementById('caissesGrid');
    
    if (!caissesToRender || caissesToRender.length === 0) {
        grid.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fa fa-building fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Aucune caisse trouvée</h4>
                    <p class="text-muted">Il n'y a actuellement aucune caisse dans le système.</p>
                </div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = caissesToRender.map(caisse => createCaisseCard(caisse)).join('');

    // Désactiver les activités côté non-admin si aucun exercice
    try {
        const roleText = document.getElementById('user-role')?.textContent?.trim();
        if (roleText && roleText !== 'Administrateur') {
            // Heuristique: prendre la première caisse (ou améliorable si API renvoie la caisse de l'utilisateur)
            const userCaisse = caissesToRender[0];
            const hasExercice = !!(userCaisse && userCaisse.exercice_actuel);
            const ids = ['tab-prets','tab-depenses'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !hasExercice;
                    el.classList.toggle('disabled', !hasExercice);
                    el.title = !hasExercice ? "Aucune activité n'est autorisée sans exercice en cours" : '';
                }
            });
        }
    } catch(e) { }
}

// Formatteur de dates résilient (prend en charge 'YYYY-MM-DD' et 'DD/MM/YYYY')
function formatDateFR(input) {
    if (!input) { return ''; }
    if (typeof input === 'string') {
        const trimmed = input.trim();
        // Déjà au format français
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(trimmed)) { return trimmed; }
        // Format ISO (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS)
        const isoMatch = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            const [_, y, m, d] = isoMatch;
            return `${d}/${m}/${y}`;
        }
        const d = new Date(trimmed);
        if (!isNaN(d.getTime())) { return d.toLocaleDateString('fr-FR'); }
        return trimmed;
    }
    if (input instanceof Date) {
        if (!isNaN(input.getTime())) { return input.toLocaleDateString('fr-FR'); }
        return '';
    }
    return '';
}

// Format DateTime (ISO) -> dd/mm/yyyy sans l'heure
function formatDateOnly(input){
    if (!input) return '';
    if (typeof input === 'string') {
        const iso = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (iso) { const [_, y,m,d] = iso; return `${d}/${m}/${y}`; }
    }
    try { const d = new Date(input); if(!isNaN(d.getTime())) return d.toLocaleDateString('fr-FR'); } catch {}
    return formatDateFR(input);
}

// Créer une carte pour une caisse
function createCaisseCard(caisse) {
    const dateCreation = formatDateOnly(caisse.date_creation) || '-';
    const solde = new Intl.NumberFormat('fr-FR').format(caisse.fond_disponible || 0);
    
    // Localisation - utiliser le champ localisation du sérialiseur
    const localisation = caisse.localisation || 'Non définie';
    
    // Statut badge
    let statutBadge = '';
    if (caisse.statut === 'ACTIVE') {
        statutBadge = '<span class="badge bg-success text-white"><i class="fa fa-check me-1"></i>Active</span>';
    } else if (caisse.statut === 'INACTIVE') {
        statutBadge = '<span class="badge bg-warning text-dark"><i class="fa fa-pause me-1"></i>Inactive</span>';
    } else {
        statutBadge = '<span class="badge bg-danger text-white"><i class="fa fa-ban me-1"></i>Suspendue</span>';
    }
    
    // Exercice en cours (date début et date fin) - style comme l'image
    let exerciceSection = '';
    if (caisse.exercice_actuel && (caisse.exercice_actuel.date_debut || caisse.exercice_actuel.date_fin)) {
        const dateDebut = formatDateFR(caisse.exercice_actuel.date_debut) || '-';
        const dateFin = formatDateFR(caisse.exercice_actuel.date_fin) || '-';
        exerciceSection = `
            <div class="mb-3">
                <div class="text-muted small mb-1">
                    <i class="fa fa-calendar-alt me-1"></i>Exercices
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold small">${dateDebut}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">au ${dateFin}</div>
                    </div>
                    <span class="badge bg-success">
                        <i class="fa fa-play me-1"></i>En cours
                    </span>
                </div>
            </div>
        `;
    } else {
        exerciceSection = `
            <div class="mb-3">
                <div class="text-muted small mb-1">
                    <i class="fa fa-calendar-alt me-1"></i>Exercices
                </div>
                <div class="alert alert-warning py-2 mb-0">
                    <i class="fa fa-exclamation-triangle me-1"></i>
                    <small>Aucun exercice</small>
                </div>
            </div>
        `;
    }
    
    // Les 3 premiers responsables de la caisse
    const responsables = [];
    
    // Ajouter les responsables s'ils existent
    if (caisse.presidente_nom) {
        responsables.push({ 
            nom: caisse.presidente_nom, 
            role: 'Présidente', 
            telephone: caisse.presidente_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assigné', role: 'Présidente', telephone: '' });
    }
    
    if (caisse.secretaire_nom) {
        responsables.push({ 
            nom: caisse.secretaire_nom, 
            role: 'Secrétaire', 
            telephone: caisse.secretaire_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assigné', role: 'Secrétaire', telephone: '' });
    }
    
    if (caisse.tresoriere_nom) {
        responsables.push({ 
            nom: caisse.tresoriere_nom, 
            role: 'Trésorière', 
            telephone: caisse.tresoriere_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assigné', role: 'Trésorière', telephone: '' });
    }
    
    // Limiter à 3 responsables maximum
    const responsablesLimites = responsables.slice(0, 3);
    
    const responsablesHtml = responsablesLimites.map(resp => `
        <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
                <div class="fw-bold small">${resp.nom}</div>
                <div class="text-muted" style="font-size: 0.7rem;">${resp.role}</div>
            </div>
            ${resp.telephone ? `
                <button class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; border-radius: 50%;" onclick="window.open('tel:${resp.telephone}', '_self')" title="Appeler ${resp.telephone}">
                    <i class="fa fa-phone" style="font-size: 0.8rem;"></i>
                </button>
            ` : `
                <button class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; border-radius: 50%;" onclick="alert('Numéro de téléphone non disponible')" title="Numéro non disponible">
                    <i class="fa fa-phone" style="font-size: 0.8rem;"></i>
                </button>
            `}
        </div>
    `).join('');
    
    return `
        <div class="col-12 col-lg-6 col-xl-4 caisse-card" 
             data-nom="${(caisse.nom_association || '').toLowerCase()}"
             data-code="${(caisse.code || '').toLowerCase()}"
             data-localisation="${localisation.toLowerCase()}"
             data-statut="${caisse.statut}"
             data-date-creation="${caisse.date_creation}"
             data-solde="${caisse.fond_disponible || 0}">
            
            <div class="card h-100 shadow-sm border-0 caisse-card-inner" style="border-radius: 12px;">
                <!-- En-tête de la carte avec nom et code -->
                <div class="card-header text-white position-relative" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border-radius: 12px 12px 0 0; border: none;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1 fw-bold" style="font-size: 1.1rem;">${caisse.nom_association || 'N/A'}</h5>
                            <small class="opacity-75" style="font-size: 0.8rem;">
                                <i class="fa fa-tag me-1"></i>Code: ${caisse.code || 'N/A'}
                            </small>
                        </div>
                        ${statutBadge}
                    </div>
                </div>

                <div class="card-body" style="padding: 1rem;">
                    <!-- Date de création et Solde disponible -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded" style="border: 1px solid #e9ecef;">
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-calendar me-1"></i>Date de création
                                </div>
                                <div class="fw-bold text-primary" style="font-size: 0.9rem;">
                                    ${dateCreation}
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded" style="border: 1px solid #e9ecef;">
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-money-bill-wave me-1"></i>Solde disponible
                                </div>
                                <div class="fw-bold text-success" style="font-size: 0.9rem;">
                                    ${solde} FCFA
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Localisation -->
                    <div class="mb-3">
                        <div class="text-muted small mb-1">
                            <i class="fa fa-map-marker-alt me-1"></i>Localisation
                        </div>
                        <div class="fw-bold small">${localisation}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Agent: ${caisse.agent_nom || 'Non assigné'}</div>
                    </div>

                    <!-- Exercice en cours (date début et date fin) -->
                    ${exerciceSection}

                    <!-- Les 3 premiers responsables -->
                    <div class="mb-3">
                        <div class="text-muted small mb-2">
                            <i class="fa fa-users me-1"></i>Responsables (3 premiers)
                        </div>
                        <div class="list-group list-group-flush">
                            ${responsablesHtml}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card-footer bg-transparent border-0 pt-0" style="padding: 0 1rem 1rem 1rem;">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-fill" 
                                onclick="voirDetailsCaisse(${caisse.id})" style="font-size: 0.8rem;">
                            <i class="fa fa-eye me-1"></i>Détails
                        </button>
                        <button class="btn btn-outline-success btn-sm flex-fill" 
                                onclick="voirRapportsCaisse(${caisse.id})" style="font-size: 0.8rem;">
                            <i class="fa fa-chart-line me-1"></i>Rapports
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Mettre à jour le compteur de caisses
function updateCaissesCount() {
    const badge = document.getElementById('total-caisses-badge');
    if (badge) {
        badge.textContent = `${allCaisses.length} Caisse${allCaisses.length > 1 ? 's' : ''}`;
    }
}

// Configurer les filtres
function setupCaissesFilters() {
    const searchInput = document.getElementById('searchInput');
    const statutFilter = document.getElementById('statutFilter');
    const sortFilter = document.getElementById('sortFilter');
    const clearFilters = document.getElementById('clearFilters');
    
    if (searchInput) searchInput.addEventListener('input', filterCaisses);
    if (statutFilter) statutFilter.addEventListener('change', filterCaisses);
    if (sortFilter) sortFilter.addEventListener('change', sortCaisses);
    if (clearFilters) clearFilters.addEventListener('click', clearCaissesFilters);
}

// Filtrer les caisses
function filterCaisses() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const statutFilter = document.getElementById('statutFilter')?.value || '';
    
    const filtered = allCaisses.filter(caisse => {
        const nom = (caisse.nom_association || '').toLowerCase();
        const code = (caisse.code || '').toLowerCase();
        const localisation = `${caisse.village_nom || ''}, ${caisse.canton_nom || ''}, ${caisse.commune_nom || ''}`.toLowerCase();
        const statut = caisse.statut;
        
        const matchesSearch = !searchTerm || 
            nom.includes(searchTerm) || 
            code.includes(searchTerm) || 
            localisation.includes(searchTerm);
        
        const matchesStatut = !statutFilter || statut === statutFilter;
        
        return matchesSearch && matchesStatut;
    });
    
    renderCaisses(filtered);
}

// Trier les caisses
function sortCaisses() {
    const sortBy = document.getElementById('sortFilter')?.value || 'date_creation';
    
    const sorted = [...allCaisses].sort((a, b) => {
        switch(sortBy) {
            case 'nom':
                return (a.nom_association || '').localeCompare(b.nom_association || '');
            case 'code':
                return (a.code || '').localeCompare(b.code || '');
            case 'solde':
                return (b.fond_disponible || 0) - (a.fond_disponible || 0);
            case 'date_creation':
            default:
                return new Date(b.date_creation) - new Date(a.date_creation);
        }
    });
    
    renderCaisses(sorted);
}

// Effacer les filtres
function clearCaissesFilters() {
    const searchInput = document.getElementById('searchInput');
    const statutFilter = document.getElementById('statutFilter');
    const sortFilter = document.getElementById('sortFilter');
    
    if (searchInput) searchInput.value = '';
    if (statutFilter) statutFilter.value = '';
    if (sortFilter) sortFilter.value = 'date_creation';
    
    renderCaisses();
}

// Actions sur les caisses
function voirDetailsCaisse(caisseId) {
    window.open(`/adminsecurelogin/gestion_caisses/caisse/${caisseId}/change/`, '_blank');
}

function voirRapportsCaisse(caisseId) {
    window.open(`/gestion-caisses/admin-frontend/?caisse_id=${caisseId}`, '_blank');
}

function voirMembresCaisse(caisseId) {
    window.open(`/adminsecurelogin/gestion_caisses/membre/?caisse__id__exact=${caisseId}`, '_blank');
}

// Charger les caisses quand la section est affichée
function showSection(event, sectionName) {
    // Masquer toutes les sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Désactiver tous les onglets
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Afficher la section demandée
    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Activer l'onglet correspondant
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Charger les caisses si c'est la section caisses et qu'elles ne sont pas encore chargées
    if (sectionName === 'caisses' && !caissesLoaded) {
        loadCaisses();
    }
}

</script>
{% endblock %}
