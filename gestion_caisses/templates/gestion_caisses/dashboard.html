{% extends 'gestion_caisses/base.html' %}
{% load static %}

{% block title %}Tableau de Bord - Gestion des Caisses{% endblock %}

{% block extra_css %}
<style>
/* Styles inspir√©s de index.html (m√™mes fonctionnalit√©s et structure) */
.dashboard-container { display: grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 2rem); background: #f8f9fa; position: relative; }

/* Header de l'application */
.app-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  z-index: 1000;
}

.app-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  padding: 4px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  backdrop-filter: blur(10px);
  overflow: hidden;
}

.logo-icon {
  font-size: 32px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.logo-image {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

.app-title h1 {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.app-title p {
  margin: 5px 0 0 0;
  font-size: 14px;
  opacity: 0.9;
  font-weight: 300;
}
.sidebar { 
  background: #2c3e50; 
  color: #fff; 
  padding: 20px; 
  position: sticky; 
  top: 1rem; 
  height: calc(100vh - 120px); 
  border-radius: 12px; 
  margin-top: 100px;
  overflow-y: auto; 
  overflow-x: hidden; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.user-info { 
  background: rgba(255,255,255,0.08); 
  border-radius: 12px; 
  padding: 20px; 
  margin-bottom: 24px; 
  text-align: center; 
  position: relative; 
  z-index: 5;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.user-avatar { font-size: 42px; margin-bottom: 10px }
.user-name { font-weight: 600 }
.user-role { color: #58a6ff }
.logout-btn { 
  background: #e74c3c; 
  color: #fff; 
  border: none; 
  padding: 10px 16px; 
  border-radius: 8px; 
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
  width: 100%;
  position: relative;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.logout-btn:hover {
  background: #c0392b;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.logout-btn:active {
  transform: translateY(0);
}
.agent-caisse-select,
.agent-caisse-select-mobile {
  background-color: #0f172a !important; /* fond fonc√© pour contraster */
  color: #f9fafb !important;            /* texte tr√®s clair et lisible */
  border-color: #4b5563 !important;
}

.agent-caisse-select option,
.agent-caisse-select-mobile option {
  color: #0f172a;         /* texte fonc√© dans la liste d√©roulante */
  background-color: #f9fafb;
}
.nav-menu { display: flex; flex-direction: column; gap: 8px }
.nav-tab { background: transparent; color: #cbd5e1; border: none; padding: 12px 14px; text-align: left; border-radius: 8px }
.nav-tab.active, .nav-tab:hover { background: rgba(255,255,255,0.12); color: #fff }
.main-content { padding: 20px; padding-top: 120px; }
.content-section { display: none }
.content-section.active { display: block }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 16px; margin-bottom: 20px }
.stat-card { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08); display: flex; align-items: center; gap: 14px }
.stat-icon { font-size: 36px }
.stat-number { font-size: 28px; font-weight: 700 }
.stat-label { color: #6b7280; text-transform: uppercase; font-size: 12px; letter-spacing: .5px }
.dashboard-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px }
.chart-container { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08) }
.alertes-section { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.08) }
.alertes-grid { display: grid; gap: 12px }
.alerte-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; border-left: 4px solid }
.alerte-item.danger { background: #f8d7da; border-left-color: #dc3545; color:#7a1c21 }
.alerte-item.warning { background: #fff3cd; border-left-color: #ffc107; color:#7a5a00 }
.alerte-item.info { background: #d1ecf1; border-left-color: #17a2b8; color:#0c5460 }
.alerte-item.success { background: #d4edda; border-left-color: #28a745; color:#155724 }
/* Centrage des modals */
.modal-dialog { display: flex; align-items: center; min-height: calc(100vh - 2rem); }
.modal-dialog .modal-content { margin: auto; }

/* Rendre tous les formulaires modaux confortables, avec footer toujours visible */
.modal-content {
  display: flex;
  flex-direction: column;
  max-height: 90vh;
}
.modal-body {
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden;
}
.modal-footer {
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  z-index: 10;
  background-color: #fff;
}

/* Assurer la superposition correcte des modales et √©viter le clipping */
.modal { z-index: 9999 !important; overflow: visible !important; }
.modal-backdrop { z-index: 9990 !important; }

/* Styles pour rendre les modaux responsives sur mobile */
@media (max-width: 767.98px) {
  .modal-dialog {
    margin: 0 !important;
    max-width: 100% !important;
    height: 100vh !important;
    min-height: 100vh !important;
    display: flex !important;
    align-items: stretch !important;
  }
  
  .modal-content {
    margin: 0 !important;
    border-radius: 0 !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    max-height: 100vh !important;
  }
  
  .modal-header {
    flex-shrink: 0 !important;
    border-radius: 0 !important;
    padding: 15px !important;
  }
  
  .modal-body {
    flex: 1 1 auto !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 15px !important;
    -webkit-overflow-scrolling: touch !important;
    /* S'assurer que le body ne d√©passe pas */
    max-height: calc(100vh - 140px) !important;
  }
  
  .modal-footer {
    flex-shrink: 0 !important;
    border-radius: 0 !important;
    padding: 15px !important;
    border-top: 2px solid #e0e0e0 !important;
    background-color: #fff !important;
    position: sticky !important;
    bottom: 0 !important;
    z-index: 10 !important;
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 10px !important;
  }
  
  .modal-footer .btn {
    flex: 1 1 auto !important;
    min-width: calc(50% - 5px) !important;
    margin: 0 !important;
    padding: 12px 16px !important;
    font-size: 16px !important;
  }
  
  /* Emp√™cher le body de scroller quand le modal est ouvert */
  body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
  }
}

/* Responsive pour tablettes */
@media (min-width: 768px) and (max-width: 991.98px) {
  .modal-dialog {
    margin: 10px !important;
    max-width: calc(100% - 20px) !important;
  }
  
  .modal-content {
    max-height: 90vh !important;
  }
  
  .modal-body {
    max-height: calc(90vh - 140px) !important;
    overflow-y: auto !important;
  }
  
  .modal-footer {
    padding: 15px !important;
  }
  
  .modal-footer .btn {
    min-width: 120px !important;
  }
}
/* Barre de recherche */
.search-bar { max-width: 420px }
@media (max-width: 1024px){ 
  .dashboard-container { grid-template-columns: 1fr } 
  .sidebar { position: static; height: auto; margin-top: 0; } 
  .dashboard-charts{ grid-template-columns:1fr } 
  .main-content { padding-top: 20px; }
  .app-header { padding: 15px 20px; }
  .app-title h1 { font-size: 24px; }
  .app-title p { font-size: 12px; }
  .logo-icon { font-size: 28px; }
  .app-logo { width: 50px; height: 50px; }
  
  /* Am√©liorer la visibilit√© du bouton de d√©connexion sur mobile */
  .logout-btn {
    padding: 12px 20px;
    font-size: 16px;
    margin-top: 15px;
  }
  
  .user-info {
    padding: 25px 20px;
    margin-bottom: 30px;
  }
}

/* Cacher le sidebar fixe sur mobile - utiliser uniquement le menu hamburger */
@media (max-width: 991.98px) {
  .dashboard-container { 
    grid-template-columns: 1fr;
  }
  
  .sidebar { 
    display: none !important; 
  }
  
  .main-content { 
    padding-top: 20px;
    width: 100%;
  }
  
  .app-header {
    position: relative;
    margin-bottom: 20px;
  }
  
  /* Am√©lioration des sections pour mobile */
  .content-section h2 {
    font-size: 1.5rem !important;
  }
  
  /* En-t√™tes flexibles */
  .d-flex.justify-content-between,
  .d-flex.align-items-center.justify-content-between {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 15px !important;
  }
  
  /* Boutons responsive - permettre le wrap */
  .d-flex.gap-2 {
    width: 100% !important;
  }
  
  .d-flex.gap-2 .btn {
    flex: 1 1 auto !important;
    min-width: calc(50% - 5px) !important;
    margin-bottom: 10px !important;
  }
  
  /* Boutons seuls en pleine largeur */
  .btn:not(.d-flex .btn) {
    width: 100% !important;
    margin-bottom: 10px !important;
  }
  
  /* Search bar responsive */
  .search-bar {
    max-width: 100% !important;
    width: 100% !important;
  }
  
  /* Stats grid responsive */
  .stats-grid {
    grid-template-columns: 1fr !important;
  }
  
  /* Tableaux responsive */
  .table-responsive {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  
  table {
    font-size: 0.875rem !important;
  }
  
  /* Cartes responsive */
  .card {
    margin-bottom: 15px !important;
  }
  
  /* Formulaires responsive */
  .row.g-3,
  .row.g-4 {
    margin: 0 !important;
  }
  
  .row.g-3 > *,
  .row.g-4 > * {
    padding: 0 0 15px 0 !important;
  }
}

/* Am√©liorations sp√©cifiques pour tr√®s petits √©crans */
@media (max-width: 575.98px) {
  .main-content {
    padding: 10px !important;
  }
  
  .content-section h2 {
    font-size: 1.25rem !important;
  }
  
  .stat-card {
    padding: 12px !important;
  }
  
  .stat-icon {
    font-size: 28px !important;
  }
  
  .stat-number {
    font-size: 24px !important;
  }
  
  .chart-container {
    padding: 12px !important;
  }
  
  .chart-container h3 {
    font-size: 1rem !important;
  }
  
  /* Boutons plus petits mais touchables */
  .btn {
    padding: 10px 16px !important;
    font-size: 14px !important;
  }
  
  /* Filtres empil√©s */
  .filter-row,
  .row.g-3 {
    flex-direction: column !important;
  }
  
  .col-md-4,
  .col-md-3,
  .col-md-2,
  .col-md-6 {
    width: 100% !important;
    max-width: 100% !important;
  }
}

/* Styles pour les modals modernes */
.modal-content {
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
  border-radius: 15px 15px 0 0;
}

.modal-footer {
  border-radius: 0 0 15px 15px;
}

.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.alert {
  border-radius: 10px;
  border: none;
}

.card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Styles pour les rapports */
.stat-item {
  text-align: center;
  padding: 15px;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  margin-bottom: 10px;
}

.stat-item h3, .stat-item h4 {
  margin: 0;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.stat-item small {
  color: #6c757d;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table-responsive {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.table th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

.table td {
  vertical-align: middle;
}

.badge.bg-pink {
  background-color: #e83e8c !important;
}

.badge.bg-blue {
  background-color: #007bff !important;
}

/* Animation pour les cartes de rapport */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Styles pour les filtres de rapport */
.form-control:focus, .form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-group .btn {
  border-radius: 6px;
  margin: 0 2px;
}

.btn-group .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Styles pour les toasts */
.toast {
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Animation pour les spinners */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.spinner-border {
  animation: spinner-border 0.75s linear infinite, pulse 2s ease-in-out infinite;
}

/* Styles pour les listes dans les modals */
.list-unstyled li {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.list-unstyled li:last-child {
  border-bottom: none;
}

/* Styles pour les ic√¥nes */
.fas, .fa {
  margin-right: 8px;
}

/* Styles pour les tableaux dans les modals */
.table {
  border-radius: 8px;
  overflow: hidden;
}

.table th {
  background-color: #f8f9fa;
  border: none;
  font-weight: 600;
}

.table td {
  border: none;
  border-bottom: 1px solid #f0f0f0;
}

/* Styles pour les boutons dans les modals */
.modal-footer .btn {
  min-width: 120px;
}

/* Styles pour les alertes dans les modals */
.alert-info {
  background-color: #e3f2fd;
  color: #0d47a1;
}

.alert-success {
  background-color: #e8f5e8;
  color: #1b5e20;
}

.alert-warning {
  background-color: #fff3e0;
  color: #e65100;
}

.alert-danger {
  background-color: #ffebee;
  color: #c62828;
}

/* Styles pour les badges et statuts */
.badge {
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

/* Styles pour les cartes de pr√™ts */
.pret-card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.pret-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

/* Styles pour les barres de progression */
.progress {
  border-radius: 10px;
  height: 20px;
  background-color: #f0f0f0;
}

.progress-bar {
  border-radius: 10px;
  font-size: 10px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Styles pour les animations de chargement */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  background-color: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Styles pour les notifications */
.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #dc3545;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Styles pour les tooltips personnalis√©s */
.custom-tooltip {
  position: relative;
  cursor: help;
}

.custom-tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
}

/* Styles pour les formulaires dans les modals */
.form-control, .form-select {
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

/* Styles pour les labels */
.form-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 8px;
}

/* Styles pour les messages d'erreur */
.text-danger {
  font-size: 0.875rem;
  font-weight: 500;
}

/* Styles pour les messages de succ√®s */
.text-success {
  font-weight: 600;
}

/* Styles pour les ic√¥nes dans les boutons */
.btn i {
  margin-right: 6px;
}

/* Styles pour les modals de confirmation */
.confirmation-modal .modal-content {
  border: 3px solid #28a745;
}

/* Styles pour les modals de succ√®s */
.success-modal .modal-content {
  border: 3px solid #28a745;
}

/* Styles pour les modals d'erreur */
.error-modal .modal-content {
  border: 3px solid #dc3545;
}

/* Styles pour les animations d'entr√©e */
.modal.fade .modal-dialog {
  transform: scale(0.8);
  transition: transform 0.3s ease;
}

.modal.show .modal-dialog {
  transform: scale(1);
}

/* Styles pour les animations de sortie */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease;
}

/* Styles pour les toasts avec animations */
.toast {
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Styles pour les boutons de fermeture */
.btn-close {
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.btn-close:hover {
  background-color: rgba(255,255,255,0.2);
  transform: rotate(90deg);
}

/* Styles pour les sections dans les modals */
.modal-section {
  padding: 20px 0;
  border-bottom: 1px solid #f0f0f0;
}

.modal-section:last-child {
  border-bottom: none;
}

/* Styles pour les titres de sections */
.section-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #007bff;
}

/* Styles pour les listes d'actions */
.action-list {
  list-style: none;
  padding: 0;
}

.action-list li {
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
}

.action-list li:last-child {
  border-bottom: none;
}

.action-list li i {
  margin-right: 10px;
  width: 20px;
  text-align: center;
}

/* Styles pour les informations importantes */
.important-info {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.important-info h6 {
  color: #856404;
  margin-bottom: 10px;
}

.important-info ul {
  margin-bottom: 0;
  padding-left: 20px;
}

.important-info li {
  color: #856404;
  margin-bottom: 5px;
}
</style>
{% endblock %}
{% block content %}
<div class="dashboard-container container-fluid">
  <!-- Header avec logo et nom de l'application -->
  <div class="app-header">
    <div class="app-logo">
      {% if logo %}
        <img src="{{ logo.url }}" alt="Logo" class="logo-image">
      {% else %}
        <span class="logo-icon">‚Ç¨</span>
      {% endif %}
    </div>
    <div class="app-title">
      <h1>{{ nom_application|default:"CashFlow Pro FKM" }}</h1>
      <p>{{ description_application|default:"Gestion des Caisses FKM" }}</p>
    </div>
  </div>
  
  <div class="sidebar">
    <div class="user-info">
      <div class="user-avatar">üë§</div>
      <div class="user-name" id="user-name">{{ user.first_name }} {{ user.last_name }}</div>
      <div class="user-role" id="user-role">{{ user_role }}</div>
      {% if user_role == 'Agent' %}
      <div class="agent-caisse-selector" style="margin-top: 15px; margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #ccc;">Caisse active :</label>
        <select id="agent-caisse-select" class="form-select form-select-sm agent-caisse-select" style="width: 100%; font-size: 0.9em;">
          <option value="">Chargement...</option>
        </select>
      </div>
      {% endif %}
      <button class="logout-btn" onclick="handleLogout()">üö™ D√©connexion</button>
    </div>
    <nav class="nav-menu">
              <button class="nav-tab active" onclick="showSection(event,'dashboard')">üìä Dashboard</button>
        <button class="nav-tab" onclick="showSection(event,'caisses')">üè¶ Caisses</button>
        <button class="nav-tab" onclick="showSection(event,'membres')">üë• Membres</button>
        <button class="nav-tab" id="tab-prets" onclick="showSection(event,'prets')">üí∞ Pr√™ts</button>
        {% if user_role == 'Administrateur' %}
        <button class="nav-tab" onclick="showSection(event,'salaires')">üßæ Salaires Agents</button>
        {% endif %}
        <button class="nav-tab" id="tab-depenses" onclick="showSection(event,'depenses')">üí∏ D√©penses</button>
        <button class="nav-tab" id="tab-rapports" onclick="showSection(event,'rapports')">üìà Rapports</button>
        {% if user_role == 'Administrateur' %}
        <button class="nav-tab" onclick="showSection(event,'frais_fondation')">üèõÔ∏è Frais Fondation</button>
        <button class="nav-tab" onclick="showSection(event,'motifs')">üóÇÔ∏è Motifs Pr√™ts</button>
        {% endif %}
        <button class="nav-tab" onclick="showSection(event,'seances')">üóìÔ∏è S√©ances</button>
        <button class="nav-tab" onclick="showSection(event,'cotisations')">üíµ Cotisations</button>
        {% if user_role == 'Administrateur' %}
        <button class="nav-tab" onclick="showSection(event,'partage')">ü§ù Partage de fonds</button>
        {% endif %}
    </nav>
  </div>

  <div class="main-content">
    <div id="dashboard" class="content-section active">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h2 id="dashboard-title" class="m-0">üìä Tableau de Bord ‚Äî {{ caisse_nom }}</h2>
        {% if user_role == 'Agent' %}
        <!-- S√©lecteur de caisse actif modernis√© pour mobile -->
        <div class="d-md-none w-100">
          <div class="card border-0 shadow-sm rounded-3 p-2" style="background: rgba(15, 23, 42, 0.85);">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small text-uppercase text-muted">Caisse active</span>
              <span id="agent-active-caisse-label-mobile" class="badge bg-primary text-wrap" style="max-width: 70%; font-size: 0.75rem;">
                S√©lectionner une caisse
              </span>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-transparent border-secondary text-primary-emphasis">üè¶</span>
              <select id="agent-caisse-select-mobile" class="form-select form-select-sm border-secondary agent-caisse-select-mobile"
                      onchange="if (typeof updateMobileActiveCaisseLabel === 'function') { updateMobileActiveCaisseLabel(); }">
                <option value="">Chargement...</option>
              </select>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üè¶</div><div><div class="stat-number" id="total-caisses">0</div><div class="stat-label">Total Caisses</div></div></div>
        <div class="stat-card"><div class="stat-icon">üë•</div><div><div class="stat-number" id="total-membres">0</div><div class="stat-label">Total Membres</div></div></div>
        <div class="stat-card"><div class="stat-icon">üí∞</div><div><div class="stat-number" id="total-fonds">0 FCFA</div><div class="stat-label">Fonds Disponibles</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìä</div><div><div class="stat-number" id="total-prets">0</div><div class="stat-label">Pr√™ts Actifs</div></div></div>
        </div>
      <div class="dashboard-charts">
        <div class="chart-container">
          <h3>üìà √âvolution des Pr√™ts</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="evolutionChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <h3>üèÜ Caisses par R√©gion</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="regionsChart"></canvas>
          </div>
        </div>
      </div>
      <div class="alertes-section">
        <h3>üö® Alertes</h3>
        <div id="alertes-list" class="alertes-grid"></div>
        </div>
    </div>
    <div id="frais_fondation" class="content-section">
      <h2>üèõÔ∏è Frais de Fondation</h2>
      <div class="card shadow-sm my-3">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">Somme totale des frais de fondation</div>
            <div class="display-6 fw-bold" id="total-frais-fondation">‚Äî</div>
          </div>
          <button class="btn btn-outline-primary" onclick="loadFraisFondationTotal()">
            Actualiser
          </button>
        </div>
      </div>
      <p class="text-muted small">
        Valeur agr√©g√©e {% if user_role == 'Administrateur' %}sur l'ensemble des caisses du syst√®me{% else %}sur votre caisse{% endif %}.
      </p>
    </div>
    {% if user_role == 'Administrateur' %}
    <div id="partage" class="content-section">
      <h2>ü§ù Partage de fonds</h2>
      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            {% if user_role == 'Administrateur' %}
            <div class="col-md-5">
              <label class="form-label">Caisse</label>
              <select id="partage-caisse-select" class="form-select">
                <option value="">Chargement...</option>
              </select>
            </div>
            {% endif %}
            <div class="col-md-5">
              <label class="form-label">Exercice</label>
              <select id="partage-exercice-select" class="form-select">
                <option value="">S√©lectionner un exercice</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <h5 class="m-0">R√©sultats</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="text-muted small" id="partage-totaux">Base: 0 | Int√©r√™t total: 0</div>
              <button id="partage-btn-pdf" class="btn btn-sm btn-outline-primary" type="button" onclick="telechargerPartagePdf()" disabled>
                <i class="fa fa-file-pdf-o me-1"></i>PDF
              </button>
            </div>
          </div>
          <div id="partage-pdf-warning" class="alert alert-warning alert-dismissible fade show d-none" role="alert" style="margin-bottom: 1rem;">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <strong>PDF indisponible :</strong> Le partage de fonds ne peut pas √™tre g√©n√©r√© en PDF pour un exercice dont le statut est "En cours". Veuillez cl√¥turer l'exercice avant de g√©n√©rer le PDF.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Membre</th>
                  <th class="text-end">Principal (hors fondation)</th>
                  <th class="text-end">Int√©r√™t</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="partage-table-body">
                <tr><td colspan="4" class="text-center text-muted">Aucune donn√©e</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <p class="text-muted small mt-2">
        Le principal correspond √† la somme des cotisations de l'exercice, hors frais de fondation. L'int√©r√™t est r√©parti proportionnellement au principal.
      </p>
    </div>
    {% endif %}
    <div id="caisses" class="content-section">
      <!-- En-t√™te avec statistiques -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="fa fa-building me-2 text-primary"></i>
          Gestion des Caisses
        </h2>
        <div class="d-flex gap-2 flex-wrap justify-content-end">
          <span class="badge bg-primary fs-6 align-self-center" id="total-caisses-badge">0 Caisse</span>
          {% if user_role == 'Administrateur' %}
          <a href="{% url 'admin:gestion_caisses_caisse_add' %}" class="btn btn-primary btn-sm" target="_blank" rel="noopener">
            <i class="fa fa-plus me-1"></i>Nouvelle Caisse
          </a>
          {% endif %}
          <button class="btn btn-outline-primary btn-sm" onclick="loadCaisses()">
            <i class="fa fa-refresh me-1"></i>Actualiser
          </button>
        </div>
      </div>

      <!-- Filtres et recherche -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Rechercher une caisse</label>
              <input type="text" id="searchInput" class="form-control" placeholder="Nom, code ou localisation...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Statut</label>
              <select id="statutFilter" class="form-select">
                <option value="">Tous les statuts</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
                <option value="SUSPENDUE">Suspendue</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Tri par</label>
              <select id="sortFilter" class="form-select">
                <option value="date_creation">Date de cr√©ation</option>
                <option value="nom">Nom</option>
                <option value="solde">Solde disponible</option>
                <option value="code">Code</option>
              </select>
            </div>
            <div class="col-md-2">
              <button id="clearFilters" class="btn btn-outline-secondary w-100">
                <i class="fa fa-times me-1"></i>Effacer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Grille des cartes -->
      <div class="row g-4" id="caissesGrid">
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-2 text-muted">Chargement des caisses...</p>
        </div>
      </div>
    </div>
    <div id="membres" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">üë• Gestion des Membres</h2>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <select id="membreCaisseFilter" class="form-select form-select-sm" style="min-width: 220px;" onchange="filterMembers()">
            <option value="">Toutes les caisses</option>
          </select>
          <input id="membreSearch" class="form-control search-bar" placeholder="Rechercher un membre..." oninput="filterMembers()" />
          <button class="btn btn-success" onclick="openMembreModal()">+ Nouveau Membre</button>
          <button class="btn btn-info" onclick="generateMembresListePDF(USER_CAISE_ID)" title="G√©n√©rer la liste compl√®te des membres en PDF">
            <i class="fas fa-file-pdf"></i> Liste PDF
          </button>
        </div>
      </div>
      <div id="membres-content" class="mt-3"></div>
    </div>
    <div id="prets" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h2 class="m-0">üí∞ Gestion des Pr√™ts</h2>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-warning" onclick="generateEcheancesRetardPDF(event)" title="G√©n√©rer le rapport des √©ch√©ances en retard">
            <i class="fas fa-exclamation-triangle"></i> <span class="d-none d-md-inline">√âch√©ances en Retard</span><span class="d-md-none">Retard</span>
          </button>
          <button class="btn btn-primary" onclick="openPretModal()">+ Nouveau Pr√™t</button>
        </div>
      </div>
      <div id="prets-content" class="mt-3"></div>
    </div>
    {% if user_role == 'Administrateur' %}
    <div id="salaires" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">üßæ Salaires des Agents</h2>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-secondary" onclick="loadSalairesAgents()">‚Üª Actualiser</button>
          <button class="btn btn-primary" onclick="genererFichesMensuelles()">üñ®Ô∏è G√©n√©rer fiches (mois courant)</button>
        </div>
      </div>
      <div id="salaires-alerts" class="mt-2"></div>
      <div class="row g-2 mt-2">
        <div class="col-6 col-md-2">
          <label class="form-label small mb-1">Mois</label>
          <select id="salaires-mois" class="form-select" onchange="loadSalairesAgents()">
            <option value="">Tous</option>
            <option value="1">Janvier</option><option value="2">F√©vrier</option><option value="3">Mars</option>
            <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>
            <option value="7">Juillet</option><option value="8">Ao√ªt</option><option value="9">Septembre</option>
            <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">D√©cembre</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label small mb-1">Ann√©e</label>
          <input id="salaires-annee" type="number" class="form-control" min="2000" max="2100" onchange="loadSalairesAgents()" />
        </div>
        <div class="col-12 col-md-8 d-flex align-items-end justify-content-end">
          <button class="btn btn-success" onclick="openCreateSalaireForm()">+ Nouveau salaire</button>
        </div>
      </div>
      <div id="salaire-form" class="card mt-2" style="display:none">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label for="sf-agent" class="form-label mb-1">Agent</label>
              <select id="sf-agent" class="form-select" onchange="checkSalaireDuplicate()"><option value="">S√©lectionner un agent...</option></select>
              <div class="form-text">Choisissez l'agent concern√© par ce salaire.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-mois" class="form-label mb-1">Mois</label>
              <select id="sf-mois" class="form-select" onchange="checkSalaireDuplicate()">
                <option value="">Mois</option>
                <option value="1">Janvier</option><option value="2">F√©vrier</option><option value="3">Mars</option>
                <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>
                <option value="7">Juillet</option><option value="8">Ao√ªt</option><option value="9">Septembre</option>
                <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">D√©cembre</option>
              </select>
              <div class="form-text">S√©lectionnez le mois de paie.</div>
            </div>
            <div class="col-6 col-md-2">
              <label for="sf-annee" class="form-label mb-1">Ann√©e</label>
              <input id="sf-annee" type="number" min="2000" max="2100" class="form-control" placeholder="Ann√©e" oninput="checkSalaireDuplicate()" />
              <div class="form-text">Saisissez l'ann√©e (ex: 2025).</div>
            </div>
            <div class="col-12"><div id="sf-duplicate" class="alert alert-warning py-2 px-3" style="display:none">Un salaire existe d√©j√† pour cet agent et cette p√©riode.</div></div>
            <div class="col-6 col-md-3">
              <label for="sf-base" class="form-label mb-1">Salaire de base</label>
              <input id="sf-base" type="number" step="0.01" class="form-control" placeholder="0.00" />
              <div class="form-text">Montant fixe mensuel en FCFA.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-bonus" class="form-label mb-1">Bonus caisses</label>
              <input id="sf-bonus" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Bonus li√© aux nouvelles caisses cr√©√©es.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-prime" class="form-label mb-1">Prime de performance</label>
              <input id="sf-prime" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Prime additionnelle √©ventuelle.</div>
            </div>
            <div class="col-6 col-md-3">
              <label for="sf-ded" class="form-label mb-1">D√©ductions</label>
              <input id="sf-ded" type="number" step="0.01" class="form-control" placeholder="0.00" value="0" />
              <div class="form-text">Retenues et charges √† d√©duire.</div>
            </div>
            <div class="col-12">
              <label for="sf-notes" class="form-label mb-1">Notes</label>
              <input id="sf-notes" type="text" class="form-control" placeholder="Informations compl√©mentaires (optionnel)" />
              <div class="form-text">Ajoutez un commentaire interne si n√©cessaire.</div>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-secondary" onclick="toggleSalaireForm()">Annuler</button>
            <button id="sf-submit" class="btn btn-primary" onclick="soumettreSalaireAgent()">Enregistrer</button>
          </div>
        </div>
      </div>
      <div id="salaires-stats" class="mt-3"></div>
      <div id="salaires-list" class="mt-3"></div>
      <div id="fiches-list" class="mt-3"></div>
    </div>
    {% endif %}
    <div id="seances" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">üóìÔ∏è S√©ances de R√©union</h2>
        <div class="d-flex gap-2 align-items-center">
          <button id="btnNewSeance" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#seanceModal">+ Nouvelle S√©ance</button>
        </div>
      </div>
      <div id="seances-list" class="mt-3"></div>
    </div>
    <div id="cotisations" class="content-section">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">üíµ Cotisations</h2>
        <div class="d-flex gap-2 align-items-center">
          <button id="btnNewCotisation" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cotisationModal">+ Nouvelle Cotisation</button>
        </div>
      </div>
      <div class="mt-3">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">üìä Totaux</h5>
                <div class="row text-center">
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Tempon</div>
                    <div class="fw-bold" id="statTempon">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Solidarit√©</div>
                    <div class="fw-bold" id="statSolidarite">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Fondation</div>
                    <div class="fw-bold" id="statFondation">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">P√©nalit√©</div>
                    <div class="fw-bold" id="statPenalite">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold" id="statTotal">0</div>
                  </div>
                  <div class="col-6 col-md-4 mb-2">
                    <div class="text-muted small"># Cotisations</div>
                    <div class="fw-bold" id="statNombre">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">üìà S√©rie mensuelle</h5>
                <canvas id="cotisationsChart" height="160"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                  <h5 class="card-title m-0">üë§ Stats par membre</h5>
                  <div class="d-flex gap-2">
                    {% if user_role == 'Administrateur' %}
                    <select id="statsCaisse" class="form-select" style="min-width:220px"></select>
                    {% endif %}
                    <select id="statsMembre" class="form-select" style="min-width:280px" onchange="refreshMemberStats()"></select>
                  </div>
                </div>
                <div class="row text-center mb-3">
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Mois cotis√©s</div>
                    <div class="fw-bold" id="mStatMois">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold" id="mStatTotal">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Tempon</div>
                    <div class="fw-bold" id="mStatTempon">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">Solidarit√©</div>
                    <div class="fw-bold" id="mStatSolidarite">0</div>
                  </div>
                  <div class="col-6 col-md-3 mb-2">
                    <div class="text-muted small">P√©nalit√©s</div>
                    <div class="fw-bold" id="mStatPenalite">0</div>
                  </div>
                </div>
                <canvas id="cotisationsMemberChart" height="120"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="cotisations-list" class="mt-3"></div>
    </div>
    
    <!-- Section D√©penses -->
    <div id="depenses" class="content-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üí∏ Gestion des D√©penses</h2>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" onclick="openDepenseCreateModal()">
            <i class="fas fa-plus"></i> Nouvelle D√©pense
          </button>
          <button type="button" class="btn btn-outline-info" onclick="chargerDepenses()">
            <i class="fas fa-sync"></i> Actualiser
          </button>
        </div>
      </div>

      <!-- Statistique des d√©penses (Solde disponible uniquement) -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Solde Disponible</h6>
                  <h4 id="solde-depenses" class="mb-0">0 FCFA</h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-wallet fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export PDF D√©penses entre deux dates -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Date de d√©but</label>
              <input type="date" class="form-control" id="depenses-date-debut" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Date de fin</label>
              <input type="date" class="form-control" id="depenses-date-fin" />
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-danger" onclick="exportDepensesPDF(this)">
                <i class="fas fa-file-pdf"></i> PDF D√©penses (p√©riode)
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste des d√©penses -->
      <div class="card">
        <div class="card-body">
          <div id="depenses-list">
            <div class="text-center py-5">
              <i class="fas fa-list fa-3x text-muted mb-3"></i>
              <p class="text-muted">Cliquez sur "Actualiser" pour charger la liste des d√©penses</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="rapports" class="content-section">
      <style>
        .rapports-header{gap:1rem;flex-wrap:wrap}
        .rapports-header h2{flex:1 1 220px}
        .report-toolbar{gap:.5rem;flex:1 1 320px;justify-content:flex-end}
        .report-btn{border-radius:999px;padding:.35rem .6rem;box-shadow:0 2px 8px rgba(0,0,0,.06);display:inline-flex;align-items:center;gap:.35rem;font-weight:600;font-size:.85rem;transition:transform .08s ease,box-shadow .2s ease}
        .report-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.09)}
        .report-sep{width:1px;background:rgba(0,0,0,.06);margin:0 .25rem}
        @media (max-width: 992px){
          .report-toolbar{justify-content:flex-start}
        }
        @media (max-width: 768px){
          .report-toolbar{width:100%;flex-wrap:nowrap;overflow-x:auto;padding-bottom:.35rem}
          .report-toolbar::-webkit-scrollbar{height:6px}
          .report-btn{flex:0 0 auto}
          .report-btn span{white-space:nowrap}
          .report-sep{display:none!important}
        }
        @media (max-width: 576px){
          .report-toolbar{overflow-x:visible;flex-wrap:wrap}
          .report-btn{width:calc(50% - .35rem);justify-content:center}
          .rapports-header h2{flex-basis:100%}
          #rapports .card .btn{width:100%}
          #rapports .card .d-flex.align-items-end{align-items:stretch}
        }
        @media (max-width: 420px){
          .report-btn{width:100%}
        }
      </style>
      <div class="rapports-header d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">üìà Rapports et Statistiques</h2>
        <div class="d-flex flex-wrap report-toolbar">
          <button type="button" class="btn btn-sm btn-outline-primary report-btn" title="Rapport g√©n√©ral (PDF)" onclick="genererRapportPDF('general', this)"><i class="fas fa-chart-line"></i><span>G√©n√©ral</span></button>
          <button type="button" class="btn btn-sm btn-outline-success report-btn" title="Rapport financier (PDF)" onclick="genererRapportPDF('financier', this)"><i class="fas fa-coins"></i><span>Financier</span></button>
          <button type="button" class="btn btn-sm btn-outline-info report-btn" title="Rapport des pr√™ts (PDF)" onclick="genererRapportPDF('prets', this)"><i class="fas fa-hand-holding-usd"></i><span>Pr√™ts</span></button>
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-outline-danger report-btn" title="Cotisations (g√©n√©ral) en PDF" onclick="genererRapportPDF('cotisations_general', this)"><i class="fas fa-file-invoice-dollar"></i><span>Cotisations</span></button>
          <button type="button" class="btn btn-sm btn-outline-danger report-btn" title="Cotisations par membre (PDF)" onclick="genererRapportPDF('cotisations_par_membre', this)"><i class="fas fa-user-friends"></i><span>Par membre</span></button>
          <button type="button" class="btn btn-sm btn-outline-warning report-btn" title="D√©penses (PDF)" onclick="genererRapportPDF('depenses', this)"><i class="fas fa-receipt"></i><span>D√©penses</span></button>
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir cotisations (g√©n√©ral)" onclick="chargerRapportCotisations()"><i class="fas fa-list"></i><span>Voir cotisations</span></button>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir cotisations par membre" onclick="chargerRapportCotisationsParMembre()"><i class="fas fa-user"></i><span>Par membre</span></button>
          <button type="button" class="btn btn-sm btn-outline-secondary report-btn" title="Voir d√©penses" onclick="chargerRapportDepenses()"><i class="fas fa-list"></i><span>Voir d√©penses</span></button>
          {% if user_role != 'Administrateur' %}
          <button type="button" class="btn btn-sm btn-outline-primary report-btn" title="Pr√©parer rapport membre" onclick="(function(){ const contenuRapport = document.getElementById('contenu-rapport'); contenuRapport.innerHTML = afficherRapportCotisationsMembre({items:[], totaux:{}, membre:{nom:''}}); initRapportMembreSelect(); })()"><i class="fas fa-user-check"></i><span>Membre</span></button>
          {% endif %}

          {% if user_role == 'Administrateur' %}
          <div class="report-sep d-none d-md-block"></div>
          <button type="button" class="btn btn-sm btn-primary report-btn" title="PDF - Tous les membres par caisse" onclick="telechargerMembresSystemePDF(this)"><i class="fas fa-users"></i><span>Membres PDF</span></button>
          <button type="button" class="btn btn-sm btn-dark report-btn" title="PDF - Tous les agents" onclick="telechargerAgentsSystemePDF(this)"><i class="fas fa-id-badge"></i><span>Agents PDF</span></button>
          <button type="button" class="btn btn-sm btn-danger report-btn" title="PDF - √âvaluation des pr√™ts" onclick="telechargerPretsEvaluationPDF(this)"><i class="fas fa-clipboard-check"></i><span>√âval. Pr√™ts</span></button>
          {% endif %}
        </div>
      </div>

      <!-- Filtres de date -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Filtres de p√©riode</h5>
          <div class="row">
            <div class="col-md-3">
              <label for="date-debut" class="form-label">Date de d√©but</label>
              <input type="date" class="form-control" id="date-debut">
            </div>
            <div class="col-md-3">
              <label for="date-fin" class="form-label">Date de fin</label>
              <input type="date" class="form-control" id="date-fin">
            </div>
            <div class="col-md-3">
              <label for="type-rapport" class="form-label">Type de rapport</label>
              <select class="form-select" id="type-rapport">
                <option value="general">Rapport G√©n√©ral</option>
                <option value="financier">Rapport Financier</option>
                <option value="prets">Rapport des Pr√™ts</option>
                <option value="membres">Rapport des Membres</option>
                <option value="echeances">Rapport des √âch√©ances</option>
              </select>
            </div>
            {% if user_role == 'Agent' %}
            <div class="col-md-3">
              <label for="rapport-caisse-select" class="form-label">Caisse pour les rapports</label>
              <select id="rapport-caisse-select" class="form-select form-select-sm">
                <option value="">Ma caisse active</option>
                <option value="_ALL_MY_">Toutes mes caisses</option>
              </select>
              <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                Uniquement vos propres caisses sont affich√©es (ou toutes vos caisses).
              </small>
            </div>
            {% endif %}
            <div class="col-md-3 d-flex align-items-end mt-3 mt-md-0">
              <button class="btn btn-primary" onclick="chargerRapport()">
                <i class="fas fa-search"></i> Charger
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenu du rapport -->
      <div id="contenu-rapport">
        <div class="text-center py-5">
          <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
          <p class="text-muted">S√©lectionnez un type de rapport et cliquez sur "Charger" pour afficher les donn√©es</p>
        </div>
      </div>
    </div>
    {% if user_role == 'Administrateur' %}
    <div id="motifs" class="content-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">üóÇÔ∏è Motifs des Pr√™ts</h2>
        <div class="d-flex gap-2">
          <select id="motif-select" class="form-select form-select-sm" style="width:200px">
            <option value="">Tous les motifs</option>
            <option value="commerce">Commerce</option>
            <option value="agriculture">Agriculture</option>
            <option value="sante">Sant√©</option>
            <option value="education">√âducation</option>
            <option value="logement">Logement</option>
            <option value="autres">Autres</option>
          </select>
          <button class="btn btn-sm btn-outline-primary" onclick="chargerPretsParMotif()"><i class="fas fa-search"></i> Filtrer</button>
          <button class="btn btn-sm btn-primary" onclick="telechargerPretsParMotifPDF(this)"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
      </div>
      <div id="motifs-content">
        <div class="text-muted">Choisissez un motif et cliquez sur Filtrer.</div>
      </div>
    </div>
    {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let evolutionChart, regionsChart;

document.addEventListener('DOMContentLoaded', function() {
  try {
    // Am√©liorer l'affichage des modaux sur mobile
    const allModals = document.querySelectorAll('.modal');
    allModals.forEach(modal => {
      modal.addEventListener('shown.bs.modal', function() {
        // Ajouter la classe modal-open au body pour emp√™cher le scroll
        document.body.classList.add('modal-open');
        // S'assurer que le footer est visible
        const footer = this.querySelector('.modal-footer');
        if (footer) {
          footer.style.display = 'flex';
          footer.style.visibility = 'visible';
        }
      });
      
      modal.addEventListener('hidden.bs.modal', function() {
        // Retirer la classe modal-open du body
        document.body.classList.remove('modal-open');
        document.body.style.position = '';
        document.body.style.width = '';
      });
    });
    
    // Attacher handlers explicites sur les boutons pour fiabilit√©
    document.getElementById('btnNewSeance')?.addEventListener('click', openSeanceCreateModal);
    document.getElementById('btnNewCotisation')?.addEventListener('click', openCotisationCreateModal);
    // Accessibilit√©: placer le focus dans le premier champ quand une modale s'affiche
    document.getElementById('seanceModal')?.addEventListener('shown.bs.modal', () => {
      const el = document.getElementById('seanceModal');
      try { el?.removeAttribute('aria-hidden'); } catch {}
      const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
      if (isAdmin) { try { loadSeanceCaisses(); } catch(e){ console.warn(e); } }
      document.getElementById('seanceDate')?.focus();
    });
    document.getElementById('cotisationModal')?.addEventListener('shown.bs.modal', () => {
      const el = document.getElementById('cotisationModal');
      try { el?.removeAttribute('aria-hidden'); } catch {}
      const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
      if (isAdmin) {
        try { loadCotisationCaisses(); } catch(e){ console.warn(e); }
      } else {
        try { hydrateMembresSelect(); hydrateSeancesSelect(); } catch(e){ console.warn(e); }
      }
      document.getElementById('cotisationMembre')?.focus();
    });
  } catch(e) { console.warn('Bind buttons error', e); }

  loadDashboardData();
  loadAlertes();
  fetchUserContext().then(() => { 
    // loadCaisse() n'est appel√© que si l'√©l√©ment existe (gestion interne de la fonction)
    loadCaisse(); 
    loadMembers(); 
    loadPrets(); 
  });
});

// Helpers de dates s√ªrs c√¥t√© frontend
function parseDateMaybe(value){
  if(!value) return null;
  try {
    // Supporte ISO, timestamps, et formats communs
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  } catch { return null; }
}
function formatDateSafe(value){
  const d = parseDateMaybe(value);
  return d ? d.toLocaleDateString('fr-FR') : (value||'');
}
function formatDateTimeSafe(value){
  const d = parseDateMaybe(value);
  return d ? d.toLocaleString('fr-FR') : (value||'');
}

function showSection(evt, id){
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  const section = document.getElementById(id);
  if (!section) {
    console.warn(`Section "${id}" not found`);
    return;
  }
  section.classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  evt.currentTarget.classList.add('active');
  if (id === 'dashboard') loadDashboardData();
  if (id === 'depenses') {
    try { chargerDepenses(); } catch(e) { console.error(e); }
  }
  if (id === 'salaires') {
    try { loadSalairesAgents(); } catch(e) { console.error(e); }
  }
  if (id === 'frais_fondation') {
    try { loadFraisFondationTotal(); } catch(e) { console.error(e); }
  }
  if (id === 'seances') {
    try { refreshSeances(); } catch(e) { console.error(e); }
  }
  if (id === 'cotisations') {
    try { refreshCotisations(); } catch(e) { console.error(e); }
  }
  if (id === 'partage') {
    try { populatePartageCaisses(); initialiserPartageUI(); } catch(e) { console.error(e); }
  }
}

function handleLogout(){
  fetch('/gestion-caisses/api/logout/', { method:'POST', headers: { 'X-CSRFToken': getCSRFToken() }})
    .then(()=> window.location.href = '/gestion-caisses/');
}

let isLoadingDashboard = false;

function loadDashboardData(){
  if (isLoadingDashboard) return; // √âviter les appels multiples
  
  isLoadingDashboard = true;
  
  fetch('/gestion-caisses/api/dashboard/stats/', { 
    headers: { 'X-CSRFToken': getCSRFToken() }
  })
    .then(r => {
      if (!r.ok) throw new Error('Erreur r√©seau');
      return r.json();
    })
    .then(data => {
      updateDashboardStats(data);
      renderCharts(data);
    })
    .catch(error => {
      console.error('Erreur lors du chargement du dashboard:', error);
      // Afficher un message d'erreur √† l'utilisateur
      const alertesList = document.getElementById('alertes-list');
      if (alertesList) {
        alertesList.innerHTML = '<div class="alerte-item danger">‚ùå Erreur lors du chargement des donn√©es</div>';
      }
    })
    .finally(() => {
      isLoadingDashboard = false;
    });
}

let isLoadingFraisFondation = false;
function loadFraisFondationTotal(){
  if (isLoadingFraisFondation) return;
  isLoadingFraisFondation = true;
  const target = document.getElementById('total-frais-fondation');
  if (target) target.textContent = 'Chargement...';
  fetch('/gestion-caisses/api/dashboard/frais-fondation-total/', {
    headers: { 'X-CSRFToken': getCSRFToken() }
  })
    .then(r => {
      if (!r.ok) throw new Error('Erreur r√©seau');
      return r.json();
    })
    .then(data => {
      const total = (data && data.total_frais_fondation) ? data.total_frais_fondation : 0;
      if (target) target.textContent = new Intl.NumberFormat('fr-FR').format(total) + ' FCFA';
    })
    .catch(e => {
      console.error(e);
      if (target) target.textContent = 'Erreur de chargement';
    })
    .finally(()=> { isLoadingFraisFondation = false; });
}

// ===================== Partage de fonds =====================
let PARTAGE_EXERCICE_ID = null;
async function initialiserPartageUI(){
  // Initialiser s√©lecteur d'exercices pour la caisse s√©lectionn√©e
  const exSelect = document.getElementById('partage-exercice-select');
  const tbody = document.getElementById('partage-table-body');
  const totaux = document.getElementById('partage-totaux');
  const warningMsg = document.getElementById('partage-pdf-warning');
  if (exSelect) {
    exSelect.innerHTML = '<option value=\"\">Chargement...</option>';
    exSelect.disabled = true;
  }
  if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune donn√©e</td></tr>';
  if (totaux) totaux.textContent = 'Base: 0 | Int√©r√™t total: 0';
  if (warningMsg) warningMsg.classList.add('d-none');
  PARTAGE_EXERCICE_ID = null;
  try {
    const caisseId = getSelectedPartageCaisseId();
    if (!caisseId) {
      if (exSelect) {
        exSelect.innerHTML = '<option value=\"\">Aucune caisse s√©lectionn√©e</option>';
        exSelect.disabled = true;
      }
      return;
    }
    await populatePartageExercices(caisseId);
    // Select first suitable option if none selected
    if (exSelect && !exSelect.value && exSelect.options.length > 0) {
      exSelect.selectedIndex = 0;
      exSelect.dispatchEvent(new Event('change'));
    }
  } catch(e){
    console.error(e);
    if (exSelect) {
      exSelect.innerHTML = '<option value=\"\">Erreur de chargement</option>';
      exSelect.disabled = true;
    }
  }
}

// Helpers s√©lection caisse (admin)
function getSelectedPartageCaisseId(){
  const sel = document.getElementById('partage-caisse-select');
  if (sel && sel.value) return sel.value;
  return (typeof USER_CAISE_ID !== 'undefined') ? USER_CAISE_ID : null;
}

let PARTAGE_CAISSES_LOADED = false;
async function populatePartageCaisses(){
  const sel = document.getElementById('partage-caisse-select');
  if (!sel) return; // non-admins n'ont pas de select
  if (PARTAGE_CAISSES_LOADED && sel.options.length > 0) return;
  try {
    sel.innerHTML = '<option value=\"\">Chargement...</option>';
    const res = await fetch(`${API_BASE}/caisses/`);
    const data = await res.json();
    const list = (data.results || data) || [];
    if (!Array.isArray(list) || list.length === 0){
      sel.innerHTML = '<option value=\"\">Aucune caisse</option>';
    } else {
      sel.innerHTML = list.map(c => `<option value=\"${c.id}\">${c.nom_association}</option>`).join('');
      if (typeof USER_CAISE_ID !== 'undefined' && USER_CAISE_ID) {
        sel.value = String(USER_CAISE_ID);
      }
      if (!sel.value && sel.options.length > 0) {
        sel.value = sel.options[0].value;
      }
    }
    if (!sel.onchange) {
      sel.addEventListener('change', () => initialiserPartageUI());
    }
    PARTAGE_CAISSES_LOADED = true;
    // Initialiser si une caisse est s√©lectionn√©e
    if (sel.value) {
      await initialiserPartageUI();
    }
  } catch (e) {
    console.error(e);
    sel.innerHTML = '<option value=\"\">Erreur de chargement</option>';
  }
}

async function calculerPartage(){
  const tbody = document.getElementById('partage-table-body');
  const totaux = document.getElementById('partage-totaux');
  if (!PARTAGE_EXERCICE_ID){
    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucun exercice s√©lectionn√©.</td></tr>';
    return;
  }
  if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Calcul en cours...</td></tr>';
  try {
    const url = `${API_BASE}/exercices-caisse/${PARTAGE_EXERCICE_ID}/partage-preview/`;
    const res = await fetch(url);
    if (res.status === 403) {
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Acc√®s refus√© √† cette caisse.</td></tr>';
      return;
    }
    if (!res.ok) {
      let message = 'Erreur r√©seau';
      try {
        const err = await res.json();
        message = err.detail || err.message || JSON.stringify(err);
      } catch {
        try { message = await res.text(); } catch {}
      }
      if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Erreur: ${message}</td></tr>`;
      console.error('Erreur partage', message, res.status);
      return;
    }
    const js = await res.json();
    const rows = js.repartition || [];
    if (totaux) {
      const base = Number(js.total_base || 0);
      const interet = Number(js.interet_total || 0);
      totaux.textContent = `Base: ${fmt(base)} FCFA | Int√©r√™t total: ${fmt(interet)} FCFA`;
    }
    if (!rows.length){
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune donn√©e</td></tr>';
      return;
    }
    const html = rows.map(r => {
      const p = Number(r.principal||0);
      const i = Number(r.interet||0);
      const t = Number(r.total||0);
      return `<tr>
        <td>${r.membre_nom || ''}</td>
        <td class="text-end">${fmt(p)} FCFA</td>
        <td class="text-end">${fmt(i)} FCFA</td>
        <td class="text-end fw-bold">${fmt(t)} FCFA</td>
      </tr>`;
    }).join('');
    if (tbody) tbody.innerHTML = html;
  } catch(e){
    console.error(e);
    const msg = e && e.message ? e.message : 'Erreur lors du calcul';
    if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${msg}</td></tr>`;
  }
}

function telechargerPartagePdf(){
  if (!PARTAGE_EXERCICE_ID){
    showToast('Aucun exercice s√©lectionn√© pour le partage.', 'warning');
    return;
  }
  window.open(`${API_BASE}/exercices-caisse/${PARTAGE_EXERCICE_ID}/partage-pdf/`, '_blank');
}

async function populatePartageExercices(caisseId){
  const exSelect = document.getElementById('partage-exercice-select');
  const btnPdf = document.getElementById('partage-btn-pdf');
  if (!exSelect) return;
  exSelect.disabled = true;
  exSelect.innerHTML = '<option value=\"\">Chargement...</option>';
  try {
    const res = await fetch(`${API_BASE}/exercices-caisse/?caisse=${caisseId}`);
    if (!res.ok) throw new Error('Erreur r√©seau');
    const data = await res.json();
    const list = (data.results || data) || [];
    if (!Array.isArray(list) || list.length === 0){
      exSelect.innerHTML = '<option value=\"\">Aucun exercice</option>';
      if (btnPdf) btnPdf.disabled = true;
      PARTAGE_EXERCICE_ID = null;
      return;
    }
    // Sort by date_debut desc (backend already orders -date_debut)
    exSelect.innerHTML = list.map(ex => {
      const finTxt = ex.date_fin ? new Date(ex.date_fin).toLocaleDateString('fr-FR') : 'N/A';
      const lbl = `${ex.date_debut} ‚Üí ${finTxt} ‚Äî ${ex.statut}`;
      return `<option value=\"${ex.id}\" data-statut=\"${(ex.statut||'').toUpperCase()}\">${lbl}</option>`;
    }).join('');
    // Prefer CLOTURE if available
    const idxCloture = list.findIndex(x => (x.statut||'').toUpperCase() === 'CLOTURE');
    exSelect.selectedIndex = idxCloture >= 0 ? idxCloture : 0;
    // Update globals and UI
    PARTAGE_EXERCICE_ID = exSelect.value ? Number(exSelect.value) : null;
    updatePartageActionsForStatut(exSelect.selectedOptions[0]?.getAttribute('data-statut'));
    // Bind change if not already
    if (!exSelect.onchange) {
      exSelect.addEventListener('change', async () => {
        const opt = exSelect.selectedOptions[0];
        PARTAGE_EXERCICE_ID = exSelect.value ? Number(exSelect.value) : null;
        updatePartageActionsForStatut(opt ? opt.getAttribute('data-statut') : null);
        if (PARTAGE_EXERCICE_ID) {
          try { await calculerPartage(); } catch(e){ console.error(e); }
        }
      });
    }
    // Trigger initial calculation
    if (PARTAGE_EXERCICE_ID) {
      await calculerPartage();
    }
  } catch (e){
    console.error(e);
    exSelect.innerHTML = '<option value=\"\">Erreur de chargement</option>';
    PARTAGE_EXERCICE_ID = null;
    if (btnPdf) btnPdf.disabled = true;
  } finally {
    exSelect.disabled = false;
  }
}

function updatePartageActionsForStatut(statut){
  const btnPdf = document.getElementById('partage-btn-pdf');
  const warningMsg = document.getElementById('partage-pdf-warning');
  const isEnCours = (statut || '').toUpperCase() === 'EN_COURS';
  if (btnPdf) {
    btnPdf.disabled = isEnCours || !PARTAGE_EXERCICE_ID;
    btnPdf.title = isEnCours ? "PDF indisponible: l'exercice est en cours." : "";
  }
  // Afficher/masquer le message d'avertissement
  if (warningMsg) {
    if (isEnCours && PARTAGE_EXERCICE_ID) {
      warningMsg.classList.remove('d-none');
    } else {
      warningMsg.classList.add('d-none');
    }
  }
}

// ===================== Salaires Agents =====================
async function loadSalairesAgents(){
  const statsBox = document.getElementById('salaires-stats');
  const listBox = document.getElementById('salaires-list');
  if (!statsBox || !listBox) return;
  statsBox.innerHTML = '<div class="alert alert-info">Chargement des statistiques...</div>';
  listBox.innerHTML = '<div class="alert alert-info">Chargement de la liste des salaires...</div>';

  // Charger stats
  try {
    const statsResp = await fetch('/gestion-caisses/api/agents-salaires-stats/', {
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'same-origin'
    });
    const stats = statsResp.ok ? await statsResp.json() : null;
    renderSalairesStats(stats);
  } catch (e){
    console.error('Stats error', e);
    statsBox.innerHTML = '<div class="alert alert-danger">Impossible de charger les statistiques.</div>';
  }

  // Charger liste salaires
  try {
    const params = new URLSearchParams();
    const mois = document.getElementById('salaires-mois')?.value;
    const annee = document.getElementById('salaires-annee')?.value;
    if (mois) params.append('mois', mois);
    if (annee) params.append('annee', annee);
    const salairesResp = await fetch(`/gestion-caisses/api/salaires-agents/${params.toString() ? ('?'+params.toString()) : ''}`, {
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'same-origin'
    });
    const salairesData = salairesResp.ok ? await salairesResp.json() : [];
    const salairesList = (salairesData && (salairesData.results || (Array.isArray(salairesData) ? salairesData : []))) || [];
    renderSalairesList(salairesList);
  } catch (e){
    console.error('List error', e);
    listBox.innerHTML = '<div class="alert alert-danger">Impossible de charger la liste des salaires.</div>';
  }

  // Charger fiches
  try { await loadFichesPaieRecents(); } catch(e){ console.error(e); }
}
function renderSalairesStats(data){
  const el = document.getElementById('salaires-stats');
  if (!el) return;
  if (!data){
    el.innerHTML = '<div class="alert alert-warning">Aucune statistique disponible.</div>';
    return;
  }
  const totalAgents = data.total_agents ?? 0;
  const annee = data.annee_courante ?? '';
  const top = (data.top_agents_bonus || []).slice(0,5).map(a=>`<li>${a.agent} ‚Ä¢ ${a.matricule} ‚Äî Bonus: ${fmt(a.bonus_caisses)} FCFA</li>`).join('') || '<li>Aucun</li>';
  el.innerHTML = `
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <div class="card"><div class="card-body">
          <div class="d-flex align-items-center gap-3">
            <div style="font-size:32px">üë§</div>
            <div>
              <div class="text-muted small">Agents</div>
              <div class="fw-bold" style="font-size:20px">${totalAgents}</div>
            </div>
          </div>
        </div></div>
      </div>
      <div class="col-12 col-md-8">
        <div class="card"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="m-0">Top bonus ${annee}</h5>
          </div>
          <ul class="mt-2 mb-0">${top}</ul>
        </div></div>
      </div>
    </div>
  `;
}

function renderSalairesList(items){
  const el = document.getElementById('salaires-list');
  if (!el) return;
  const rows = (items || []).map(it=>{
    const periode = it.periode || `${it.mois}/${it.annee}`;
    const statut = it.statut || '';
    return `
      <tr>
        <td>${it.agent_nom || ''}<div class="text-muted small">${it.agent_matricule || ''}</div></td>
        <td>${periode}</td>
        <td class="text-end">${fmt(it.salaire_base)} FCFA</td>
        <td class="text-end">${fmt(it.bonus_caisses)} FCFA</td>
        <td class="text-end">${fmt(it.prime_performance)} FCFA</td>
        <td class="text-end">${fmt(it.total_net)} FCFA</td>
        <td><span class="badge ${statut==='PAYE'?'bg-success':(statut==='EN_ATTENTE'?'bg-warning text-dark':'bg-secondary')}">${statut}</span></td>
        <td class="text-end">
          ${statut!=='PAYE' ? `<button class=\"btn btn-sm btn-success\" onclick=\"payerSalaire(${it.id})\">Payer</button>` : ''}
          <button class=\"btn btn-sm btn-outline-secondary ms-1\" onclick=\"calculerBonus(${it.id})\">Calculer bonus</button>
          <button class=\"btn btn-sm btn-outline-primary ms-1\" onclick=\"openEditSalaireForm(${encodeURIComponent(JSON.stringify(it))})\">√âditer</button>
          ${statut==='PAYE' ? `<button class=\"btn btn-sm btn-outline-primary ms-1\" onclick=\"openFicheFromSalaire(${it.id})\">PDF</button>` : ''}
        </td>
      </tr>
    `;
  }).join('');
  el.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">Derniers salaires</h5>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Agent</th>
                <th>P√©riode</th>
                <th class="text-end">Salaire base</th>
                <th class="text-end">Bonus caisses</th>
                <th class="text-end">Prime</th>
                <th class="text-end">Net</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="7" class="text-center text-muted">Aucun salaire</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

async function payerSalaire(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/salaires-agents/${id}/marquer-paye/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    if (!resp.ok) throw new Error('Paiement √©chou√©');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    alert('Impossible de marquer le salaire comme pay√©.');
  }
}

async function calculerBonus(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/salaires-agents/${id}/calculer-bonus/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ montant_par_caisse: 5000 })
    });
    if (!resp.ok) throw new Error('Calcul √©chou√©');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    alert('Impossible de calculer le bonus.');
  }
}

async function loadFichesPaieRecents(){
  const box = document.getElementById('fiches-list');
  if (!box) return;
  box.innerHTML = '<div class="alert alert-info">Chargement des fiches de paie...</div>';
  try{
    const mois = document.getElementById('salaires-mois')?.value;
    const annee = document.getElementById('salaires-annee')?.value;
    const qp = new URLSearchParams();
    if (mois) qp.append('mois', mois);
    if (annee) qp.append('annee', annee);
    qp.append('page_size', '1000');
    const url = `/gestion-caisses/api/fiches-paie/${qp.toString() ? ('?'+qp.toString()) : ''}`;
    const resp = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }, credentials: 'same-origin' });
    const data = resp.ok ? await resp.json() : [];
    const items = (data && (data.results || (Array.isArray(data) ? data : []))) || [];
    renderFichesPaie(items);
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="alert alert-danger">Impossible de charger les fiches de paie.</div>';
  }
}

function renderFichesPaie(items){
  const el = document.getElementById('fiches-list');
  if (!el) return;
  const rows = (items || []).map(it=>{
    const periode = it.periode || `${it.mois}/${it.annee}`;
    const pdf = it.fichier_pdf_url ? `<a class=\"btn btn-sm btn-outline-primary\" href=\"${it.fichier_pdf_url}\" target=\"_blank\">PDF</a>` : `<button class=\"btn btn-sm btn-primary\" onclick=\"genererFiche(${it.id})\">G√©n√©rer PDF</button>`;
    return `
      <tr>
        <td>${it.agent_nom || ''}<div class="text-muted small">${it.agent_matricule || ''}</div></td>
        <td>${periode}</td>
        <td class="text-end">${fmt(it.total_net)} FCFA</td>
        <td class="text-end">${pdf}</td>
      </tr>
    `;
  }).join('');
  el.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">Fiches de paie</h5>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Agent</th>
                <th>P√©riode</th>
                <th class="text-end">Net</th>
                <th class="text-end">Fichier</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="4" class="text-center text-muted">Aucune fiche</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

async function genererFiche(id){
  try{
    const resp = await fetch(`/gestion-caisses/api/fiches-paie/${id}/generer-pdf/`, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() }});
    if (!resp.ok) throw new Error('G√©n√©ration √©chou√©e');
    await loadFichesPaieRecents();
  }catch(e){
    console.error(e);
    alert('Impossible de g√©n√©rer le PDF.');
  }
}

async function openFicheFromSalaire(salaireId){
  try{
    // Essayer de trouver une fiche li√©e √† ce salaire
    const resp = await fetch(`/gestion-caisses/api/fiches-paie/?salaire=${salaireId}`, { headers: { 'X-CSRFToken': getCSRFToken() }, credentials: 'same-origin' });
    const data = await resp.json();
    const items = data.results || data || [];
    if (Array.isArray(items) && items.length > 0){
      const f = items[0];
      if (f.fichier_pdf_url){
        window.open(f.fichier_pdf_url, '_blank');
        return;
      }
      await genererFiche(f.id);
      // Recharger et ouvrir si dispo
      const r2 = await fetch(`/gestion-caisses/api/fiches-paie/${f.id}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
      const f2 = await r2.json();
      if (f2.fichier_pdf && f2.fichier_pdf_url){ window.open(f2.fichier_pdf_url, '_blank'); }
      return;
    }
    // Sinon, tenter la g√©n√©ration mensuelle pour ce salaire (mois/ann√©e)
    const sResp = await fetch(`/gestion-caisses/api/salaires-agents/${salaireId}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if (!sResp.ok) return;
    const s = await sResp.json();
    // Cr√©er une fiche li√©e √† ce salaire
    const createResp = await fetch('/gestion-caisses/api/fiches-paie/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ salaire: salaireId, type_fiche: 'MOIS' })
    });
    if (createResp.ok){
      const created = await createResp.json();
      await genererFiche(created.id);
      // Recharger et ouvrir
      const r3 = await fetch(`/gestion-caisses/api/fiches-paie/${created.id}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
      const f3 = await r3.json();
      if (f3.fichier_pdf && f3.fichier_pdf_url){ window.open(f3.fichier_pdf_url, '_blank'); }
    } else {
      alert("Fiche introuvable et cr√©ation non disponible.");
    }
  }catch(e){ console.error(e); }
}

async function genererFichesMensuelles(){
  try{
    const now = new Date();
    const mois = now.getMonth() + 1;
    const annee = now.getFullYear();
    const resp = await fetch('/gestion-caisses/api/fiches-paie/generer-mensuelle/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ mois, annee })
    });
    if (!resp.ok) throw new Error('G√©n√©ration mensuelle √©chou√©e');
    await loadFichesPaieRecents();
  }catch(e){
    console.error(e);
    alert('Impossible de g√©n√©rer les fiches mensuelles.');
  }
}

function toggleSalaireForm(){
  const box = document.getElementById('salaire-form');
  if (!box) return;
  box.style.display = (box.style.display === 'none' || !box.style.display) ? 'block' : 'none';
  if (box.style.display === 'block') hydrateAgentsSelect();
}

function showSalaireAlert(type, message){
  const wrap = document.getElementById('salaires-alerts');
  if (!wrap) return;
  const cls = type === 'success' ? 'alert-success' : (type === 'warning' ? 'alert-warning' : 'alert-danger');
  wrap.innerHTML = `<div class="alert ${cls} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button></div>`;
  setTimeout(()=>{ if (wrap.firstChild) wrap.firstChild.remove(); }, 5000);
}

function openCreateSalaireForm(){
  document.getElementById('salaire-form').dataset.mode = 'create';
  document.getElementById('salaire-form').dataset.id = '';
  document.getElementById('sf-submit').textContent = 'Enregistrer';
  // reset fields
  ['sf-agent','sf-mois','sf-annee','sf-base','sf-bonus','sf-prime','sf-ded','sf-notes'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT') el.value = '';
    else el.value = '';
  });
  toggleSalaireForm();
}

function openEditSalaireForm(item){
  document.getElementById('salaire-form').dataset.mode = 'edit';
  document.getElementById('salaire-form').dataset.id = item.id;
  document.getElementById('sf-submit').textContent = 'Mettre √† jour';
  toggleSalaireForm();
  hydrateAgentsSelect().then(()=>{
    document.getElementById('sf-agent').value = item.agent;
  });
  document.getElementById('sf-mois').value = item.mois;
  document.getElementById('sf-annee').value = item.annee;
  document.getElementById('sf-base').value = item.salaire_base;
  document.getElementById('sf-bonus').value = item.bonus_caisses;
  document.getElementById('sf-prime').value = item.prime_performance;
  document.getElementById('sf-ded').value = item.deductions;
  document.getElementById('sf-notes').value = item.notes || '';
}

async function soumettreSalaireAgent(){
  try{
    const agent = document.getElementById('sf-agent').value;
    const mois = document.getElementById('sf-mois').value;
    const annee = document.getElementById('sf-annee').value;
    const base = document.getElementById('sf-base').value;
    const bonus = document.getElementById('sf-bonus').value;
    const prime = document.getElementById('sf-prime').value;
    const ded = document.getElementById('sf-ded').value;
    const notes = document.getElementById('sf-notes').value || '';

    if (!agent){ alert('Veuillez s√©lectionner un agent.'); return; }
    if (!mois){ alert('Veuillez choisir le mois.'); return; }
    if (!annee){ alert("Veuillez saisir l'ann√©e."); return; }
    if (!base){ alert('Veuillez saisir le salaire de base.'); return; }

    const payload = {
      agent: parseInt(document.getElementById('sf-agent').value || '0', 10),
      mois: parseInt(document.getElementById('sf-mois').value || '0', 10),
      annee: parseInt(document.getElementById('sf-annee').value || '0', 10),
      salaire_base: parseFloat(document.getElementById('sf-base').value || '0'),
      bonus_caisses: parseFloat(document.getElementById('sf-bonus').value || '0'),
      prime_performance: parseFloat(document.getElementById('sf-prime').value || '0'),
      deductions: parseFloat(document.getElementById('sf-ded').value || '0'),
      notes: notes
    };
    const formEl = document.getElementById('salaire-form');
    const mode = formEl.dataset.mode || 'create';
    const currentId = formEl.dataset.id;
    const url = mode === 'edit' && currentId ? `/gestion-caisses/api/salaires-agents/${currentId}/` : '/gestion-caisses/api/salaires-agents/';
    const method = mode === 'edit' && currentId ? 'PUT' : 'POST';
    const resp = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      let message = 'Cr√©ation √©chou√©e';
      try{ const err = await resp.json(); message = JSON.stringify(err); }catch(e){ message = await resp.text(); }
      throw new Error(message || 'Cr√©ation √©chou√©e');
    }
    toggleSalaireForm();
    showSalaireAlert('success', mode === 'edit' ? 'Salaire mis √† jour avec succ√®s.' : 'Salaire ajout√© avec succ√®s.');
    await loadSalairesAgents();
  }catch(e){
    console.error(e);
    showSalaireAlert('danger', '√âchec: ' + (e.message || 'Erreur inconnue'));
  }
}

async function hydrateAgentsSelect(){
  try{
    const sel = document.getElementById('sf-agent');
    if (!sel) return;
    sel.innerHTML = '<option value="">Chargement...</option>';
    const resp = await fetch('/gestion-caisses/api/agents/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = resp.ok ? await resp.json() : [];
    const list = data.results || data || [];
    sel.innerHTML = '<option value="">S√©lectionner un agent...</option>' +
      list.map(a=>`<option value="${a.id}">${a.nom_complet} ‚Äî ${a.matricule}</option>`).join('');
    checkSalaireDuplicate();
  }catch(e){
    console.error(e);
  }
}

async function checkSalaireDuplicate(){
  try{
    const btn = document.getElementById('sf-submit');
    const alertBox = document.getElementById('sf-duplicate');
    const formEl = document.getElementById('salaire-form');
    const mode = formEl.dataset.mode || 'create';

    const agent = document.getElementById('sf-agent').value;
    const mois = document.getElementById('sf-mois').value;
    const annee = document.getElementById('sf-annee').value;
    if (!agent || !mois || !annee){
      if (alertBox) alertBox.style.display = 'none';
      if (btn) btn.disabled = false;
      return;
    }
    const url = `/gestion-caisses/api/salaires-agents/?agent_id=${encodeURIComponent(agent)}&mois=${encodeURIComponent(mois)}&annee=${encodeURIComponent(annee)}`;
    const resp = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = resp.ok ? await resp.json() : [];
    const list = data.results || data || [];
    const exists = Array.isArray(list) && list.length > 0;
    if (exists && mode !== 'edit'){
      if (alertBox) alertBox.style.display = 'block';
      if (btn) btn.disabled = true;
    } else {
      if (alertBox) alertBox.style.display = 'none';
      if (btn) btn.disabled = false;
    }
  }catch(e){
    console.error(e);
  }
}

function loadAlertes(){
  fetch('/gestion-caisses/api/dashboard/alertes/', { headers: { 'X-CSRFToken': getCSRFToken() }})
    .then(r=>r.json()).then(data=> updateAlertes(data.alertes || []));
}

function updateDashboardStats(data){
  document.getElementById('total-caisses').textContent = data.total_caisses || 0;
  document.getElementById('total-membres').textContent = data.total_membres || 0;
  document.getElementById('total-fonds').textContent = ((data.solde_total_disponible || 0)).toLocaleString('fr-FR') + ' FCFA';
  document.getElementById('total-prets').textContent = data.total_prets_actifs || 0;
}

function updateAlertes(alertes){
  const el = document.getElementById('alertes-list');
  if (!alertes.length){ el.innerHTML = '<div class="alerte-item success">‚úÖ Aucune alerte en cours</div>'; return; }
  el.innerHTML = alertes.map(a=>`
    <div class="alerte-item ${a.niveau}">
      <div class="alerte-icon">${getAlerteIcon(a.niveau)}</div>
      <div class="alerte-content">
        <div class="alerte-message">${a.message}</div>
        <div class="alerte-type">${a.type}</div>
      </div>
    </div>
  `).join('');
}

function getAlerteIcon(n){ return ({ danger:'üö®', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è', success:'‚úÖ'})[n] || '‚ÑπÔ∏è' }

function getCSRFToken(){ return window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value }

function renderCharts(stats){
  // V√©rifier si les donn√©es sont valides
  if (!stats || (!stats.evolution_prets && !stats.caisses_par_region)) {
    console.log('Aucune donn√©e de graphique disponible');
    return;
  }

  // Donn√©es pour l'√©volution des pr√™ts
  const evoLabels = (stats.evolution_prets || []).map(e=>e.mois).reverse();
  const evoValues = (stats.evolution_prets || []).map(e=>e.nombre).reverse();
  
  // Donn√©es pour les caisses par r√©gion
  const regLabels = (stats.caisses_par_region || []).map(r=> r.region__nom || r.region || Object.values(r)[0]);
  const regValues = (stats.caisses_par_region || []).map(r=> r.total);

  // D√©truire les graphiques existants
  if (evolutionChart) {
    evolutionChart.destroy();
    evolutionChart = null;
  }
  if (regionsChart) {
    regionsChart.destroy();
    regionsChart = null;
  }

  // Cr√©er le graphique d'√©volution des pr√™ts
  const evoCtx = document.getElementById('evolutionChart');
  if (evoCtx && evoLabels.length > 0) {
    const ctx = evoCtx.getContext('2d');
    evolutionChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: evoLabels,
        datasets: [{
          label: 'Pr√™ts',
          data: evoValues,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,.15)',
          tension: 0.3,
          fill: true,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Cr√©er le graphique des caisses par r√©gion
  const regCtx = document.getElementById('regionsChart');
  if (regCtx && regLabels.length > 0) {
    const ctx = regCtx.getContext('2d');
    regionsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: regLabels,
        datasets: [{
          label: 'Caisses',
          data: regValues,
          backgroundColor: 'rgba(25,135,84,.65)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });
  }
}

// ===== Contexte utilisateur / Caisse =====
async function fetchUserContext(){
  try{
    const r = await fetch('/gestion-caisses/api/user-context/', { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await r.json();
    USER_CAISE_ID = data.caisse_id || null;
    
    // Si c'est un agent, charger les caisses dans le s√©lecteur
    const userRole = data.user?.role || '';
    if (userRole === 'Agent' && data.caisses && data.caisses.length > 0) {
      await loadAgentCaissesSelector(data.caisses, data.caisse_id);
    }
    
    return data;
  }catch(e){ 
    USER_CAISE_ID = null; 
    return null;
  }
}

// Met √† jour le badge mobile avec le nom de la caisse s√©lectionn√©e
function updateMobileActiveCaisseLabel() {
  const mobileSelect = document.getElementById('agent-caisse-select-mobile');
  const labelEl = document.getElementById('agent-active-caisse-label-mobile');
  if (!mobileSelect || !labelEl) return;

  const selectedOption = mobileSelect.options[mobileSelect.selectedIndex];
  const text = selectedOption && selectedOption.text ? selectedOption.text.trim() : '';
  labelEl.textContent = text || 'Aucune caisse';
}

// Charger le s√©lecteur de caisses pour les agents (desktop + mobile)
async function loadAgentCaissesSelector(caisses, selectedCaisseId = null) {
  const desktopSelect = document.getElementById('agent-caisse-select');
  const mobileSelect = document.getElementById('agent-caisse-select-mobile');
  const rapportSelect = document.getElementById('rapport-caisse-select');
  if (!desktopSelect && !mobileSelect && !rapportSelect) return;
  
  if (!caisses || caisses.length === 0) {
    const emptyHtml = '<option value=\"\">Aucune caisse</option>';
    if (desktopSelect) desktopSelect.innerHTML = emptyHtml;
    if (mobileSelect) mobileSelect.innerHTML = emptyHtml;
    return;
  }
  
  // D√©terminer la caisse s√©lectionn√©e par d√©faut
  const effectiveSelectedId = selectedCaisseId || (typeof USER_CAISE_ID !== 'undefined' ? USER_CAISE_ID : null) || (caisses[0]?.id || null);
  
  const buildOptions = () => {
    return caisses.map(caisse => {
      const selectedAttr = (effectiveSelectedId && caisse.id === effectiveSelectedId) ? ' selected' : '';
      const label = `${caisse.code || ''} - ${caisse.nom_association || ''}`.trim();
      return `<option value=\"${caisse.id}\"${selectedAttr}>${label}</option>`;
    }).join('');
  };
  
  const optionsHtml = buildOptions();
  if (desktopSelect) {
    desktopSelect.innerHTML = optionsHtml;
    desktopSelect.value = String(effectiveSelectedId || '');
  }
  if (mobileSelect) {
    mobileSelect.innerHTML = optionsHtml;
    mobileSelect.value = String(effectiveSelectedId || '');
    // Mettre √† jour le badge mobile apr√®s chargement des options
    updateMobileActiveCaisseLabel();
  }
  if (rapportSelect) {
    // Conserver l'option sp√©ciale "Toutes mes caisses" si pr√©sente
    const baseOptions = '<option value=\"\">Ma caisse active</option><option value=\"_ALL_MY_\">Toutes mes caisses</option>';
    rapportSelect.innerHTML = baseOptions + optionsHtml;
    // Par d√©faut, on se cale sur la caisse active (ou laisse _ALL_MY_ si d√©j√† choisi)
    if (rapportSelect.value !== '_ALL_MY_') {
      rapportSelect.value = String(effectiveSelectedId || '');
    }
  }
  
  // Fonction commune de gestion du changement de caisse
  const handleChange = async (newCaisseId) => {
    const idNum = Number(newCaisseId || 0);
    if (!idNum || idNum === USER_CAISE_ID) return;
    USER_CAISE_ID = idNum;
    // Synchroniser les deux s√©lecteurs
    if (desktopSelect && desktopSelect.value !== String(idNum)) {
      desktopSelect.value = String(idNum);
    }
    if (mobileSelect && mobileSelect.value !== String(idNum)) {
      mobileSelect.value = String(idNum);
      updateMobileActiveCaisseLabel();
    }
    if (rapportSelect && rapportSelect.value !== String(idNum)) {
      rapportSelect.value = String(idNum);
    }
    // Recharger toutes les donn√©es avec la nouvelle caisse
    await reloadDataForSelectedCaisse();
    showToast('Caisse chang√©e avec succ√®s', 'success');
  };
  
  if (desktopSelect) {
    desktopSelect.onchange = function () {
      handleChange(this.value);
    };
  }
  if (mobileSelect) {
    mobileSelect.onchange = function () {
      handleChange(this.value);
    };
  }
}

// Recharger toutes les donn√©es quand l'agent change de caisse
async function reloadDataForSelectedCaisse() {
  try {
    // Recharger les statistiques du dashboard
    if (typeof loadDashboardStats === 'function') {
      await loadDashboardStats();
    }
    
    // Recharger les membres
    if (typeof loadMembers === 'function') {
      await loadMembers();
    }
    
    // Recharger les pr√™ts
    if (typeof loadPrets === 'function') {
      await loadPrets();
    }
    
    // Recharger les s√©ances
    if (typeof refreshSeances === 'function') {
      await refreshSeances();
    }
    
    // Recharger les cotisations
    if (typeof refreshCotisations === 'function') {
      await refreshCotisations();
    }
    
    // Recharger les d√©penses
    if (typeof chargerDepenses === 'function') {
      await chargerDepenses();
    }
    
    // Recharger les informations de la caisse
    if (typeof loadCaisse === 'function') {
      await loadCaisse();
    }
  } catch(e) {
    console.error('Erreur lors du rechargement des donn√©es:', e);
  }
}
async function loadCaisse(){
  const wrap = document.getElementById('caisse-card');
  // V√©rifier si l'√©l√©ment existe avant de l'utiliser
  if (!wrap) {
    console.warn('√âl√©ment #caisse-card non trouv√© dans le DOM');
    return;
  }
  
  if (!USER_CAISE_ID){ 
    wrap.innerHTML = '<div class="alert alert-warning mt-2">Aucune caisse li√©e.</div>'; 
    return; 
  }
  
  try {
    // Charger les informations de base de la caisse s√©lectionn√©e (endpoint d√©tail)
    const res = await fetch(`/gestion-caisses/api/caisses/${USER_CAISE_ID}/`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const caisse = await res.json();
    if (!caisse || !caisse.id){ 
      wrap.innerHTML = '<div class="alert alert-warning mt-2">Caisse introuvable.</div>'; 
      return; 
    }
    
    // Charger les pr√™ts pour calculer les statistiques (uniquement pour cette caisse)
    const pretsParams = new URLSearchParams({ caisse: USER_CAISE_ID });
    const pretsRes = await fetch(`/gestion-caisses/api/prets/?${pretsParams.toString()}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const pretsData = await pretsRes.json();
    const prets = pretsData.results || pretsData || [];
    
    // Calculer les statistiques des pr√™ts
    const pretsActifs = prets.filter(p => ['EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(p.statut)).length;
    const pretsEnAttente = prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length;
    const pretsValides = prets.filter(p => p.statut === 'VALIDE').length;
    const pretsTermines = prets.filter(p => p.statut === 'REMBOURSE').length;
    const pretsRejetes = prets.filter(p => p.statut === 'REJETE').length;
    
    // Calculer les montants
    const montantTotalPrets = prets.filter(p => ['EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(p.statut))
      .reduce((sum, p) => sum + (parseFloat(p.montant_accord || 0)), 0);
    const montantTotalRembourse = prets.filter(p => p.statut === 'REMBOURSE')
      .reduce((sum, p) => sum + (parseFloat(p.montant_rembourse || 0)), 0);
    
    // Mettre √† jour le titre du tableau de bord avec le nom et le montant de la caisse
    const dashboardTitle = document.getElementById('dashboard-title');
    const montantCaisse = Number(caisse.fond_disponible || 0).toLocaleString('fr-FR');
    if (dashboardTitle) {
      dashboardTitle.textContent = `üìä Tableau de Bord ‚Äî ${caisse.nom_association || ''} (${montantCaisse} FCFA)`;
    }

    // Mettre √† jour la carte principale de la caisse
    wrap.innerHTML = `
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="card-title mb-1">üè¶ ${caisse.nom_association}</h5>
              <div class="text-muted">Code: ${caisse.code}</div>
              <div class="text-muted small">${caisse.region?.nom || ''} ${caisse.prefecture?.nom ? '> ' + caisse.prefecture.nom : ''} ${caisse.commune?.nom ? '> ' + caisse.commune.nom : ''}</div>
            </div>
            <div class="text-end d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="loadCaisse()" title="Rafra√Æchir">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="openCaisseModal(${caisse.id}, \"${(caisse.notes||'').replace(/"/g,'&quot;')}\")">
                <i class="fas fa-edit"></i> Modifier notes
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="generateMembresListePDF(${caisse.id})" title="G√©n√©rer PDF liste des membres">
                <i class="fas fa-file-pdf"></i> Liste membres
              </button>
            </div>
          </div>
          
          <!-- Statistiques principales -->
          <div class="row g-3 mb-4">
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-primary mb-1">${caisse.nombre_membres || 0}</div>
                <div class="text-muted small">Membres actifs</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-success mb-1">${pretsActifs}</div>
                <div class="text-muted small">Pr√™ts actifs</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-warning mb-1">${montantCaisse}</div>
                <div class="text-muted small">Fonds disponibles (FCFA)</div>
              </div>
            </div>
            <div class="col-6 col-lg-3">
              <div class="text-center p-3 bg-light rounded">
                <div class="h4 text-info mb-1">${Number(montantTotalPrets).toLocaleString('fr-FR')}</div>
                <div class="text-muted small">En circulation (FCFA)</div>
              </div>
            </div>
          </div>
          
          <!-- D√©tails des pr√™ts -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h6 class="text-muted mb-3">üìä √âtat des pr√™ts</h6>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-warning mb-1">${pretsEnAttente}</div>
                <div class="text-muted small">En attente</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-info mb-1">${pretsValides}</div>
                <div class="text-muted small">Valid√©s</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-success mb-1">${pretsTermines}</div>
                <div class="text-muted small">Termin√©s</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center p-2 border rounded">
                <div class="h6 text-danger mb-1">${pretsRejetes}</div>
                <div class="text-muted small">Rejet√©s</div>
              </div>
            </div>
          </div>
          
          <!-- Graphique des pr√™ts par statut -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <div class="card border-light">
                <div class="card-body">
                  <h6 class="text-muted mb-3">üìà R√©partition des pr√™ts par statut</h6>
                  <div style="height: 300px; position: relative;">
                    <canvas id="pretStatusChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Informations financi√®res -->
          <div class="row g-3">
            <div class="col-12">
              <h6 class="text-muted mb-3">üí∞ Informations financi√®res</h6>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Fond initial:</span>
                <span class="fw-bold">${Number(caisse.fond_initial||0).toLocaleString('fr-FR')} FCFA</span>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Total rembours√©:</span>
                <span class="fw-bold text-success">${Number(montantTotalRembourse).toLocaleString('fr-FR')} FCFA</span>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="d-flex justify-content-between p-2 border rounded">
                <span class="text-muted">Taux de remboursement:</span>
                <span class="fw-bold text-info">${pretsActifs + pretsTermines > 0 ? Math.round((pretsTermines / (pretsActifs + pretsTermines)) * 100) : 0}%</span>
              </div>
            </div>
          </div>
          
          ${caisse.notes ? `
          <div class="mt-4 p-3 bg-light rounded">
            <h6 class="text-muted mb-2">üìù Notes</h6>
            <p class="mb-0">${caisse.notes}</p>
          </div>
          ` : ''}
        </div>
      </div>
      
                <!-- Actions rapides et Mouvements de fonds -->
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card border-primary">
                <div class="card-body text-center">
                  <h6 class="text-primary mb-2">üöÄ Actions rapides</h6>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="showSection(event, 'membres')">
                      <i class="fas fa-users"></i> G√©rer les membres
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="showSection(event, 'prets')">
                      <i class="fas fa-hand-holding-usd"></i> G√©rer les pr√™ts
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h6 class="text-info mb-2">üìà Prochaines √©tapes</h6>
                  <div class="text-start small">
                    ${pretsEnAttente > 0 ? `<div class="mb-1">‚Ä¢ ${pretsEnAttente} pr√™t(s) en attente de validation</div>` : ''}
                    ${pretsValides > 0 ? `<div class="mb-1">‚Ä¢ ${pretsValides} pr√™t(s) valid√©(s) √† octroyer</div>` : ''}
                    ${pretsActifs > 0 ? `<div class="mb-1">‚Ä¢ ${pretsActifs} pr√™t(s) actif(s) √† suivre</div>` : ''}
                    ${!pretsEnAttente && !pretsValides && !pretsActifs ? '<div class="text-muted">‚Ä¢ Aucune action requise</div>' : ''}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <h6 class="text-warning mb-2">üí∞ Derniers mouvements</h6>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning btn-sm" onclick="loadMouvementsFonds()">
                      <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                  </div>
                  <div id="mouvements-fonds-list" class="mt-2 small text-start">
                    <div class="text-muted text-center">Cliquez pour charger</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
    `;
    
    // Cr√©er le graphique des pr√™ts par statut
    setTimeout(() => createPretStatusChart(prets), 100);
    
    // Charger les mouvements de fonds
    setTimeout(() => loadMouvementsFonds(), 200);
    
  } catch (error) {
    console.error('Erreur lors du chargement de la caisse:', error);
    wrap.innerHTML = '<div class="alert alert-danger mt-2">Erreur lors du chargement des donn√©es de la caisse.</div>';
  }
}

// Fonction pour cr√©er un graphique des pr√™ts par statut
function createPretStatusChart(prets) {
  const ctx = document.getElementById('pretStatusChart');
  if (!ctx) return;
  
  // Compter les pr√™ts par statut
  const stats = {
    'En attente': prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length,
    'Valid√©s': prets.filter(p => p.statut === 'VALIDE').length,
    'En cours': prets.filter(p => p.statut === 'EN_COURS').length,
    'En retard': prets.filter(p => p.statut === 'EN_RETARD').length,
    'Termin√©s': prets.filter(p => p.statut === 'REMBOURSE').length,
    'Rejet√©s': prets.filter(p => p.statut === 'REJETE').length
  };
  
  // Filtrer les statuts avec des valeurs > 0
  const labels = Object.keys(stats).filter(key => stats[key] > 0);
  const data = labels.map(key => stats[key]);
  
  // Couleurs pour chaque statut
  const colors = {
    'En attente': '#ffc107',
    'Valid√©s': '#17a2b8',
    'En cours': '#28a745',
    'En retard': '#dc3545',
    'Termin√©s': '#6f42c1',
    'Rejet√©s': '#6c757d'
  };
  
  const backgroundColor = labels.map(key => colors[key]);
  
  // D√©truire le graphique existant s'il y en a un (et s'il expose destroy)
  if (window.pretStatusChart && typeof window.pretStatusChart.destroy === 'function') {
    window.pretStatusChart.destroy();
  }
  
  // Cr√©er le nouveau graphique
  window.pretStatusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColor,
        borderWidth: 2,
        borderColor: '#fff',
        hoverBorderWidth: 3,
        hoverBorderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#fff',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return `${context.label}: ${context.parsed} pr√™t(s) (${percentage}%)`;
            },
            afterLabel: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              return `Total: ${total} pr√™t(s)`;
            }
          }
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true
      }
    }
  });
  
  // Ajouter des statistiques d√©taill√©es sous le graphique
  const chartContainer = ctx.parentElement;
  const statsDiv = document.createElement('div');
  statsDiv.className = 'mt-3';
  statsDiv.innerHTML = `
    <div class="row g-2 text-center">
      ${Object.entries(stats).map(([key, value]) => `
        <div class="col-4 col-md-2">
          <div class="p-2 border rounded bg-light">
            <div class="h6 mb-1" style="color: ${colors[key] || '#6c757d'}">${value}</div>
            <div class="small text-muted">${key}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  // Supprimer l'ancien div de statistiques s'il existe
  const oldStatsDiv = chartContainer.querySelector('.mt-3');
  if (oldStatsDiv) {
    oldStatsDiv.remove();
  }
  
  chartContainer.appendChild(statsDiv);
}

// Graphique des pr√™ts par statut dans l'onglet "Pr√™ts"
function createPretStatusChartInPrets(prets) {
  const canvas = document.getElementById('pretStatusChartPrets');
  // Ne rien faire si le canvas n'existe plus (nous gardons le graphique uniquement c√¥t√© Caisse)
  if (!canvas) return;
  // R√©utilise la logique de comptage et couleurs
  const stats = {
    'En attente': prets.filter(p => ['EN_ATTENTE', 'EN_ATTENTE_ADMIN'].includes(p.statut)).length,
    'Valid√©s': prets.filter(p => p.statut === 'VALIDE').length,
    'En cours': prets.filter(p => p.statut === 'EN_COURS').length,
    'En retard': prets.filter(p => p.statut === 'EN_RETARD').length,
    'Termin√©s': prets.filter(p => p.statut === 'REMBOURSE').length,
    'Rejet√©s': prets.filter(p => p.statut === 'REJETE').length
  };
  const labels = Object.keys(stats).filter(k => stats[k] > 0);
  const data = labels.map(k => stats[k]);
  const colors = {
    'En attente': '#ffc107',
    'Valid√©s': '#17a2b8',
    'En cours': '#28a745',
    'En retard': '#dc3545',
    'Termin√©s': '#6f42c1',
    'Rejet√©s': '#6c757d'
  };
  const backgroundColor = labels.map(k => colors[k]);

  if (window.pretStatusChartPrets && typeof window.pretStatusChartPrets.destroy === 'function') {
    window.pretStatusChartPrets.destroy();
  }
  window.pretStatusChartPrets = new Chart(canvas, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor, borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
        tooltip: { callbacks: { label: (ctx) => {
          const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
          const pc = total ? ((ctx.parsed/total)*100).toFixed(1) : 0;
          return `${ctx.label}: ${ctx.parsed} (${pc}%)`;
        }}}
      }
    }
  });
}

// Fonction pour charger et afficher les derniers mouvements de fonds
async function loadMouvementsFonds() {
  try {
    const response = await fetch('/gestion-caisses/api/mouvements-fonds/', { 
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const data = await response.json();
    const mouvements = (data.results || data).slice(0, 10); // Limiter √† 10 derniers
    
    const container = document.getElementById('mouvements-fonds-list');
    if (!container) return;
    
    if (!mouvements.length) {
      container.innerHTML = '<div class="text-muted text-center">Aucun mouvement de fonds r√©cent</div>';
      return;
    }
    
    container.innerHTML = mouvements.map(m => `
      <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
        <div>
          <div class="fw-bold">${m.type_mouvement}</div>
          <div class="small text-muted">${m.description || 'Aucune description'}</div>
          <div class="small text-muted">${new Date(m.date_mouvement).toLocaleDateString('fr-FR')}</div>
        </div>
        <div class="text-end">
          <div class="fw-bold ${m.type_mouvement === 'ALIMENTATION' || m.type_mouvement === 'REMBOURSEMENT' ? 'text-success' : 'text-danger'}">
            ${m.type_mouvement === 'ALIMENTATION' || m.type_mouvement === 'REMBOURSEMENT' ? '+' : '-'}${Number(m.montant).toLocaleString('fr-FR')} FCFA
          </div>
          <div class="small text-muted">Solde: ${Number(m.solde_apres).toLocaleString('fr-FR')} FCFA</div>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Erreur lors du chargement des mouvements de fonds:', error);
    const container = document.getElementById('mouvements-fonds-list');
    if (container) {
      container.innerHTML = '<div class="text-danger text-center">Erreur lors du chargement des mouvements</div>';
    }
  }
}

function openCaisseModal(id, notes){
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('caisseModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const html = `
  <div class="modal fade" tabindex="-1" id="caisseModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üìù Modifier les notes de la caisse</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Notes et commentaires</label>
            <textarea class="form-control" id="caisseNotes" rows="5" placeholder="Ajoutez des notes, commentaires ou informations importantes sur cette caisse...">${notes||''}</textarea>
            <div class="form-text">Ces notes seront visibles par tous les membres de la caisse.</div>
          </div>
          <div id="caisseError" class="alert alert-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" onclick="submitCaisse(${id})">
            <i class="fas fa-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  
  const modal = new bootstrap.Modal(document.getElementById('caisseModal'));
  modal.show();
}
function closeCaisseModal(){ 
  const el = document.getElementById('caisseModal'); 
  if (!el) return; 
  const modal = bootstrap.Modal.getInstance(el);
  if (modal) {
    modal.hide();
    setTimeout(() => el.remove(), 300); // Attendre la fin de l'animation
  } else {
    el.remove();
  }
}
async function submitCaisse(id){
  try{
    const submitBtn = document.querySelector('#caisseModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    
    // D√©sactiver le bouton et afficher un indicateur de chargement
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    
    const notes = document.getElementById('caisseNotes').value;
    const r = await fetch(`/gestion-caisses/api/caisses/${id}/`, { 
      method:'PATCH', 
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':getCSRFToken() 
      }, 
      body: JSON.stringify({ notes }) 
    });
    
    if (!r.ok) {
      const errorData = await r.json().catch(() => ({}));
      throw new Error(errorData.detail || '√âchec de mise √† jour des notes');
    }
    
    // Succ√®s
    closeCaisseModal();
    
    // Afficher un message de succ√®s temporaire
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Notes mises √† jour avec succ√®s !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte apr√®s 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
    // Recharger les donn√©es de la caisse
    loadCaisse();
    
  } catch(e) { 
    const err = document.getElementById('caisseError'); 
    if (err) { 
      err.textContent = e.message; 
      err.style.display = 'block'; 
    }
    
    // R√©activer le bouton
    const submitBtn = document.querySelector('#caisseModal .btn-primary');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
}

// ===== Membres (CRUD minimal) =====
async function loadMembreCaisses(){
  const sel = document.getElementById('membreCaisse');
  if(!sel) return;
  sel.innerHTML = '<option value="">Chargement...</option>';
  try {
    const res = await fetch(`${API_BASE}/caisses/`);
    const data = await res.json();
    sel.innerHTML = '<option value="">S√©lectionner une caisse</option>';
    (data.results||data).forEach(c=>{ 
      const opt = document.createElement('option'); 
      opt.value = c.id; 
      opt.textContent = `${c.code || ''} ${c.nom_association || ''}`.trim(); 
      sel.appendChild(opt); 
    });
  } catch (e) {
    console.error('Erreur chargement caisses membres:', e);
    sel.innerHTML = '<option value="">Erreur lors du chargement</option>';
  }
}

function openMembreModal(id){
  document.getElementById('membreError')?.style && (document.getElementById('membreError').style.display='none');
  const form = document.getElementById('membreForm');
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  
  // Ne faire reset que si c'est un nouveau membre (pas d'ID)
  if (!id) {
    form.reset();
    form.id.value = '';
    
    // Charger les caisses pour les admins lors de la cr√©ation d'un nouveau membre
    if (isAdmin) {
      loadMembreCaisses().catch(e => console.error('Erreur chargement caisses:', e));
    }
    
    // Initialiser les valeurs par d√©faut pour nouveau membre
    const sexeSelect = form.querySelector('select[name="sexe"]');
    if (sexeSelect) sexeSelect.value = 'F';
    
    const statutSelect = form.querySelector('select[name="statut"]');
    if (statutSelect) statutSelect.value = 'ACTIF';
    
    const roleSelect = form.querySelector('select[name="role"]');
    if (roleSelect) roleSelect.value = 'MEMBRE';
    
    // Initialiser les checkboxes de carte d'√©lecteur
    const possedeCarte = document.getElementById('possede_carte_electeur');
    const carteValide = document.getElementById('carte_electeur_valide');
    if (possedeCarte) possedeCarte.checked = true;
    if (carteValide) { carteValide.checked = false; carteValide.disabled = false; }
    
    // Initialiser l'indicatif t√©l√©phone
    const indicatif = form.querySelector('select[name="indicatif_telephone"]');
    if (indicatif) indicatif.value = '+228';
    
    // Masquer les aper√ßus d'images
    const photoPreviewWrapper = document.getElementById('photoPreviewWrapper');
    const signaturePreviewWrapper = document.getElementById('signaturePreviewWrapper');
    if (photoPreviewWrapper) photoPreviewWrapper.style.display = 'none';
    if (signaturePreviewWrapper) signaturePreviewWrapper.style.display = 'none';
  } else {
    // Pour modification, on garde l'ID mais on ne fait pas de reset
    form.id.value = id;
  }
  
  document.getElementById('membreModalTitle').textContent = id ? 'Modifier membre' : 'Nouveau membre';
  new bootstrap.Modal(document.getElementById('membreModal')).show();
}
function closeMembreModal(){ const m = document.getElementById('membreModal'); bootstrap.Modal.getInstance(m)?.hide(); }

async function submitMembre(){
  try{
    const form = document.getElementById('membreForm');
    const id = form.id.value;
    const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
    
    // D√©terminer la caisse : si admin, utiliser la caisse s√©lectionn√©e, sinon USER_CAISE_ID
    let caisseId;
    if (isAdmin && !id) {
      // Pour la cr√©ation d'un nouveau membre par admin, utiliser le champ membreCaisse
      const membreCaisseSelect = document.getElementById('membreCaisse');
      if (!membreCaisseSelect || !membreCaisseSelect.value) {
        throw new Error('Veuillez s√©lectionner une caisse.');
      }
      caisseId = Number(membreCaisseSelect.value);
    } else {
      // Pour les non-admins ou la modification, utiliser USER_CAISE_ID
      if (!USER_CAISE_ID) throw new Error('Aucune caisse li√©e');
      caisseId = USER_CAISE_ID;
    }
    
    if (id) {
      // Modification : utiliser JSON pour les donn√©es textuelles
      const formData = new FormData(form);
      const photoFile = formData.get('photo');
      
      // Cr√©er un objet avec les donn√©es textuelles
      const payload = {
        numero_carte_electeur: formData.get('numero_carte_electeur'),
        numero_telephone: formData.get('numero_telephone'),
        nom: formData.get('nom'),
        prenoms: formData.get('prenoms'),
        date_naissance: formData.get('date_naissance'),
        adresse: formData.get('adresse'),
        sexe: formData.get('sexe'),
        role: formData.get('role'),
        statut: formData.get('statut'),
        caisse_id: caisseId
      };
      
      const r = await fetch(`/gestion-caisses/api/membres/${id}/`, { 
        method: 'PATCH', 
        headers:{ 
          'Content-Type': 'application/json',
          'X-CSRFToken':getCSRFToken() 
        }, 
        body: JSON.stringify(payload)
      });
      
      if (!r.ok) {
        const errorData = await r.json();
        throw new Error(errorData.detail || '√âchec modification membre');
      }
    } else {
      // Cr√©ation : utiliser FormData pour inclure la photo
      const formData = new FormData(form);
      formData.append('caisse_id', caisseId);
      
      const r = await fetch('/gestion-caisses/api/membres/', { 
        method: 'POST', 
        headers:{ 'X-CSRFToken':getCSRFToken() }, 
        body: formData 
      });
      
      if (!r.ok) {
        const errorData = await r.json();
        throw new Error(errorData.detail || '√âchec cr√©ation membre');
      }
    }
    
    closeMembreModal();
    loadMembers();
  }catch(e){ 
    const el = document.getElementById('membreError'); 
    if (el){ 
      el.textContent = e.message; 
      el.style.display='block'; 
    } 
  }
}
let CURRENT_MEMBRES = [];
async function loadMembers(){
  const container = document.getElementById('membres-content');
  container.innerHTML = '<div class="text-muted">Chargement...</div>';
  const r = await fetch('/gestion-caisses/api/membres/?ordering=nom', { headers:{ 'X-CSRFToken': getCSRFToken() }});
  const data = await r.json();
  CURRENT_MEMBRES = data.results || data || [];
  if (!CURRENT_MEMBRES.length){ container.innerHTML = '<div class="alert alert-light">Aucun membre.</div>'; return; }

  // Mettre √† jour le filtre par caisse (√† partir des membres charg√©s)
  const caisseFilter = document.getElementById('membreCaisseFilter');
  if (caisseFilter) {
    const caisses = Array.from(new Set((CURRENT_MEMBRES || []).map(m => m.caisse_nom).filter(Boolean))).sort();
    caisseFilter.innerHTML = '<option value=\"\">Toutes les caisses</option>' + caisses.map(n => `<option value=\"${n}\">${n}</option>`).join('');
  }

  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  CURRENT_MEMBRES.forEach(m=>{
    const card = document.createElement('div');
    card.className = 'col-12 col-md-6 col-lg-4';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between'>
            <h5 class='card-title mb-1'>${m.nom_complet}</h5>
            <span class='badge ${m.statut==='ACTIF'?'bg-success':'bg-secondary'}'>${m.statut}</span>
          </div>
          <div class='text-muted mb-1'>R√¥le: ${m.role}</div>
          <div class='small text-muted mb-1'>Caisse: ${m.caisse_nom || '-'}</div>
          <div class='small text-muted'>T√©l√©phone: ${m.numero_telephone||'-'}</div>
          <div class='mt-3 d-flex gap-2'>
            <button class='btn btn-sm btn-outline-primary' onclick='prefillMembre(${m.id})'>Modifier</button>
            <button class='btn btn-sm btn-outline-success' onclick='generateMembrePDF(${m.id})' title='G√©n√©rer fiche PDF'>
              <i class="fas fa-file-pdf"></i>
            </button>
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

function filterMembers(){
  const q = (document.getElementById('membreSearch').value||'').toLowerCase();
  const caisseSelect = document.getElementById('membreCaisseFilter');
  const caisseFilter = (caisseSelect && caisseSelect.value ? caisseSelect.value.toLowerCase() : '');

  const list = CURRENT_MEMBRES.filter(m => {
    const matchesText = (m.nom_complet||'').toLowerCase().includes(q) || (m.numero_telephone||'').toLowerCase().includes(q);
    const caisseName = (m.caisse_nom || '').toLowerCase();
    const matchesCaisse = !caisseFilter || caisseName === caisseFilter;
    return matchesText && matchesCaisse;
  });
  const container = document.getElementById('membres-content');
  if (!list.length){ container.innerHTML = '<div class="alert alert-light mt-3">Aucun membre ne correspond.</div>'; return; }
  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  list.forEach(m=>{
    const card = document.createElement('div');
    card.className = 'col-12 col-md-6 col-lg-4';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between'>
            <h5 class='card-title mb-1'>${m.nom_complet}</h5>
            <span class='badge ${m.statut==='ACTIF'?'bg-success':'bg-secondary'}'>${m.statut}</span>
          </div>
          <div class='text-muted mb-1'>R√¥le: ${m.role}</div>
          <div class='small text-muted mb-1'>Caisse: ${m.caisse_nom || '-'}</div>
          <div class='small text-muted'>T√©l√©phone: ${m.numero_telephone||'-'}</div>
          <div class='mt-3 d-flex gap-2'>
            <button class='btn btn-sm btn-outline-primary' onclick='prefillMembre(${m.id})'>Modifier</button>
            <button class='btn btn-sm btn-outline-success' onclick='generateMembrePDF(${m.id})' title='G√©n√©rer fiche PDF'>
              <i class="fas fa-file-pdf"></i>
            </button>
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

async function prefillMembre(id){
  const r = await fetch(`/gestion-caisses/api/membres/${id}/`, { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const m = await r.json();
  
  // D'abord ouvrir le modal
  openMembreModal(id);
  
  // Ensuite remplir les donn√©es
  const form = document.getElementById('membreForm');
  form.id.value = id;
  
  // Informations d'identification
  const possedeCarte = document.getElementById('possede_carte_electeur');
  const carteValide = document.getElementById('carte_electeur_valide');
  if (possedeCarte) possedeCarte.checked = m.possede_carte_electeur || false;
  if (carteValide) carteValide.checked = m.carte_electeur_valide || false;
  
  form.numero_carte_electeur.value = m.numero_carte_electeur || '';
  
  // Informations personnelles
  form.nom.value = m.nom || '';
  form.prenoms.value = m.prenoms || '';
  form.date_naissance.value = m.date_naissance || '';
  form.adresse.value = m.adresse || '';
  
  // G√©rer le champ sexe
  const sexeSelect = form.querySelector('select[name="sexe"]');
  if (sexeSelect) sexeSelect.value = m.sexe || 'F';
  
  // Contact
  const indicatifSelect = form.querySelector('select[name="indicatif_telephone"]');
  if (indicatifSelect) indicatifSelect.value = m.indicatif_telephone || '+228';
  
  form.numero_telephone.value = m.numero_telephone || '';
  form.numero_whatsapp.value = m.numero_whatsapp || '';
  
  // Localisation
  form.quartier.value = m.quartier || '';
  
  // R√¥le et statut
  form.role.value = m.role || 'MEMBRE';
  form.statut.value = m.statut || 'ACTIF';
  
  // Notes
  form.notes.value = m.notes || '';
  
  // G√©rer l'affichage de la photo existante
  if (m.photo){
    const preview = document.getElementById('photoPreview');
    const previewWrapper = document.getElementById('photoPreviewWrapper');
    if (preview && previewWrapper){
      preview.src = m.photo;
      previewWrapper.style.display = 'block';
    }
  } else {
    const previewWrapper = document.getElementById('photoPreviewWrapper');
    if (previewWrapper) previewWrapper.style.display = 'none';
  }
  
  // G√©rer l'affichage de la signature existante
  if (m.signature){
    const preview = document.getElementById('signaturePreview');
    const previewWrapper = document.getElementById('signaturePreviewWrapper');
    if (preview && previewWrapper){
      preview.src = m.signature;
      previewWrapper.style.display = 'block';
    }
  } else {
    const previewWrapper = document.getElementById('signaturePreviewWrapper');
    if (previewWrapper) previewWrapper.style.display = 'none';
  }
}

// ===== Pr√™ts (CRUD minimal) =====
function openPretModal(id){
  document.getElementById('pretError')?.style && (document.getElementById('pretError').style.display='none');
  const form = document.getElementById('pretForm');
  form.reset();
  form.id.value = id || '';
  document.getElementById('pretModalTitle').textContent = id ? 'Modifier pr√™t' : 'Nouveau pr√™t';
  
  // R√©initialiser l'avertissement et le bouton
  const warningDiv = document.getElementById('memberLoanWarning');
  const submitBtn = document.querySelector('#pretModal .btn-primary');
  if (warningDiv) warningDiv.style.display = 'none';
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Enregistrer';
  }
  
  // Charger les caisses si admin
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  const promises = [];
  if (isAdmin) {
    promises.push(loadPretCaisses());
    // Pour les admins, ne pas charger les membres tant qu'une caisse n'est pas s√©lectionn√©e
    const membreSelect = document.getElementById('pretMembre');
    if (membreSelect) {
      membreSelect.innerHTML = '<option value="">S√©lectionner d\'abord une caisse</option>';
      membreSelect.disabled = true;
    }
  } else {
    promises.push(loadPretMembres(USER_CAISE_ID));
  }
  
  Promise.all(promises).then(async ()=>{ 
    const modalEl = document.getElementById('pretModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    if (id) {
      await prefillPret(id);
    } else {
      setTimeout(() => updateInterestPreview(), 0);
    }
  });
}
function closePretModal(){
  const m = document.getElementById('pretModal');
  bootstrap.Modal.getInstance(m)?.hide();
  const preview = document.getElementById('interestPreview');
  if (preview) preview.style.display = 'none';
}

async function loadPretMembres(caisseId = null){
  const sel = document.getElementById('pretMembre');
  sel.innerHTML = '<option value="">Chargement...</option>';
  let url = '/gestion-caisses/api/membres/';
  if (caisseId) {
    url += `?caisse=${caisseId}`;
  }
  const r = await fetch(url, { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const data = await r.json();
  sel.innerHTML = '';
  (data.results||data).forEach(m=>{ 
    const opt = document.createElement('option'); 
    opt.value = m.id; 
    opt.textContent = m.nom_complet; 
    sel.appendChild(opt); 
  });
}

async function loadPretCaisses(){
  const sel = document.getElementById('pretCaisse');
  if (!sel) return; // Si le champ n'existe pas (non-admin), ne rien faire
  sel.innerHTML = '<option value="">Chargement...</option>';
  const r = await fetch('/gestion-caisses/api/caisses/', { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const data = await r.json();
  sel.innerHTML = '<option value="">S√©lectionner une caisse</option>';
  (data.results||data).forEach(c=>{ 
    const opt = document.createElement('option'); 
    opt.value = c.id; 
    opt.textContent = `${c.code || ''} ${c.nom_association || ''}`.trim(); 
    sel.appendChild(opt); 
  });
}

function onPretCaisseChange(){
  const caisseSelect = document.getElementById('pretCaisse');
  const membreSelect = document.getElementById('pretMembre');
  if (caisseSelect && membreSelect) {
    const caisseId = caisseSelect.value;
    if (caisseId) {
      membreSelect.disabled = true;
      membreSelect.innerHTML = '<option value="">Chargement...</option>';
      loadPretMembres(caisseId).then(() => {
        membreSelect.disabled = false;
      });
    } else {
      membreSelect.innerHTML = '<option value="">S√©lectionner d\'abord une caisse</option>';
      membreSelect.disabled = true;
    }
  }
}

async function submitPret(){
  try{
    const form = document.getElementById('pretForm');
    const payload = Object.fromEntries(new FormData(form).entries());
    const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
    
    // D√©terminer la caisse √† utiliser
    let caisseId = null;
    if (isAdmin) {
      caisseId = payload.caisse_id;
      if (!caisseId) {
        throw new Error('Veuillez s√©lectionner une caisse');
      }
    } else {
      if (!USER_CAISE_ID) throw new Error('Aucune caisse li√©e');
      caisseId = USER_CAISE_ID;
    }
    
    // Validation plafond c√¥t√© client: montant <= 2x cotisations
    if (payload.membre_id) {
      try {
        const resTot = await fetch(`/gestion-caisses/api/membres/${payload.membre_id}/cotisations-total/`, { headers: { 'X-CSRFToken': getCSRFToken() } });
        if (resTot.ok) {
          const jsTot = await resTot.json();
          const total = parseFloat(jsTot.total_cotisations) || 0;
          const plafond = (total || 0) * 2;
          const montant = parseFloat(payload.montant_demande || '0');
          if (!isNaN(montant) && montant > plafond) {
            throw new Error(`Le montant demand√© d√©passe le plafond autoris√© (${plafond.toLocaleString('fr-FR')} FCFA).`);
          }
        }
      } catch(e){
        if (e instanceof Error) {
          const el = document.getElementById('pretError'); if (el){ el.textContent = e.message; el.style.display='block'; }
          return;
        }
      }
    }
    const id = payload.id; delete payload.id;
    payload.caisse_id = caisseId;
    
    // G√©rer la logique du motif "autres"
    if (payload.motif === 'autres') {
      if (!payload.motif_autre || payload.motif_autre.trim() === '') {
        throw new Error('Veuillez pr√©ciser le motif sp√©cifique');
      }
      payload.motif = payload.motif_autre;
    }
    delete payload.motif_autre; // Supprimer le champ temporaire
    
    const method = id ? 'PATCH' : 'POST';
    const url = id ? `/gestion-caisses/api/prets/${id}/` : '/gestion-caisses/api/prets/';
    const r = await fetch(url, { method, headers:{ 'Content-Type':'application/json','X-CSRFToken':getCSRFToken() }, body: JSON.stringify(payload) });
    if (!r.ok) {
      // remonter le message backend s'il existe
      const err = await r.json().catch(()=>({}));
      const msg = err.montant_demande?.[0] || err.membre?.[0] || err.detail || '√âchec enregistrement pr√™t';
      throw new Error(msg);
    }
    closePretModal();
    loadPrets();
  }catch(e){ const el = document.getElementById('pretError'); if (el){ el.textContent = e.message; el.style.display='block'; } }
}

async function loadPrets(){
  const container = document.getElementById('prets-content');
  container.innerHTML = '<div class="text-muted">Chargement...</div>';
  // D√©terminer si l'utilisateur est administrateur
  const roleText = document.getElementById('user-role')?.textContent?.trim() || '';
  const isAdmin = roleText === 'Administrateur';

  // Pour les agents et autres non-admins, filtrer par la caisse active si disponible
  let url = '/gestion-caisses/api/prets/';
  if (!isAdmin && typeof USER_CAISE_ID !== 'undefined' && USER_CAISE_ID) {
    const params = new URLSearchParams({ caisse: USER_CAISE_ID });
    url = `/gestion-caisses/api/prets/?${params.toString()}`;
  }

  const r = await fetch(url, { headers:{ 'X-CSRFToken': getCSRFToken() }});
  const data = await r.json();
  const prets = data.results || data;
  // (supprim√©) mise √† jour graph dans l'onglet Pr√™ts
  if (!prets || !prets.length){ container.innerHTML = '<div class="alert alert-light">Aucun pr√™t.</div>'; return; }
  container.innerHTML = '<div class="row g-3"></div>';
  const row = container.firstElementChild;
  prets.forEach(p=>{
    const principalReference = Number(p.montant_accord || p.montant_demande || 0);
    const interetTotal = Number(p.interet_total ?? ((p.total_a_rembourser || 0) - principalReference)) || 0;
    const interetMensuel = p.duree_mois ? (interetTotal / Number(p.duree_mois || 1)) : interetTotal;
    const totalARemb = Number(p.total_a_rembourser|| (principalReference + interetTotal));
    const montantRestant = Number(p.montant_restant||0);
    let ratio = 0;
    if (totalARemb > 0) {
      ratio = (totalARemb - Math.max(0, montantRestant)) / totalARemb;
    } else if (p.nombre_echeances) {
      ratio = Number(p.nombre_echeances_payees||0) / Number(p.nombre_echeances||1);
    }
    if (!isFinite(ratio) || ratio < 0) ratio = 0; if (ratio > 1) ratio = 1;
    const pct = Math.round(ratio * 100);
    const barClass = pct >= 100 ? 'bg-success' : (pct >= 50 ? 'bg-info' : 'bg-warning');
    const statutLabel = (p.statut==='REMBOURSE') ? 'REMBOURS√â' : p.statut;
    const statusClass = p.statut==='EN_COURS'?'bg-success':(p.statut==='EN_RETARD'?'bg-danger':'bg-secondary');
    const card = document.createElement('div'); card.className='col-12 col-lg-6';
    card.innerHTML = `
      <div class='card h-100 shadow-sm'>
        <div class='card-body'>
          <div class='d-flex justify-content-between align-items-center'>
            <span class='badge ${statusClass}'>${statutLabel}</span>
            <div class='text-end'>
              <div class='text-muted'>${p.numero_pret||''}</div>
              <div class='small text-secondary'>${p.caisse_code || p.caisse?.code || ''} ‚Äî ${p.caisse_nom || p.caisse?.nom_association || ''}</div>
            </div>
          </div>
          <h5 class='mt-2 mb-1'>${p.membre_nom || p.membre?.nom_complet || ''}</h5>
          <div class='small text-muted'>Montant demand√©: ${Number(p.montant_demande||0).toLocaleString('fr-FR')} FCFA</div>
          ${interetTotal > 0 ? `
          <div class='small text-info'>
            <i class="fas fa-percentage"></i> Taux mensuel: ${p.taux_interet}% | 
            Int√©r√™t total: ${interetTotal.toLocaleString('fr-FR')} FCFA (${interetMensuel.toLocaleString('fr-FR')} FCFA / mois)
          </div>
          <div class='small text-success fw-bold'>
            Total √† rembourser: ${totalARemb.toLocaleString('fr-FR')} FCFA
          </div>
          ` : `
          <div class='small text-muted'>Total √† rembourser: ${totalARemb.toLocaleString('fr-FR')} FCFA</div>
          `}
          <div class='small text-muted'>Reste: ${Number(p.montant_restant||0).toLocaleString('fr-FR')} FCFA</div>
          <div class='mt-2'>
            <div class='d-flex justify-content-between small'>
              <span>Parcours de remboursement</span><span>${pct}%</span>
            </div>
            <div class='progress' style='height:6px;'>
              <div class='progress-bar ${barClass}' role='progressbar' style='width:${pct}%' aria-valuenow='${pct}' aria-valuemin='0' aria-valuemax='100'></div>
            </div>
            ${p.nombre_echeances ? `<div class='small text-muted mt-1'>√âch√©ances: ${p.nombre_echeances_payees||0}/${p.nombre_echeances}</div>` : ''}
          </div>
          <div class='mt-3 d-flex gap-2 flex-wrap'>
            ${['EN_ATTENTE','EN_ATTENTE_ADMIN'].includes(p.statut) ? `<button class='btn btn-sm btn-outline-primary' onclick='openPretModal(${p.id})'><i class="fas fa-edit"></i> Modifier</button>` : ''}
            
            ${p.statut==='VALIDE' ? `<button class='btn btn-sm btn-success' onclick='octroyerPret(${p.id})'><i class="fas fa-hand-holding-usd"></i> Octroyer</button>` : ''}
            ${(p.statut==='EN_COURS'||p.statut==='EN_RETARD') ? `<button class='btn btn-sm btn-warning' onclick='openRemboursementModal(${p.id})'><i class="fas fa-money-bill-wave"></i> Rembourser</button>` : ''}
            ${p.statut==='EN_COURS' ? `<button class='btn btn-sm btn-outline-info' onclick='generateAttestationPretPDF(${p.id})'><i class="fas fa-file-pdf"></i> Attestation Pr√™t</button>` : ''}
            ${p.statut==='REMBOURSE' ? `<button class='btn btn-sm btn-info' onclick='generateRemboursementCompletPDF(${p.id})'><i class="fas fa-file-pdf"></i> PDF Complet</button>` : ''}
            ${p.statut==='REMBOURSE' ? `<button class='btn btn-sm btn-outline-success' onclick='generateAttestationRemboursementPDF(${p.id})'><i class="fas fa-file-pdf"></i> Attestation Remboursement</button>` : ''}
            ${p.statut==='BLOQUE' ? `<button class='btn btn-sm btn-warning' onclick='showFondsInsuffisantsAlert(${JSON.stringify(p).replace(/"/g, '&quot;')})'><i class="fas fa-exclamation-triangle"></i> Voir D√©tails</button>` : ''}
          </div>
        </div>
      </div>`;
    row.appendChild(card);
  });
}

// Fonction pour v√©rifier le statut des pr√™ts du membre s√©lectionn√©
async function checkMemberLoanStatus() {
  const membreId = document.getElementById('pretMembre').value;
  const warningDiv = document.getElementById('memberLoanWarning');
  const contribWarningDiv = document.getElementById('memberContributionWarning');
  const contribInfo = document.getElementById('memberContributionInfo');
  const submitBtn = document.querySelector('#pretModal .btn-primary');
  
  if (!membreId) {
    warningDiv.style.display = 'none';
    if (contribWarningDiv) contribWarningDiv.style.display = 'none';
    if (contribInfo) contribInfo.style.display = 'none';
    submitBtn.disabled = false;
    return;
  }
  
  try {
    const response = await fetch(`/gestion-caisses/api/prets/?membre=${membreId}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const data = await response.json();
    const prets = data.results || data;
    
    // V√©rifier s'il y a des pr√™ts actifs (tous les statuts sauf REMBOURSE et REJETE)
    const hasActiveLoan = prets.some(pret => 
      ['EN_ATTENTE', 'EN_ATTENTE_ADMIN', 'VALIDE', 'EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(pret.statut)
    );
    
    if (hasActiveLoan) {
      warningDiv.style.display = 'block';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Pr√™t impossible - Membre a d√©j√† un pr√™t actif';
      
      // Afficher un message plus d√©taill√©
      const activePret = prets.find(pret => 
        ['EN_ATTENTE', 'EN_ATTENTE_ADMIN', 'VALIDE', 'EN_COURS', 'EN_RETARD', 'BLOQUE'].includes(pret.statut)
      );
      
      if (activePret) {
        const statutLabel = activePret.statut === 'EN_COURS' ? 'En cours' : 
                           activePret.statut === 'EN_ATTENTE' ? 'En attente' :
                           activePret.statut === 'EN_ATTENTE_ADMIN' ? 'En attente validation admin' :
                           activePret.statut === 'VALIDE' ? 'Valid√©' :
                           activePret.statut === 'EN_RETARD' ? 'En retard' :
                           activePret.statut === 'BLOQUE' ? 'Bloqu√©' : activePret.statut;
        
        warningDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i> 
          Ce membre a d√©j√† un pr√™t ${statutLabel.toLowerCase()} (${activePret.numero_pret}). 
          Il doit d'abord terminer ce pr√™t avant de pouvoir faire un nouveau pr√™t.
        `;
      }
    } else {
      warningDiv.style.display = 'none';

      // Bloquer les pr√™ts √† partir du 10√®me mois de l'exercice en cours
      try {
        const caisseResp = await fetch(`${API_BASE}/caisses/?id=${encodeURIComponent(USER_CAISE_ID||'')}`);
        const caisses = await caisseResp.json();
        const my = Array.isArray(caisses.results) ? caisses.results[0] : (Array.isArray(caisses) ? caisses[0] : null);
        if (my && my.exercice_actuel && my.exercice_actuel.date_debut) {
          const d0 = new Date(my.exercice_actuel.date_debut);
          const today = new Date();
          const monthsSince = (today.getFullYear()-d0.getFullYear())*12 + (today.getMonth()-d0.getMonth()) + 1;
          if (monthsSince >= 10) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Pr√™t indisponible - 10√®me mois de l'exercice";
            if (contribWarningDiv) {
              contribWarningDiv.style.display = 'block';
              contribWarningDiv.innerHTML = `<i class=\"fas fa-exclamation-triangle\"></i> Les nouveaux pr√™ts sont interdits √† partir du 10√®me mois jusqu'√† la cl√¥ture de l'exercice.`;
            }
            return; // ne pas continuer d'autres validations
          }
        }
      } catch(e) {}

      // Nouvelle r√®gle: v√©rifier le nombre de mois distincts cotis√©s (>= 3)
      let moisCotises = 0;
      try {
        const res2 = await fetch(`${API_BASE}/cotisations/stats/membre/?membre_id=${encodeURIComponent(membreId)}`);
        if (res2.ok) {
          const js2 = await res2.json();
          moisCotises = parseInt(js2.nombre_mois_cotises || 0, 10);
        }
      } catch (e) {
        // En cas d'erreur, ne pas bloquer c√¥t√© frontend; le backend validera
      }

      // R√®gle combin√©e: mois >= 3 OU total cotisations >= 5000 FCFA
      let totalCotisations = 0;
      try {
        const resTot = await fetch(`/gestion-caisses/api/membres/${membreId}/cotisations-total/`, { headers: { 'X-CSRFToken': getCSRFToken() } });
        if (resTot.ok) {
          const jsTot = await resTot.json();
          totalCotisations = parseFloat(jsTot.total_cotisations) || 0;
        }
      } catch (e) {}

      if ((moisCotises < 3) && (totalCotisations < 5000)) {
        if (contribWarningDiv) {
          contribWarningDiv.style.display = 'block';
          contribWarningDiv.innerHTML = `<i class=\"fas fa-exclamation-triangle\"></i> Non √©ligible: au moins 3 mois cotis√©s ou 5000 FCFA cumul√©s (actuel: ${moisCotises} mois, ${totalCotisations.toLocaleString('fr-FR')} FCFA).`;
        }
        if (contribInfo) {
          contribInfo.style.display = 'block';
          contribInfo.textContent = `Mois cotis√©s: ${moisCotises} | Total: ${totalCotisations.toLocaleString('fr-FR')} FCFA`;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Pr√™t indisponible - conditions non remplies';
      } else {
        if (contribWarningDiv) contribWarningDiv.style.display = 'none';
        if (contribInfo) {
          contribInfo.style.display = 'block';
          contribInfo.textContent = `Mois cotis√©s: ${moisCotises} | Total: ${totalCotisations.toLocaleString('fr-FR')} FCFA`;
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enregistrer';
      }

      // Appliquer le plafond 2x cotisations au champ "Montant demand√©"
      const plafondEl = document.getElementById('memberPlafondInfo');
      const montantInput = document.getElementById('montant_demande');
      const plafond = (totalCotisations || 0) * 2;
      if (plafondEl) {
        plafondEl.style.display = 'block';
        plafondEl.textContent = `Plafond: ${plafond.toLocaleString('fr-FR')} FCFA (2√ó cotisations cumul√©es)`;
      }
      if (montantInput) {
        if (!isNaN(plafond) && plafond > 0) {
          montantInput.setAttribute('max', String(Math.floor(plafond)));
          if (parseFloat(montantInput.value||'0') > plafond) {
            montantInput.classList.add('is-invalid');
          } else {
            montantInput.classList.remove('is-invalid');
          }
        } else {
          montantInput.removeAttribute('max');
          montantInput.classList.remove('is-invalid');
        }
        montantInput.oninput = function(){
          const val = parseFloat(this.value || '0');
          if (!isNaN(val) && val > plafond) this.classList.add('is-invalid'); else this.classList.remove('is-invalid');
        };
      }
    }
  } catch (error) {
    console.error('Erreur lors de la v√©rification du statut des pr√™ts:', error);
  }
}

// Fonction pour mettre √† jour l'aper√ßu du calcul d'int√©r√™t
function updateInterestPreview() {
  const form = document.getElementById('pretForm');
  if (!form) return;
  const montantDemande = parseFloat(form.montant_demande?.value || 0);
  const tauxInteret = parseFloat(form.taux_interet?.value || 0);
  const dureeMois = parseInt(form.duree_mois?.value || 0, 10);
  
  if (montantDemande > 0 && tauxInteret > 0 && dureeMois > 0) {
    const interetMensuel = montantDemande * tauxInteret / 100;
    const interetTotal = interetMensuel * dureeMois;
    const total = montantDemande + interetTotal;
    
    document.getElementById('previewMontantDemande').textContent = montantDemande.toLocaleString('fr-FR');
    document.getElementById('previewInteretMensuel').textContent = interetMensuel.toLocaleString('fr-FR');
    document.getElementById('previewInteretTotal').textContent = interetTotal.toLocaleString('fr-FR');
    document.getElementById('previewTotal').textContent = total.toLocaleString('fr-FR');
    document.getElementById('previewTaux').textContent = tauxInteret.toLocaleString('fr-FR');
    document.getElementById('previewDuree').textContent = dureeMois;
    
    document.getElementById('interestPreview').style.display = 'block';
  } else {
    document.getElementById('interestPreview').style.display = 'none';
  }
}

// Fonction pour g√©rer l'affichage du champ "Autres" pour le motif
function toggleMotifAutre() {
  const motifSelect = document.getElementById('motifSelect');
  const motifAutreDiv = document.getElementById('motifAutreDiv');
  const motifAutre = document.getElementById('motifAutre');
  
  if (motifSelect.value === 'autres') {
    motifAutreDiv.style.display = 'block';
    motifAutre.required = true;
  } else {
    motifAutreDiv.style.display = 'none';
    motifAutre.required = false;
    motifAutre.value = '';
  }
}

async function prefillPret(id){
  const r = await fetch(`/gestion-caisses/api/prets/${id}/`, { headers:{ 'X-CSRFToken':getCSRFToken() }});
  const p = await r.json();
  const form = document.getElementById('pretForm');
  form.id.value = id;
  // Pr√©remplir la caisse si admin
  const caisseSelect = document.getElementById('pretCaisse');
  const membreSelect = document.getElementById('pretMembre');
  if (caisseSelect && p.caisse?.id) {
    caisseSelect.value = p.caisse.id;
    // Recharger les membres de cette caisse
    if (membreSelect) {
      membreSelect.disabled = true;
      membreSelect.innerHTML = '<option value="">Chargement...</option>';
    }
    await loadPretMembres(p.caisse.id);
    if (membreSelect) {
      membreSelect.disabled = false;
    }
  }
  if (membreSelect) {
    membreSelect.value = p.membre?.id || '';
  }
  form.montant_demande.value = p.montant_demande || p.montant_accord || 0;
  form.duree_mois.value = p.duree_mois || 0;
  form.taux_interet.value = p.taux_interet || 0;
  
  // G√©rer le motif - v√©rifier si c'est une valeur pr√©d√©finie ou "autres"
  const motifSelect = document.getElementById('motifSelect');
  const motifAutre = document.getElementById('motifAutre');
  const motifAutreDiv = document.getElementById('motifAutreDiv');
  
  if (p.motif) {
    // V√©rifier si le motif correspond √† une option pr√©d√©finie
    const options = Array.from(motifSelect.options).map(opt => opt.value);
    if (options.includes(p.motif)) {
      motifSelect.value = p.motif;
      if (p.motif === 'autres') {
        motifAutreDiv.style.display = 'block';
        motifAutre.required = true;
      } else {
        motifAutreDiv.style.display = 'none';
        motifAutre.required = false;
      }
    } else {
      // Si le motif n'est pas dans les options pr√©d√©finies, le mettre dans "autres"
      motifSelect.value = 'autres';
      motifAutre.value = p.motif;
      motifAutreDiv.style.display = 'block';
      motifAutre.required = true;
    }
  }
  
  // G√©rer les d√©tails du pr√™t
  form.details_pret.value = p.details_pret || '';
  
  // Mettre √† jour l'aper√ßu du calcul d'int√©r√™t
  setTimeout(() => updateInterestPreview(), 0);
}

async function octroyerPret(id){
  // Afficher un modal moderne de confirmation
  showOctroiConfirmationModal(id);
}

function showOctroiConfirmationModal(pretId) {
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('octroiConfirmationModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalHtml = `
    <div class="modal fade" id="octroiConfirmationModal" tabindex="-1" aria-labelledby="octroiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-success text-white border-0">
            <h5 class="modal-title" id="octroiModalLabel">
              <i class="fas fa-hand-holding-usd me-2"></i>
              Confirmation d'Octroi de Pr√™t
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-info border-0 bg-light">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong>Action importante :</strong> Vous √™tes sur le point d'octroyer ce pr√™t au membre.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="d-flex align-items-center justify-content-center mb-3">
                  <div class="spinner-border text-primary me-3" role="status" id="octroiSpinner" style="display: none;">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <div id="octroiContent">
                    <p class="mb-3">
                      <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                      Cette action va :
                    </p>
                    <ul class="list-unstyled ms-4">
                      <li><i class="fas fa-check-circle text-success me-2"></i>D√©biter le montant du pr√™t de la caisse</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>Changer le statut du pr√™t √† "En cours"</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>G√©n√©rer un PDF d'attestation d'octroi</li>
                      <li><i class="fas fa-check-circle text-success me-2"></i>Envoyer une notification √† la pr√©sidente</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="octroiError" class="alert alert-danger mt-3" style="display: none;">
              <i class="fas fa-exclamation-circle me-2"></i>
              <span id="octroiErrorMessage"></span>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Annuler
            </button>
            <button type="button" class="btn btn-success" onclick="confirmOctroi(${pretId})" id="confirmOctroiBtn">
              <i class="fas fa-hand-holding-usd me-2"></i>Confirmer l'Octroi
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('octroiConfirmationModal'));
  modal.show();
}

async function confirmOctroi(pretId) {
  const spinner = document.getElementById('octroiSpinner');
  const content = document.getElementById('octroiContent');
  const confirmBtn = document.getElementById('confirmOctroiBtn');
  const errorDiv = document.getElementById('octroiError');
  const errorMessage = document.getElementById('octroiErrorMessage');
  
  // Afficher le spinner et d√©sactiver le bouton
  spinner.style.display = 'block';
  content.style.display = 'none';
  confirmBtn.disabled = true;
  confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement en cours...';
  errorDiv.style.display = 'none';
  
  try {
    // Appeler l'API pour octroyer le pr√™t
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/octroyer/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Erreur lors de l\'octroi du pr√™t');
    }
    
    const data = await response.json();
    
    // Afficher le succ√®s
    showOctroiSuccessModal(pretId, data);
    
  } catch (error) {
    console.error('Erreur lors de l\'octroi:', error);
    
    // Afficher l'erreur
    errorMessage.textContent = error.message;
    errorDiv.style.display = 'block';
    
    // Restaurer l'interface
    spinner.style.display = 'none';
    content.style.display = 'block';
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = '<i class="fas fa-hand-holding-usd me-2"></i>Confirmer l\'Octroi';
  }
}
function showOctroiSuccessModal(pretId, pretData) {
  // Fermer le modal de confirmation
  const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('octroiConfirmationModal'));
  confirmationModal.hide();
  
  // Supprimer le modal existant s'il y en a un
  const existingModal = document.getElementById('octroiSuccessModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalHtml = `
    <div class="modal fade" id="octroiSuccessModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-success text-white border-0">
            <h5 class="modal-title" id="successModalLabel">
              <i class="fas fa-check-circle me-2"></i>
              Pr√™t Octroy√© avec Succ√®s !
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-success border-0 bg-light-success">
                <i class="fas fa-hand-holding-usd text-success me-2"></i>
                <strong>F√©licitations !</strong> Le pr√™t a √©t√© octroy√© avec succ√®s.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title text-primary">
                      <i class="fas fa-file-alt me-2"></i>D√©tails de l'Octroi
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Num√©ro de pr√™t :</strong></p>
                        <p class="text-muted">${pretData.numero_pret || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Membre :</strong></p>
                        <p class="text-muted">${pretData.membre?.nom_complet || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Montant accord√© :</strong></p>
                        <p class="text-success fw-bold">${Number(pretData.montant_accord || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Date d'octroi :</strong></p>
                        <p class="text-muted">${new Date().toLocaleDateString('fr-FR')}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info mt-3 border-0">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Prochaines √©tapes :</strong>
              <ul class="mb-0 mt-2">
                <li>T√©l√©chargez l'attestation d'octroi en PDF</li>
                <li>Remettez le montant au membre</li>
                <li>Suivez les remboursements dans le tableau</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Fermer
            </button>
            <button type="button" class="btn btn-primary" onclick="downloadOctroiPDF(${pretId})">
              <i class="fas fa-file-pdf me-2"></i>T√©l√©charger l'Attestation
            </button>
            <button type="button" class="btn btn-success" onclick="closeOctroiSuccessAndRefresh()">
              <i class="fas fa-check me-2"></i>Termin√©
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('octroiSuccessModal'));
  modal.show();
}

async function downloadOctroiPDF(pretId) {
  try {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>G√©n√©ration...';
    
    // Appeler l'API pour g√©n√©rer le PDF
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/octroi_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `attestation-octroi-pret-${pretId}.pdf`;
    document.body.appendChild(a);
    a.click();
    // Rafra√Æchir l'application apr√®s le clic
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    showToast('PDF g√©n√©r√© avec succ√®s !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    showToast('Erreur lors de la g√©n√©ration du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = '<i class="fas fa-file-pdf me-2"></i>T√©l√©charger l\'Attestation';
  }
}

function closeOctroiSuccessAndRefresh() {
  // Fermer le modal de succ√®s
  const successModal = bootstrap.Modal.getInstance(document.getElementById('octroiSuccessModal'));
  successModal.hide();
  
  // Recharger la liste des pr√™ts
  loadPrets();
  
  // Afficher un toast de confirmation
  showToast('Pr√™t octroy√© avec succ√®s !', 'success');
}

function showToast(message, type = 'info') {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0 position-fixed" 
         style="top: 20px; right: 20px; z-index: 9999;" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.querySelector('.toast');
  const toast = new bootstrap.Toast(toastElement);
  toast.show();
  
  // Supprimer le toast apr√®s qu'il soit cach√©
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

async function openRemboursementModal(id){
  // R√©cup√©rer les infos du pr√™t pour afficher le reste total (principal + int√©r√™ts)
  let pret;
  try{
    const r = await fetch(`/gestion-caisses/api/prets/${id}/`);
    pret = await r.json();
  }catch(e){ pret = null; }

  if (!pret) {
    showToast('Erreur lors de la r√©cup√©ration des informations du pr√™t', 'error');
    return;
  }

  // Calculer le montant restant de mani√®re plus pr√©cise
  const montantAccord = Number(pret?.montant_accord||0);
  const principalRembourse = Number(pret?.montant_rembourse||0);
  const totalARembourser = Number(pret?.total_a_rembourser||0);
  
  // Calculer le montant restant r√©el
  let totalRestant;
  if (totalARembourser > 0) {
    // Utiliser le total √† rembourser calcul√© par le backend
    totalRestant = Math.max(totalARembourser - principalRembourse, 0);
  } else {
    // Fallback sur le montant restant du mod√®le
    totalRestant = Math.max(Number(pret?.montant_restant||0), 0);
  }

  // Calculer le principal restant et l'int√©r√™t restant
  const principalRestant = Math.max(montantAccord - principalRembourse, 0);
  const interetRestant = Math.max(totalRestant - principalRestant, 0);

  // Exposer la limite pour la validation c√¥t√© client
  window.__totalRembRestant = totalRestant;
  window.__principalRestant = principalRestant;
  window.__interetRestant = interetRestant;

  const fmt = (n)=> Number(n||0).toLocaleString('fr-FR') + ' FCFA';

  const html = `
  <div class="modal" tabindex="-1" id="rembModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remboursement</h5>
          <button type="button" class="btn-close" onclick="closeRembModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 p-3 bg-light rounded">
            <h6 class="mb-2">R√©sum√© du pr√™t</h6>
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Montant accord√©:</small><br/>
                <strong>${fmt(montantAccord)}</strong>
              </div>
              <div class="col-6">
                <small class="text-muted">D√©j√† rembours√©:</small><br/>
                <strong>${fmt(principalRembourse)}</strong>
              </div>
            </div>
            <hr class="my-2">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Principal restant:</small><br/>
                <strong class="text-primary">${fmt(principalRestant)}</strong>
              </div>
              <div class="col-6">
                <small class="text-muted">Int√©r√™t restant:</small><br/>
                <strong class="text-warning">${fmt(interetRestant)}</strong>
              </div>
            </div>
            <hr class="my-2">
            <div class="text-center">
              <small class="text-muted">Total restant √† payer:</small><br/>
              <strong class="text-success fs-5">${fmt(totalRestant)}</strong>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Montant principal √† rembourser (peut inclure l'int√©r√™t)</label>
            <input type="number" class="form-control" id="rembMontant" 
                   value="${totalRestant}" min="0" max="${totalRestant}" step="100"
                   oninput="validateRemboursement()" 
                   placeholder="Saisissez le montant total √† rembourser" />
            <small class="text-muted">Maximum: ${fmt(totalRestant)} (principal + int√©r√™t)</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Montant int√©r√™t √† rembourser (optionnel)</label>
            <input type="number" class="form-control" id="rembInteret" 
                   value="0" min="0" max="${interetRestant}" step="100"
                   oninput="validateRemboursement()" 
                   placeholder="Saisissez le montant d'int√©r√™t s√©par√©ment (optionnel)" />
            <small class="text-muted">Maximum: ${fmt(interetRestant)} - Laissez vide si l'int√©r√™t est inclus dans le montant principal</small>
          </div>
          
          <div class="mb-3 p-2 bg-info text-white rounded" id="rembTotal">
            <strong>Total du remboursement: ${fmt(0)}</strong>
          </div>
          
          <div class="alert alert-danger" id="rembErr" style="display:none" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="rembErrText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeRembModal()">Annuler</button>
          <button class="btn btn-primary" id="btnEnregistrer" onclick="submitRemboursement(${id})" disabled>
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>`;
  
  document.body.insertAdjacentHTML('beforeend', html);
  new bootstrap.Modal(document.getElementById('rembModal')).show();
  
  // Initialiser la validation
  validateRemboursement();
}

function closeRembModal(){ 
  const el = document.getElementById('rembModal'); 
  if (!el) return; 
  
  // Nettoyer les variables globales
  delete window.__totalRembRestant;
  delete window.__principalRestant;
  delete window.__interetRestant;
  
  bootstrap.Modal.getInstance(el)?.hide(); 
  el.remove(); 
}

async function submitRemboursement(id){
  try{
    // D√©sactiver le bouton pendant le traitement
    const btnEnregistrer = document.getElementById('btnEnregistrer');
    if (btnEnregistrer) {
      btnEnregistrer.disabled = true;
      btnEnregistrer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    }
    
    const montant = parseFloat(document.getElementById('rembMontant').value||'0');
    const interet = parseFloat(document.getElementById('rembInteret').value||'0');
    
    // Validation finale c√¥t√© client
    if (!montant && !interet) {
      throw new Error('Veuillez saisir au moins un montant √† rembourser');
    }
    
    if (montant < 0 || interet < 0) {
      throw new Error('Les montants ne peuvent pas √™tre n√©gatifs');
    }
    
    // Validation que le total ne d√©passe pas le reste √† payer
    const total = montant + interet;
    if (typeof window.__totalRembRestant==='number' && total > window.__totalRembRestant + 1e-6){
      throw new Error(`Le montant total (${total.toLocaleString('fr-FR')} FCFA) d√©passe le reste √† payer (${(window.__totalRembRestant||0).toLocaleString('fr-FR')} FCFA)`);
    }
    
    // Envoyer la requ√™te
    const r = await fetch(`/gestion-caisses/api/prets/${id}/rembourser/`, { 
      method:'POST', 
      headers:{ 
        'Content-Type':'application/json',
        'X-CSRFToken':getCSRFToken() 
      }, 
      body: JSON.stringify({ montant, interet }) 
    });
    
    const data = await r.json();
    if (!r.ok) {
      throw new Error(data.error || data.detail || '√âchec du remboursement');
    }
    
    // Succ√®s
    closeRembModal();
    showToast('Remboursement enregistr√© avec succ√®s !', 'success');
    
    // Ouvrir le PDF si disponible
    if (data.mouvement_id){ 
      window.open(`/gestion-caisses/api/prets/${id}/remboursement_pdf/?mouvement_id=${data.mouvement_id}`, '_blank'); 
      setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    }
    
    // Recharger la liste des pr√™ts
    loadPrets();
    
  } catch(e) { 
    console.error('Erreur remboursement:', e);
    
    // Afficher l'erreur
    const el = document.getElementById('rembErr'); 
    const errText = document.getElementById('rembErrText');
    if (el && errText){ 
      errText.textContent = e.message; 
      el.style.display='block'; 
    }
    
    // R√©activer le bouton
    if (btnEnregistrer) {
      btnEnregistrer.disabled = false;
      btnEnregistrer.innerHTML = 'Enregistrer';
    }
  }
}

function validateRemboursement(){
  const montant = parseFloat(document.getElementById('rembMontant').value||'0');
  const interet = parseFloat(document.getElementById('rembInteret').value||'0');
  const total = (isNaN(montant)?0:montant) + (isNaN(interet)?0:interet);
  
  const err = document.getElementById('rembErr');
  const btnEnregistrer = document.getElementById('btnEnregistrer');
  const rembTotal = document.getElementById('rembTotal');
  
  if (!err || !btnEnregistrer || !rembTotal) return;
  
  // Mettre √† jour l'affichage du total
  const fmt = (n)=> Number(n||0).toLocaleString('fr-FR') + ' FCFA';
  rembTotal.innerHTML = `<strong>Total du remboursement: ${fmt(total)}</strong>`;
  
  let isValid = true;
  let errorMessage = '';
  
  // Validation du montant principal (peut inclure l'int√©r√™t)
  if (isNaN(montant) || montant < 0) {
    isValid = false;
    errorMessage = 'Le montant principal doit √™tre un nombre positif';
  } else if (montant > (window.__totalRembRestant || 0)) {
    isValid = false;
    errorMessage = `Le montant principal ne peut pas d√©passer ${fmt(window.__totalRembRestant || 0)} (total restant √† payer)`;
  }
  
  // Validation de l'int√©r√™t (optionnel mais contr√¥l√© si saisi)
  if (interet > 0) { // Seulement si une valeur est saisie
    if (isNaN(interet) || interet < 0) {
      isValid = false;
      errorMessage = 'Le montant d\'int√©r√™t doit √™tre un nombre positif';
    } else if (interet > (window.__interetRestant || 0)) {
      isValid = false;
      errorMessage = `Le montant d'int√©r√™t ne peut pas d√©passer ${fmt(window.__interetRestant || 0)}`;
    }
  }
  
  // Validation du total
  if (isValid && typeof window.__totalRembRestant==='number' && total > window.__totalRembRestant + 1e-6) {
    isValid = false;
    errorMessage = `Le montant total (principal + int√©r√™t) d√©passe le reste √† payer (${fmt(window.__totalRembRestant || 0)})`;
  }
  
  // Validation que au moins un montant est saisi
  if (isValid && total <= 0) {
    isValid = false;
    errorMessage = 'Veuillez saisir au moins un montant √† rembourser';
  }
  
      // Afficher/masquer l'erreur et activer/d√©sactiver le bouton
    if (!isValid) {
      const errText = document.getElementById('rembErrText');
      if (errText) errText.textContent = errorMessage;
      err.style.display = 'block';
      btnEnregistrer.disabled = true;
    } else {
      err.style.display = 'none';
      btnEnregistrer.disabled = false;
    }
}



// Fonction pour g√©n√©rer un PDF de remboursement complet
async function generateRemboursementCompletPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Appeler l'API pour g√©n√©rer le PDF de remboursement complet
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/remboursement_complet_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `remboursement-complet-pret-${pretId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> PDF de remboursement complet g√©n√©r√© avec succ√®s !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte apr√®s 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la g√©n√©ration du PDF: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte apr√®s 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // R√©activer le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}

// Fonction pour g√©n√©rer l'attestation de pr√™t PDF
async function generateAttestationPretPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Rediriger vers l'URL de g√©n√©ration du PDF
    window.open(`/gestion-caisses/attestation-pret/${pretId}/pdf/`, '_blank');
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    
    // Afficher un message de succ√®s
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Attestation de pr√™t g√©n√©r√©e avec succ√®s !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte apr√®s 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration de l\'attestation:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la g√©n√©ration de l'attestation: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte apr√®s 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // R√©activer le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}

// Fonction pour g√©n√©rer l'attestation de remboursement PDF
async function generateAttestationRemboursementPDF(pretId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Rediriger vers l'URL de g√©n√©ration du PDF
    window.open(`/gestion-caisses/attestation-remboursement/${pretId}/pdf/`, '_blank');
    setTimeout(()=>{ try { window.location.reload(); } catch(_){} }, 500);
    
    // Afficher un message de succ√®s
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    successAlert.innerHTML = `
      <i class="fas fa-check-circle"></i> Attestation de remboursement g√©n√©r√©e avec succ√®s !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(successAlert);
    
    // Supprimer l'alerte apr√®s 3 secondes
    setTimeout(() => {
      if (successAlert.parentNode) {
        successAlert.remove();
      }
    }, 3000);
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration de l\'attestation:', error);
    
    // Afficher un message d'erreur
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    errorAlert.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> Erreur lors de la g√©n√©ration de l'attestation: ${error.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(errorAlert);
    
    // Supprimer l'alerte apr√®s 5 secondes
    setTimeout(() => {
      if (errorAlert.parentNode) {
        errorAlert.remove();
      }
    }, 5000);
  } finally {
    // R√©activer le bouton
    const button = event.target;
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
}
// Aper√ßu de l'image s√©lectionn√©e
document.addEventListener('change', function(e){
  // Gestion des checkboxes pour la carte d'√©lecteur
  if (e.target && e.target.id === 'possede_carte_electeur'){
    const checked = e.target.checked;
    const valide = document.getElementById('carte_electeur_valide');
    const numero = document.querySelector('input[name="numero_carte_electeur"]');
    
    if (valide){
      valide.disabled = !checked;
      if (!checked) valide.checked = false;
    }
    if (numero){
      numero.required = checked;
      if (!checked) numero.value = '';
    }
  }
  
  // Gestion de l'aper√ßu photo
  if (e.target && e.target.id === 'photoInput' && e.target.files && e.target.files[0]){
    const file = e.target.files[0];
    
    // V√©rifier la taille du fichier (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Le fichier est trop volumineux. Taille maximum autoris√©e : 5MB');
      e.target.value = '';
      return;
    }
    
    // V√©rifier le type de fichier
    if (!file.type.match('image.*')) {
      alert('Veuillez s√©lectionner un fichier image valide (JPG, PNG, GIF)');
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(evt){
      const preview = document.getElementById('photoPreview');
      const previewWrapper = document.getElementById('photoPreviewWrapper');
      if (preview && previewWrapper){
        preview.src = evt.target.result;
        previewWrapper.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  }
  
  // Gestion de l'aper√ßu signature
  if (e.target && e.target.id === 'signatureInput' && e.target.files && e.target.files[0]){
    const file = e.target.files[0];
    
    // V√©rifier la taille du fichier (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Le fichier est trop volumineux. Taille maximum autoris√©e : 5MB');
      e.target.value = '';
      return;
    }
    
    // V√©rifier le type de fichier
    if (!file.type.match('image.*')) {
      alert('Veuillez s√©lectionner un fichier image valide (JPG, PNG, GIF)');
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(evt){
      const preview = document.getElementById('signaturePreview');
      const previewWrapper = document.getElementById('signaturePreviewWrapper');
      if (preview && previewWrapper){
        preview.src = evt.target.result;
        previewWrapper.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  }
});

// Fonction pour v√©rifier les fonds disponibles avant validation
async function checkFondsDisponibles(pretId) {
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/check-fonds/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la v√©rification des fonds');
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Erreur lors de la v√©rification des fonds:', error);
    return null;
  }
}

// Fonction pour afficher une alerte de fonds insuffisants
function showFondsInsuffisantsAlert(pretData) {
  const alertHtml = `
    <div class="modal fade" id="fondsInsuffisantsModal" tabindex="-1" aria-labelledby="fondsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-danger text-white border-0">
            <h5 class="modal-title" id="fondsModalLabel">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Fonds Insuffisants
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="alert alert-danger border-0">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <strong>Attention :</strong> Les fonds de la caisse sont insuffisants pour octroyer ce pr√™t.
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title text-danger">
                      <i class="fas fa-info-circle me-2"></i>D√©tails du Pr√™t
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Num√©ro de pr√™t :</strong></p>
                        <p class="text-muted">${pretData.numero_pret || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Membre :</strong></p>
                        <p class="text-muted">${pretData.membre?.nom_complet || 'N/A'}</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Montant demand√© :</strong></p>
                        <p class="text-danger fw-bold">${Number(pretData.montant_demande || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Fonds disponibles :</strong></p>
                        <p class="text-success fw-bold">${Number(pretData.caisse?.fond_disponible || 0).toLocaleString('fr-FR')} FCFA</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-warning mt-3 border-0">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Solutions possibles :</strong>
              <ul class="mb-0 mt-2">
                <li>Alimenter la caisse avec des fonds suppl√©mentaires</li>
                <li>R√©duire le montant du pr√™t demand√©</li>
                <li>Attendre que d'autres pr√™ts soient rembours√©s</li>
                <li>Mettre le pr√™t en attente jusqu'√† disponibilit√© des fonds</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Fermer
            </button>
            <button type="button" class="btn btn-warning" onclick="mettreEnAttentePret(${pretData.id})">
              <i class="fas fa-clock me-2"></i>Mettre en Attente
            </button>
            <button type="button" class="btn btn-primary" onclick="alimenterCaisse(${pretData.caisse?.id})">
              <i class="fas fa-plus-circle me-2"></i>Alimenter la Caisse
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', alertHtml);
  const modal = new bootstrap.Modal(document.getElementById('fondsInsuffisantsModal'));
  modal.show();
}

// Fonction pour mettre un pr√™t en attente
async function mettreEnAttentePret(pretId) {
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/mettre_en_attente/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({
        motif_attente: 'Fonds insuffisants - Pr√™t mis en attente'
      })
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la mise en attente');
    }
    
    // Fermer le modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('fondsInsuffisantsModal'));
    modal.hide();
    
    // Recharger la liste des pr√™ts
    loadPrets();
    
    // Afficher un message de succ√®s
    showToast('Pr√™t mis en attente avec succ√®s', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la mise en attente:', error);
    showToast('Erreur lors de la mise en attente', 'error');
  }
}

// Fonction pour alimenter la caisse
function alimenterCaisse(caisseId) {
  // Fermer le modal actuel
  const modal = bootstrap.Modal.getInstance(document.getElementById('fondsInsuffisantsModal'));
  modal.hide();
  
  // Rediriger vers la page d'alimentation de la caisse
  window.location.href = `/gestion-caisses/caisses/${caisseId}/alimenter/`;
}

// Fonction pour valider un pr√™t (admin seulement)
async function validerPret(pretId) {
  try {
    // V√©rifier les fonds disponibles avant la validation
    const fondsData = await checkFondsDisponibles(pretId);
    
    if (!fondsData) {
      showToast('Erreur lors de la v√©rification des fonds', 'error');
      return;
    }
    
    if (!fondsData.fonds_suffisants) {
      // Afficher l'alerte de fonds insuffisants
      showFondsInsuffisantsAlert(fondsData);
      return;
    }
    
    // Si les fonds sont suffisants, proc√©der √† la validation
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/valider/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Erreur lors de la validation');
    }
    
    const data = await response.json();
    
    // Afficher un message de succ√®s
    showToast('Pr√™t valid√© avec succ√®s !', 'success');
    
    // Recharger la liste des pr√™ts
    loadPrets();
    
  } catch (error) {
    console.error('Erreur lors de la validation:', error);
    showToast(error.message || 'Erreur lors de la validation', 'error');
  }
}

// Fonction pour rejeter un pr√™t (admin seulement)
async function rejeterPret(pretId) {
  const motif = prompt('Motif du rejet :');
  if (!motif) return;
  
  try {
    const response = await fetch(`/gestion-caisses/api/prets/${pretId}/rejeter/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({ motif_rejet: motif })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Erreur lors du rejet');
    }
    
    // Afficher un message de succ√®s
    showToast('Pr√™t rejet√© avec succ√®s', 'success');
    
    // Recharger la liste des pr√™ts
    loadPrets();
    
  } catch (error) {
    console.error('Erreur lors du rejet:', error);
    showToast(error.message || 'Erreur lors du rejet', 'error');
  }
}

// Fonction de d√©connexion pour le dashboard
async function handleLogout() {
  try {
    const response = await fetch('/gestion-caisses/api/logout/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      window.location.href = '/gestion-caisses/login/';
    } else {
      showToast('Erreur lors de la d√©connexion', 'error');
    }
  } catch (error) {
    console.error('Erreur de d√©connexion:', error);
    showToast('Erreur lors de la d√©connexion', 'error');
  }
}

// ============================================================================
// FONCTIONS POUR LES RAPPORTS DE CAISSE
// ============================================================================

async function chargerRapport() {
  try {
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const typeRapport = document.getElementById('type-rapport').value;
    const rapportCaisseSelect = document.getElementById('rapport-caisse-select');
    const selectedCaisseValue = rapportCaisseSelect ? (rapportCaisseSelect.value || '') : '';
    
    // Afficher un indicateur de chargement
    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-3">Chargement du rapport...</p>
      </div>
    `;
    
    // Construire l'URL avec les param√®tres
    const params = new URLSearchParams();
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    params.append('type', typeRapport);
    if (selectedCaisseValue && selectedCaisseValue !== '_ALL_MY_') {
      params.append('caisse_id', selectedCaisseValue);
    }
    
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors du chargement du rapport');
    }
    
    const rapport = await response.json();
    afficherRapport(rapport, typeRapport);
    
  } catch (error) {
    console.error('Erreur lors du chargement du rapport:', error);
    showToast('Erreur lors du chargement du rapport', 'error');
    
    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        Erreur lors du chargement du rapport: ${error.message}
      </div>
    `;
  }
}

function afficherRapport(rapport, typeRapport) {
  const contenuRapport = document.getElementById('contenu-rapport');
  
  switch (typeRapport) {
    case 'general':
      contenuRapport.innerHTML = afficherRapportGeneral(rapport);
      break;
    case 'financier':
      contenuRapport.innerHTML = afficherRapportFinancier(rapport);
      break;
    case 'prets':
      contenuRapport.innerHTML = afficherRapportPrets(rapport);
      break;
    case 'membres':
      contenuRapport.innerHTML = afficherRapportMembres(rapport);
      break;
    case 'echeances':
      contenuRapport.innerHTML = afficherRapportEcheances(rapport);
      break;
    case 'cotisations_membre':
      contenuRapport.innerHTML = afficherRapportCotisationsMembre(rapport);
      break;
    default:
      contenuRapport.innerHTML = '<div class="alert alert-warning">Type de rapport non reconnu</div>';
  }
}

// === Rapports Cotisations ===
async function chargerRapportCotisations(){
  const rapportCaisseSelect = document.getElementById('rapport-caisse-select');
  const selectedCaisseId = rapportCaisseSelect ? (rapportCaisseSelect.value || USER_CAISE_ID || '') : (USER_CAISE_ID || '');
  const caisseParam = selectedCaisseId ? `?caisse=${encodeURIComponent(selectedCaisseId)}` : '';
  const res = await fetch(`${API_BASE}/cotisations/${caisseParam}`);
  const data = await res.json();
  const list = (data.results||data);
  const contenuRapport = document.getElementById('contenu-rapport');
  contenuRapport.innerHTML = `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">üìã Cotisations - Vue g√©n√©rale</h5>
        <span class="text-muted">Total: ${fmt(list.reduce((a,c)=> a + Number(c.montant_total||0), 0))} FCFA</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>Date</th><th>Membre</th><th>S√©ance</th>
            <th>Tempon</th><th>Solidarit√©</th><th>Fondation</th><th>P√©nalit√©</th><th>Total</th>
          </tr></thead>
          <tbody>
            ${list.map(c=>`
              <tr>
                <td>${formatDateTimeSafe(c.date_cotisation)}</td>
                <td>${c.membre_nom}</td>
                <td>${formatDateSafe(c.seance_date)}</td>
                <td>${fmt(c.prix_tempon)}</td>
                <td>${fmt(c.frais_solidarite)}</td>
                <td>${fmt(c.frais_fondation)}</td>
                <td>${fmt(c.penalite_emprunt_retard)}</td>
                <td class="fw-bold">${fmt(c.montant_total)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
}

async function chargerRapportCotisationsParMembre(){
  const rapportCaisseSelect = document.getElementById('rapport-caisse-select');
  const selectedCaisseId = rapportCaisseSelect ? (rapportCaisseSelect.value || USER_CAISE_ID || '') : (USER_CAISE_ID || '');
  const caisseParam = selectedCaisseId ? `?caisse=${encodeURIComponent(selectedCaisseId)}` : '';
  const res = await fetch(`${API_BASE}/cotisations/${caisseParam}`);
  const data = await res.json();
  const list = (data.results||data);
  const agg = new Map();
  for (const c of list){
    const key = `${c.membre}`;
    const cur = agg.get(key) || { nom: c.membre_nom, tempon:0, solidarite:0, fondation:0, penalite:0, total:0, nombre:0 };
    cur.tempon += Number(c.prix_tempon||0);
    cur.solidarite += Number(c.frais_solidarite||0);
    cur.fondation += Number(c.frais_fondation||0);
    cur.penalite += Number(c.penalite_emprunt_retard||0);
    cur.total += Number(c.montant_total||0);
    cur.nombre += 1;
    agg.set(key, cur);
  }
  const rows = Array.from(agg.values());
  const contenuRapport = document.getElementById('contenu-rapport');
  contenuRapport.innerHTML = `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">üë§ Cotisations par membre</h5>
        <span class="text-muted">Membres: ${rows.length}</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>Membre</th><th>#</th><th>Tempon</th><th>Solidarit√©</th><th>Fondation</th><th>P√©nalit√©s</th><th>Total</th>
          </tr></thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.nom}</td>
                <td>${fmt(r.nombre)}</td>
                <td>${fmt(r.tempon)}</td>
                <td>${fmt(r.solidarite)}</td>
                <td>${fmt(r.fondation)}</td>
                <td>${fmt(r.penalite)}</td>
                <td class="fw-bold">${fmt(r.total)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
}

// UI: G√©n√©rer PDF cotisations pour un membre
async function genererPdfCotisationsMembre(){
  const membreSelect = document.getElementById('rapport-membre-select');
  const membreId = membreSelect && membreSelect.value;
  if (!membreId){
    showToast('Veuillez s√©lectionner un membre', 'warning');
    return;
  }
  const dateDebut = document.getElementById('date-debut')?.value || '';
  const dateFin = document.getElementById('date-fin')?.value || '';
  const params = new URLSearchParams();
  params.append('type', 'cotisations_membre');
  params.append('membre', membreId);
  // Pour les agents ayant plusieurs caisses, on pr√©cise explicitement la caisse utilis√©e
  if (typeof USER_CAISE_ID !== 'undefined' && USER_CAISE_ID) {
    params.append('caisse_id', USER_CAISE_ID);
  }
  if (dateDebut) params.append('date_debut', dateDebut);
  if (dateFin) params.append('date_fin', dateFin);
  params.append('format', 'pdf');
  window.open(`/gestion-caisses/api/rapports-caisse/?${params.toString()}`, '_blank');
}

// Charger les cotisations du membre s√©lectionn√© et afficher le tableau dans l'onglet Rapports
async function chargerRapportCotisationsMembreDepuisSelect(){
  const membreSelect = document.getElementById('rapport-membre-select');
  const membreId = membreSelect && membreSelect.value;
  if (!membreId){
    return; // pas de membre choisi, ne rien faire
  }

  const dateDebut = document.getElementById('date-debut')?.value || '';
  const dateFin = document.getElementById('date-fin')?.value || '';
  const params = new URLSearchParams();
  params.append('type', 'cotisations_membre');
  params.append('membre', membreId);
  // M√™me logique que pour le PDF : pr√©ciser la caisse de l'agent si connue
  if (typeof USER_CAISE_ID !== 'undefined' && USER_CAISE_ID) {
    params.append('caisse_id', USER_CAISE_ID);
  }
  if (dateDebut) params.append('date_debut', dateDebut);
  if (dateFin) params.append('date_fin', dateFin);

  const contenuRapport = document.getElementById('contenu-rapport');
  if (contenuRapport){
    contenuRapport.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-3">Chargement des cotisations du membre...</p>
      </div>
    `;
  }

  try{
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params.toString()}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    if (!resp.ok){
      throw new Error('Erreur lors du chargement des cotisations du membre');
    }
    const rapport = await resp.json();
    if (contenuRapport){
      contenuRapport.innerHTML = afficherRapportCotisationsMembre(rapport);
    }
    // Repeupler la liste des membres et res√©lectionner le membre courant
    await initRapportMembreSelect();
    const sel = document.getElementById('rapport-membre-select');
    if (sel){
      sel.value = String(membreId);
    }
  } catch(e){
    console.error(e);
    showToast('Erreur lors du chargement des cotisations du membre', 'error');
  }
}

function afficherRapportCotisationsMembre(rapport){
  const items = rapport.items || [];
  // S√©curiser les totaux pour √©viter les "NaN" √† l'affichage lorsque le rapport est vide
  const baseTotaux = { tempon: 0, solidarite: 0, penalite: 0, total: 0, nombre: 0 };
  const totaux = Object.assign({}, baseTotaux, (rapport.totaux || {}));
  const membre = rapport.membre?.nom || '';
  return `
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">üìã Cotisations ‚Äî ${membre}</h5>
        <div class="d-flex gap-2">
          <select id="rapport-membre-select" class="form-select form-select-sm" onchange="chargerRapportCotisationsMembreDepuisSelect()"></select>
          <button class="btn btn-sm btn-primary" onclick="genererPdfCotisationsMembre()"><i class="fas fa-file-pdf"></i> PDF Membre</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>S√©ance</th><th>Tempon</th><th>Solidarit√©</th><th>P√©nalit√©</th><th>Total</th><th>Observation</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>`
              <tr>
                <td>${it.seance||''}</td>
                <td>${fmt(it.prix_tempon)}</td>
                <td>${fmt(it.frais_solidarite)}</td>
                <td>${fmt(it.penalite_emprunt_retard)}</td>
                <td class="fw-bold">${fmt(it.montant_total)}</td>
                <td>${(it.observation||'')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="p-3 text-end">
        <strong>Totaux ‚Äî Tempon:</strong> ${fmt(totaux.tempon)}
        <strong class="ms-3">Solidarit√©:</strong> ${fmt(totaux.solidarite)}
        <strong class="ms-3">P√©nalit√©s:</strong> ${fmt(totaux.penalite)}
        <strong class="ms-3">Total:</strong> ${fmt(totaux.total)}
      </div>
    </div>`;
}

// Peupler la liste de membres pour le rapport membre
async function initRapportMembreSelect(){
  try{
    let url = '/gestion-caisses/api/membres/';
    const params = new URLSearchParams();
    if (USER_CAISE_ID) params.append('caisse', USER_CAISE_ID);
    if (params.toString()) url += `?${params.toString()}`;
    const r = await fetch(url, { headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await r.json();
    const membres = data.results || data;
    const sel = document.getElementById('rapport-membre-select');
    if (!sel) return;
    sel.innerHTML = '<option value="">S√©lectionner un membre</option>';
    membres.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m.id; opt.textContent = m.nom_complet; sel.appendChild(opt);
    });
  } catch(e) {}
}
function afficherRapportGeneral(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-pie"></i> Rapport G√©n√©ral - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>Date de cr√©ation:</strong> ${rapport.caisse.date_creation}</li>
                  <li><strong>Statut:</strong> ${rapport.caisse.statut}</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6>P√©riode du rapport</h6>
                <ul class="list-unstyled">
                  <li><strong>D√©but:</strong> ${rapport.periode.debut || 'Toutes les dates'}</li>
                  <li><strong>Fin:</strong> ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìä Membres</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-primary">${rapport.membres.total}</h3>
                  <small>Total</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-success">${rapport.membres.actifs}</h3>
                  <small>Actifs</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-warning">${rapport.membres.inactifs}</h3>
                  <small>Inactifs</small>
                </div>
              </div>
            </div>
            <div class="row text-center mt-3">
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.membres.femmes}</h4>
                  <small>Femmes</small>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-secondary">${rapport.membres.hommes}</h4>
                  <small>Hommes</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üí∞ Pr√™ts</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-primary">${rapport.prets.total}</h3>
                  <small>Total</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-success">${rapport.prets.en_cours}</h3>
                  <small>En cours</small>
                </div>
              </div>
              <div class="col-4">
                <div class="stat-item">
                  <h3 class="text-info">${rapport.prets.rembourses}</h3>
                  <small>Rembours√©s</small>
                </div>
              </div>
            </div>
            <div class="row text-center mt-3">
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.prets.en_retard}</h4>
                  <small>En retard</small>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-item">
                  <h4 class="text-danger">${(rapport.prets.montant_moyen || 0).toLocaleString('fr-FR')} FCFA</h4>
                  <small>Moyenne</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üè¶ Fonds</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-primary">${rapport.fonds.fond_initial.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond initial</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-success">${rapport.fonds.fond_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond disponible</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.fonds.montant_total_prets.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Total pr√™ts</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.fonds.solde_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Solde disponible</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportFinancier(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-line"></i> Rapport Financier - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>P√©riode:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üí∞ Fonds Actuels</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-primary">${rapport.fonds_actuels.fond_initial.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond initial</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-success">${rapport.fonds_actuels.fond_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Fond disponible</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-warning">${rapport.fonds_actuels.montant_total_prets.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Total pr√™ts</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-item">
                  <h4 class="text-info">${rapport.fonds_actuels.solde_disponible.toLocaleString('fr-FR')} FCFA</h4>
                  <small>Solde disponible</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìä Mouvements de Fonds</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Nombre</th>
                    <th>Montant Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.mouvements.stats_par_type.map(stat => `
                    <tr>
                      <td>${stat.type_mouvement}</td>
                      <td>${stat.nombre}</td>
                      <td>${stat.total.toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìà √âvolution des Fonds</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Montant</th>
                    <th>Solde</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.mouvements.evolution.map(mouvement => `
                    <tr>
                      <td>${mouvement.date}</td>
                      <td><span class="badge bg-${getBadgeColor(mouvement.type)}">${mouvement.type}</span></td>
                      <td>${mouvement.montant.toLocaleString('fr-FR')} FCFA</td>
                      <td>${mouvement.solde.toLocaleString('fr-FR')} FCFA</td>
                      <td>${mouvement.description}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportPrets(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-hand-holding-usd"></i> Rapport des Pr√™ts - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>P√©riode:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìä Statistiques par Statut</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Statut</th>
                    <th>Nombre</th>
                    <th>Montant Total</th>
                    <th>Montant Moyen</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.statistiques.par_statut.map(stat => `
                    <tr>
                      <td><span class="badge bg-${getBadgeColor(stat.statut)}">${stat.statut}</span></td>
                      <td>${stat.nombre}</td>
                      <td>${(stat.montant_total || 0).toLocaleString('fr-FR')} FCFA</td>
                      <td>${(stat.montant_moyen || 0).toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">‚ö†Ô∏è Pr√™ts en Retard</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-6">
                <div class="stat-item">
                  <h3 class="text-danger">${rapport.prets_retard.nombre}</h3>
                  <small>Nombre de pr√™ts en retard</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stat-item">
                  <h3 class="text-warning">${rapport.prets_retard.montant_total_retard.toLocaleString('fr-FR')} FCFA</h3>
                  <small>Montant total en retard</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìã D√©tails des Pr√™ts</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Num√©ro</th>
                    <th>Membre</th>
                    <th>Montant Accord√©</th>
                    <th>Montant Rembours√©</th>
                    <th>Montant Restant</th>
                    <th>Statut</th>
                    <th>Date Demande</th>
                    <th>Dur√©e (mois)</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_prets.map(pret => `
                    <tr>
                      <td>${pret.numero}</td>
                      <td>${pret.membre}</td>
                      <td>${pret.montant_accord.toLocaleString('fr-FR')} FCFA</td>
                      <td>${pret.montant_rembourse.toLocaleString('fr-FR')} FCFA</td>
                      <td>${pret.montant_restant.toLocaleString('fr-FR')} FCFA</td>
                      <td><span class="badge bg-${getBadgeColor(pret.statut)}">${pret.statut}</span></td>
                      <td>${pret.date_demande}</td>
                      <td>${pret.duree_mois}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function afficherRapportMembres(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-users"></i> Rapport des Membres - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>P√©riode:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìä Par Statut</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_statut.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.statut}</span>
                <span class="badge bg-primary">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üë• Par Sexe</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_sexe.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.sexe === 'F' ? 'Femmes' : 'Hommes'}</span>
                <span class="badge bg-info">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üé≠ Par R√¥le</h6>
          </div>
          <div class="card-body">
            ${rapport.statistiques.par_role.map(stat => `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${stat.role}</span>
                <span class="badge bg-success">${stat.nombre}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìã D√©tails des Membres</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nom Complet</th>
                    <th>Num√©ro Carte</th>
                    <th>T√©l√©phone</th>
                    <th>Sexe</th>
                    <th>R√¥le</th>
                    <th>Statut</th>
                    <th>Date Adh√©sion</th>
                    <th>Nombre Pr√™ts</th>
                    <th>Total Pr√™ts</th>
                    <th>Total Rembours√©</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_membres.map(membre => `
                    <tr>
                      <td>${membre.nom_complet}</td>
                      <td>${membre.numero_carte}</td>
                      <td>${membre.telephone}</td>
                      <td>${membre.sexe === 'F' ? 'F' : 'M'}</td>
                      <td><span class="badge bg-secondary">${membre.role}</span></td>
                      <td><span class="badge bg-${getBadgeColor(membre.statut)}">${membre.statut}</span></td>
                      <td>${membre.date_adhesion}</td>
                      <td>${membre.nombre_prets}</td>
                      <td>${membre.montant_total_prets.toLocaleString('fr-FR')} FCFA</td>
                      <td>${membre.montant_total_rembourse.toLocaleString('fr-FR')} FCFA</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function afficherRapportEcheances(rapport) {
  return `
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-calendar-check"></i> Rapport des √âch√©ances - ${rapport.caisse.nom}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Informations de la Caisse</h6>
                <ul class="list-unstyled">
                  <li><strong>Code:</strong> ${rapport.caisse.code}</li>
                  <li><strong>P√©riode:</strong> ${rapport.periode.debut || 'Toutes les dates'} - ${rapport.periode.fin || 'Toutes les dates'}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìä Statistiques G√©n√©rales</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-primary">${rapport.statistiques.total_echeances}</h3>
              <small>Total √©ch√©ances</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-success">${rapport.statistiques.total_montant.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant total</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-info">${rapport.statistiques.total_paye.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant pay√©</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">‚ö†Ô∏è √âch√©ances en Retard</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-danger">${rapport.echeances_retard.nombre}</h3>
              <small>Nombre en retard</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-warning">${rapport.echeances_retard.montant_total.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant en retard</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìÖ √âch√©ances √† Venir</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <h3 class="text-info">${rapport.echeances_a_venir.nombre}</h3>
              <small>Nombre √† venir</small>
            </div>
            <div class="text-center mt-3">
              <h4 class="text-primary">${rapport.echeances_a_venir.montant_total.toLocaleString('fr-FR')} FCFA</h4>
              <small>Montant √† venir</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">üìã D√©tails des √âch√©ances</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>N¬∞ √âch√©ance</th>
                    <th>N¬∞ Pr√™t</th>
                    <th>Membre</th>
                    <th>Montant √âch√©ance</th>
                    <th>Montant Pay√©</th>
                    <th>Montant Restant</th>
                    <th>Date √âch√©ance</th>
                    <th>Date Paiement</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  ${rapport.details_echeances.map(echeance => `
                    <tr class="${echeance.en_retard ? 'table-danger' : ''}">
                      <td>${echeance.numero_echeance}</td>
                      <td>${echeance.pret_numero}</td>
                      <td>${echeance.membre}</td>
                      <td>${echeance.montant_echeance.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.montant_paye.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.montant_restant.toLocaleString('fr-FR')} FCFA</td>
                      <td>${echeance.date_echeance}</td>
                      <td>${echeance.date_paiement || '-'}</td>
                      <td><span class="badge bg-${getBadgeColor(echeance.statut)}">${echeance.statut}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function getBadgeColor(type) {
  const colors = {
    // Statuts de pr√™ts
    'EN_ATTENTE': 'warning',
    'EN_ATTENTE_ADMIN': 'warning',
    'VALIDE': 'info',
    'REJETE': 'danger',
    'BLOQUE': 'secondary',
    'EN_COURS': 'primary',
    'REMBOURSE': 'success',
    'EN_RETARD': 'danger',
    
    // Statuts de membres
    'ACTIF': 'success',
    'INACTIF': 'secondary',
    'SUSPENDU': 'warning',
    'RETRAITE': 'info',
    
    // Types de mouvements
    'ALIMENTATION': 'success',
    'DECAISSEMENT': 'danger',
    'REMBOURSEMENT': 'info',
    'FRAIS': 'warning',
    'AUTRE': 'secondary',
    
    // Statuts d'√©ch√©ances
    'A_PAYER': 'warning',
    'PARTIELLEMENT_PAYE': 'info',
    'PAYE': 'success',
    'EN_RETARD': 'danger',
    
    // R√¥les de membres
    'PRESIDENTE': 'primary',
    'SECRETAIRE': 'info',
    'TRESORIERE': 'success',
    'MEMBRE': 'secondary',
    
    // Sexe
    'F': 'pink',
    'M': 'blue'
  };
  
  return colors[type] || 'secondary';
}

async function genererRapportPDF(typeRapport, btnEl) {
  let button = null; let originalText = '';
  try {
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const rapportCaisseSelect = document.getElementById('rapport-caisse-select');
    const selectedCaisseValue = rapportCaisseSelect ? (rapportCaisseSelect.value || '') : '';
    
    // Afficher un indicateur de chargement
    button = btnEl || document.activeElement || null;
    originalText = button ? button.innerHTML : '';
    if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...'; }
    
    // Construire l'URL avec les param√®tres
    const params = new URLSearchParams();
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    params.append('type', typeRapport);
    params.append('format', 'pdf');
    if (selectedCaisseValue && selectedCaisseValue !== '_ALL_MY_') {
      params.append('caisse_id', selectedCaisseValue);
    }
    
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `rapport_${typeRapport}_${new Date().toISOString().split('T')[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    showToast(`PDF du rapport ${typeRapport} g√©n√©r√© avec succ√®s !`, 'success');
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    showToast('Erreur lors de la g√©n√©ration du PDF', 'error');
  } finally {
    // Restaurer le bouton
    if (button) { button.disabled = false; button.innerHTML = originalText; }
  }
}

async function telechargerMembresSystemePDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const params = new URLSearchParams({ type: 'membres_systeme_pdf', format: 'pdf' });
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `membres_systeme_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur g√©n√©ration PDF membres', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function telechargerAgentsSystemePDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const params = new URLSearchParams({ type: 'agents_systeme_pdf', format: 'pdf' });
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `agents_systeme_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur g√©n√©ration PDF agents', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function telechargerPretsEvaluationPDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const dateDebut = document.getElementById('date-debut').value;
    const dateFin = document.getElementById('date-fin').value;
    const params = new URLSearchParams({ type: 'prets_evaluation_pdf', format: 'pdf' });
    if (dateDebut) params.append('date_debut', dateDebut);
    if (dateFin) params.append('date_fin', dateFin);
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `prets_evaluation_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur g√©n√©ration PDF √©valuation des pr√™ts', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}

async function chargerPretsParMotif(){
  const motif = document.getElementById('motif-select').value;
  const content = document.getElementById('motifs-content');
  content.innerHTML = '<div class="text-muted">Chargement...</div>';
  const params = new URLSearchParams({ type: 'prets_par_motif' });
  if (motif) params.append('motif', motif);
  const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
  if (!resp.ok){ content.innerHTML = '<div class="alert alert-warning">Erreur de chargement</div>'; return; }
  const data = await resp.json();
  const rows = (data.items||[]).map(it=>`<tr><td>${it.numero_pret}</td><td>${it.membre}</td><td>${it.caisse}</td><td class='text-end'>${(it.pourcentage||0)}%</td></tr>`).join('');
  const total = data.totaux || {};
  content.innerHTML = `
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="m-0">R√©sultats</h5>
          <div class='small text-muted'>Motif: ${data.motif||'Tous'} ‚Äî Nombre: ${data.nombre||0}</div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-hover">
            <thead><tr><th>N¬∞ Pr√™t</th><th>Membre</th><th>Caisse</th><th class='text-end'>% rembours√©</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="4" class="text-center text-muted">Aucun r√©sultat</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>`;
}

async function telechargerPretsParMotifPDF(btn){
  let original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
  try{
    const motif = document.getElementById('motif-select').value;
    const params = new URLSearchParams({ type: 'prets_par_motif', format: 'pdf' });
    if (motif) params.append('motif', motif);
    const resp = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, { headers: { 'X-CSRFToken': getCSRFToken() }});
    if(!resp.ok) throw new Error('HTTP');
    const blob = await resp.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `prets_par_motif_${new Date().toISOString().slice(0,10)}.pdf`; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast('Erreur g√©n√©ration PDF pr√™ts par motif', 'error'); }
  finally{ btn.disabled = false; btn.innerHTML = original; }
}
</script>

<!-- Membres Modal -->
<div class="modal" tabindex="-1" id="membreModal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="membreModalTitle">Nouveau membre</h5>
        <button type="button" class="btn-close" onclick="closeMembreModal()"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <form id="membreForm">
          {% csrf_token %}
          <input type="hidden" name="id" />
          <div class="row g-3">
            {% if user_role == 'Administrateur' %}
            <!-- S√©lection de la caisse (Admin uniquement) -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3">üè¶ Caisse</h6>
            </div>
            <div class="col-12">
              <label class="form-label">Caisse <span class="text-danger">*</span></label>
              <select class="form-select" name="membreCaisse" id="membreCaisse" required>
                <option value="">S√©lectionner une caisse</option>
              </select>
            </div>
            {% endif %}
            <!-- Informations d'identification -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3">üìã Informations d'identification</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Poss√®de une carte d'√©lecteur</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="possede_carte_electeur" id="possede_carte_electeur" checked />
                <label class="form-check-label" for="possede_carte_electeur">Oui</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Carte d'√©lecteur valide</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="carte_electeur_valide" id="carte_electeur_valide" />
                <label class="form-check-label" for="carte_electeur_valide">Valide</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Num√©ro carte d'√©lecteur (optionnel)</label>
              <input class="form-control" name="numero_carte_electeur" maxlength="27" pattern="[A-Z0-9-]{27}" placeholder="Ex: A457-475G-5478U-45-01-01-25-12" />
              <small class="form-text text-muted">27 caract√®res, lettres/chiffres/tirets, en majuscules</small>
            </div>
            
            <!-- Informations personnelles -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">üë§ Informations personnelles</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nom <span class="text-danger">*</span></label>
              <input class="form-control" name="nom" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Pr√©noms <span class="text-danger">*</span></label>
              <input class="form-control" name="prenoms" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Date de naissance <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="date_naissance" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Sexe <span class="text-danger">*</span></label>
              <select class="form-select" name="sexe">
                <option value="F" selected>F√©minin</option>
                <option value="M">Masculin</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Adresse <span class="text-danger">*</span></label>
              <textarea class="form-control" name="adresse" rows="2" placeholder="Adresse compl√®te du membre" required></textarea>
            </div>
            
            <!-- Contact -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">üìû Contact</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">T√©l√©phone <span class="text-danger">*</span></label>
              <div class="input-group">
                <select class="form-select" style="max-width:120px" name="indicatif_telephone">
                  <option value="+228" selected>+228 (Togo)</option>
                  <option value="+229">+229 (B√©nin)</option>
                  <option value="+233">+233 (Ghana)</option>
                </select>
                <input class="form-control" name="numero_telephone" placeholder="90123456" required />
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Num√©ro WhatsApp</label>
              <input class="form-control" name="numero_whatsapp" placeholder="90123456" />
            </div>
            
            <!-- Localisation -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">üìç Localisation</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Quartier</label>
              <input type="text" class="form-control" name="quartier" id="quartier" placeholder="Nom du quartier (optionnel)" />
            </div>
            
            <!-- Photos et documents -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">üì∑ Photos et documents</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">Photo</label>
              <input type="file" class="form-control" name="photo" id="photoInput" accept="image/*" />
              <small class="form-text text-muted">Formats accept√©s: JPG, PNG, GIF (max 5MB)</small>
            </div>
            <div class="col-md-6">
              <div id="photoPreviewWrapper" style="display:none; text-align:center;">
                <img id="photoPreview" alt="Aper√ßu de la photo" style="max-height:120px; max-width:100%; border-radius:8px; border: 1px solid #ddd;" />
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Signature</label>
              <input type="file" class="form-control" name="signature" id="signatureInput" accept="image/*" />
              <small class="form-text text-muted">Formats accept√©s: JPG, PNG, GIF (max 5MB)</small>
            </div>
            <div class="col-md-6">
              <div id="signaturePreviewWrapper" style="display:none; text-align:center;">
                <img id="signaturePreview" alt="Aper√ßu de la signature" style="max-height:120px; max-width:100%; border-radius:8px; border: 1px solid #ddd;" />
              </div>
            </div>
            
            <!-- R√¥le et statut -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">‚öôÔ∏è R√¥le et statut</h6>
            </div>
            <div class="col-md-6">
              <label class="form-label">R√¥le</label>
              <select class="form-select" name="role">
                <option value="MEMBRE" selected>Membre simple</option>
                <option value="SECRETAIRE">Secr√©taire</option>
                <option value="PRESIDENTE">Pr√©sidente</option>
                <option value="TRESORIERE">Tr√©sori√®re</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Statut</label>
              <select class="form-select" name="statut">
                <option value="ACTIF" selected>Actif</option>
                <option value="INACTIF">Inactif</option>
                <option value="SUSPENDU">Suspendu</option>
                <option value="RETRAITE">Retrait√©</option>
              </select>
            </div>
            
            <!-- Notes -->
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">üìù Notes</h6>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="3" placeholder="Notes additionnelles sur le membre (optionnel)"></textarea>
            </div>
          </div>
        </form>
        <div id="membreError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeMembreModal()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitMembre()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal S√©ance -->
  <div class="modal fade" id="seanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nouvelle s√©ance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="seanceForm">
            {% csrf_token %}
            {% if user_role == 'Administrateur' %}
            <div class="mb-3">
              <label class="form-label required">Caisse</label>
              <select id="seanceCaisse" class="form-select" required></select>
            </div>
            {% endif %}
            <div class="mb-3">
              <label class="form-label required">Date de la s√©ance</label>
              <input id="seanceDate" name="date_seance" type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Titre (optionnel)</label>
              <input id="seanceTitre" name="titre" class="form-control" placeholder="Titre" />
            </div>
          </form>
          <div id="seanceError" class="text-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="submitSeanceModal()">Cr√©er</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cotisation -->
  <div class="modal fade" id="cotisationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Nouvelle cotisation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="cotisationForm">
            {% csrf_token %}
            <div class="row g-3">
              {% if user_role == 'Administrateur' %}
              <div class="col-12">
                <label class="form-label required">Caisse</label>
                <select id="cotisationCaisse" class="form-select" required></select>
              </div>
              {% endif %}
              <div class="col-12 col-md-6">
                <label class="form-label required">Membre</label>
                <select id="cotisationMembre" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label required">S√©ance</label>
                <select id="cotisationSeance" class="form-select" required></select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Prix tempon</label>
                <input id="prixTempon" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Frais solidarit√©</label>
                <input id="fraisSolidarite" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Frais fondation</label>
                <input id="fraisFondation" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">P√©nalit√© emprunt</label>
                <input id="penaliteEmprunt" type="number" class="form-control" min="0" step="1" />
              </div>
              <div class="col-12">
                <label class="form-label">Observation</label>
                <textarea id="cotisationDescription" class="form-control" rows="2" placeholder="Observation"></textarea>
              </div>
            </div>
          </form>
          <div id="cotisationError" class="text-danger mt-2" style="display:none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-success" onclick="submitCotisationModal()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal √âdition S√©ance -->
<div class="modal fade" id="seanceEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Modifier la s√©ance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="seanceEditId" />
        <div class="mb-3">
          <label class="form-label">Date de la s√©ance</label>
          <input id="seanceEditDate" type="date" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">Titre (optionnel)</label>
          <input id="seanceEditTitre" class="form-control" placeholder="Titre" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitSeanceEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal √âdition Cotisation -->
<div class="modal fade" id="cotisationEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Modifier la cotisation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cotisationEditId" />
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Membre</label>
            <select id="cotisationEditMembre" class="form-select"></select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">S√©ance</label>
            <select id="cotisationEditSeance" class="form-select"></select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Prix tempon</label>
            <input id="prixTemponEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Frais solidarit√©</label>
            <input id="fraisSolidariteEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Frais fondation</label>
            <input id="fraisFondationEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">P√©nalit√© emprunt</label>
            <input id="penaliteEmpruntEdit" type="number" class="form-control" min="0" step="1" />
          </div>
          <div class="col-12">
            <label class="form-label">Observation</label>
            <textarea id="cotisationDescriptionEdit" class="form-control" rows="2" placeholder="Observation"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" onclick="submitCotisationEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal D√©pense -->
<div class="modal fade" id="depenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Nouvelle d√©pense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="depenseForm">
          {% csrf_token %}
          <div class="row g-3">
            {% if user_role == 'Administrateur' %}
            <div class="col-12">
              <label class="form-label required">Caisse</label>
              <select id="depenseCaisse" class="form-select" required></select>
            </div>
            {% endif %}
            <div class="col-12">
              <label class="form-label">Solde d√©penses disponible</label>
              <div id="depenseSoldeInfo" class="alert alert-secondary py-2 mb-0">S√©lectionnez une caisse pour voir le solde disponible.</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label required">Objectif de la d√©pense</label>
              <textarea id="depenseObjectif" class="form-control" rows="2" placeholder="Objectif de la d√©pense" required></textarea>
            </div>
            
            <div class="col-12 col-md-6">
              <label class="form-label required">Montant (FCFA)</label>
              <input id="depenseMontant" type="number" class="form-control" min="0" step="1" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label required">Date de la d√©pense</label>
              <input id="depenseDate" type="date" class="form-control" required />
            </div>
            <div class="col-12">
              <label class="form-label">Observation (optionnel)</label>
              <textarea id="depenseObservation" class="form-control" rows="3" placeholder="Observation (facultatif)"></textarea>
            </div>
          </div>
        </form>
        <div id="depenseError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" onclick="submitDepenseModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal √âdition D√©pense -->
<div class="modal fade" id="depenseEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Modifier la d√©pense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="depenseEditId" />
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label required">Objectif de la d√©pense</label>
            <textarea id="depenseEditDescription" class="form-control" rows="2" placeholder="Objectif de la d√©pense" required></textarea>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label required">Montant (FCFA)</label>
            <input id="depenseEditMontant" type="number" class="form-control" min="0" step="1" required />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label required">Date de la d√©pense</label>
            <input id="depenseEditDate" type="date" class="form-control" required />
          </div>
          <div class="col-12">
            <label class="form-label">Observation (optionnel)</label>
            <textarea id="depenseEditObservation" class="form-control" rows="3" placeholder="Observation (facultatif)"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" onclick="submitDepenseEditModal()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmation G√©n√©rique -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmTitle">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmMessage">√ätes-vous s√ªr ?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmAcceptBtn">Supprimer</button>
      </div>
    </div>
  </div>
  </div>

<!-- Pr√™ts Modal -->
<div class="modal" tabindex="-1" id="pretModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pretModalTitle">Nouveau pr√™t</h5>
        <button type="button" class="btn-close" onclick="closePretModal()"></button>
      </div>
      <div class="modal-body">
        <form id="pretForm">
          {% csrf_token %}
          <input type="hidden" name="id" />
          {% if user_role == 'Administrateur' %}
          <div class="mb-3">
            <label class="form-label required">Caisse</label>
            <select class="form-select" name="caisse_id" id="pretCaisse" required onchange="onPretCaisseChange()"></select>
          </div>
          {% endif %}
          <div class="mb-3">
              <label class="form-label">Membre</label>
              <select class="form-select" name="membre_id" id="pretMembre" required onchange="checkMemberLoanStatus()"></select>
              <div id="memberLoanWarning" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> 
                Ce membre a d√©j√† un pr√™t en cours. Il doit d'abord terminer le remboursement de son pr√™t actuel.
              </div>
              <div id="memberContributionWarning" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                Ce membre n'a pas encore atteint 3000 FCFA de cotisations. Le pr√™t est indisponible.
              </div>
              <div id="memberContributionInfo" class="text-muted mt-1" style="display:none; font-size: 12px;"></div>
              <div id="memberPlafondInfo" class="text-muted mt-1" style="display:none; font-size: 12px;"></div>
            </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Montant demand√© (FCFA)</label>
              <input class="form-control" id="montant_demande" name="montant_demande" type="number" required oninput="updateInterestPreview()" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Dur√©e (mois)</label>
              <input class="form-control" name="duree_mois" type="number" required oninput="updateInterestPreview()" />
            </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Taux d'int√©r√™t (%)</label>
              <small class="text-muted d-block mb-1">Taux appliqu√© chaque mois</small>
              <input class="form-control" name="taux_interet" type="number" step="0.01" value="0" oninput="updateInterestPreview()" />
            </div>
            <div class="col-12">
              <div class="alert alert-info" id="interestPreview" style="display: none;">
                <div class="row">
                  <div class="col-md-3">
                    <strong>Montant demand√©:</strong><br>
                    <span id="previewMontantDemande">0</span> FCFA
                  </div>
                  <div class="col-md-3">
                    <strong>Int√©r√™t mensuel (<span id="previewTaux">0</span>%):</strong><br>
                    <span id="previewInteretMensuel">0</span> FCFA
                  </div>
                  <div class="col-md-3">
                    <strong>Int√©r√™t total (<span id="previewDuree">0</span> mois):</strong><br>
                    <span id="previewInteretTotal">0</span> FCFA
                  </div>
                  <div class="col-md-3">
                    <strong>Total √† rembourser:</strong><br>
                    <span id="previewTotal" class="text-success fw-bold">0</span> FCFA
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Motif <span class="text-danger">*</span></label>
              <select class="form-select" name="motif" id="motifSelect" required onchange="toggleMotifAutre()">
                <option value="">S√©lectionner un motif</option>
                <option value="commerce">Commerce</option>
                <option value="agriculture">Agriculture</option>
                <option value="elevage">√âlevage</option>
                <option value="artisanat">Artisanat</option>
                <option value="transport">Transport</option>
                <option value="education">√âducation</option>
                <option value="sante">Sant√©</option>
                <option value="habitat">Habitat</option>
                <option value="equipement">√âquipement</option>
                <option value="stock">Stock</option>
                <option value="urgence">Urgence</option>
                <option value="autres">Autres</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">D√©tails du pr√™t</label>
              <textarea class="form-control" name="details_pret" id="detailsPret" rows="3" placeholder="Pr√©cisions sur l'utilisation du pr√™t (optionnel)"></textarea>
            </div>
            <div class="col-12" id="motifAutreDiv" style="display: none;">
              <label class="form-label">Pr√©ciser le motif <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="motif_autre" id="motifAutre" placeholder="D√©crivez le motif sp√©cifique" />
            </div>
          </div>
        </form>
        <div id="pretError" class="text-danger mt-2" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePretModal()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="submitPret()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Fonctions pour la g√©n√©ration de PDFs
async function generateMembresListePDF(caisseId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Appeler l'API pour g√©n√©rer le PDF de la liste des membres
    const response = await fetch(`/gestion-caisses/api/caisses/${caisseId}/membres_liste_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `liste_membres_caisse_${caisseId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    showToast('PDF de la liste des membres g√©n√©r√© avec succ√®s !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    showToast('Erreur lors de la g√©n√©ration du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

async function generateMembrePDF(membreId) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Appeler l'API pour g√©n√©rer le PDF de la fiche membre
    const response = await fetch(`/gestion-caisses/api/membres/${membreId}/fiche_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `fiche_membre_${membreId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    showToast('PDF de la fiche membre g√©n√©r√© avec succ√®s !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    showToast('Erreur lors de la g√©n√©ration du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

async function generateEcheancesRetardPDF(event) {
  try {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    // Appeler l'API pour g√©n√©rer le PDF des √©ch√©ances en retard
    const response = await fetch(`/gestion-caisses/api/caisses/${USER_CAISE_ID}/echeances_retard_pdf/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    
    if (!response.ok) {
      throw new Error('Erreur lors de la g√©n√©ration du PDF');
    }
    
    // T√©l√©charger le PDF
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `echeances_retard_${new Date().toISOString().split('T')[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Afficher un message de succ√®s
    showToast('PDF des √©ch√©ances en retard g√©n√©r√© avec succ√®s !', 'success');
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
    showToast('Erreur lors de la g√©n√©ration du PDF', 'error');
  } finally {
    // Restaurer le bouton
    const button = event.target;
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// === S√©ances & Cotisations (Frontend) ===
const API_BASE = '/gestion-caisses/api';
// IMPORTANT: √©viter la red√©claration si d√©j√† d√©fini plus haut
if (typeof USER_CAISE_ID === 'undefined') { var USER_CAISE_ID = null; }

document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Charger contexte utilisateur (r√©cup√®re caisse_id et caisses pour les agents)
    const ctx = await fetchUserContext();
    if (ctx) {
      USER_CAISE_ID = ctx.caisse_id;
      
      // Si c'est un agent, charger les caisses dans le s√©lecteur
      const userRole = ctx.user?.role || '';
      if (userRole === 'Agent' && ctx.caisses && ctx.caisses.length > 0) {
        await loadAgentCaissesSelector(ctx.caisses, ctx.caisse_id);
      }
    }
    
    // Pr√©charger caisses pour l'onglet Partage si pr√©sent (admin)
    try { await populatePartageCaisses(); } catch(e) { console.warn(e); }
    // Pr√©charger listes
    await refreshSeances();
    await refreshCotisations();
    await hydrateMembresSelect();
    await hydrateSeancesSelect();
    // Pr√©charger les d√©penses et le solde d√®s l'arriv√©e sur le dashboard
    try { await chargerDepenses(); } catch(e) { console.error(e); }
  } catch(e) { console.error(e); }
});

window.openSeanceCreateModal = function(e){
  try { e && e.preventDefault && e.preventDefault(); } catch {}
  try {
    const d = document.getElementById('seanceDate'); if(d) d.value = '';
    const t = document.getElementById('seanceTitre'); if(t) t.value = '';
    const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
    if (isAdmin) { try { loadSeanceCaisses(); } catch(e){ console.warn(e); } }
  } catch {}
  const el = document.getElementById('seanceModal');
  if(el){
    try { if (el.parentElement !== document.body) document.body.appendChild(el); } catch {}
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }
};

window.openCotisationCreateModal = function(e){
  try { e && e.preventDefault && e.preventDefault(); } catch {}
  // Hydrater selects si n√©cessaire
  try { hydrateMembresSelect(); } catch {}
  try { hydrateSeancesSelect(); } catch {}
  // Bloquer ouverture si aucun exercice actif
  // Ne plus bloquer les cotisations en absence d'exercice actif
  const el = document.getElementById('cotisationModal');
  if(el){
    try { if (el.parentElement !== document.body) document.body.appendChild(el); } catch {}
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }
};

async function openSeanceEditModal(id, dateStr, titre){
  try {
    if(!id){ return; }
    // Si date/titre non fournis ou potentiellement invalides, recharger depuis l'API
    if(!dateStr){
      const s = await fetch(`${API_BASE}/seances/${id}/`).then(r=>r.json());
      dateStr = s.date_seance || '';
      titre = s.titre || '';
    }
    document.getElementById('seanceEditId').value = id;
    document.getElementById('seanceEditDate').value = (dateStr||'');
    document.getElementById('seanceEditTitre').value = (titre||'');
    const el = document.getElementById('seanceEditModal');
    if(el){ bootstrap.Modal.getOrCreateInstance(el).show(); }
  } catch(e) { console.error(e); }
}

async function submitSeanceEditModal(){
  const id = document.getElementById('seanceEditId').value;
  const dateVal = document.getElementById('seanceEditDate').value;
  const titreVal = document.getElementById('seanceEditTitre').value;
  if(!id){ return; }
  const res = await fetch(`${API_BASE}/seances/${id}/`,{
    method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({ date_seance: dateVal, titre: titreVal })
  });
  if(!res.ok){ showToast('Erreur mise √† jour s√©ance','error'); return; }
  showToast('S√©ance mise √† jour','success');
  bootstrap.Modal.getInstance(document.getElementById('seanceEditModal'))?.hide();
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function deleteSeance(id){
  if(!confirm('Supprimer cette s√©ance ?')) return;
  const res = await fetch(`${API_BASE}/seances/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': getCSRFToken()} });
  if(res.status !== 204){ showToast('Erreur suppression s√©ance','error'); return; }
  showToast('S√©ance supprim√©e','success');
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function openCotisationEditModal(id){
  // Charger la cotisation
  const data = await fetch(`${API_BASE}/cotisations/${id}/`).then(r=>r.json());
  document.getElementById('cotisationEditId').value = id;
  // Hydrate selects si vides
  if(document.getElementById('cotisationEditMembre').options.length === 0){
    const m = await fetch(`${API_BASE}/membres/?caisse=${USER_CAISE_ID}`).then(r=>r.json());
    document.getElementById('cotisationEditMembre').innerHTML = (m.results||m).map(x=>`<option value="${x.id}">${x.nom_complet}</option>`).join('');
  }
  if(document.getElementById('cotisationEditSeance').options.length === 0){
    const s = await fetch(`${API_BASE}/seances/?caisse=${USER_CAISE_ID}`).then(r=>r.json());
    document.getElementById('cotisationEditSeance').innerHTML = (s.results||s).map(x=>`<option value="${x.id}">${formatDateSafe(x.date_seance)} - ${x.titre||''}</option>`).join('');
  }
  document.getElementById('cotisationEditMembre').value = data.membre;
  document.getElementById('cotisationEditSeance').value = data.seance;
  document.getElementById('prixTemponEdit').value = data.prix_tempon||0;
  document.getElementById('fraisSolidariteEdit').value = data.frais_solidarite||0;
  document.getElementById('fraisFondationEdit').value = data.frais_fondation||0;
  document.getElementById('penaliteEmpruntEdit').value = data.penalite_emprunt_retard||0;
  document.getElementById('cotisationDescriptionEdit').value = data.description||'';
  const modal = new bootstrap.Modal(document.getElementById('cotisationEditModal'));
  modal.show();
}

async function submitCotisationEditModal(){
  const id = document.getElementById('cotisationEditId').value;
  const payload = {
    membre: Number(document.getElementById('cotisationEditMembre').value||0),
    seance: Number(document.getElementById('cotisationEditSeance').value||0),
    prix_tempon: Number(document.getElementById('prixTemponEdit').value||0),
    frais_solidarite: Number(document.getElementById('fraisSolidariteEdit').value||0),
    frais_fondation: Number(document.getElementById('fraisFondationEdit').value||0),
    penalite_emprunt_retard: Number(document.getElementById('penaliteEmpruntEdit').value||0),
    description: document.getElementById('cotisationDescriptionEdit').value||''
  };
  const res = await fetch(`${API_BASE}/cotisations/${id}/`, { method:'PATCH', headers:{'Content-Type':'application/json','X-CSRFToken': getCSRFToken()}, body: JSON.stringify(payload) });
  if(!res.ok){ showToast('Erreur mise √† jour cotisation','error'); return; }
  showToast('Cotisation mise √† jour','success');
  bootstrap.Modal.getInstance(document.getElementById('cotisationEditModal'))?.hide();
  await refreshCotisations();
}

async function deleteCotisation(id){
  // Confirmation moderne via modal inline minimaliste
  const confirmHtml = `
  <div class="modal fade" id="confirmDeleteCotModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white"><h6 class="modal-title m-0">Confirmer la suppression</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">Cette action est irr√©versible. Continuer ?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmDeleteCotBtn" class="btn btn-danger">Supprimer</button>
        </div>
      </div>
    </div>
  </div>`;
  document.getElementById('confirmDeleteCotModal')?.remove();
  document.body.insertAdjacentHTML('beforeend', confirmHtml);
  const mdl = new bootstrap.Modal(document.getElementById('confirmDeleteCotModal'));
  mdl.show();
  document.getElementById('confirmDeleteCotBtn').onclick = async () => {
    const res = await fetch(`${API_BASE}/cotisations/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': getCSRFToken()} });
    mdl.hide();
    if(res.status !== 204){ showToast('Erreur suppression cotisation','error'); return; }
    showToast('Suppression r√©ussie','success');
    await refreshCotisations();
    setTimeout(()=> document.getElementById('confirmDeleteCotModal')?.remove(), 300);
  };
}

async function refreshSeances(){
  if(!USER_CAISE_ID) return;
  const res = await fetch(`${API_BASE}/seances/?caisse=${USER_CAISE_ID}`);
  const data = await res.json();
  const list = document.getElementById('seances-list');
  list.innerHTML = (data.results||data).map(s=>`
    <div class="card mb-2"><div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div><strong>${s.titre||''}</strong></div>
        <div>Date: ${formatDateSafe(s.date_seance)}</div>
      </div>
      <div class="text-end">
        <div class="mb-2">
          <button class="btn btn-sm btn-outline-primary" onclick="openSeanceEditModal(${s.id}, '${s.date_seance}', ${JSON.stringify(s.titre||'')})">√âditer</button>
        </div>
        <small class="text-muted">Cr√©√© le: ${formatDateTimeSafe(s.date_creation)}</small>
      </div>
    </div></div>
  `).join('');
}

async function createSeance(){
  const err = document.getElementById('seanceError'); if(err){ err.style.display='none'; err.textContent=''; }
  const dateVal = (document.getElementById('seanceDate').value||'').trim();
  const titreVal = (document.getElementById('seanceTitre').value||'').trim();
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  const selectedCaisseId = isAdmin ? Number(document.getElementById('seanceCaisse')?.value || 0) : Number(USER_CAISE_ID || 0);
  if(!dateVal){ if(err){ err.textContent = 'La date est requise.'; err.style.display='block'; } showToast('S√©lectionnez une date', 'warning'); return; }
  if(isAdmin && !selectedCaisseId){ if(err){ err.textContent='Veuillez s√©lectionner une caisse.'; err.style.display='block'; } showToast('S√©lectionnez une caisse','warning'); return; }
  const res = await fetch(`${API_BASE}/seances/`,{
    method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({ caisse: selectedCaisseId, date_seance: dateVal, titre: titreVal })
  });
  if(!res.ok){ const t=await res.text(); if(err){ err.textContent='Erreur: '+t; err.style.display='block'; } showToast('Erreur cr√©ation s√©ance','error'); return; }
  showToast('S√©ance cr√©√©e','success');
  document.getElementById('seanceDate').value='';
  document.getElementById('seanceTitre').value='';
  await refreshSeances();
  await hydrateSeancesSelect();
}

async function submitSeanceModal(){
  const btns = document.querySelectorAll('#seanceModal .btn');
  btns.forEach(b=>b.disabled=true);
  try {
    await createSeance();
    const modalEl = document.getElementById('seanceModal');
    bootstrap.Modal.getInstance(modalEl)?.hide();
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}

async function hydrateMembresSelect(caisseId = null){
  const sel = document.getElementById('cotisationMembre');
  const resolvedCaisseId = caisseId || (typeof USER_CAISE_ID !== 'undefined' ? USER_CAISE_ID : null);
  if(!sel||!resolvedCaisseId) return;
  const res = await fetch(`${API_BASE}/membres/?caisse=${resolvedCaisseId}`);
  const data = await res.json();
  sel.innerHTML = '<option value="">S√©lectionner un membre</option>' + (data.results||data).map(m=>`<option value="${m.id}">${m.nom_complet} (${m.numero_carte_electeur})</option>`).join('');
}

async function hydrateSeancesSelect(caisseId = null){
  const sel = document.getElementById('cotisationSeance');
  const resolvedCaisseId = caisseId || (typeof USER_CAISE_ID !== 'undefined' ? USER_CAISE_ID : null);
  if(!sel||!resolvedCaisseId) return;
  const res = await fetch(`${API_BASE}/seances/?caisse=${resolvedCaisseId}`);
  const data = await res.json();
  sel.innerHTML = '<option value="">S√©lectionner une s√©ance</option>' + (data.results||data).map(s=>`<option value="${s.id}">${s.date_seance} - ${s.titre||''}</option>`).join('');
}

async function loadCotisationCaisses(){
  const sel = document.getElementById('cotisationCaisse');
  if(!sel) return;
  sel.innerHTML = '<option value="">Chargement...</option>';
  const res = await fetch(`${API_BASE}/caisses/`);
  const data = await res.json();
  sel.innerHTML = '<option value="">S√©lectionner une caisse</option>' + (data.results||data).map(c=>`<option value="${c.id}">${c.nom_association}</option>`).join('');
  sel.onchange = onCotisationCaisseChange;
}

function onCotisationCaisseChange(){
  const caisseId = Number(document.getElementById('cotisationCaisse')?.value||0);
  if(!caisseId){ 
    document.getElementById('cotisationMembre').innerHTML = '<option value=\"\">S√©lectionner un membre</option>';
    document.getElementById('cotisationSeance').innerHTML = '<option value=\"\">S√©lectionner une s√©ance</option>';
    return; 
  }
  hydrateMembresSelect(caisseId);
  hydrateSeancesSelect(caisseId);
}

async function loadSeanceCaisses(){
  const sel = document.getElementById('seanceCaisse');
  if(!sel) return;
  sel.innerHTML = '<option value="">Chargement...</option>';
  const res = await fetch(`${API_BASE}/caisses/`);
  const data = await res.json();
  sel.innerHTML = '<option value="">S√©lectionner une caisse</option>' + (data.results||data).map(c=>`<option value="${c.id}">${c.nom_association}</option>`).join('');
}

async function refreshCotisations(){
  // Charger la liste et les stats seulement si une caisse utilisateur est d√©finie
  if (typeof USER_CAISE_ID !== 'undefined' && USER_CAISE_ID) {
    const res = await fetch(`${API_BASE}/cotisations/?caisse=${USER_CAISE_ID}`);
    const data = await res.json();
    const list = document.getElementById('cotisations-list');
    if (list) {
      list.innerHTML = (data.results||data).map(c=>`
        <div class="card mb-2"><div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div><strong>${c.membre_nom}</strong> ‚Äî S√©ance: ${formatDateSafe(c.seance_date)}</div>
            <div>
              Tempon: <strong>${fmt(c.prix_tempon)} FCFA</strong> ¬∑ Solidarit√©: <strong>${fmt(c.frais_solidarite)} FCFA</strong> ¬∑ Fondation: <strong>${fmt(c.frais_fondation)} FCFA</strong> ¬∑ P√©nalit√©: <strong>${fmt(c.penalite_emprunt_retard)} FCFA</strong>
            </div>
          </div>
          <div class="text-end">
            <div class="fw-bold">Total: ${fmt(c.montant_total)} FCFA</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-primary me-2" onclick="openCotisationEditModal(${c.id})">√âditer</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCotisation(${c.id})">Supprimer</button>
            </div>
            <small class="text-muted">${formatDateTimeSafe(c.date_cotisation)}</small>
          </div>
        </div></div>
      `).join('');
    }

    // Stats totales
    const tot = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${USER_CAISE_ID}`).then(r=>r.json());
    const t = tot.totaux || {};
    setText('statTempon', fmt(t.prix_tempon||0)+' FCFA');
    setText('statSolidarite', fmt(t.frais_solidarite||0)+' FCFA');
    setText('statFondation', fmt(t.frais_fondation||0)+' FCFA');
    setText('statPenalite', fmt(t.penalite_emprunt_retard||0)+' FCFA');
    const totalSansFondation1 = (Number(t.total||0) - Number(t.frais_fondation||0)) || 0;
    setText('statTotal', fmt(Math.max(0, totalSansFondation1))+' FCFA');
    setText('statNombre', fmt(t.nombre||0));

    // S√©rie mensuelle
    const serie = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${USER_CAISE_ID}&group_by=month`).then(r=>r.json());
    const series = serie.series||[];
    drawCotisationsChart(series.map(x=>x.mois), series.map(x=>x.total||0));
  }

  // Hydrater s√©lecteurs de stats (caisse pour admin, membre pour caisse s√©lectionn√©e)
  try {
    const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
    if (isAdmin) {
      const caisseSel = document.getElementById('statsCaisse');
      if (caisseSel && caisseSel.options.length === 0) {
        caisseSel.innerHTML = '<option value=\"\">S√©lectionner une caisse</option>';
        const cres = await fetch(`${API_BASE}/caisses/`);
        const cdata = await cres.json();
        caisseSel.innerHTML = '<option value=\"\">S√©lectionner une caisse</option>' + (cdata.results||cdata).map(c=>`<option value=\"${c.id}\">${c.nom_association}</option>`).join('');
        caisseSel.onchange = onStatsCaisseChange;
      }
      // Ne pas hydrater les membres tant qu'une caisse de stats n'est pas choisie
      const currentCaisseId = Number(document.getElementById('statsCaisse')?.value || 0);
      if (currentCaisseId) {
        await hydrateStatsMembre(currentCaisseId);
      } else {
        const statsSel = document.getElementById('statsMembre');
        if (statsSel) statsSel.innerHTML = '<option value=\"\">S√©lectionner un membre</option>';
      }
    } else {
      // Non admin: hydrater directement avec la caisse de l'utilisateur
      await hydrateStatsMembre(USER_CAISE_ID);
    }
  } catch(e){ console.warn(e); }
}

function fmt(x){ try{ return Number(x).toLocaleString('fr-FR'); }catch{ return x; } }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

let cotChart;
function drawCotisationsChart(labels, values){
  const ctx = document.getElementById('cotisationsChart');
  if(!ctx) return;
  if(cotChart){ cotChart.destroy(); }
  cotChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total mensuel (FCFA)',
        data: values,
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76,175,80,0.15)',
        tension: 0.2,
        fill: true,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { ticks: { callback: v=>fmt(v) } } }
    }
  });
}

let cotMemberChart;

async function refreshTotalsForCaisse(caisseId){
  try{
    if(!caisseId) return;
    const tot = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${caisseId}`).then(r=>r.json());
    const t = tot.totaux || {};
    setText('statTempon', fmt(t.prix_tempon||0)+' FCFA');
    setText('statSolidarite', fmt(t.frais_solidarite||0)+' FCFA');
    setText('statFondation', fmt(t.frais_fondation||0)+' FCFA');
    setText('statPenalite', fmt(t.penalite_emprunt_retard||0)+' FCFA');
    const totalSansFondation2 = (Number(t.total||0) - Number(t.frais_fondation||0)) || 0;
    setText('statTotal', fmt(Math.max(0, totalSansFondation2))+' FCFA');
    setText('statNombre', fmt(t.nombre||0));

    const serie = await fetch(`${API_BASE}/cotisations-stats/caisse/?caisse_id=${caisseId}&group_by=month`).then(r=>r.json());
    const series = serie.series||[];
    drawCotisationsChart(series.map(x=>x.mois), series.map(x=>x.total||0));
  }catch(e){
    console.warn('Erreur refreshTotalsForCaisse', e);
  }
}

async function hydrateStatsMembre(caisseId){
  const statsSel = document.getElementById('statsMembre');
  if(!statsSel || !caisseId) return;
  statsSel.innerHTML = '<option value=\"\">Chargement...</option>';
  const mres = await fetch(`${API_BASE}/membres/?caisse=${caisseId}`);
  const mdata = await mres.json();
  statsSel.innerHTML = '<option value=\"\">S√©lectionner un membre</option>' + (mdata.results||mdata).map(m=>`<option value=\"${m.id}\">${m.nom_complet} (${m.numero_carte_electeur})</option>`).join('');
}

function onStatsCaisseChange(){
  const caisseId = Number(document.getElementById('statsCaisse')?.value || 0);
  if(!caisseId){
    const statsSel = document.getElementById('statsMembre');
    if (statsSel) statsSel.innerHTML = '<option value=\"\">S√©lectionner un membre</option>';
    // R√©initialiser la carte Totaux et le graphe si aucune caisse s√©lectionn√©e
    try {
      setText('statTempon', '0 FCFA');
      setText('statSolidarite', '0 FCFA');
      setText('statFondation', '0 FCFA');
      setText('statPenalite', '0 FCFA');
      setText('statTotal', '0 FCFA');
      setText('statNombre', '0');
      drawCotisationsChart([], []);
    } catch(e){ console.warn(e); }
    return;
  }
  hydrateStatsMembre(caisseId);
  // Mettre √† jour la carte Totaux et le graphe pour la caisse s√©lectionn√©e
  refreshTotalsForCaisse(caisseId);
}

async function refreshMemberStats(){
  const id = document.getElementById('statsMembre').value;
  if(!id){ return; }
  const agg = await fetch(`${API_BASE}/cotisations-stats/membre/?membre_id=${id}`).then(r=>r.json());
  const serie = await fetch(`${API_BASE}/cotisations-stats/membre/?membre_id=${id}&group_by=month`).then(r=>r.json());
  const t = agg.totaux||{};
  setText('mStatMois', fmt(agg.nombre_mois_cotises||0));
  setText('mStatTotal', fmt(t.total||0)+' FCFA');
  setText('mStatTempon', fmt(t.prix_tempon||0)+' FCFA');
  setText('mStatSolidarite', fmt(t.frais_solidarite||0)+' FCFA');
  setText('mStatPenalite', fmt(t.penalite_emprunt_retard||0)+' FCFA');
  drawMemberChart((serie.series||[]).map(x=>x.mois), (serie.series||[]).map(x=>x.total||0));
}
function drawMemberChart(labels, values){
  const ctx = document.getElementById('cotisationsMemberChart');
  if(!ctx) return;
  if(cotMemberChart){ cotMemberChart.destroy(); }
  cotMemberChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Total mensuel (FCFA)', data: values, backgroundColor: 'rgba(54,162,235,0.4)', borderColor:'#36A2EB' }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v=>fmt(v) } } } }
  });
}

async function createCotisation(){
  const err = document.getElementById('cotisationError'); if(err){ err.style.display='none'; err.textContent=''; }
  const membreId = document.getElementById('cotisationMembre').value;
  const seanceId = document.getElementById('cotisationSeance').value;
  const prixTempon = Number(document.getElementById('prixTempon').value||0);
  const fraisSolid = Number(document.getElementById('fraisSolidarite').value||0);
  const fraisFond = Number(document.getElementById('fraisFondation').value||0);
  const penalite = Number(document.getElementById('penaliteEmprunt').value||0);
  const description = (document.getElementById('cotisationDescription')?.value||'');
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  const selectedCaisseId = isAdmin ? Number(document.getElementById('cotisationCaisse')?.value || 0) : Number(USER_CAISE_ID || 0);
  if(!membreId||!seanceId){ if(err){ err.textContent='Veuillez s√©lectionner un membre et une s√©ance.'; err.style.display='block'; } showToast('S√©lectionnez membre et s√©ance','warning'); return; }
  if(isAdmin && !selectedCaisseId){ if(err){ err.textContent='Veuillez s√©lectionner une caisse.'; err.style.display='block'; } showToast('S√©lectionnez une caisse','warning'); return; }
  const res = await fetch(`${API_BASE}/cotisations/`,{
    method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFToken()},
    body: JSON.stringify({
      membre_id: Number(membreId), caisse_id: Number(selectedCaisseId), seance_id: Number(seanceId),
      prix_tempon: prixTempon, frais_solidarite: fraisSolid, frais_fondation: fraisFond, penalite_emprunt_retard: penalite,
      description: description
    })
  });
  if(!res.ok){ const t=await res.text(); console.error(t); if(err){ err.textContent='Erreur: '+t; err.style.display='block'; } showToast('Erreur enregistrement','error'); return; }
  showToast('Cotisation enregistr√©e','success');
  document.getElementById('prixTempon').value='';
  document.getElementById('fraisSolidarite').value='';
  document.getElementById('fraisFondation').value='';
  document.getElementById('penaliteEmprunt').value='';
  await refreshCotisations();
}

async function submitCotisationModal(){
  const btns = document.querySelectorAll('#cotisationModal .btn');
  btns.forEach(b=>b.disabled=true);
  try {
    await createCotisation();
    const modalEl = document.getElementById('cotisationModal');
    bootstrap.Modal.getInstance(modalEl)?.hide();
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}
// Fonction de d√©connexion pour le dashboard
async function handleLogout() {
  try {
    const response = await fetch('/gestion-caisses/api/logout/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      window.location.href = '/gestion-caisses/login/';
    } else {
      showToast('Erreur lors de la d√©connexion', 'error');
    }
  } catch (error) {
    console.error('Erreur de d√©connexion:', error);
    showToast('Erreur lors de la d√©connexion', 'error');
  }
}

// === FONCTIONS D√âPENSES ===

// Ouvrir la modale de cr√©ation de d√©pense
async function openDepenseCreateModal() {
  // Initialiser la date √† aujourd'hui
  document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
  
  // Charger les caisses si admin
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  if (isAdmin) {
    try {
      await loadDepenseCaisses();
    } catch(e) {
      console.warn(e);
    }
  } else {
    updateDepenseSoldeInfo(USER_CAISE_ID);
  }
  
  // Afficher la modale
  const modal = new bootstrap.Modal(document.getElementById('depenseModal'));
  modal.show();
}

// Charger les caisses pour le formulaire de d√©pense (pour les admins)
async function loadDepenseCaisses() {
  const sel = document.getElementById('depenseCaisse');
  if (!sel) return;
  sel.innerHTML = '<option value="">Chargement...</option>';
  try {
    const res = await fetch(`${API_BASE}/caisses/`);
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    sel.innerHTML = '<option value="">S√©lectionner une caisse</option>' + (data.results || data).map(c => `<option value="${c.id}">${c.nom_association}</option>`).join('');
  } catch (error) {
    console.error('Erreur chargement caisses d√©penses:', error);
    sel.innerHTML = '<option value="">Erreur lors du chargement</option>';
  }
  sel.onchange = (event) => {
    const caisseId = Number(event.target.value || 0);
    updateDepenseSoldeInfo(caisseId || null);
  };
  await updateDepenseSoldeInfo(Number(sel.value || 0) || null);
}

// Mettre √† jour l'affichage du solde de d√©pense disponible
async function updateDepenseSoldeInfo(caisseId) {
  const info = document.getElementById('depenseSoldeInfo');
  if (!info) return;
  
  if (!caisseId) {
    info.classList.remove('alert-info', 'alert-danger');
    info.classList.add('alert-secondary');
    info.textContent = 'S√©lectionnez une caisse pour voir le solde disponible.';
    return;
  }
  
  info.classList.remove('alert-secondary', 'alert-danger');
  info.classList.add('alert-info');
  info.textContent = 'Chargement du solde disponible...';
  
  try {
    const res = await fetch(`${API_BASE}/depenses/stats/?caisse_id=${caisseId}`);
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    const solde = data?.solde_disponible ?? 0;
    info.innerHTML = `Solde disponible: <strong>${fmt(solde)} FCFA</strong>`;
  } catch (error) {
    console.error('Erreur solde d√©pense:', error);
    info.classList.remove('alert-info');
    info.classList.add('alert-danger');
    info.textContent = 'Impossible de charger le solde disponible.';
  }
}

// Charger les caisses pour le formulaire de d√©pense (ancienne fonction, conserv√©e pour compatibilit√©)
async function chargerCaissesDepenses() {
  try {
    const res = await fetch(`${API_BASE}/caisses/?id=${USER_CAISE_ID||''}`);
    const data = await res.json();
    const caisses = data.results || data;
    
    const select = document.getElementById('depenseCaisse');
    if (!select) return;
    select.innerHTML = '<option value="">S√©lectionner une caisse</option>';
    
    caisses.forEach(caisse => {
      const option = document.createElement('option');
      option.value = caisse.id;
      option.textContent = caisse.nom_association;
      select.appendChild(option);
    });
    // Pr√©-s√©lectionner la caisse de l'utilisateur si disponible
    if (USER_CAISE_ID) {
      try { select.value = String(USER_CAISE_ID); } catch {}
    }
  } catch (error) {
    console.error('Erreur chargement caisses:', error);
  }
}

// Charger les membres pour le formulaire de d√©pense
async function chargerMembresDepenses() {
  try {
    const res = await fetch(`${API_BASE}/membres/`);
    const data = await res.json();
    const membres = data.results || data;
    
    const select = document.getElementById('depenseResponsable');
    select.innerHTML = '<option value="">S√©lectionner un responsable</option>';
    
    membres.forEach(membre => {
      const option = document.createElement('option');
      option.value = membre.id;
      option.textContent = membre.nom_complet;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Erreur chargement membres:', error);
  }
}

// Charger la liste des d√©penses
async function chargerDepenses() {
  try {
    const url = USER_CAISE_ID ? `${API_BASE}/depenses/?caisse=${USER_CAISE_ID}` : `${API_BASE}/depenses/`;
    const res = await fetch(url);
    const data = await res.json();
    const depenses = data.results || data;
    
    afficherDepenses(depenses);
    chargerStatsDepenses();
  } catch (error) {
    console.error('Erreur chargement d√©penses:', error);
    showToast('Erreur lors du chargement des d√©penses', 'error');
  }
}

// Afficher la liste des d√©penses
function afficherDepenses(depenses) {
  const container = document.getElementById('depenses-list');
  
  if (!depenses || depenses.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">Aucune d√©pense trouv√©e</p>
      </div>
    `;
    return;
  }
  
  const table = `
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Caisse</th>
            <th>Objectif</th>
            <th>Montant</th>
            <th>Observation</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${depenses.map(depense => `
            <tr>
              <td>${formatDateSafe(depense.datedepense)}</td>
              <td>${depense.caisse_nom || '‚Äî'}</td>
              <td>${depense.Objectifdepense}</td>
              <td class="fw-bold">${fmt(depense.montantdepense)} FCFA</td>
              <td>${depense.observation || ''}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-warning" onclick="editerDepense(${depense.id})" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger" onclick="supprimerDepense(${depense.id})" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                  ${depense.statut === 'EN_COURS' ? `
                    <button class="btn btn-outline-success" onclick="approuverDepense(${depense.id})" title="Approuver">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="rejeterDepense(${depense.id})" title="Rejeter">
                      <i class="fas fa-times"></i>
                    </button>
                  ` : ''}
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  container.innerHTML = table;
}

// Obtenir le badge de statut
function getStatutBadge(statut) {
  const badges = {
    'EN_COURS': '<span class="badge bg-warning">En cours</span>',
    'APPROUVEE': '<span class="badge bg-success">Approuv√©e</span>',
    'REJETEE': '<span class="badge bg-danger">Rejet√©e</span>',
    'TERMINEE': '<span class="badge bg-info">Termin√©e</span>',
    'ENREGISTREE': '<span class="badge bg-secondary">Enregistr√©e</span>'
  };
  return badges[statut] || '<span class="badge bg-secondary">Inconnu</span>';
}

// Charger les statistiques des d√©penses
async function chargerStatsDepenses() {
  try {
    if (!USER_CAISE_ID) { return; }
    const res = await fetch(`${API_BASE}/depenses/stats/?caisse_id=${USER_CAISE_ID}`, { credentials: 'same-origin', headers: { 'X-CSRFToken': getCSRFToken() }});
    const data = await res.json();
    
    document.getElementById('solde-depenses').textContent = `${fmt(data.solde_disponible || 0)} FCFA`;
  } catch (error) {
    console.error('Erreur chargement stats d√©penses:', error);
  }
}

// Filtrer les d√©penses
function filtrerDepenses() {
  const caisse = document.getElementById('depense-caisse').value;
  const categorie = document.getElementById('depense-categorie').value;
  const statut = document.getElementById('depense-statut').value;
  
  // Construire l'URL avec les filtres
  let url = `${API_BASE}/depenses/`;
  const params = new URLSearchParams();
  
  if (caisse) params.append('caisse', caisse);
  if (categorie) params.append('categorie', categorie);
  if (statut) params.append('statut', statut);
  
  if (params.toString()) {
    url += '?' + params.toString();
  }
  
  // Charger les d√©penses filtr√©es
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const depenses = data.results || data;
      afficherDepenses(depenses);
    })
    .catch(error => {
      console.error('Erreur filtrage d√©penses:', error);
      showToast('Erreur lors du filtrage', 'error');
    });
}

// Cr√©er une nouvelle d√©pense
async function createDepense() {
  const err = document.getElementById('depenseError');
  if (err) {
    err.style.display = 'none';
    err.textContent = '';
  }
  
  // D√©terminer la caisse : si admin, utiliser la caisse s√©lectionn√©e, sinon USER_CAISE_ID
  const isAdmin = document.getElementById('user-role')?.textContent?.trim() === 'Administrateur';
  const caisseId = isAdmin ? Number(document.getElementById('depenseCaisse')?.value || 0) : USER_CAISE_ID;
  
  const objectif = document.getElementById('depenseObjectif').value;
  const montant = Number(document.getElementById('depenseMontant').value);
  const dateDepense = document.getElementById('depenseDate').value;
  const observation = document.getElementById('depenseObservation').value;
  // Champs optionnels supprim√©s pour correspondre au mod√®le en base
  
  if (!caisseId || !objectif || !montant || !dateDepense) {
    if (err) {
      err.textContent = isAdmin && !caisseId ? 'Veuillez s√©lectionner une caisse.' : 'Veuillez remplir tous les champs obligatoires.';
      err.style.display = 'block';
    }
    showToast(isAdmin && !caisseId ? 'S√©lectionnez une caisse' : 'Veuillez remplir tous les champs obligatoires', 'warning');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/depenses/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        caisse: Number(caisseId),
        Objectifdepense: objectif,
        montantdepense: montant,
        datedepense: dateDepense,
        observation: observation
      })
    });
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error(errorText);
      if (err) {
        err.textContent = 'Erreur: ' + errorText;
        err.style.display = 'block';
      }
      showToast('Erreur lors de l\'enregistrement', 'error');
      return;
    }
    
    showToast('D√©pense enregistr√©e avec succ√®s', 'success');
    
    // Fermer la modale et recharger
    const modal = bootstrap.Modal.getInstance(document.getElementById('depenseModal'));
    modal.hide();
    
    // Vider le formulaire
    document.getElementById('depenseForm').reset();
    
    // Recharger la liste
    await chargerDepenses();
    
  } catch (error) {
    console.error('Erreur cr√©ation d√©pense:', error);
    if (err) {
      err.textContent = 'Erreur lors de l\'enregistrement';
      err.style.display = 'block';
    }
    showToast('Erreur lors de l\'enregistrement', 'error');
  }
}

// Soumettre la modale de d√©pense
async function submitDepenseModal() {
  const btns = document.querySelectorAll('#depenseModal .btn');
  btns.forEach(b => b.disabled = true);
  
  try {
    await createDepense();
  } finally {
    btns.forEach(b => b.disabled = false);
  }
}

// Voir une d√©pense
function voirDepense(depenseId) {
  // Impl√©menter la vue d√©taill√©e d'une d√©pense
  showToast('Fonctionnalit√© √† impl√©menter', 'info');
}

// √âditer une d√©pense
async function editerDepense(depenseId) {
  try {
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/`);
    const d = await res.json();
    document.getElementById('depenseEditId').value = d.id;
    document.getElementById('depenseEditMontant').value = d.montantdepense;
    document.getElementById('depenseEditDate').value = (d.datedepense||'').slice(0,10);
    document.getElementById('depenseEditDescription').value = d.Objectifdepense || '';
    const modal = new bootstrap.Modal(document.getElementById('depenseEditModal'));
    modal.show();
  } catch (e) {
    console.error(e);
    showToast('Erreur chargement d√©pense', 'error');
  }
}

async function submitDepenseEditModal(){
  const id = document.getElementById('depenseEditId').value;
  const payload = {
    caisse: USER_CAISE_ID ? Number(USER_CAISE_ID) : undefined,
    Objectifdepense: document.getElementById('depenseEditDescription').value,
    montantdepense: Number(document.getElementById('depenseEditMontant').value),
    datedepense: document.getElementById('depenseEditDate').value,
    observation: document.getElementById('depenseEditObservation').value || ''
  };
  try {
    const res = await fetch(`${API_BASE}/depenses/${id}/`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    showToast('D√©pense modifi√©e', 'success');
    const modal = bootstrap.Modal.getInstance(document.getElementById('depenseEditModal'));
    modal.hide();
    await chargerDepenses();
  } catch(e){
    console.error(e);
    showToast('Erreur modification', 'error');
  }
}

// Approuver une d√©pense
async function approuverDepense(depenseId) {
  try {
    const notes = prompt('Notes d\'approbation (optionnel):');
    
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/approuver/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        notes: notes || ''
      })
    });
    
    if (res.ok) {
      showToast('D√©pense approuv√©e avec succ√®s', 'success');
      await chargerDepenses();
    } else {
      const error = await res.json();
      showToast('Erreur: ' + (error.error || 'Impossible d\'approuver la d√©pense'), 'error');
    }
  } catch (error) {
    console.error('Erreur approbation d√©pense:', error);
    showToast('Erreur lors de l\'approbation', 'error');
  }
}

// Rejeter une d√©pense
async function rejeterDepense(depenseId) {
  try {
    const notes = prompt('Motif du rejet (optionnel):');
    
    const res = await fetch(`${API_BASE}/depenses/${depenseId}/rejeter/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        notes: notes || ''
      })
    });
    
    if (res.ok) {
      showToast('D√©pense rejet√©e avec succ√®s', 'success');
      await chargerDepenses();
    } else {
      const error = await res.json();
      showToast('Erreur: ' + (error.error || 'Impossible de rejeter la d√©pense'), 'error');
    }
  } catch (error) {
    console.error('Erreur rejet d√©pense:', error);
    showToast('Erreur lors du rejet', 'error');
  }
}

// Supprimer une d√©pense
function confirmAction({title='Confirmation', message='√ätes-vous s√ªr ?', confirmText='Confirmer', confirmClass='btn-primary', onConfirm}){
  try {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    const btn = document.getElementById('confirmAcceptBtn');
    btn.textContent = confirmText;
    btn.className = 'btn ' + confirmClass;
    const modalEl = document.getElementById('confirmModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    // Nettoyer anciens listeners
    btn.replaceWith(btn.cloneNode(true));
    const newBtn = document.getElementById('confirmAcceptBtn');
    newBtn.addEventListener('click', async ()=>{
      try { await onConfirm?.(); } finally { modal.hide(); }
    });
    modal.show();
  } catch(e) { if (onConfirm) onConfirm(); }
}

async function supprimerDepense(depenseId){
  confirmAction({
    title: 'Supprimer la d√©pense',
    message: 'Cette action est irr√©versible. Confirmez la suppression ?',
    confirmText: 'Supprimer',
    confirmClass: 'btn-danger',
    onConfirm: async () => {
      try {
        const res = await fetch(`${API_BASE}/depenses/${depenseId}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': getCSRFToken() }
        });
        if (res.status === 204) {
          showToast('D√©pense supprim√©e', 'success');
          await chargerDepenses();
        } else {
          const t = await res.text();
          throw new Error(t);
        }
      } catch(e) {
        console.error(e);
        showToast('Erreur suppression', 'error');
      }
    }
  });
}

// Charger le rapport des d√©penses
async function chargerRapportDepenses() {
  try {
    const rapportCaisseSelect = document.getElementById('rapport-caisse-select');
    const selectedCaisseId = rapportCaisseSelect ? (rapportCaisseSelect.value || USER_CAISE_ID || '') : (USER_CAISE_ID || '');
    const caisseParam = selectedCaisseId ? `?caisse=${encodeURIComponent(selectedCaisseId)}` : '';
    const res = await fetch(`${API_BASE}/depenses/${caisseParam}`);
    const data = await res.json();
    const depenses = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
    const totalMontant = depenses.reduce((a, d) => a + Number(d?.montantdepense || 0), 0);
    const rows = depenses.length
      ? depenses.map(depense => {
          const statutCode = depense?.statut || 'ENREGISTREE';
          return `
            <tr>
              <td>${formatDateSafe(depense?.datedepense)}</td>
              <td>${depense?.caisse_nom || '‚Äî'}</td>
              <td><span class="badge bg-info">${depense?.categorie_display || depense?.Objectifdepense || 'Non pr√©cis√©'}</span></td>
              <td class="fw-bold">${fmt(depense?.montantdepense || 0)} FCFA</td>
              <td>${depense?.responsable_nom || 'Inconnu'}</td>
              <td>${getStatutBadge(statutCode)}</td>
              <td>${depense?.observation || depense?.description || ''}</td>
            </tr>
          `;
        }).join('')
      : `<tr><td colspan="7" class="text-center text-muted py-4">Aucune d√©pense trouv√©e pour cette p√©riode.</td></tr>`;

    const contenuRapport = document.getElementById('contenu-rapport');
    contenuRapport.innerHTML = `
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="m-0">üí∏ Rapport des D√©penses</h5>
          <span class="text-muted">Total: ${fmt(totalMontant)} FCFA</span>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Caisse</th>
                <th>Cat√©gorie</th>
                <th>Montant</th>
                <th>Responsable</th>
                <th>Statut</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      </div>`;
  } catch (error) {
    console.error('Erreur chargement rapport d√©penses:', error);
    showToast('Erreur lors du chargement du rapport', 'error');
  }
}

// Exporter PDF D√©penses entre deux dates
async function exportDepensesPDF(btn){
  let button = btn; let originalText = button ? button.innerHTML : '';
  try {
    if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...'; }
    const d1 = document.getElementById('depenses-date-debut').value;
    const d2 = document.getElementById('depenses-date-fin').value;
    const params = new URLSearchParams();
    if (d1) params.append('date_debut', d1);
    if (d2) params.append('date_fin', d2);
    params.append('type', 'depenses');
    params.append('format', 'pdf');
    const response = await fetch(`/gestion-caisses/api/rapports-caisse/?${params}`, {
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    if (!response.ok) throw new Error('Erreur g√©n√©ration PDF');
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `depenses_${new Date().toISOString().split('T')[0]}.pdf`; a.style.display='none';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    showToast('PDF D√©penses g√©n√©r√©', 'success');
  } catch(e){
    console.error(e); showToast('Erreur g√©n√©ration PDF', 'error');
  } finally {
    if (button) { button.disabled = false; button.innerHTML = originalText; }
  }
}

// ============================================================================
// GESTION DES CAISSES - INTERFACE CARTES
// ============================================================================

// Variables globales pour les caisses
let allCaisses = [];
let caissesLoaded = false;
// CSS pour les cartes de caisses
const caissesCSS = `
<style>
    .caisse-card-inner {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid #e9ecef;
    }
    
    .caisse-card-inner:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    
    .card-header {
        border-bottom: none;
        padding: 1rem;
    }
    
    .list-group-item {
        background: transparent;
        border: none;
        padding: 0.25rem 0;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.4em 0.6em;
    }
    
    .text-success {
        color: #198754 !important;
    }
    
    .text-warning {
        color: #ffc107 !important;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .text-primary {
        color: #007bff !important;
    }
    
    .caisse-card .card-body {
        background: #f8f9fa;
    }
    
    .caisse-card .card-footer {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }
    
    .caisse-card .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .caisse-card .alert {
        font-size: 0.75rem;
        padding: 0.5rem;
    }
</style>
`;

// Ajouter le CSS au head
document.head.insertAdjacentHTML('beforeend', caissesCSS);

// Charger les caisses
async function loadCaisses() {
    try {
        const response = await fetch(`${API_BASE}/caisses/`);
        if (!response.ok) throw new Error('Erreur lors du chargement des caisses');
        
        const data = await response.json();
        const caisses = data.results || data;
        
        // Charger les exercices pour chaque caisse
        const caissesWithDetails = await Promise.all(caisses.map(async (caisse) => {
            try {
                console.log('Traitement caisse:', caisse.nom_association, caisse);
                
                // Charger les exercices - essayer diff√©rentes approches
                let exerciceActuel = null;
                
                try {
                    // Essayer d'abord l'endpoint sp√©cifique
                    const exerciceResponse = await fetch(`${API_BASE}/caisses/${caisse.id}/exercices/`);
                    if (exerciceResponse.ok) {
                        const exerciceData = await exerciceResponse.json();
                        const exercices = exerciceData.results || exerciceData;
                        // Prendre le dernier exercice (EN_COURS en priorit√©, sinon le plus r√©cent)
                        exerciceActuel = exercices.find(e => e.statut === 'EN_COURS') || 
                                        (exercices.length > 0 ? exercices[0] : null);
                    }
                } catch (e) {
                    console.log('Erreur chargement exercices sp√©cifique:', e);
                }
                
                // Si pas trouv√©, essayer l'endpoint g√©n√©ral des exercices
                if (!exerciceActuel) {
                    try {
                        const allExercicesResponse = await fetch(`${API_BASE}/exercices-caisse/?caisse=${caisse.id}`);
                        if (allExercicesResponse.ok) {
                            const allExercicesData = await allExercicesResponse.json();
                            const allExercices = allExercicesData.results || allExercicesData;
                            // Filtrer les exercices de cette caisse
                            const exercicesCaisse = allExercices.filter(e => e.caisse === caisse.id || e.caisse_id === caisse.id);
                            // Prendre le dernier exercice (EN_COURS en priorit√©, sinon le plus r√©cent)
                            exerciceActuel = exercicesCaisse.find(e => e.statut === 'EN_COURS') ||
                                            (exercicesCaisse.length > 0 ? exercicesCaisse[0] : null);
                        }
                    } catch (e) {
                        console.log('Erreur chargement exercices g√©n√©ral:', e);
                    }
                }
                
                // Construire la localisation √† partir des donn√©es du serializer
                const parts = [];
                if (caisse.village_nom) parts.push(caisse.village_nom);
                if (caisse.canton_nom) parts.push(caisse.canton_nom);
                if (caisse.commune_nom) parts.push(caisse.commune_nom);
                const localisation = parts.join(', ');
                
                console.log(`Caisse ${caisse.nom_association}: exercice_actuel =`, exerciceActuel);
                console.log(`Caisse ${caisse.nom_association}: localisation =`, localisation);
                console.log(`Caisse ${caisse.nom_association}: agent_nom =`, caisse.agent_nom);
                console.log(`Caisse ${caisse.nom_association}: presidente_nom =`, caisse.presidente_nom);
                
                return {
                    ...caisse,
                    exercice_actuel: exerciceActuel,
                    localisation: localisation
                };
            } catch (e) {
                console.log('Erreur g√©n√©rale pour caisse:', caisse.nom_association, e);
                return { ...caisse, exercice_actuel: null };
            }
        }));
        
        allCaisses = caissesWithDetails;
        caissesLoaded = true;
        
        renderCaisses();
        updateCaissesCount();
        
        // Ajouter les √©v√©nements de filtrage
        setupCaissesFilters();
        
    } catch (error) {
        console.error('Erreur lors du chargement des caisses:', error);
        document.getElementById('caissesGrid').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    Erreur lors du chargement des caisses: ${error.message}
                </div>
            </div>
        `;
    }
}

// Rendre les cartes de caisses
function renderCaisses(caissesToRender = allCaisses) {
    const grid = document.getElementById('caissesGrid');
    
    if (!caissesToRender || caissesToRender.length === 0) {
        grid.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fa fa-building fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Aucune caisse trouv√©e</h4>
                    <p class="text-muted">Il n'y a actuellement aucune caisse dans le syst√®me.</p>
                </div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = caissesToRender.map(caisse => createCaisseCard(caisse)).join('');

    // D√©sactiver les activit√©s c√¥t√© non-admin si aucun exercice
    try {
        const roleText = document.getElementById('user-role')?.textContent?.trim();
        if (roleText && roleText !== 'Administrateur') {
            // Heuristique: prendre la premi√®re caisse (ou am√©liorable si API renvoie la caisse de l'utilisateur)
            const userCaisse = caissesToRender[0];
            const hasExercice = !!(userCaisse && userCaisse.exercice_actuel);
            const ids = ['tab-prets','tab-depenses'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !hasExercice;
                    el.classList.toggle('disabled', !hasExercice);
                    el.title = !hasExercice ? "Aucune activit√© n'est autoris√©e sans exercice en cours" : '';
                }
            });
        }
    } catch(e) { }
}

// Formatteur de dates r√©silient (prend en charge 'YYYY-MM-DD' et 'DD/MM/YYYY')
function formatDateFR(input) {
    if (!input) { return ''; }
    if (typeof input === 'string') {
        const trimmed = input.trim();
        // D√©j√† au format fran√ßais
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(trimmed)) { return trimmed; }
        // Format ISO (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS)
        const isoMatch = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            const [_, y, m, d] = isoMatch;
            return `${d}/${m}/${y}`;
        }
        const d = new Date(trimmed);
        if (!isNaN(d.getTime())) { return d.toLocaleDateString('fr-FR'); }
        return trimmed;
    }
    if (input instanceof Date) {
        if (!isNaN(input.getTime())) { return input.toLocaleDateString('fr-FR'); }
        return '';
    }
    return '';
}

// Format DateTime (ISO) -> dd/mm/yyyy sans l'heure
function formatDateOnly(input){
    if (!input) return '';
    if (typeof input === 'string') {
        const iso = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (iso) { const [_, y,m,d] = iso; return `${d}/${m}/${y}`; }
    }
    try { const d = new Date(input); if(!isNaN(d.getTime())) return d.toLocaleDateString('fr-FR'); } catch {}
    return formatDateFR(input);
}

// Cr√©er une carte pour une caisse
function createCaisseCard(caisse) {
    const dateCreation = formatDateOnly(caisse.date_creation) || '-';
    const solde = new Intl.NumberFormat('fr-FR').format(caisse.fond_disponible || 0);
    
    // Localisation - utiliser le champ localisation du s√©rialiseur
    const localisation = caisse.localisation || 'Non d√©finie';
    
    // Statut badge
    let statutBadge = '';
    if (caisse.statut === 'ACTIVE') {
        statutBadge = '<span class="badge bg-success text-white"><i class="fa fa-check me-1"></i>Active</span>';
    } else if (caisse.statut === 'INACTIVE') {
        statutBadge = '<span class="badge bg-warning text-dark"><i class="fa fa-pause me-1"></i>Inactive</span>';
    } else {
        statutBadge = '<span class="badge bg-danger text-white"><i class="fa fa-ban me-1"></i>Suspendue</span>';
    }
    
    // Exercice en cours (date d√©but et date fin) - style comme l'image
    let exerciceSection = '';
    if (caisse.exercice_actuel && (caisse.exercice_actuel.date_debut || caisse.exercice_actuel.date_fin)) {
        const dateDebut = formatDateFR(caisse.exercice_actuel.date_debut) || '-';
        const dateFin = formatDateFR(caisse.exercice_actuel.date_fin) || '-';
        const statut = caisse.exercice_actuel.statut || 'EN_COURS';
        const estCloture = statut === 'CLOTURE' || statut === 'CLOTUR√â';
        const badgeClass = estCloture ? 'bg-secondary' : 'bg-success';
        const badgeText = estCloture ? 'Cl√¥tur√©' : 'En cours';
        const badgeIcon = estCloture ? 'fa-check-circle' : 'fa-play';
        exerciceSection = `
            <div class="mb-3">
                <div class="text-muted small mb-1">
                    <i class="fa fa-calendar-alt me-1"></i>Exercices
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold small">${dateDebut}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">au ${dateFin}</div>
                    </div>
                    <span class="badge ${badgeClass}">
                        <i class="fa ${badgeIcon} me-1"></i>${badgeText}
                    </span>
                </div>
            </div>
        `;
    } else {
        exerciceSection = `
            <div class="mb-3">
                <div class="text-muted small mb-1">
                    <i class="fa fa-calendar-alt me-1"></i>Exercices
                </div>
                <div class="alert alert-warning py-2 mb-0">
                    <i class="fa fa-exclamation-triangle me-1"></i>
                    <small>Aucun exercice</small>
                </div>
            </div>
        `;
    }
    
    // Les 3 premiers responsables de la caisse
    const responsables = [];
    
    // Ajouter les responsables s'ils existent
    if (caisse.presidente_nom) {
        responsables.push({ 
            nom: caisse.presidente_nom, 
            role: 'Pr√©sidente', 
            telephone: caisse.presidente_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assign√©', role: 'Pr√©sidente', telephone: '' });
    }
    
    if (caisse.secretaire_nom) {
        responsables.push({ 
            nom: caisse.secretaire_nom, 
            role: 'Secr√©taire', 
            telephone: caisse.secretaire_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assign√©', role: 'Secr√©taire', telephone: '' });
    }
    
    if (caisse.tresoriere_nom) {
        responsables.push({ 
            nom: caisse.tresoriere_nom, 
            role: 'Tr√©sori√®re', 
            telephone: caisse.tresoriere_telephone || '' 
        });
    } else {
        responsables.push({ nom: 'Non assign√©', role: 'Tr√©sori√®re', telephone: '' });
    }
    
    // Limiter √† 3 responsables maximum
    const responsablesLimites = responsables.slice(0, 3);
    
    const responsablesHtml = responsablesLimites.map(resp => `
        <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
                <div class="fw-bold small">${resp.nom}</div>
                <div class="text-muted" style="font-size: 0.7rem;">${resp.role}</div>
            </div>
            ${resp.telephone ? `
                <button class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; border-radius: 50%;" onclick="window.open('tel:${resp.telephone}', '_self')" title="Appeler ${resp.telephone}">
                    <i class="fa fa-phone" style="font-size: 0.8rem;"></i>
                </button>
            ` : `
                <button class="btn btn-outline-primary btn-sm" style="padding: 4px 8px; border-radius: 50%;" onclick="alert('Num√©ro de t√©l√©phone non disponible')" title="Num√©ro non disponible">
                    <i class="fa fa-phone" style="font-size: 0.8rem;"></i>
                </button>
            `}
        </div>
    `).join('');
    
    return `
        <div class="col-12 col-lg-6 col-xl-4 caisse-card" 
             data-nom="${(caisse.nom_association || '').toLowerCase()}"
             data-code="${(caisse.code || '').toLowerCase()}"
             data-localisation="${localisation.toLowerCase()}"
             data-statut="${caisse.statut}"
             data-date-creation="${caisse.date_creation}"
             data-solde="${caisse.fond_disponible || 0}">
            
            <div class="card h-100 shadow-sm border-0 caisse-card-inner" style="border-radius: 12px;">
                <!-- En-t√™te de la carte avec nom et code -->
                <div class="card-header text-white position-relative" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border-radius: 12px 12px 0 0; border: none;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1 fw-bold" style="font-size: 1.1rem;">${caisse.nom_association || 'N/A'}</h5>
                            <small class="opacity-75" style="font-size: 0.8rem;">
                                <i class="fa fa-tag me-1"></i>Code: ${caisse.code || 'N/A'}
                            </small>
                        </div>
                        ${statutBadge}
                    </div>
                </div>

                <div class="card-body" style="padding: 1rem;">
                    <!-- Date de cr√©ation et Solde disponible -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded" style="border: 1px solid #e9ecef;">
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-calendar me-1"></i>Date de cr√©ation
                                </div>
                                <div class="fw-bold text-primary" style="font-size: 0.9rem;">
                                    ${dateCreation}
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded" style="border: 1px solid #e9ecef;">
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-money-bill-wave me-1"></i>Solde disponible
                                </div>
                                <div class="fw-bold text-success" style="font-size: 0.9rem;">
                                    ${solde} FCFA
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Localisation -->
                    <div class="mb-3">
                        <div class="text-muted small mb-1">
                            <i class="fa fa-map-marker-alt me-1"></i>Localisation
                        </div>
                        <div class="fw-bold small">${localisation}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Agent: ${caisse.agent_nom || 'Non assign√©'}</div>
                    </div>

                    <!-- Exercice en cours (date d√©but et date fin) -->
                    ${exerciceSection}

                    <!-- Les 3 premiers responsables -->
                    <div class="mb-3">
                        <div class="text-muted small mb-2">
                            <i class="fa fa-users me-1"></i>Responsables (3 premiers)
                        </div>
                        <div class="list-group list-group-flush">
                            ${responsablesHtml}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card-footer bg-transparent border-0 pt-0" style="padding: 0 1rem 1rem 1rem;">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-fill" 
                                onclick="voirDetailsCaisse(${caisse.id})" style="font-size: 0.8rem;">
                            <i class="fa fa-eye me-1"></i>D√©tails
                        </button>
                        <button class="btn btn-outline-success btn-sm flex-fill" 
                                onclick="voirRapportsCaisse(${caisse.id})" style="font-size: 0.8rem;">
                            <i class="fa fa-chart-line me-1"></i>Rapports
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Mettre √† jour le compteur de caisses
function updateCaissesCount() {
    const badge = document.getElementById('total-caisses-badge');
    if (badge) {
        badge.textContent = `${allCaisses.length} Caisse${allCaisses.length > 1 ? 's' : ''}`;
    }
}

// Configurer les filtres
function setupCaissesFilters() {
    const searchInput = document.getElementById('searchInput');
    const statutFilter = document.getElementById('statutFilter');
    const sortFilter = document.getElementById('sortFilter');
    const clearFilters = document.getElementById('clearFilters');
    
    if (searchInput) searchInput.addEventListener('input', filterCaisses);
    if (statutFilter) statutFilter.addEventListener('change', filterCaisses);
    if (sortFilter) sortFilter.addEventListener('change', sortCaisses);
    if (clearFilters) clearFilters.addEventListener('click', clearCaissesFilters);
}

// Filtrer les caisses
function filterCaisses() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const statutFilter = document.getElementById('statutFilter')?.value || '';
    
    const filtered = allCaisses.filter(caisse => {
        const nom = (caisse.nom_association || '').toLowerCase();
        const code = (caisse.code || '').toLowerCase();
        const localisation = `${caisse.village_nom || ''}, ${caisse.canton_nom || ''}, ${caisse.commune_nom || ''}`.toLowerCase();
        const statut = caisse.statut;
        
        const matchesSearch = !searchTerm || 
            nom.includes(searchTerm) || 
            code.includes(searchTerm) || 
            localisation.includes(searchTerm);
        
        const matchesStatut = !statutFilter || statut === statutFilter;
        
        return matchesSearch && matchesStatut;
    });
    
    renderCaisses(filtered);
}

// Trier les caisses
function sortCaisses() {
    const sortBy = document.getElementById('sortFilter')?.value || 'date_creation';
    
    const sorted = [...allCaisses].sort((a, b) => {
        switch(sortBy) {
            case 'nom':
                return (a.nom_association || '').localeCompare(b.nom_association || '');
            case 'code':
                return (a.code || '').localeCompare(b.code || '');
            case 'solde':
                return (b.fond_disponible || 0) - (a.fond_disponible || 0);
            case 'date_creation':
            default:
                return new Date(b.date_creation) - new Date(a.date_creation);
        }
    });
    
    renderCaisses(sorted);
}

// Effacer les filtres
function clearCaissesFilters() {
    const searchInput = document.getElementById('searchInput');
    const statutFilter = document.getElementById('statutFilter');
    const sortFilter = document.getElementById('sortFilter');
    
    if (searchInput) searchInput.value = '';
    if (statutFilter) statutFilter.value = '';
    if (sortFilter) sortFilter.value = 'date_creation';
    
    renderCaisses();
}

// Actions sur les caisses
function voirDetailsCaisse(caisseId) {
    window.open(`/adminsecurelogin/gestion_caisses/caisse/${caisseId}/change/`, '_blank');
}

function voirRapportsCaisse(caisseId) {
    window.open(`/gestion-caisses/admin-frontend/?caisse_id=${caisseId}`, '_blank');
}

function voirMembresCaisse(caisseId) {
    window.open(`/adminsecurelogin/gestion_caisses/membre/?caisse__id__exact=${caisseId}`, '_blank');
}

// Charger les caisses quand la section est affich√©e
function showSection(event, sectionName) {
    // Masquer toutes les sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // D√©sactiver tous les onglets
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Afficher la section demand√©e
    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Activer l'onglet correspondant
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Charger les caisses si c'est la section caisses et qu'elles ne sont pas encore charg√©es
    if (sectionName === 'caisses' && !caissesLoaded) {
        loadCaisses();
    }
}

</script>
{% endblock %}