{% extends 'gestion_caisses/base.html' %}
{% load static %}

{% block title %}Gestion des Caisses - Gestion des Caisses{% endblock %}

{% block extra_css %}
<style>
    .caisses-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .add-caisse-btn {
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
    }
    
    .add-caisse-btn:hover {
        background: #059669;
    }
    
    .caisses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .caisse-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #2563eb;
    }
    
    .caisse-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .caisse-code {
        background: #2563eb;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
    }
    
    .caisse-name {
        font-size: 1.2em;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 10px;
    }
    
    .caisse-location {
        color: #6b7280;
        margin-bottom: 15px;
    }
    
    .caisse-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #2563eb;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #6b7280;
    }
    
    .caisse-actions {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9em;
        text-align: center;
        flex: 1;
    }
    
    .btn-view {
        background: #3b82f6;
        color: white;
    }
    
    .btn-edit {
        background: #f59e0b;
        color: white;
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    
    .empty-state h3 {
        margin-bottom: 10px;
        color: #1f2937;
    }
</style>
{% endblock %}

{% block content %}
<div class="caisses-container">
    <div class="page-header">
        <h1>Gestion des Caisses</h1>
        <a href="/adminsecurelogin/gestion_caisses/caisse/add/" class="add-caisse-btn">+ Nouvelle Caisse</a>
    </div>
    
    <div id="caisses-content">
        <div class="empty-state">
            <h3>Chargement des caisses...</h3>
            <p>Veuillez patienter pendant le chargement des données.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCaisses();
});

function loadCaisses() {
    fetch('/api/caisses/', {
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCaisses(data.results || data);
    })
    .catch(error => {
        console.error('Erreur lors du chargement des caisses:', error);
        document.getElementById('caisses-content').innerHTML = 
            '<div class="empty-state"><h3>Erreur de chargement</h3><p>Impossible de charger les caisses.</p></div>';
    });
}

function displayCaisses(caisses) {
    const container = document.getElementById('caisses-content');
    
    if (!caisses || caisses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>Aucune caisse trouvée</h3>
                <p>Commencez par créer votre première caisse.</p>
            </div>
        `;
        return;
    }
    
    const caissesHTML = caisses.map(caisse => `
        <div class="caisse-card">
            <div class="caisse-header">
                <span class="caisse-code">${caisse.code}</span>
                <span style="color: ${caisse.solde_disponible >= 0 ? '#10b981' : '#ef4444'}; font-weight: 500;">
                    ${caisse.solde_disponible >= 0 ? '+' : ''}${caisse.solde_disponible?.toLocaleString() || 0} FCFA
                </span>
            </div>
            <div class="caisse-name">${caisse.nom}</div>
            <div class="caisse-location">
                ${caisse.commune?.nom || ''}, ${caisse.commune?.prefecture?.nom || ''}
            </div>
            <div class="caisse-stats">
                <div class="stat-item">
                    <div class="stat-value">${caisse.nombre_membres || 0}</div>
                    <div class="stat-label">Membres</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${caisse.nombre_prets_actifs || 0}</div>
                    <div class="stat-label">Prêts Actifs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${caisse.date_creation ? new Date(caisse.date_creation).getFullYear() : '-'}</div>
                    <div class="stat-label">Année</div>
                </div>
            </div>
            <div class="caisse-actions">
                <a href="/adminsecurelogin/gestion_caisses/caisse/${caisse.id}/change/" class="action-btn btn-view">Voir</a>
                <a href="/adminsecurelogin/gestion_caisses/caisse/${caisse.id}/change/" class="action-btn btn-edit">Modifier</a>
                <a href="/adminsecurelogin/gestion_caisses/caisse/${caisse.id}/delete/" class="action-btn btn-delete">Supprimer</a>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `<div class="caisses-grid">${caissesHTML}</div>`;
}

function getCSRFToken() {
    return window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
}
</script>
{% endblock %}
