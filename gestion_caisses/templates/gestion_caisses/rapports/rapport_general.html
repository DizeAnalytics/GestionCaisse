{% load math_filters %}
{% extends 'gestion_caisses/rapports/base_rapport.html' %}

{% block title %}Rapport GÃ©nÃ©ral - Gestion des Caisses{% endblock %}

{% block rapport_title %}Rapport GÃ©nÃ©ral du SystÃ¨me{% endblock %}
{% block rapport_subtitle %}Vue d'ensemble complÃ¨te de la gestion des caisses{% endblock %}
{% block rapport_type %}GÃ©nÃ©ral{% endblock %}
{% block rapport_periode %}Toutes pÃ©riodes{% endblock %}

{% block rapport_content %}
    <!-- Section Statistiques GÃ©nÃ©rales -->
    <div class="section">
        <h2 class="section-title">ğŸ“Š Statistiques GÃ©nÃ©rales du SystÃ¨me</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ total_caisses }}</div>
                <div class="stat-label">Total Caisses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_membres }}</div>
                <div class="stat-label">Total Membres</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_prets }}</div>
                <div class="stat-label">Total PrÃªts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_fonds|floatformat:0 }} FCFA</div>
                <div class="stat-label">Fonds Totaux</div>
            </div>
        </div>
    </div>

    <!-- Section Ã‰tat des PrÃªts -->
    <div class="section">
        <h2 class="section-title">ğŸ’³ Ã‰tat des PrÃªts</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ prets_valides }}</div>
                <div class="stat-label">PrÃªts ValidÃ©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ prets_en_cours }}</div>
                <div class="stat-label">PrÃªts en Cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ prets_rembourses }}</div>
                <div class="stat-label">PrÃªts RemboursÃ©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_montant_prets|floatformat:0 }} FCFA</div>
                <div class="stat-label">Montant Total AccordÃ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_montant_rembourse|floatformat:0 }} FCFA</div>
                <div class="stat-label">Montant Total RemboursÃ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_montant_prets|add:"-"|add:total_montant_rembourse|floatformat:0 }} FCFA</div>
                <div class="stat-label">Montant Restant</div>
            </div>
        </div>
    </div>

    <!-- Section Caisse GÃ©nÃ©rale -->
    <div class="section">
        <h2 class="section-title">ğŸ›ï¸ Ã‰tat de la Caisse GÃ©nÃ©rale</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ solde_reserve|floatformat:0 }} FCFA</div>
                <div class="stat-label">Solde de RÃ©serve</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ solde_systeme|floatformat:0 }} FCFA</div>
                <div class="stat-label">Solde SystÃ¨me Total</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>RÃ©partition des Fonds</h3>
            <div class="chart-placeholder">
                <p>ğŸ“Š Graphique de rÃ©partition des fonds</p>
                <p>Solde de RÃ©serve: {{ solde_reserve|floatformat:0 }} FCFA</p>
                <p>Solde Total des Caisses: {{ total_fonds|floatformat:0 }} FCFA</p>
                <p>Solde SystÃ¨me: {{ solde_systeme|floatformat:0 }} FCFA</p>
            </div>
        </div>
    </div>

    <!-- Section Transferts -->
    <div class="section">
        <h2 class="section-title">ğŸ”„ Ã‰tat des Transferts entre Caisses</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ total_transferts }}</div>
                <div class="stat-label">Total Transferts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ transferts_valides }}</div>
                <div class="stat-label">Transferts ValidÃ©s</div>
            </div>
        </div>
        
        {% if total_transferts > 0 %}
        <div class="chart-container">
            <h3>RÃ©partition des Transferts</h3>
            <div class="chart-placeholder">
                <p>ğŸ“ˆ Graphique des transferts par statut</p>
                <p>ValidÃ©s: {{ transferts_valides }} (<span id="pourcentage-transferts">0</span>%)</p>
                <p>En attente: {{ total_transferts|add:"-"|add:transferts_valides }}</p>
            </div>
        </div>
        {% else %}
        <div class="chart-container">
            <p class="text-center text-muted">Aucun transfert enregistrÃ© pour le moment</p>
        </div>
        {% endif %}
    </div>

    <!-- Section RÃ©sumÃ© et Recommandations -->
    <div class="section">
        <h2 class="section-title">ğŸ“‹ RÃ©sumÃ© et Recommandations</h2>
        
        <div class="p-20" style="background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #007bff; margin-bottom: 15px;">Points ClÃ©s du SystÃ¨me</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Fonds disponibles :</strong> {{ total_fonds|floatformat:0 }} FCFA rÃ©partis sur {{ total_caisses }} caisses</li>
                <li><strong>ActivitÃ© des prÃªts :</strong> {{ prets_en_cours }} prÃªts actuellement en cours</li>
                <li><strong>Taux de remboursement :</strong> 
                    {% if total_montant_prets > 0 %}
                        {{ total_montant_rembourse|div:total_montant_prets|mul:100|floatformat:1 }}%
                    {% else %}
                        0%
                    {% endif %}
                    du montant total accordÃ©
                </li>
                <li><strong>Solde de rÃ©serve :</strong> {{ solde_reserve|floatformat:0 }} FCFA dans la caisse gÃ©nÃ©rale</li>
            </ul>
            
            <h3 style="color: #007bff; margin: 20px 0 15px 0;">Recommandations</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                {% if prets_en_cours > 0 %}
                <li>ğŸ“Š <strong>Suivi des prÃªts :</strong> Surveiller les {{ prets_en_cours }} prÃªts en cours pour assurer un bon taux de remboursement</li>
                {% endif %}
                
                {% if total_fonds > 0 %}
                <li>ğŸ’° <strong>Gestion des fonds :</strong> Optimiser la rÃ©partition des {{ total_fonds|floatformat:0 }} FCFA disponibles</li>
                {% endif %}
                
                {% if solde_reserve < 1000000 %}
                <li>âš ï¸ <strong>RÃ©serve :</strong> ConsidÃ©rer l'augmentation du solde de rÃ©serve (actuellement {{ solde_reserve|floatformat:0 }} FCFA)</li>
                {% endif %}
                
                {% if total_transferts > 0 %}
                <li>ğŸ”„ <strong>Transferts :</strong> Maintenir la traÃ§abilitÃ© des {{ total_transferts }} transferts effectuÃ©s</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- Section DÃ©tails Techniques -->
    <div class="section">
        <h2 class="section-title">ğŸ”§ Informations Techniques</h2>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>MÃ©trique</th>
                        <th>Valeur</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre total de caisses</td>
                        <td class="text-center">{{ total_caisses }}</td>
                        <td>Caisses enregistrÃ©es dans le systÃ¨me</td>
                    </tr>
                    <tr>
                        <td>Nombre total de membres</td>
                        <td class="text-center">{{ total_membres }}</td>
                        <td>Membres actifs et inactifs</td>
                    </tr>
                    <tr>
                        <td>Nombre total de prÃªts</td>
                        <td class="text-center">{{ total_prets }}</td>
                        <td>Tous les prÃªts depuis le dÃ©but</td>
                    </tr>
                    <tr>
                        <td>PrÃªts en cours</td>
                        <td class="text-center">{{ prets_en_cours }}</td>
                        <td>PrÃªts actuellement en cours de remboursement</td>
                    </tr>
                    <tr>
                        <td>PrÃªts remboursÃ©s</td>
                        <td class="text-center">{{ prets_rembourses }}</td>
                        <td>PrÃªts entiÃ¨rement remboursÃ©s</td>
                    </tr>
                    <tr>
                        <td>Fonds totaux disponibles</td>
                        <td class="text-center">{{ total_fonds|floatformat:0 }} FCFA</td>
                        <td>Somme des fonds disponibles dans toutes les caisses</td>
                    </tr>
                    <tr>
                        <td>Montant total des prÃªts</td>
                        <td class="text-center">{{ total_montant_prets|floatformat:0 }} FCFA</td>
                        <td>Capital total prÃªtÃ©</td>
                    </tr>
                    <tr>
                        <td>Montant total remboursÃ©</td>
                        <td class="text-center">{{ total_montant_rembourse|floatformat:0 }} FCFA</td>
                        <td>Capital total remboursÃ©</td>
                    </tr>
                    <tr>
                        <td>Solde de rÃ©serve</td>
                        <td class="text-center">{{ solde_reserve|floatformat:0 }} FCFA</td>
                        <td>Fonds de rÃ©serve de la caisse gÃ©nÃ©rale</td>
                    </tr>
                    <tr>
                        <td>Solde systÃ¨me total</td>
                        <td class="text-center">{{ solde_systeme|floatformat:0 }} FCFA</td>
                        <td>Solde total du systÃ¨me (rÃ©serve + caisses)</td>
                    </tr>
                    <tr>
                        <td>Nombre de transferts</td>
                        <td class="text-center">{{ total_transferts }}</td>
                        <td>Transferts entre caisses effectuÃ©s</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Calculer le pourcentage des transferts validÃ©s
        document.addEventListener('DOMContentLoaded', function() {
            const transfertsValides = {{ transferts_valides }};
            const totalTransferts = {{ total_transferts }};
            
            if (totalTransferts > 0) {
                const pourcentage = (transfertsValides / totalTransferts * 100).toFixed(1);
                document.getElementById('pourcentage-transferts').textContent = pourcentage;
            }
        });
    </script>
{% endblock %}
