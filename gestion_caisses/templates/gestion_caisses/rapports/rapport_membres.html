{% extends 'gestion_caisses/rapports/base_rapport.html' %}

{% block title %}Rapport des Membres - Gestion des Caisses{% endblock %}

{% block rapport_title %}Rapport des Membres{% endblock %}
{% block rapport_subtitle %}Analyse détaillée des membres et de leurs activités{% endblock %}
{% block rapport_type %}Membres{% endblock %}
{% block rapport_period %}Toutes périodes{% endblock %}

{% block rapport_content %}
    <!-- Section Statistiques Générales -->
    <div class="section">
        <h2 class="section-title">📊 Statistiques Générales</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ membres.count }}</div>
                <div class="stat-label">Total Membres</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ membres|length }}</div>
                <div class="stat-label">Membres Analysés</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ date_generation|date:"d/m/Y" }}</div>
                <div class="stat-label">Date de Génération</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats_par_region.count }}</div>
                <div class="stat-label">Régions</div>
            </div>
        </div>
    </div>

    <!-- Section Statistiques par Région -->
    <div class="section">
        <h2 class="section-title">🗺️ Statistiques par Région</h2>
        
        {% if stats_par_region %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Région</th>
                        <th>Nombre de Membres</th>
                        <th>Nombre de Prêts</th>
                        <th>Montant Total des Prêts</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats_par_region %}
                    <tr>
                        <td>{{ stat.caisse__region__nom|default:"Région inconnue" }}</td>
                        <td class="text-center">{{ stat.total }}</td>
                        <td class="text-center">{{ stat.nombre_prets|default:0 }}</td>
                        <td class="text-right">{{ stat.montant_prets|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-center">
                            <span class="pourcentage-region" data-total="{{ stat.total }}">0</span>%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucune statistique par région disponible.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Statistiques par Préfecture -->
    <div class="section">
        <h2 class="section-title">🏛️ Statistiques par Préfecture</h2>
        
        {% if stats_par_prefecture %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Préfecture</th>
                        <th>Nombre de Membres</th>
                        <th>Nombre de Prêts</th>
                        <th>Montant Total des Prêts</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats_par_prefecture %}
                    <tr>
                        <td>{{ stat.caisse__prefecture__nom|default:"Préfecture inconnue" }}</td>
                        <td class="text-center">{{ stat.total }}</td>
                        <td class="text-center">{{ stat.nombre_prets|default:0 }}</td>
                        <td class="text-right">{{ stat.montant_prets|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-center">
                            <span class="pourcentage-prefecture" data-total="{{ stat.total }}">0</span>%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucune statistique par préfecture disponible.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Détail des Membres -->
    <div class="section">
        <h2 class="section-title">👥 Détail des Membres</h2>
        
        {% if membres %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénoms</th>
                        <th>Caisse</th>
                        <th>Région</th>
                        <th>Préfecture</th>
                        <th>Nombre de Prêts</th>
                        <th>Montant Total des Prêts</th>
                        <th>Montant Total Remboursé</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for membre in membres %}
                    <tr>
                        <td>{{ membre.nom }}</td>
                        <td>{{ membre.prenoms }}</td>
                        <td>{{ membre.caisse.nom_association|default:"-" }}</td>
                        <td>{{ membre.caisse.region.nom|default:"-" }}</td>
                        <td>{{ membre.caisse.prefecture.nom|default:"-" }}</td>
                        <td class="text-center">{{ membre.nombre_prets|default:0 }}</td>
                        <td class="text-right">{{ membre.montant_total_prets|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-right">{{ membre.montant_total_rembourse|default:0|floatformat:0 }} FCFA</td>
                        <td>
                            <span class="badge badge-{{ membre.statut|lower }}">
                                {{ membre.statut }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucun membre disponible pour l'analyse.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Analyse des Rôles -->
    <div class="section">
        <h2 class="section-title">🎭 Analyse des Rôles</h2>
        
        <div class="p-20" style="background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #007bff; margin-bottom: 15px;">Répartition des Rôles</h3>
            
            <div class="role-stats">
                <div class="role-item">
                    <span class="role-icon">👑</span>
                    <span class="role-name">Présidents</span>
                    <span class="role-count">{{ membres|length }}</span>
                </div>
                <div class="role-item">
                    <span class="role-icon">📝</span>
                    <span class="role-name">Secrétaires</span>
                    <span class="role-count">{{ membres|length }}</span>
                </div>
                <div class="role-item">
                    <span class="role-icon">💰</span>
                    <span class="role-name">Trésoriers</span>
                    <span class="role-count">{{ membres|length }}</span>
                </div>
                <div class="role-item">
                    <span class="role-icon">👥</span>
                    <span class="role-name">Membres Actifs</span>
                    <span class="role-count">{{ membres|length }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Analyse et Recommandations -->
    <div class="section">
        <h2 class="section-title">💡 Analyse et Recommandations</h2>
        
        <div class="p-20" style="background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #007bff; margin-bottom: 15px;">Points Clés de l'Analyse</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Total des membres :</strong> {{ membres.count }} membres enregistrés</li>
                <li><strong>Répartition géographique :</strong> {{ stats_par_region.count }} régions couvertes</li>
                <li><strong>Préfectures actives :</strong> {{ stats_par_prefecture.count }} préfectures représentées</li>
                <li><strong>Période d'analyse :</strong> Derniers 30 jours</li>
            </ul>
            
            <h3 style="color: #007bff; margin: 20px 0 15px 0;">Recommandations</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li>📊 <strong>Croissance des membres :</strong> Développer l'adhésion dans les régions moins représentées</li>
                <li>🏦 <strong>Gestion des caisses :</strong> Équilibrer la répartition des membres entre les caisses</li>
                <li>📈 <strong>Formation continue :</strong> Organiser des sessions de formation pour les nouveaux membres</li>
                <li>🔍 <strong>Suivi des activités :</strong> Analyser la participation des membres aux activités</li>
                <li>📋 <strong>Communication :</strong> Maintenir une communication régulière avec tous les membres</li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .role-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .role-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .role-icon {
        font-size: 2em;
        display: block;
        margin-bottom: 10px;
    }
    
    .role-name {
        display: block;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .role-count {
        display: block;
        font-size: 1.5em;
        color: #007bff;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Calculer les pourcentages
    document.addEventListener('DOMContentLoaded', function() {
        const totalMembres = {{ membres.count }};
        
        if (totalMembres > 0) {
            // Pourcentages par région
            document.querySelectorAll('.pourcentage-region').forEach(function(element) {
                const total = parseInt(element.dataset.total);
                const pourcentage = (total / totalMembres * 100).toFixed(1);
                element.textContent = pourcentage;
            });
            
            // Pourcentages par préfecture
            document.querySelectorAll('.pourcentage-prefecture').forEach(function(element) {
                const total = parseInt(element.dataset.total);
                const pourcentage = (total / totalMembres * 100).toFixed(1);
                element.textContent = pourcentage;
            });
        }
    });
</script>
{% endblock %}
