{% extends 'gestion_caisses/rapports/base_rapport.html' %}

{% block title %}Rapport des Caisses - Gestion des Caisses{% endblock %}

{% block rapport_title %}Rapport des Caisses{% endblock %}
{% block rapport_subtitle %}Analyse d√©taill√©e des caisses et de leurs performances{% endblock %}
{% block rapport_type %}Caisses{% endblock %}
{% block rapport_period %}Toutes p√©riodes{% endblock %}

{% block rapport_content %}
    <!-- Section Statistiques G√©n√©rales -->
    <div class="section">
        <h2 class="section-title">üìä Statistiques G√©n√©rales</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ caisses.count }}</div>
                <div class="stat-label">Total Caisses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ caisses|length }}</div>
                <div class="stat-label">Caisses Analys√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ date_generation|date:"d/m/Y" }}</div>
                <div class="stat-label">Date de G√©n√©ration</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats_par_region.count }}</div>
                <div class="stat-label">R√©gions</div>
            </div>
        </div>
    </div>

    <!-- Section Statistiques par R√©gion -->
    <div class="section">
        <h2 class="section-title">üó∫Ô∏è Statistiques par R√©gion</h2>
        
        {% if stats_par_region %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>R√©gion</th>
                        <th>Nombre de Caisses</th>
                        <th>Total Fonds</th>
                        <th>Total Membres</th>
                        <th>Total Pr√™ts</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats_par_region %}
                    <tr>
                        <td>{{ stat.region__nom|default:"R√©gion inconnue" }}</td>
                        <td class="text-center">{{ stat.total }}</td>
                        <td class="text-right">{{ stat.total_fonds|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-center">{{ stat.total_membres|default:0 }}</td>
                        <td class="text-center">{{ stat.total_prets|default:0 }}</td>
                        <td class="text-center">
                            <span class="pourcentage-region" data-total="{{ stat.total }}">0</span>%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucune statistique par r√©gion disponible.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Statistiques par Pr√©fecture -->
    <div class="section">
        <h2 class="section-title">üèõÔ∏è Statistiques par Pr√©fecture</h2>
        
        {% if stats_par_prefecture %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Pr√©fecture</th>
                        <th>Nombre de Caisses</th>
                        <th>Total Fonds</th>
                        <th>Total Membres</th>
                        <th>Total Pr√™ts</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats_par_prefecture %}
                    <tr>
                        <td>{{ stat.prefecture__nom|default:"Pr√©fecture inconnue" }}</td>
                        <td class="text-center">{{ stat.total }}</td>
                        <td class="text-right">{{ stat.total_fonds|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-center">{{ stat.total_membres|default:0 }}</td>
                        <td class="text-center">{{ stat.total_prets|default:0 }}</td>
                        <td class="text-center">
                            <span class="pourcentage-prefecture" data-total="{{ stat.total }}">0</span>%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucune statistique par pr√©fecture disponible.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section D√©tail des Caisses -->
    <div class="section">
        <h2 class="section-title">üè¶ D√©tail des Caisses</h2>
        
        {% if caisses %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nom de l'Association</th>
                        <th>R√©gion</th>
                        <th>Pr√©fecture</th>
                        <th>Fond Disponible</th>
                        <th>Membres</th>
                        <th>Pr√™ts</th>
                        <th>Pr√™ts Actifs</th>
                        <th>Montant Total Pr√™ts</th>
                        <th>Montant Total Rembours√©</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for caisse in caisses %}
                    <tr>
                        <td>{{ caisse.nom_association }}</td>
                        <td>{{ caisse.region.nom|default:"-" }}</td>
                        <td>{{ caisse.prefecture.nom|default:"-" }}</td>
                        <td class="text-right">{{ caisse.fond_disponible|floatformat:0 }} FCFA</td>
                        <td class="text-center">{{ caisse.nombre_membres|default:0 }}</td>
                        <td class="text-center">{{ caisse.nombre_prets|default:0 }}</td>
                        <td class="text-center">{{ caisse.prets_actifs|default:0 }}</td>
                        <td class="text-right">{{ caisse.total_montant_prets|default:0|floatformat:0 }} FCFA</td>
                        <td class="text-right">{{ caisse.total_montant_rembourse|default:0|floatformat:0 }} FCFA</td>
                        <td>
                            <span class="badge badge-{{ caisse.statut|lower }}">
                                {{ caisse.statut }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>Aucune caisse disponible pour l'analyse.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section Analyse des Performances -->
    <div class="section">
        <h2 class="section-title">üìà Analyse des Performances</h2>
        
        <div class="p-20" style="background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #007bff; margin-bottom: 15px;">Indicateurs de Performance</h3>
            
            <div class="performance-grid">
                <div class="performance-item">
                    <span class="performance-icon">üí∞</span>
                    <span class="performance-label">Fonds Total</span>
                    <span class="performance-value">
                        {% with total_fonds=caisses|length %}
                            {% for caisse in caisses %}
                                {% if forloop.first %}
                                    {{ caisse.fond_disponible|default:0|floatformat:0 }}
                                {% endif %}
                            {% endfor %}
                        {% endwith %} FCFA
                    </span>
                </div>
                <div class="performance-item">
                    <span class="performance-icon">üë•</span>
                    <span class="performance-label">Membres Total</span>
                    <span class="performance-value">
                        {% with total_membres=caisses|length %}
                            {% for caisse in caisses %}
                                {% if forloop.first %}
                                    {{ caisse.nombre_membres|default:0 }}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </span>
                </div>
                <div class="performance-item">
                    <span class="performance-icon">üìä</span>
                    <span class="performance-label">Pr√™ts Total</span>
                    <span class="performance-value">
                        {% with total_prets=caisses|length %}
                            {% for caisse in caisses %}
                                {% if forloop.first %}
                                    {{ caisse.nombre_prets|default:0 }}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </span>
                </div>
                <div class="performance-item">
                    <span class="performance-icon">üéØ</span>
                    <span class="performance-label">Taux d'Activit√©</span>
                    <span class="performance-value">
                        <span class="taux-activite" data-caisses="{{ caisses.count }}">0</span>%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Analyse et Recommandations -->
    <div class="section">
        <h2 class="section-title">üí° Analyse et Recommandations</h2>
        
        <div class="p-20" style="background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #007bff; margin-bottom: 15px;">Points Cl√©s de l'Analyse</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Total des caisses :</strong> {{ caisses.count }} caisses actives</li>
                <li><strong>R√©partition g√©ographique :</strong> {{ stats_par_region.count }} r√©gions couvertes</li>
                <li><strong>Pr√©fectures actives :</strong> {{ stats_par_prefecture.count }} pr√©fectures repr√©sent√©es</li>
                <li><strong>P√©riode d'analyse :</strong> Derniers 30 jours</li>
            </ul>
            
            <h3 style="color: #007bff; margin: 20px 0 15px 0;">Recommandations</h3>
            
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li>üìä <strong>√âquilibrage des fonds :</strong> R√©partir √©quitablement les fonds entre les caisses</li>
                <li>üè¶ <strong>Gestion des risques :</li>
                <li>üìà <strong>Formation des gestionnaires :</strong> Organiser des sessions de formation</li>
                <li>üîç <strong>Audit r√©gulier :</strong> V√©rifier la conformit√© des op√©rations</li>
                <li>üìã <strong>Communication :</strong> Maintenir une communication r√©guli√®re entre caisses</li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .performance-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .performance-icon {
        font-size: 2em;
        display: block;
        margin-bottom: 10px;
    }
    
    .performance-label {
        display: block;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .performance-value {
        display: block;
        font-size: 1.5em;
        color: #007bff;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Calculer les pourcentages
    document.addEventListener('DOMContentLoaded', function() {
        const totalCaisses = {{ caisses.count }};
        
        if (totalCaisses > 0) {
            // Pourcentages par r√©gion
            document.querySelectorAll('.pourcentage-region').forEach(function(element) {
                const total = parseInt(element.dataset.total);
                const pourcentage = (total / totalCaisses * 100).toFixed(1);
                element.textContent = pourcentage;
            });
            
            // Pourcentages par pr√©fecture
            document.querySelectorAll('.pourcentage-prefecture').forEach(function(element) {
                const total = parseInt(element.dataset.total);
                const pourcentage = (total / totalCaisses * 100).toFixed(1);
                element.textContent = pourcentage;
            });
            
            // Taux d'activit√©
            const tauxActivite = document.querySelector('.taux-activite');
            if (tauxActivite) {
                const caissesActives = {{ caisses.count }};
                const taux = (caissesActives / totalCaisses * 100).toFixed(1);
                tauxActivite.textContent = taux;
            }
        }
    });
</script>
{% endblock %}
