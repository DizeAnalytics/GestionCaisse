{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content_title %}
    <h1>ğŸ›ï¸ Dashboard d'Administration - Gestion des Caisses de Femmes</h1>
{% endblock %}

{% block object-tools-items %}
    {{ block.super }}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .admin-dashboard {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-card h3 {
        margin: 0 0 12px 0;
        color: #333;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #007bff;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .stat-icon {
        font-size: 24px;
        opacity: 0.8;
    }
    
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .action-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .action-card h3 {
        margin: 0 0 16px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
    }
    
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        color: #495057;
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .action-btn:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
        transform: translateX(4px);
    }
    
    .action-btn.primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .action-btn.primary:hover {
        background: #0056b3;
        border-color: #0056b3;
    }
    
    .action-btn.success {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .action-btn.success:hover {
        background: #1e7e34;
        border-color: #1e7e34;
    }
    
    .action-btn.warning {
        background: #ffc107;
        color: #212529;
        border-color: #ffc107;
    }
    
    .action-btn.warning:hover {
        background: #e0a800;
        border-color: #e0a800;
    }
    
    .action-btn.danger {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .action-btn.danger:hover {
        background: #c82333;
        border-color: #c82333;
    }
    
    .quick-actions {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .quick-actions h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 12px;
    }
    
    .quick-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .quick-btn {
        padding: 10px 16px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quick-btn:hover {
        background: #5a6268;
        color: white;
        transform: translateY(-1px);
    }
    
    .quick-btn.primary { background: #007bff; }
    .quick-btn.primary:hover { background: #0056b3; }
    
    .quick-btn.success { background: #28a745; }
    .quick-btn.success:hover { background: #1e7e34; }
    
    .quick-btn.warning { background: #ffc107; color: #212529; }
    .quick-btn.warning:hover { background: #e0a800; }
    
    .quick-btn.info { background: #17a2b8; }
    .quick-btn.info:hover { background: #138496; }
    
    .quick-btn.dark { background: #343a40; }
    .quick-btn.dark:hover { background: #23272b; }
    
    .reports-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .reports-section h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 12px;
    }
    
    .report-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .report-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .report-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .report-btn.primary {
        background: #007bff;
        color: white;
    }
    
    .report-btn.primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }
    
    .report-btn.success {
        background: #28a745;
        color: white;
    }
    
    .report-btn.success:hover {
        background: #1e7e34;
        transform: translateY(-1px);
    }
    
    .report-btn.warning {
        background: #ffc107;
        color: #212529;
    }
    
    .report-btn.warning:hover {
        background: #e0a800;
        transform: translateY(-1px);
    }
    
    .report-btn.info {
        background: #17a2b8;
        color: white;
    }
    
    .report-btn.info:hover {
        background: #138496;
        transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .actions-grid {
            grid-template-columns: 1fr;
        }
        
        .report-filters {
            grid-template-columns: 1fr;
        }
        
        .quick-buttons {
            justify-content: center;
        }
        
        .report-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="admin-dashboard">
        <!-- Statistiques principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>ğŸ’° Fonds Totaux Disponibles</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ’µ</span>
                    {{ total_fonds_disponibles|floatformat:0 }} FCFA
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ¦ Nombre de Caisses</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ›ï¸</span>
                    {{ total_caisses }}
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ‘¥ Total Membres</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ‘¤</span>
                    {{ total_membres }}
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ“Š PrÃªts Actifs</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ“ˆ</span>
                    {{ prets_actifs }}
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ’³ Montant Total PrÃªts</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ’³</span>
                    {{ total_montant_prets|floatformat:0 }} FCFA
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ”„ Montant RemboursÃ©</h3>
                <p class="stat-value">
                    <span class="stat-icon">âœ…</span>
                    {{ total_montant_rembourse|floatformat:0 }} FCFA
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ›ï¸ Caisse GÃ©nÃ©rale - RÃ©serve</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ¦</span>
                    {{ caisse_generale_reserve|floatformat:0 }} FCFA
                </p>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ“Š Caisse GÃ©nÃ©rale - Total SystÃ¨me</h3>
                <p class="stat-value">
                    <span class="stat-icon">ğŸ“ˆ</span>
                    {{ caisse_generale_systeme|floatformat:0 }} FCFA
                </p>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="quick-actions">
            <h3>âš¡ Actions Rapides</h3>
            <div class="quick-buttons">
                <a href="/adminsecurelogin/gestion_caisses/pret/" class="quick-btn primary">ğŸ“„ GÃ©rer les PrÃªts</a>
                <a href="/adminsecurelogin/gestion_caisses/caisse/" class="quick-btn success">ğŸ¦ GÃ©rer les Caisses</a>
                <a href="/adminsecurelogin/gestion_caisses/membre/" class="quick-btn warning">ğŸ‘¥ GÃ©rer les Membres</a>
                <a href="/adminsecurelogin/gestion_caisses/transfertcaisse/" class="quick-btn info">ğŸ”„ Transferts entre Caisses</a>
                <a href="/adminsecurelogin/gestion_caisses/caissegenerale/" class="quick-btn dark">ğŸ›ï¸ Caisse GÃ©nÃ©rale</a>
                <a href="/adminsecurelogin/gestion_caisses/notification/" class="quick-btn primary">ğŸ”” Notifications</a>
            </div>
        </div>

        <!-- Actions principales -->
        <div class="actions-grid">
            <!-- Rapports et Ã‰tats -->
            <div class="action-card">
                <h3>ğŸ“Š Rapports et Ã‰tats</h3>
                <div class="action-buttons">
                    <a href="#" class="action-btn primary" onclick="genererRapportGeneral()">
                        ğŸ“ˆ Rapport GÃ©nÃ©ral du SystÃ¨me
                    </a>
                    <a href="#" class="action-btn success" onclick="genererRapportFinancier()">
                        ğŸ’° Rapport Financier Complet
                    </a>
                    <a href="#" class="action-btn warning" onclick="genererRapportPrets()">
                        ğŸ’³ Rapport des PrÃªts
                    </a>
                    <a href="#" class="action-btn info" onclick="genererRapportMembres()">
                        ğŸ‘¥ Rapport des Membres
                    </a>
                    <a href="#" class="action-btn dark" onclick="genererRapportTransferts()">
                        ğŸ”„ Rapport des Transferts
                    </a>
                </div>
            </div>

            <!-- Impressions -->
            <div class="action-card">
                <h3>ğŸ–¨ï¸ Impressions</h3>
                <div class="action-buttons">
                    <a href="#" class="action-btn primary" onclick="imprimerEtatGeneral()">
                        ğŸ–¨ï¸ Ã‰tat GÃ©nÃ©ral du SystÃ¨me
                    </a>
                    <a href="#" class="action-btn success" onclick="imprimerEtatFinancier()">
                        ğŸ–¨ï¸ Ã‰tat Financier
                    </a>
                    <a href="#" class="action-btn warning" onclick="imprimerEtatPrets()">
                        ğŸ–¨ï¸ Ã‰tat des PrÃªts
                    </a>
                    <a href="#" class="action-btn info" onclick="imprimerEtatCaisses()">
                        ğŸ–¨ï¸ Ã‰tat des Caisses
                    </a>
                    <a href="#" class="action-btn dark" onclick="imprimerEtatTransferts()">
                        ğŸ–¨ï¸ Ã‰tat des Transferts
                    </a>
                </div>
            </div>

            <!-- Gestion des fonds -->
            <div class="action-card">
                <h3>ğŸ’µ Gestion des Fonds</h3>
                <div class="action-buttons">
                    <a href="#" class="action-btn primary" onclick="voirCaisseGenerale()">
                        ğŸ›ï¸ Voir Caisse GÃ©nÃ©rale
                    </a>
                    <a href="#" class="action-btn success" onclick="gererTransferts()">
                        ğŸ”„ GÃ©rer les Transferts
                    </a>
                    <a href="#" class="action-btn warning" onclick="voirMouvementsFonds()">
                        ğŸ“Š Mouvements de Fonds
                    </a>
                    <a href="#" class="action-btn info" onclick="voirVirementsBancaires()">
                        ğŸ¦ Virements Bancaires
                    </a>
                    <a href="#" class="action-btn dark" onclick="voirAuditLogs()">
                        ğŸ“ Logs d'Audit
                    </a>
                </div>
            </div>

            <!-- Maintenance -->
            <div class="action-card">
                <h3>ğŸ”§ Maintenance</h3>
                <div class="action-buttons">
                    <a href="#" class="action-btn primary" onclick="synchroniserSysteme()">
                        ğŸ”„ Synchroniser le SystÃ¨me
                    </a>
                    <a href="#" class="action-btn success" onclick="verifierIntegrite()">
                        âœ… VÃ©rifier l'IntÃ©gritÃ©
                    </a>
                    <a href="#" class="action-btn warning" onclick="nettoyerDonnees()">
                        ğŸ§¹ Nettoyer les DonnÃ©es
                    </a>
                    <a href="#" class="action-btn info" onclick="sauvegarderSysteme()">
                        ğŸ’¾ Sauvegarder le SystÃ¨me
                    </a>
                    <a href="#" class="action-btn dark" onclick="voirParametres()">
                        âš™ï¸ ParamÃ¨tres du SystÃ¨me
                    </a>
                </div>
            </div>
        </div>

        <!-- Section Rapports avec Filtres -->
        <div class="reports-section">
            <h3>ğŸ“‹ GÃ©nÃ©ration de Rapports PersonnalisÃ©s</h3>
            
            <div class="report-filters">
                <div class="filter-group">
                    <label for="typeRapport">Type de Rapport</label>
                    <select id="typeRapport" class="form-select">
                        <option value="general">GÃ©nÃ©ral</option>
                        <option value="financier">Financier</option>
                        <option value="prets">PrÃªts</option>
                        <option value="membres">Membres</option>
                        <option value="caisses">Caisses</option>
                        <option value="transferts">Transferts</option>
                        <option value="audit">Audit</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="caisseSelect">Caisse (optionnel)</label>
                    <select id="caisseSelect" class="form-select">
                        <option value="">Toutes les Caisses</option>
                        {% for caisse in caisses %}
                        <option value="{{ caisse.id }}">{{ caisse.nom_association }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="dateDebut">Date de DÃ©but</label>
                    <input type="date" id="dateDebut" class="form-control">
                </div>
                
                <div class="filter-group">
                    <label for="dateFin">Date de Fin</label>
                    <input type="date" id="dateFin" class="form-control">
                </div>
                
                <div class="filter-group">
                    <label for="formatRapport">Format</label>
                    <select id="formatRapport" class="form-select">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                        <option value="html">HTML</option>
                    </select>
                </div>
            </div>
            
            <div class="report-actions">
                <button type="button" class="report-btn primary" onclick="genererRapportPersonnalise()">
                    ğŸ“Š GÃ©nÃ©rer le Rapport
                </button>
                <button type="button" class="report-btn success" onclick="previsualiserRapport()">
                    ğŸ‘ï¸ PrÃ©visualiser
                </button>
                <button type="button" class="report-btn warning" onclick="exporterDonnees()">
                    ğŸ“¥ Exporter les DonnÃ©es
                </button>
                <button type="button" class="report-btn info" onclick="planifierRapport()">
                    â° Planifier
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour les rapports -->
    <div id="rapportModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
            <h2 style="margin-top: 0;">ğŸ“Š Rapport en Cours de GÃ©nÃ©ration</h2>
            <div id="rapportContent">
                <p>GÃ©nÃ©ration du rapport en cours...</p>
                <div class="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 4px; height: 20px; margin-top: 10px;">
                    <div class="progress-fill" style="width: 0%; background-color: #007bff; height: 100%; border-radius: 4px; animation: progress 2s ease-in-out forwards;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>

    <script>
        // Fonctions pour les actions rapides - Rapports
        function genererRapportGeneral() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/rapport-general/?format=${format}`, '_blank');
        }
        
        function genererRapportFinancier() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/rapport-financier/?format=${format}`, '_blank');
        }
        
        function genererRapportPrets() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/rapport-prets/?format=${format}`, '_blank');
        }
        
        function genererRapportMembres() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/rapport-membres/?format=${format}`, '_blank');
        }
        
        function genererRapportTransferts() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/rapport-transferts/?format=${format}`, '_blank');
        }
        
        // Fonctions pour les impressions - Ã‰tats
        function imprimerEtatGeneral() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/etat-general/?format=${format}`, '_blank');
        }
        
        function imprimerEtatFinancier() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/etat-financier/?format=${format}`, '_blank');
        }
        
        function imprimerEtatPrets() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/etat-prets/?format=${format}`, '_blank');
        }
        
        function imprimerEtatCaisses() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/etat-caisses/?format=${format}`, '_blank');
        }
        
        function imprimerEtatTransferts() {
            const format = 'pdf';
            window.open(`/gestion-caisses/admin/etat-transferts/?format=${format}`, '_blank');
        }
        
        // Fonctions pour la gestion des fonds
        function voirCaisseGenerale() {
            window.location.href = '/adminsecurelogin/gestion_caisses/caissegenerale/';
        }
        
        function gererTransferts() {
            window.location.href = '/adminsecurelogin/gestion_caisses/transfertcaisse/';
        }
        
        function voirMouvementsFonds() {
            window.location.href = '/adminsecurelogin/gestion_caisses/mouvementfond/';
        }
        
        function voirVirementsBancaires() {
            window.location.href = '/adminsecurelogin/gestion_caisses/virementbancaire/';
        }
        
        function voirAuditLogs() {
            window.location.href = '/adminsecurelogin/gestion_caisses/auditlog/';
        }
        
        // Fonctions pour la maintenance
        function synchroniserSysteme() {
            if (confirm('Voulez-vous synchroniser le systÃ¨me ? Cette action peut prendre quelques instants.')) {
                window.location.href = '/gestion-caisses/admin/synchroniser-systeme/';
            }
        }
        
        function verifierIntegrite() {
            if (confirm('Voulez-vous vÃ©rifier l\'intÃ©gritÃ© du systÃ¨me ? Cette action peut prendre quelques instants.')) {
                window.location.href = '/gestion-caisses/admin/verifier-integrite/';
            }
        }
        
        function nettoyerDonnees() {
            if (confirm('ATTENTION: Cette action va nettoyer les donnÃ©es temporaires du systÃ¨me. ÃŠtes-vous sÃ»r de vouloir continuer ?')) {
                window.location.href = '/gestion-caisses/admin/nettoyer-donnees/';
            }
        }
        
        function sauvegarderSysteme() {
            if (confirm('Voulez-vous sauvegarder le systÃ¨me ? Cette action peut prendre quelques instants.')) {
                window.location.href = '/gestion-caisses/admin/sauvegarder-systeme/';
            }
        }
        
        function voirParametres() {
            window.location.href = '/adminsecurelogin/gestion_caisses/parametre/';
        }
        
        // Fonctions pour les rapports personnalisÃ©s
        function genererRapportPersonnalise() {
            try {
                const typeRapport = document.getElementById('typeRapport').value;
                const caisse = document.getElementById('caisseSelect').value;
                const dateDebut = document.getElementById('dateDebut').value;
                const dateFin = document.getElementById('dateFin').value;
                const format = document.getElementById('formatRapport').value;
                
                if (!typeRapport) {
                    alert('Veuillez sÃ©lectionner un type de rapport');
                    return;
                }
                
                // Construire l'URL selon le format
                let url = '';
                if (format === 'pdf') {
                    url = `/gestion-caisses/admin/rapport-${typeRapport}/?format=pdf`;
                } else if (format === 'excel') {
                    url = `/gestion-caisses/rapport/export-excel/${typeRapport}/`;
                } else if (format === 'csv') {
                    url = `/gestion-caisses/rapport/export-csv/${typeRapport}/`;
                } else {
                    url = `/gestion-caisses/admin/rapport-${typeRapport}/`;
                }
                
                // Ajouter les paramÃ¨tres de filtre
                const params = new URLSearchParams();
                if (caisse) params.append('caisse', caisse);
                if (dateDebut) params.append('date_debut', dateDebut);
                if (dateFin) params.append('date_fin', dateFin);
                if (format && format !== 'excel' && format !== 'csv') {
                    params.append('format', format);
                }
                
                if (params.toString()) {
                    url += (url.includes('?') ? '&' : '?') + params.toString();
                }
                
                // Afficher le modal
                const modal = document.getElementById('rapportModal');
                if (modal) {
                    modal.style.display = 'block';
                }
                
                // GÃ©nÃ©rer le rapport
                setTimeout(() => {
                    window.open(url, '_blank');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }, 1000);
            } catch (error) {
                console.error('Erreur lors de la gÃ©nÃ©ration du rapport:', error);
                alert('Une erreur est survenue lors de la gÃ©nÃ©ration du rapport. Veuillez rÃ©essayer.');
            }
        }
        
        function previsualiserRapport() {
            try {
                const typeRapport = document.getElementById('typeRapport').value;
                const caisse = document.getElementById('caisseSelect').value;
                const dateDebut = document.getElementById('dateDebut').value;
                const dateFin = document.getElementById('dateFin').value;
                
                if (!typeRapport) {
                    alert('Veuillez sÃ©lectionner un type de rapport');
                    return;
                }
                
                const params = new URLSearchParams();
                if (caisse) params.append('caisse', caisse);
                if (dateDebut) params.append('date_debut', dateDebut);
                if (dateFin) params.append('date_fin', dateFin);
                params.append('format', 'html');
                
                const url = `/gestion-caisses/admin/rapport-${typeRapport}/?${params.toString()}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error('Erreur lors de la prÃ©visualisation du rapport:', error);
                alert('Une erreur est survenue lors de la prÃ©visualisation du rapport. Veuillez rÃ©essayer.');
            }
        }
        
        function exporterDonnees() {
            try {
                const typeRapport = document.getElementById('typeRapport').value;
                const format = document.getElementById('formatRapport').value;
                const caisse = document.getElementById('caisseSelect').value;
                const dateDebut = document.getElementById('dateDebut').value;
                const dateFin = document.getElementById('dateFin').value;
                
                if (!typeRapport) {
                    alert('Veuillez sÃ©lectionner un type de rapport');
                    return;
                }
                
                let url = '';
                if (format === 'excel') {
                    url = `/gestion-caisses/rapport/export-excel/${typeRapport}/`;
                } else if (format === 'csv') {
                    url = `/gestion-caisses/rapport/export-csv/${typeRapport}/`;
                } else {
                    alert('Veuillez sÃ©lectionner Excel ou CSV comme format d\'export');
                    return;
                }
                
                const params = new URLSearchParams();
                if (caisse) params.append('caisse', caisse);
                if (dateDebut) params.append('date_debut', dateDebut);
                if (dateFin) params.append('date_fin', dateFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Afficher un message de chargement
                const modal = document.getElementById('rapportModal');
                if (modal) {
                    modal.style.display = 'block';
                }
                
                // Ouvrir l'URL pour tÃ©lÃ©charger le fichier
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.click();
                
                // Fermer le modal aprÃ¨s un court dÃ©lai
                setTimeout(() => {
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }, 1500);
            } catch (error) {
                console.error('Erreur lors de l\'export des donnÃ©es:', error);
                alert('Une erreur est survenue lors de l\'export des donnÃ©es. Veuillez rÃ©essayer.');
            }
        }
        
        function planifierRapport() {
            alert('FonctionnalitÃ© de planification des rapports en cours de dÃ©veloppement.\n\nCette fonctionnalitÃ© permettra de planifier la gÃ©nÃ©ration automatique de rapports Ã  des dates et heures spÃ©cifiques.');
        }
        
        // Fermer le modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('rapportModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('rapportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Initialiser les dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('dateFin').value = today.toISOString().split('T')[0];
            document.getElementById('dateDebut').value = lastMonth.toISOString().split('T')[0];
        });
    </script>
{% endblock %}
